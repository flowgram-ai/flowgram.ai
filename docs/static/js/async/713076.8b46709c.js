"use strict";(self.webpackChunk_flowgram_ai_docs=self.webpackChunk_flowgram_ai_docs||[]).push([["713076"],{213153:function(t,e,i){let r;i.d(e,{VO:()=>$,RX:()=>ey,RD:()=>B,W6:()=>it,M1:()=>e0,xm:()=>ee,qY:()=>eH,Fw:()=>e6,O0:()=>ef,YZ:()=>g,mY:()=>c,p4:()=>tt,Ho:()=>T,Qc:()=>m.Qc,Tj:()=>eA,ER:()=>ej,KU:()=>ii,G2:()=>io,H$:()=>is,mh:()=>eV,yy:()=>f,nn:()=>eE,JH:()=>V,Yv:()=>eN,Rm:()=>eG,rQ:()=>e$,wY:()=>eB,v2:()=>eh,z2:()=>eM,Zs:()=>eR,XQ:()=>e5,WV:()=>Y,JW:()=>eP,JA:()=>m.JA,km:()=>ir,cv:()=>ea,iX:()=>ia,el:()=>er,aI:()=>em,KV:()=>m.KV,Zn:()=>eZ,Dc:()=>ie,yb:()=>m.yb,d3:()=>e1,s5:()=>K,Lk:()=>ex,VD:()=>L,W4:()=>eJ,_z:()=>Q});var s,n,o,a,h,l,d,c,u,g,p,f,y,m=i("177783"),E=i("433210"),D=i("461932"),M=i("362270"),C=i("550570");i("543789");var b=i("908600"),N=i("473732"),S=i("89802"),x=Object.defineProperty,_=Object.getOwnPropertyDescriptor,w=(t,e,i,r)=>{for(var s=r>1?void 0:r?_(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&x(e,i,s),s};(n=(s=c||(c={})).Default||(s.Default={})).ZOOM_IN="ZOOM_IN",n.ZOOM_OUT="ZOOM_OUT",n.DELETE="DELETE",n.COPY="COPY",n.PASTE="PASTE",n.UNDO="UNDO",n.REDO="REDO",n.VIEW_CLOSE_ALL_WIDGET="view.closeAllWidget",n.VIEW_CLOSE_CURRENT_WIDGET="view.closeCurrentWidget",n.VIEW_REOPEN_LAST_WIDGET="view.reopenLastWidget",n.VIEW_CLOSE_OTHER_WIDGET="view.closeOtherWidget",n.VIEW_CLOSE_BOTTOM_PANEL="view.closeBottomPannel",n.VIEW_OPEN_NEXT_TAB="view.openNextTab",n.VIEW_OEPN_LAST_TAB="view.openLastTab",n.VIEW_FULL_SCREEN="view.fullScreen",n.VIEW_SAVING_WIDGET_CLOSE_CONFIRM="view.savingWidgetCloseConfirm",n.VIEW_SHORTCUTS="view.shortcuts",n.VIEW_PREFERENCES="view.preferences",n.VIEW_LOG="view.log",n.VIEW_PROBLEMS="view.problems",s.is=function(t){return!!t&&t===Object(t)&&"id"in t};var I=Symbol("CommandContribution");(u||(u={})).findSimple=function(t,e){for(let i of t.values())if(i.id===e.id&&i.args.length===e.args.length&&i.args.every((t,i)=>e[i]===t))return i};var T=class{constructor(){this._handlers={},this._commands={},this._commandExecutings=new Set,this.toUnregisterCommands=new Map,this.onDidExecuteCommandEmitter=new m.Q5,this.onDidExecuteCommand=this.onDidExecuteCommandEmitter.event,this.onWillExecuteCommandEmitter=new m.Q5,this.onWillExecuteCommand=this.onWillExecuteCommandEmitter.event}init(){for(let t of this.contributions)t.registerCommands(this)}get commands(){let t=[];for(let e of this.commandIds){let i=this.getCommand(e);i&&t.push(i)}return t}get commandIds(){return Object.keys(this._commands)}registerCommand(t,e){let i="string"==typeof t?{id:t}:t;if(this._commands[i.id])return console.warn(`A command ${i.id} is already registered.`),m.JT.NULL;let r=new m.K4(this.doRegisterCommand(i));return e&&r.push(this.registerHandler(i.id,e)),this.toUnregisterCommands.set(i.id,r),r.push(m.JT.create(()=>this.toUnregisterCommands.delete(i.id))),r}unregisterCommand(t){let e=c.is(t)?t.id:t,i=this.toUnregisterCommands.get(e);i&&i.dispose()}registerHandler(t,e){let i=this._handlers[t];return!i&&(this._handlers[t]=i=[]),i.unshift(e),{dispose:()=>{let t=i.indexOf(e);t>=0&&i.splice(t,1)}}}isVisible(t,...e){return void 0!==this.getVisibleHandler(t,...e)}isEnabled(t,...e){return void 0!==this.getActiveHandler(t,...e)}isToggled(t,...e){return void 0!==this.getToggledHandler(t,...e)}async executeCommand(t,...e){let i=this.getActiveHandler(t,...e),r={id:t,args:e};if(u.findSimple(this._commandExecutings,r))return r.promise;if(i)try{this._commandExecutings.add(r),this.onWillExecuteCommandEmitter.fire({commandId:t,args:e});let s=i.execute(...e);r.promise=s;let n=await s;return this.onDidExecuteCommandEmitter.fire({commandId:t,args:e}),n}finally{this._commandExecutings.delete(r)}}getVisibleHandler(t,...e){let i=this._handlers[t];if(i)for(let t of i)try{if(!t.isVisible||t.isVisible(...e))return t}catch(t){console.error(t)}}getActiveHandler(t,...e){let i=this._handlers[t];if(i)for(let t of i)try{if(!t.isEnabled||t.isEnabled(...e))return t}catch(t){console.error(t)}}getAllHandlers(t){let e=this._handlers[t];return e?e.slice():[]}getToggledHandler(t,...e){let i=this._handlers[t];if(i)for(let t of i)try{if(t.isToggled&&t.isToggled(...e))return t}catch(t){console.error(t)}}getCommand(t){return this._commands[t]}doRegisterCommand(t){return this._commands[t.id]=t,{dispose:()=>{delete this._commands[t.id]}}}updateCommand(t,e){this._commands[t]&&(this._commands[t]={...this._commands[t],...e})}dispose(){this.onWillExecuteCommandEmitter.dispose(),this.onDidExecuteCommandEmitter.dispose()}};w([(0,D.nx)(I),(0,D.jt)()],T.prototype,"contributions",2),T=w([(0,D.b2)()],T);var L=Symbol("CommandService"),O=new D.nZ(t=>{(0,m.yb)(t,I),t(T).toSelf().inSingletonScope(),t(L).toService(T),t("CommandRegistryFactory").toFactory(t=>()=>t.container.get(T))}),A=Object.defineProperty,k=Object.getOwnPropertyDescriptor,R=(t,e,i,r)=>{for(var s=r>1?void 0:r?k(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&A(e,i,s),s},P=(t,e)=>(i,r)=>e(i,r,t),j=Object.__proto__,z=0,V=class{constructor(t){this.onEntityChangeEmitter=new m.Q5,this.onDataChangeEmitter=new m.Q5,this.initializeDataKeys=[],this.dataManager=new Map,this.toDispose=new m.K4,this.onEntityChange=this.onEntityChangeEmitter.event,this.onDataChange=this.onDataChangeEmitter.event,this._changeLockedTimes=0,this.isInitialized=!0,this._version=z++,this._savedInManager=!0,this.entityManager=t.entityManager,this._id=t.id||(0,E.x0)(),this._savedInManager=void 0===t.savedInManager||t.savedInManager,this.isInitialized=!0,this.toDispose.push(this.onEntityChangeEmitter),this.toDispose.push(this.onDataChangeEmitter),this.register(),t.datas&&t.datas.forEach(t=>this.addData(t.registry,t.data)),this.isInitialized=!1}getDefaultDataRegistries(){return[]}get changeLocked(){return this._changeLockedTimes>0}set changeLocked(t){this._changeLockedTimes=t?this._changeLockedTimes+1:this._changeLockedTimes-1,this._changeLockedTimes<0&&(this._changeLockedTimes=0)}get type(){if(!this.constructor.type)throw Error(`Entity Registry need a type: ${this.constructor.name}`);return this.constructor.type}get context(){return this.entityManager.context}addInitializeData(t,e){this.isInitialized=!0,t.forEach(t=>this.addData(t,e)),this.isInitialized=!1}get version(){return this._version}toJSON(){let t=[];for(let e of this.dataManager.values())t.push({type:e.type,data:e.toJSON()});return{type:this.type,id:this.id,dataList:t}}fromJSON(t){t&&t.id&&t.type&&(this.changeLocked=!0,this.reset(),t.dataList&&t.dataList.forEach(t=>{let e=this.entityManager.getDataRegistryByType(t.type);e&&this.addData(e).update(t.data)}),this.changeLocked=!1,this.fireChange())}get id(){return this._id}dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}reset(){for(let t of(this.changeLocked=!0,this.dataManager.values()))!this.initializeDataKeys.includes(t.type)&&t.dispose();this.register(),this.changeLocked=!1,this.fireChange()}get onDispose(){return this.toDispose.onDispose}fireChange(){!this.changeLocked&&!this.isInitialized&&!this.disposed&&(this._version++,this._version>=Number.MAX_SAFE_INTEGER&&(this._version=0),this.onEntityChangeEmitter.fire(this))}addData(t,e){this.entityManager.registerEntityData(t);let i=this.dataManager.get(t.type);if(i)return e&&this.updateData(t,e),i;let r=this.entityManager.getDataInjector(t);i=new t(this,r?.()),this.isInitialized&&this.initializeDataKeys.push(i.type),this.dataManager.set(t.type,i),this.toDispose.push(i),i.onDataChange(()=>{let t={type:"update",data:i,entity:this};this.onDataChangeEmitter.fire(t),this.fireChange()}),i.toDispose.push(m.JT.create(()=>{!this.initializeDataKeys.includes(t.type)&&this.dataManager.delete(t.type);let e={type:"delete",data:i,entity:this};this.onDataChangeEmitter.fire(e),this.fireChange()})),i.changeLocked=!0,this.updateData(t,e||i.getDefaultData()),i.changeLocked=!1;let s={type:"add",data:i,entity:this};return this.onDataChangeEmitter.fire(s),i}get savedInManager(){return this._savedInManager}updateData(t,e){let i=this.dataManager.get(t.type);i&&i.update(e)}getData(t){return this.dataManager.get(t.type)}hasData(t){return this.dataManager.has(t.type)}removeData(t){if(this.initializeDataKeys.includes(t.type))return;let e=this.dataManager.get(t.type);e&&e.dispose()}getService(t){return this.entityManager.getService(t)}register(){this.getDefaultDataRegistries().forEach(t=>this.addData(t))}};V.type="Entity",(o=V||(V={})).getType=function(t){return t.type},o.checkDataChanged=function(t,e){return m.XJ.isChanged(t,e)},o.isRegistryOf=function(t,e){if(t===e)return!0;let i=t.__proto__;for(;i&&i!==j;){if(i.prototype===e.prototype)return!0;i=i.__proto__}return!1};var B=class extends m.Pq{constructor(t,e){super(),this.opts=e,this.onDataChangeEmitter=new m.Q5,this.onWillChangeEmitter=new m.Q5,this._changeLocked=!1,this._version=0,this.onDataChange=this.onDataChangeEmitter.event,this.onWillChange=this.onWillChangeEmitter.event,this.entity=t,this._data=this.getDefaultData(),this.toDispose.push(this.onDataChangeEmitter),this.toDispose.push(this.onWillChangeEmitter)}get type(){if(!this.constructor.type)throw Error(`Entity Data Registry need a type: ${this.constructor.name}`);return this.constructor.type}get data(){return this._data}update(t,e){2==arguments.length?this._data[t]!==e&&(this.fireWillChange(),this._data[t]=e,this.fireChange()):this.checkChanged(t)&&(this.fireWillChange(),"object"!=typeof t?this._data=t:this._data={...this._data,...t},this.fireChange())}fullyUpdate(t){m.XJ.isChanged(this._data,t,1,!1)&&(this.fireWillChange(),this._data=t,this.fireChange())}checkChanged(t){return V.checkDataChanged(this._data,t)}toJSON(){return this.data}fromJSON(t){this.update(t)}get changeLocked(){return this._changeLocked}set changeLocked(t){this._changeLocked=t}fireWillChange(){this.onWillChangeEmitter.fire(this)}fireChange(){!this._changeLocked&&(this._version++,this._version>=Number.MAX_SAFE_INTEGER&&(this._version=0),this.onDataChangeEmitter.fire(this))}bindChange(t,e){this.toDispose.push(t.onDataChange(()=>{e&&e(),this.fireChange()}))}get version(){return this._version}};B.type="EntityData";var F=class extends B{getDefaultData(){return m.V_.createDefault(m.i1)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};F.type="OriginData",(class extends B{getDefaultData(){return m.V_.createDefault(m.r9)}}).type="OpacityData";var Y=class extends B{getDefaultData(){return m.V_.createDefault(m.Zp)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};Y.type="PositionData";var U=class extends B{getDefaultData(){return m.V_.createDefault(m.z)}};U.type="RotationData";var G=class extends B{getDefaultData(){return m.V_.createDefault(m.Of)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};G.type="ScaleData";var Q=class extends B{getDefaultData(){return m.V_.createDefault(m.gE)}get width(){return this.data.width}get height(){return this.data.height}set width(t){this.update("width",t)}set height(t){this.update("height",t)}get locked(){return!!this.data.locked}set locked(t){this.update("locked",t)}};Q.type="SizeData";var X=class extends B{getDefaultData(){return m.V_.createDefault(m.S9)}get x(){return this.data.x}get y(){return this.data.y}set x(t){this.update("x",t)}set y(t){this.update("y",t)}};X.type="SkewData";var{fixZero:W}=m.E9;(t=>{function e(t,e){return e&&e.apply(t,t),W(t),t}t.getPointWithMatrix=e;t.getBounds=function(t,e){let o=new m.Ae;if(!e||e.isSimple()){let{size:i,origin:r}=t;o.x=-(i.width*r.x)+(e?.tx||0),o.y=-(i.height*r.y)+(e?.ty||0),o.width=i.width,o.height=i.height,W(o)}else{let a=i(t,e),h=r(t,e),l=s(t,e),d=n(t,e);o.x=Math.min(a.x,h.x,l.x,d.x),o.y=Math.min(a.y,h.y,l.y,d.y),o.width=Math.max(a.x,h.x,l.x,d.x)-o.x,o.height=Math.max(a.y,h.y,l.y,d.y)-o.y}return o};t.applyMatrix=function(t,i){let r=new m.Ae;if(i.isSimple())r.x=t.x+i.tx,r.y=t.y+i.ty,r.width=t.width,r.height=t.height,W(r);else{let s=e(t.leftTop,i),n=e(t.rightTop,i),o=e(t.leftBottom,i),a=e(t.rightBottom,i);r.x=Math.min(s.x,n.x,o.x,a.x),r.y=Math.min(s.y,n.y,o.y,a.y),r.width=Math.max(s.x,n.x,o.x,a.x)-r.x,r.height=Math.max(s.y,n.y,o.y,a.y)-r.y}return r};t.getLeftPointFromBounds=function(t,e){let o=i(t,e),a=r(t,e),h=s(t,e);return[o,a,h,n(t,e)].sort((t,e)=>t.x-e.x)[0]};t.getTopPointFromBounds=function(t,e){let o=i(t,e),a=r(t,e),h=s(t,e);return[o,a,h,n(t,e)].sort((t,e)=>t.y-e.y)[0]};function i(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x),y:-(r.height*s.y)},i)}t.getCenter=function(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x)+r.width/2,y:-(r.height*s.y)+r.height/2},i)},t.getTopLeft=i;function r(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x)+r.width,y:-(r.height*s.y)},i)}t.getTopCenter=function(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x)+r.width/2,y:-(r.height*s.y)},i)},t.getTopRight=r;t.getLeftCenter=function(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x),y:-(r.height*s.y)+r.height/2},i)};function s(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x),y:-(r.height*s.y)+r.height},i)}t.getRightCenter=function(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x)+r.width,y:-(r.height*s.y)+r.height/2},i)},t.getBottomLeft=s;function n(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x)+r.width,y:-(r.height*s.y)+r.height},i)}t.getBottomCenter=function(t,i){let{size:r,origin:s}=t;return e({x:-(r.width*s.x)+r.width/2,y:-(r.height*s.y)+r.height},i)},t.getBottomRight=n})(g||(g={}));var $=class extends B{constructor(t){super(t),this._worldTransform=new m.y3,this._localTransform=new m.y3,this.mutationCache=new Map,this.sizeToScale=!1,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._localID=0,this._currentLocalID=0,this._worldID=0,this._parentID=0,this.bindChange(this.entity.addData(Y)),this.bindChange(this.entity.addData(Q)),this.bindChange(this.entity.addData(F)),this.bindChange(this.entity.addData(G)),this.bindChange(this.entity.addData(X),()=>this.updateSkew()),this.bindChange(this.entity.addData(U),()=>this.updateSkew())}get children(){return this._children||[]}clearChildren(){this._children&&this._children.slice().forEach(t=>{t.setParent(void 0)})}get isContainer(){return!!this._children&&this._children.length>0}fireChange(){!this.changeLocked&&(this._localID++,this.mutationCache.clear(),super.fireChange())}get localTransform(){return this.updateLocalTransformMatrix(),this._localTransform}get worldTransform(){return this.updateTransformMatrix(),this._worldTransform}getDefaultData(){return m.V_.createDefault(m.hY)}update(t){t.position&&this.entity.updateData(Y,t.position),t.size&&this.entity.updateData(Q,t.size),t.origin&&this.entity.updateData(F,t.origin),t.scale&&this.entity.updateData(G,t.scale),t.skew&&this.entity.updateData(X,t.skew),void 0!==t.rotation&&this.entity.updateData(U,t.rotation)}get position(){return this.entity.getData(Y)}set position(t){this.entity.updateData(Y,t)}get size(){return this.entity.getData(Q)}set size(t){this.entity.updateData(Q,t)}get origin(){return this.entity.getData(F)}set origin(t){this.entity.updateData(F,t)}get scale(){return this.entity.getData(G)}set scale(t){this.entity.updateData(G,t)}get skew(){return this.entity.getData(X)}set skew(t){this.entity.updateData(X,t)}get rotation(){return this.entity.getData(U).data}set rotation(t){this.entity.updateData(U,t)}get data(){return m.pL.toJSON(this)}updateSkew(){let{rotation:t}=this;this._cx=Math.cos(t+this.skew.y),this._sx=Math.sin(t+this.skew.y),this._cy=-Math.sin(t-this.skew.x),this._sy=Math.cos(t-this.skew.x),this._localID++}updateLocalTransformMatrix(){let t=this._localTransform;this._localID!==this._currentLocalID&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x,t.ty=this.position.y,this._currentLocalID=this._localID,this._parentID=-1)}get localID(){return this._localID}get worldID(){return this._worldID}updateTransformMatrix(){let t=this._localTransform;this.updateLocalTransformMatrix();let e=m.y3.TEMP_MATRIX,i=0;if(this.parent&&(e=this.parent.worldTransform,i=this.parent._worldID),this._parentID!==i){let r=e,s=this._worldTransform;s.a=t.a*r.a+t.b*r.c,s.b=t.a*r.b+t.b*r.d,s.c=t.c*r.a+t.d*r.c,s.d=t.c*r.b+t.d*r.d,s.tx=t.tx*r.a+t.ty*r.c+r.tx,s.ty=t.tx*r.b+t.ty*r.d+r.ty,this._parentID=i,this._worldID++}}setFromMatrix(t){let{a:e,b:i,c:r,d:s}=t,n=-Math.atan2(-r,s),o=Math.atan2(i,e),a=Math.abs(n+o);a<1e-5||1e-5>Math.abs(m._b-a)?(this.rotation=o,this.skew.x=this.skew.y=0):(this.rotation=0,this.skew.x=n,this.skew.y=o),this.scale.x=Math.sqrt(e*e+i*i),this.scale.y=Math.sqrt(r*r+s*s),this.position.x=t.tx,this.position.y=t.ty,this.fireChange()}getMutationCache(t,e){if(this.mutationCache.has(t))return this.mutationCache.get(t);let i=e();return this.mutationCache.set(t,i),i}get bounds(){if(this.isContainer){let t=this._children;return m.Ae.enlarge(t.map(t=>t.bounds))}return g.getBounds(this,this.worldTransform)}get boundsWithoutRotation(){let{center:t}=this.bounds,{worldScale:e}=this,i=this.localSize,r=e.x*i.width,s=e.y*i.height,n={x:t.x-r/2,y:t.y-s/2};return new m.Ae(n.x,n.y,r,s)}get localSize(){let{size:t}=this;if(this.isContainer){let e=m.Ae.enlarge(this.children.map(t=>t.localBounds));t={width:e.width,height:e.height}}return{width:t.width,height:t.height}}get worldSize(){let{localSize:t}=this,{worldScale:e}=this;return{width:t.width*e.x,height:t.height*e.y}}get localBounds(){if(this.isContainer){let t=this._children,e=m.Ae.enlarge(t.map(t=>t.localBounds));return g.applyMatrix(e,this.localTransform)}return this.getMutationCache("localBounds",()=>g.getBounds(this,this.localTransform))}contains(t,e,i){if(this.isContainer)return this.bounds.contains(t,e);let r=this.worldTransform.applyInverse({x:t,y:e}),{width:s,height:n}=this.size;if(0===s||0===n)return!1;let o=-s*this.origin.x,a=-n*this.origin.y;return i?new m.Cd(o+s/2,a+n/2,Math.min(s/2,n/2)).contains(r.x,r.y):!!(r.x>=o)&&!!(r.x<o+s)&&!!(r.y>=a)&&!!(r.y<a+n)||!1}get parent(){return this._parent}isParent(t){let e=this.parent;for(;e;){if(e===t)return!0;e=e.parent}return!1}isParentTransform(t){let e=this.parent;for(;e;){if(e===t)return!0;e=e.parent}return!1}setParent(t,e=!0){this._parent!==t&&(this._parentChangedDispose&&(this._parentChangedDispose.dispose(),this._parentChangedDispose=void 0),this._parentID=-1,t&&e&&(!t._children&&(t._children=[]),t._children.push(this),this._parentChangedDispose=new m.K4,this.toDispose.push(this._parentChangedDispose),this._parentChangedDispose.pushAll([t.onDispose(()=>{this.setParent(void 0)}),m.JT.create(()=>{let e=t._children.indexOf(this);-1!==e&&t._children.splice(e,1)})])),this._parent=t,this.fireChange())}intersects(t){return(!!this.isContainer||0!==this.size.width&&0!==this.size.height)&&m.Ae.intersectsWithRotation(this.boundsWithoutRotation,this.worldRotation,t,0)}get worldScale(){let{parent:t}=this,e=t?t.worldScale:{x:1,y:1};return{x:this.scale.x*e.x,y:this.scale.y*e.y}}get worldRotation(){let{parent:t}=this;return t?m.RZ.wrap(this.rotation+t.worldRotation):m.RZ.wrap(this.rotation)}get worldDegree(){return Math.round(this.worldRotation*m.jl)}get localOrigin(){let t=this.localTransform,e=this.localBounds;return t.apply({x:this.origin.x*e.width,y:this.origin.y*e.height})}get worldOrigin(){let t=this.worldTransform,{bounds:e}=this;return t.apply({x:this.origin.x*e.width,y:this.origin.y*e.height})}widthToScaleX(t,e){return t/(e&&this.parent?this.parent.worldScale.x:1)/this.localSize.width}heightToScaleY(t,e){return t/(e&&this.parent?this.parent.worldScale.y:1)/this.localSize.height}sizeToScaleValue(t,e){return{x:this.widthToScaleX(t.width,e),y:this.heightToScaleY(t.height,e)}}};$.type="TransformData",(a=$||($={})).isParentOrChildrenTransform=function(t,e){let i=e.getData(a);if(!i)return!1;for(let e of t.values()){let t=e.getData(a);if(t&&(t.isParent(i)||i.isParent(t)))return!0}return!1};var J=class{constructor(){this.execMap=new Map}push(t,e){let{execMap:i}=this,r=i.get(t);!r&&(r=(0,M.throttle)(e,0),i.set(t,r)),r()}dispose(){this.execMap.clear()}};function H(t,e,i){let r=document.createEvent("MouseEvent");return r.initMouseEvent(t,!0,!0,void 0,0,0,0,e,i,!1,!1,!1,!1,0,null),r}var K=class{constructor(t={}){this.onDragStartEmitter=new m.Q5,this.onDragEndEmitter=new m.Q5,this.onDragEmitter=new m.Q5,this._stopGlobalEventNames=["mouseenter","mouseleave","mouseover","mouseout","contextmenu"],this.onDrag=this.onDragEmitter.event,this.onDragStart=this.onDragStartEmitter.event,this.onDragEnd=this.onDragEndEmitter.event,this._lastPos={x:0,y:0},this._updateDragScroll=t=>{if(!this._playgroundConfigEntity)return;let e=this._playgroundConfigEntity.config,i=t.endPos,{scrollX:r,width:s,height:n,scrollY:o}=e;i.x>s+r-20?this._startScrollX(r,!0):i.x<r+20?this._startScrollX(r,!1):this._stopScrollX(),i.y>n+o-20?this._startScrollY(o,!0):i.y<o+20?this._startScrollY(o,!1):this._stopScrollY()},this._disposed=!1,t.onDragStart&&this.onDragStart(e=>t.onDragStart(e,this.context)),t.onDrag&&this.onDrag(e=>t.onDrag(e,this.context)),t.onDragEnd&&this.onDragEnd(e=>t.onDragEnd(e,this.context)),t.stopGlobalEventNames&&(this._stopGlobalEventNames=t.stopGlobalEventNames)}get isStarted(){return!!this._promise}start(t,e,i,r){if(this._disposed)return Promise.resolve();if(this._promise)return this._promise;this.context=r,this.localId=(0,m.oN)(),this._addListeners(),this._promise=new Promise(t=>{this._resolve=t}),this._playgroundConfigEntity=i;let s=H("mousedown",t,e);return this._startPos=this.getRelativePos(s),this.onDragStartEmitter.fire(this.getDragEvent(s)),this._promise}stop(t,e){if(this._disposed||!this._promise)return;let i=H("mouseup",t,e);this.handleEvent(i)}dispose(){!this._disposed&&(this._stopScrollX(),this._stopScrollY(),this._disposed=!0,this.onDragEmitter.dispose(),this.onDragStartEmitter.dispose(),this.onDragEndEmitter.dispose(),this._finalize())}handleEvent(t){switch(t.type){case"mousemove":this._evtMouseMove(t);break;case"mouseup":this._stopScrollX(),this._stopScrollY(),this._evtMouseUp(t);break;case"keydown":this._evtKeyDown(t);break;case"contextmenu":let e=H("mouseup",t.clientX,t.clientY);this._evtMouseUp(e);break;default:t.preventDefault(),t.stopPropagation()}}get scale(){return this._playgroundConfigEntity?this._playgroundConfigEntity.finalScale:1}getRelativePos(t){return this._playgroundConfigEntity?this._playgroundConfigEntity.getPosFromMouseEvent(t,!1):{x:t.clientX,y:t.clientY}}getDragEvent(t){let e=this._startPos,{scale:i}=this;switch(t.type){case"mousedown":return this._lastPos=e,Object.assign(t,{id:this.localId,startPos:e,endPos:e,scale:i,movingDelta:{x:0,y:0},isStart:!0,isMoving:!1});case"mousemove":let r=this.getRelativePos(t),s={x:r.x-this._lastPos.x,y:r.y-this._lastPos.y};return this._lastPos=r,Object.assign(t,{id:this.localId,startPos:e,endPos:r,scale:i,isStart:!0,movingDelta:s,isMoving:!0});case"mouseup":return this._lastPos={x:0,y:0},Object.assign(t,{id:this.localId,startPos:e,endPos:this.getRelativePos(t),movingDelta:{x:0,y:0},scale:i,isStart:!1,isMoving:!1});default:throw Error("unknown event")}}_finalize(){let t=this._resolve;this._removeListeners(),this._startPos=void 0,this._promise=void 0,this._resolve=void 0,t&&t()}_evtMouseMove(t){t.preventDefault(),t.stopPropagation(),this._lastMouseMoveEvent=t;let e=this.getDragEvent(t);this._updateDragScroll(e),this.onDragEmitter.fire(e)}_evtMouseUp(t){if(this._lastMouseMoveEvent=void 0,t.preventDefault(),t.stopPropagation(),0===t.button||1===t.button)this.onDragEndEmitter.fire(this.getDragEvent(t)),this._finalize()}_evtKeyDown(t){t.preventDefault(),t.stopPropagation(),27===t.keyCode&&this.stop(NaN,NaN)}_addListeners(){document.addEventListener("mousedown",this,!0),document.addEventListener("mousemove",this,!0),document.addEventListener("mouseup",this,!0),this._stopGlobalEventNames.forEach(t=>{document.addEventListener(t,this,!0)})}_removeListeners(){document.removeEventListener("mousedown",this,!0),document.removeEventListener("mousemove",this,!0),document.removeEventListener("mouseup",this,!0),this._stopGlobalEventNames.forEach(t=>{document.removeEventListener(t,this,!0)})}_startScrollX(t,e){if(this._scrollXInterval)return;let i=window.setInterval(()=>{this._scrollXInterval&&this.fireScroll("scrollX",e)},20);this._scrollXInterval={interval:i,origin:t}}_stopScrollX(){this._scrollXInterval&&(clearInterval(this._scrollXInterval.interval),this._scrollXInterval=void 0)}_startScrollY(t,e){if(this._scrollYInterval)return;let i=window.setInterval(()=>{this.fireScroll("scrollY",e)},20);this._scrollYInterval={interval:i,origin:t}}_stopScrollY(){this._scrollYInterval&&(clearInterval(this._scrollYInterval.interval),this._scrollYInterval=void 0)}fireScroll(t,e){let i="scrollY"===t?this._scrollYInterval:this._scrollXInterval;if(!i)return;let r=i.origin=e?i.origin+4:i.origin-4,s=this._playgroundConfigEntity.config[t];this._playgroundConfigEntity.updateConfig({[t]:r});let n=this._playgroundConfigEntity.config[t];if(n!==s){let e=this._lastMouseMoveEvent,r={x:"scrollX"===t?n-i.origin:0,y:"scrollY"===t?n-i.origin:0},s=H("mousemove",e.clientX+r.x,e.clientY+r.y),o=this.getDragEvent(s);this.onDragEmitter.fire(o)}}};(h=K||(K={})).startDrag=function(t,e,i={}){p&&p.stop(NaN,NaN);let r=p=new h({onDragStart(t,e){i.onDragStart&&i.onDragStart(t,e)},onDrag(t,e){i.onDrag&&i.onDrag(t,e)},onDragEnd(t,e){i.onDragEnd&&i.onDragEnd(t,e),r.dispose(),p===r&&(p=void 0)}});return r.start(t,e,i.config,i.context),m.JT.create(()=>{r.stop(0,0),r.dispose(),p===r&&(p=void 0)})};var Z=0;function q(){Z--}function tt(t){Z++,requestAnimationFrame(function t(e){!(Z<=0)&&(requestAnimationFrame(t),C.ZP.update(e))});let e=!1,i=new C.ZP.Tween(t.from).to(t.to,t.duration).easing(t.easing||C.ZP.Easing.Quadratic.Out).onUpdate(()=>{!e&&t.onUpdate&&t.onUpdate(t.from)}).onComplete(()=>{!e&&(e=!0,Z--,t.onComplete&&t.onComplete(t.from))}).start();return m.JT.create(()=>{!e&&(e=!0,Z--,i.stop(),t.onDispose&&t.onDispose(t.from))})}function te(t){let[e,i]=t.overflow,[r,s]=t._delta,[n,o]=t._direction;(e<0&&r>0&&n<0||e>0&&r<0&&n>0)&&(t._movement[0]=t._movementBound[0]),(i<0&&s>0&&o<0||i>0&&s<0&&o>0)&&(t._movement[1]=t._movementBound[1])}var ti={toVector:(t,e)=>(void 0===t&&(t=e),Array.isArray(t)?t:[t,t]),add:(t,e)=>[t[0]+e[0],t[1]+e[1]],sub:(t,e)=>[t[0]-e[0],t[1]-e[1]],addTo(t,e){t[0]+=e[0],t[1]+=e[1]},subTo(t,e){t[0]-=e[0],t[1]-=e[1]}};function tr(t,e,i){return 0===e||Math.abs(e)===1/0?Math.pow(t,5*i):t*e*i/(e+i*t)}function ts(t,e,i,r=.15){if(0===r)return Math.max(e,Math.min(t,i));return t<e?-tr(e-t,i-e,r)+e:t>i?+tr(t-i,i-e,r)+i:t}var tn={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function to(t){return t?t[0].toUpperCase()+t.slice(1):""}var ta=["enter","leave"],th=["gotpointercapture","lostpointercapture"];function tl(t){return"touches"in t}function td(t){return tl(t)?"touch":"pointerType"in t?t.pointerType:"mouse"}function tc(t){var e;return tl(t)?("touchend"===(e=t).type||"touchcancel"===e.type?e.changedTouches:e.targetTouches)[0]:t}function tu(t,e){try{let i=e.clientX-t.clientX,r=e.clientY-t.clientY,s=(e.clientX+t.clientX)/2,n=(e.clientY+t.clientY)/2,o=Math.hypot(i,r),a=-(180*Math.atan2(i,r))/Math.PI;return{angle:a,distance:o,origin:[s,n]}}catch{}return null}function tg(t,e){let[i,r]=Array.from(t.touches).filter(t=>e.includes(t.identifier));return tu(i,r)}function tp(t){let e=tc(t);return tl(t)?e.identifier:e.pointerId}function tf(t){let e=tc(t);return[e.clientX,e.clientY]}function ty(t){let{deltaX:e,deltaY:i,deltaMode:r}=t;return 1===r?(e*=40,i*=40):2===r&&(e*=800,i*=800),[e,i]}function tm(t,...e){return"function"==typeof t?t(...e):t}function tv(){}function tE(t,e){return Object.assign({},e,t||{})}var tD=class{constructor(t,e,i){this.ctrl=t,this.args=e,this.key=i,!this.state&&(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(t){this.ctrl.state[this.key]=t}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){let{state:t,shared:e,ingKey:i,args:r}=this;e[i]=t._active=t.active=t._blocked=t._force=!1,t._step=[!1,!1],t.intentional=!1,t._movement=[0,0],t._distance=[0,0],t._direction=[0,0],t._delta=[0,0],t._bounds=[[-1/0,1/0],[-1/0,1/0]],t.args=r,t.axis=void 0,t.memo=void 0,t.elapsedTime=t.timeDelta=0,t.direction=[0,0],t.distance=[0,0],t.overflow=[0,0],t._movementBound=[!1,!1],t.velocity=[0,0],t.movement=[0,0],t.delta=[0,0],t.timeStamp=0}start(t){let e=this.state,i=this.config;!e._active&&(this.reset(),this.computeInitial(),e._active=!0,e.target=t.target,e.currentTarget=t.currentTarget,e.lastOffset=i.from?tm(i.from,e):e.offset,e.offset=e.lastOffset,e.startTime=e.timeStamp=t.timeStamp)}computeValues(t){let e=this.state;e._values=t,e.values=this.config.transform(t)}computeInitial(){let t=this.state;t._initial=t._values,t.initial=t.values}compute(t){let{state:e,config:i,shared:r}=this;e.args=this.args;let s=0;if(t&&(e.event=t,i.preventDefault&&t.cancelable&&e.event.preventDefault(),e.type=t.type,r.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,r.locked=!!document.pointerLockElement,Object.assign(r,function(t){let e={};if("buttons"in t&&(e.buttons=t.buttons),"shiftKey"in t){let{shiftKey:i,altKey:r,metaKey:s,ctrlKey:n}=t;Object.assign(e,{shiftKey:i,altKey:r,metaKey:s,ctrlKey:n})}return e}(t)),r.down=r.pressed=r.buttons%2==1||r.touches>0,s=t.timeStamp-e.timeStamp,e.timeStamp=t.timeStamp,e.elapsedTime=e.timeStamp-e.startTime),e._active){let t=e._delta.map(Math.abs);ti.addTo(e._distance,t)}this.axisIntent&&this.axisIntent(t);let[n,o]=e._movement,[a,h]=i.threshold,{_step:l,values:d}=e;if(i.hasCustomTransform?(!1===l[0]&&(l[0]=Math.abs(n)>=a&&d[0]),!1===l[1]&&(l[1]=Math.abs(o)>=h&&d[1])):(!1===l[0]&&(l[0]=Math.abs(n)>=a&&Math.sign(n)*a),!1===l[1]&&(l[1]=Math.abs(o)>=h&&Math.sign(o)*h)),e.intentional=!1!==l[0]||!1!==l[1],!e.intentional)return;let c=[0,0];if(i.hasCustomTransform){let[t,e]=d;c[0]=!1!==l[0]?t-l[0]:0,c[1]=!1!==l[1]?e-l[1]:0}else c[0]=!1!==l[0]?n-l[0]:0,c[1]=!1!==l[1]?o-l[1]:0;this.restrictToAxis&&!e._blocked&&this.restrictToAxis(c);let u=e.offset,g=e._active&&!e._blocked||e.active;g&&(e.first=e._active&&!e.active,e.last=!e._active&&e.active,e.active=r[this.ingKey]=e._active,t&&(e.first&&("bounds"in i&&(e._bounds=tm(i.bounds,e)),this.setup&&this.setup()),e.movement=c,this.computeOffset()));let[p,f]=e.offset,[[y,m],[E,D]]=e._bounds;e.overflow=[p<y?-1:p>m?1:0,f<E?-1:f>D?1:0],e._movementBound[0]=!!e.overflow[0]&&(!1===e._movementBound[0]?e._movement[0]:e._movementBound[0]),e._movementBound[1]=!!e.overflow[1]&&(!1===e._movementBound[1]?e._movement[1]:e._movementBound[1]);let M=e._active&&i.rubberband||[0,0];if(e.offset=function(t,[e,i],[r,s]){let[[n,o],[a,h]]=t;return[ts(e,n,o,r),ts(i,a,h,s)]}(e._bounds,e.offset,M),e.delta=ti.sub(e.offset,u),this.computeMovement(),g&&(!e.last||s>32)){e.delta=ti.sub(e.offset,u);let t=e.delta.map(Math.abs);ti.addTo(e.distance,t),e.direction=e.delta.map(Math.sign),e._direction=e._delta.map(Math.sign),!e.first&&s>0&&(e.velocity=[t[0]/s,t[1]/s],e.timeDelta=s)}}emit(){let t=this.state,e=this.shared,i=this.config;if(!t._active&&this.clean(),(t._blocked||!t.intentional)&&!t._force&&!i.triggerAllEvents)return;let r=this.handler({...e,...t,[this.aliasKey]:t.values});void 0!==r&&(t.memo=r)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}},tM=class extends tD{constructor(){super(...arguments),this.aliasKey="xy"}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=ti.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=ti.sub(this.state.offset,this.state.lastOffset)}axisIntent(t){let e=this.state,i=this.config;if(!e.axis&&t){let r="object"==typeof i.axisThreshold?i.axisThreshold[td(t)]:i.axisThreshold;e.axis=function([t,e],i){let r=Math.abs(t),s=Math.abs(e);return r>s&&r>i?"x":s>r&&s>i?"y":void 0}(e._movement,r)}e._blocked=(i.lockDirection||!!i.axis)&&!e.axis||!!i.axis&&i.axis!==e.axis}restrictToAxis(t){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":t[1]=0;break;case"y":t[0]=0}}},tC=class extends tM{constructor(){super(...arguments),this.ingKey="wheeling"}wheel(t){!this.state._active&&this.start(t),this.wheelChange(t),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(t){let e=this.state;e._delta=ty(t),ti.addTo(e._movement,e._delta),te(e),this.compute(t),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(t){t("wheel","",this.wheel.bind(this))}},tb=class extends tM{constructor(){super(...arguments),this.ingKey="scrolling"}scroll(t){!this.state._active&&this.start(t),this.scrollChange(t),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(t){t.cancelable&&t.preventDefault();let e=this.state,i=function(t){let{scrollX:e,scrollY:i,scrollLeft:r,scrollTop:s}=t.currentTarget;return[e??r??0,i??s??0]}(t);e._delta=ti.sub(i,e._values),ti.addTo(e._movement,e._delta),this.computeValues(i),this.compute(t),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(t){t("scroll","",this.scroll.bind(this))}},tN=class extends tD{constructor(){super(...arguments),this.ingKey="pinching",this.aliasKey="da"}init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();let t=this.state;t._touchIds=[],t.canceled=!1,t.cancel=this.cancel.bind(this),t.turns=0}computeOffset(){let{type:t,movement:e,lastOffset:i}=this.state;"wheel"===t?this.state.offset=ti.add(e,i):this.state.offset=[(1+e[0])*i[0],e[1]+i[1]]}computeMovement(){let{offset:t,lastOffset:e}=this.state;this.state.movement=[t[0]/e[0],t[1]-e[1]]}axisIntent(){let t=this.state,[e,i]=t._movement;if(!t.axis){let r=30*Math.abs(e)-Math.abs(i);r<0?t.axis="angle":r>0&&(t.axis="scale")}}restrictToAxis(t){this.config.lockDirection&&("scale"===this.state.axis?t[1]=0:"angle"===this.state.axis&&(t[0]=0))}cancel(){let t=this.state;!t.canceled&&setTimeout(()=>{t.canceled=!0,t._active=!1,this.compute(),this.emit()},0)}touchStart(t){this.ctrl.setEventIds(t);let e=this.state,i=this.ctrl.touchIds;if(e._active&&e._touchIds.every(t=>i.has(t))||i.size<2)return;this.start(t),e._touchIds=Array.from(i).slice(0,2);let r=tg(t,e._touchIds);r&&this.pinchStart(t,r)}pointerStart(t){if(null!=t.buttons&&t.buttons%2!=1)return;this.ctrl.setEventIds(t),t.target.setPointerCapture(t.pointerId);let e=this.state,i=e._pointerEvents,r=this.ctrl.pointerIds;if(e._active&&Array.from(i.keys()).every(t=>r.has(t)))return;if(i.size<2&&i.set(t.pointerId,t),e._pointerEvents.size<2)return;this.start(t);let s=tu(...Array.from(i.values()));s&&this.pinchStart(t,s)}pinchStart(t,e){this.state.origin=e.origin,this.computeValues([e.distance,e.angle]),this.computeInitial(),this.compute(t),this.emit()}touchMove(t){if(!this.state._active)return;let e=tg(t,this.state._touchIds);e&&this.pinchMove(t,e)}pointerMove(t){let e=this.state._pointerEvents;if(e.has(t.pointerId)&&e.set(t.pointerId,t),!this.state._active)return;let i=tu(...Array.from(e.values()));i&&this.pinchMove(t,i)}pinchMove(t,e){let i=this.state,r=i._values[1],s=e.angle-r,n=0;Math.abs(s)>270&&(n+=Math.sign(s)),this.computeValues([e.distance,e.angle-360*n]),i.origin=e.origin,i.turns=n,i._movement=[i._values[0]/i._initial[0]-1,i._values[1]-i._initial[1]],this.compute(t),this.emit()}touchEnd(t){this.ctrl.setEventIds(t),this.state._active&&this.state._touchIds.some(t=>!this.ctrl.touchIds.has(t))&&(this.state._active=!1,this.compute(t),this.emit())}pointerEnd(t){let e=this.state;this.ctrl.setEventIds(t);try{t.target.releasePointerCapture(t.pointerId)}catch{}e._pointerEvents.has(t.pointerId)&&e._pointerEvents.delete(t.pointerId),e._active&&e._pointerEvents.size<2&&(e._active=!1,this.compute(t),this.emit())}gestureStart(t){t.cancelable&&t.preventDefault();let e=this.state;!e._active&&(this.start(t),this.computeValues([t.scale,t.rotation]),e.origin=[t.clientX,t.clientY],this.compute(t),this.emit())}gestureMove(t){if(t.cancelable&&t.preventDefault(),!this.state._active)return;let e=this.state;this.computeValues([t.scale,t.rotation]),e.origin=[t.clientX,t.clientY];let i=e._movement;e._movement=[t.scale-1,t.rotation],e._delta=ti.sub(e._movement,i),this.compute(t),this.emit()}gestureEnd(t){this.state._active&&(this.state._active=!1,this.compute(t),this.emit())}wheel(t){let e=this.config.modifierKey;(!e||(Array.isArray(e)?!!e.find(e=>t[e]):!!t[e]))&&(this.state._active?this.wheelChange(t):this.wheelStart(t),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(t){this.start(t),this.wheelChange(t)}wheelChange(t){!("uv"in t)&&t.cancelable&&t.preventDefault();let e=this.state,i=-ty(t)[1]/100*e.offset[0];Math.abs(i)>.1&&(i=.1*Math.sign(i)),e._delta=[i,0],ti.addTo(e._movement,e._delta),te(e),this.state.origin=[t.clientX,t.clientY],this.compute(t),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(t){let e=this.config.device;e&&(t(e,"start",this[e+"Start"].bind(this)),t(e,"change",this[e+"Move"].bind(this)),t(e,"end",this[e+"End"].bind(this)),t(e,"cancel",this[e+"End"].bind(this)),t("lostPointerCapture","",this[e+"End"].bind(this))),this.config.pinchOnWheel&&t("wheel","",this.wheel.bind(this),{passive:!1})}},tS=class extends tM{constructor(){super(...arguments),this.ingKey="moving"}move(t){(!this.config.mouseOnly||"mouse"===t.pointerType)&&(this.state._active?this.moveChange(t):this.moveStart(t),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(t){this.start(t),this.computeValues(tf(t)),this.compute(t),this.computeInitial(),this.emit()}moveChange(t){if(!this.state._active)return;let e=tf(t),i=this.state;i._delta=ti.sub(e,i._values),ti.addTo(i._movement,i._delta),this.computeValues(e),this.compute(t),this.emit()}moveEnd(t){this.state._active&&(this.state._active=!1,this.compute(t),this.emit())}bind(t){t("pointer","change",this.move.bind(this)),t("pointer","leave",this.moveEnd.bind(this))}},tx=class extends tM{constructor(){super(...arguments),this.ingKey="hovering"}enter(t){(!this.config.mouseOnly||"mouse"===t.pointerType)&&(this.start(t),this.computeValues(tf(t)),this.compute(t),this.emit())}leave(t){if(this.config.mouseOnly&&"mouse"!==t.pointerType)return;let e=this.state;if(!e._active)return;e._active=!1;let i=tf(t);e._movement=e._delta=ti.sub(i,e._values),this.computeValues(i),this.compute(t),e.delta=e.movement,this.emit()}bind(t){t("pointer","enter",this.enter.bind(this)),t("pointer","leave",this.leave.bind(this))}},t_=t=>t,tw={enabled:(t=!0)=>t,eventOptions:(t,e,i)=>({...i.shared.eventOptions,...t}),preventDefault:(t=!1)=>t,triggerAllEvents:(t=!1)=>t,rubberband(t=0){switch(t){case!0:return[.15,.15];case!1:return[0,0];default:return ti.toVector(t)}},from:t=>"function"==typeof t?t:null!=t?ti.toVector(t):void 0,transform(t,e,i){let r=t||i.shared.transform;return this.hasCustomTransform=!!r,r||t_},threshold:t=>ti.toVector(t,0)},tI=0,tT={...tw,axis(t,e,{axis:i}){if(this.lockDirection="lock"===i,!this.lockDirection)return i},axisThreshold:(t=tI)=>t,bounds(t={}){if("function"==typeof t)return e=>tT.bounds(t(e));if("current"in t)return()=>t.current;if("function"==typeof HTMLElement&&t instanceof HTMLElement)return t;let{left:e=-1/0,right:i=1/0,top:r=-1/0,bottom:s=1/0}=t;return[[e,i],[r,s]]}},tL={ArrowRight:(t,e=1)=>[t*e,0],ArrowLeft:(t,e=1)=>[-1*t*e,0],ArrowUp:(t,e=1)=>[0,-1*t*e],ArrowDown:(t,e=1)=>[0,t*e]},tO=class extends tM{constructor(){super(...arguments),this.ingKey="dragging"}reset(){super.reset();let t=this.state;t._pointerId=void 0,t._pointerActive=!1,t._keyboardActive=!1,t._preventScroll=!1,t._delayed=!1,t.swipe=[0,0],t.tap=!1,t.canceled=!1,t.cancel=this.cancel.bind(this)}setup(){let t=this.state;if(t._bounds instanceof HTMLElement){let e=t._bounds.getBoundingClientRect(),i=t.currentTarget.getBoundingClientRect(),r={left:e.left-i.left+t.offset[0],right:e.right-i.right+t.offset[0],top:e.top-i.top+t.offset[1],bottom:e.bottom-i.bottom+t.offset[1]};t._bounds=tT.bounds(r)}}cancel(){let t=this.state;!t.canceled&&(t.canceled=!0,t._active=!1,setTimeout(()=>{this.compute(),this.emit()},0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(t){let e=this.config,i=this.state;if(null!=t.buttons&&(Array.isArray(e.pointerButtons)?!e.pointerButtons.includes(t.buttons):-1!==e.pointerButtons&&e.pointerButtons!==t.buttons))return;let r=this.ctrl.setEventIds(t);e.pointerCapture&&t.target.setPointerCapture(t.pointerId),(!r||!(r.size>1)||!i._pointerActive)&&(this.start(t),this.setupPointer(t),i._pointerId=tp(t),i._pointerActive=!0,this.computeValues(tf(t)),this.computeInitial(),e.preventScrollAxis&&"mouse"!==td(t)?(i._active=!1,this.setupScrollPrevention(t)):e.delay>0?(this.setupDelayTrigger(t),e.triggerAllEvents&&(this.compute(t),this.emit())):this.startPointerDrag(t))}startPointerDrag(t){let e=this.state;e._active=!0,e._preventScroll=!0,e._delayed=!1,this.compute(t),this.emit()}pointerMove(t){let e=this.state,i=this.config;if(!e._pointerActive)return;let r=tp(t);if(void 0!==e._pointerId&&r!==e._pointerId)return;let s=tf(t);if(document.pointerLockElement===t.target?e._delta=[t.movementX,t.movementY]:(e._delta=ti.sub(s,e._values),this.computeValues(s)),ti.addTo(e._movement,e._delta),this.compute(t),e._delayed&&e.intentional){this.timeoutStore.remove("dragDelay"),e.active=!1,this.startPointerDrag(t);return}if(i.preventScrollAxis&&!e._preventScroll){if(!e.axis)return;if(e.axis===i.preventScrollAxis||"xy"===i.preventScrollAxis){e._active=!1,this.clean();return}this.timeoutStore.remove("startPointerDrag"),this.startPointerDrag(t);return}this.emit()}pointerUp(t){this.ctrl.setEventIds(t);try{this.config.pointerCapture&&t.target.hasPointerCapture(t.pointerId)&&t.target.releasePointerCapture(t.pointerId)}catch{}let e=this.state,i=this.config;if(!e._active||!e._pointerActive)return;let r=tp(t);if(void 0!==e._pointerId&&r!==e._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(t);let[s,n]=e._distance;if(e.tap=s<=i.tapsThreshold&&n<=i.tapsThreshold,e.tap&&i.filterTaps)e._force=!0;else{let[t,r]=e._delta,[s,n]=e._movement,[o,a]=i.swipe.velocity,[h,l]=i.swipe.distance,d=i.swipe.duration;if(e.elapsedTime<d){let i=Math.abs(t/e.timeDelta),d=Math.abs(r/e.timeDelta);i>o&&Math.abs(s)>h&&(e.swipe[0]=Math.sign(t)),d>a&&Math.abs(n)>l&&(e.swipe[1]=Math.sign(r))}}this.emit()}pointerClick(t){!this.state.tap&&t.detail>0&&(t.preventDefault(),t.stopPropagation())}setupPointer(t){let e=this.config,i=e.device;e.pointerLock&&t.currentTarget.requestPointerLock(),!e.pointerCapture&&(this.eventStore.add(this.sharedConfig.window,i,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(t){this.state._preventScroll&&t.cancelable&&t.preventDefault()}setupScrollPrevention(t){this.state._preventScroll=!1,function(t){"persist"in t&&"function"==typeof t.persist&&t.persist()}(t);let e=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",e),this.eventStore.add(this.sharedConfig.window,"touch","cancel",e),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,t)}setupDelayTrigger(t){this.state._delayed=!0,this.timeoutStore.add("dragDelay",()=>{this.state._step=[0,0],this.startPointerDrag(t)},this.config.delay)}keyDown(t){let e=tL[t.key];if(e){let i=this.state,r=t.shiftKey?10:t.altKey?.1:1;this.start(t),i._delta=e(this.config.keyboardDisplacement,r),i._keyboardActive=!0,ti.addTo(i._movement,i._delta),this.compute(t),this.emit()}}keyUp(t){t.key in tL&&(this.state._keyboardActive=!1,this.setActive(),this.compute(t),this.emit())}bind(t){let e=this.config.device;t(e,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(t(e,"change",this.pointerMove.bind(this)),t(e,"end",this.pointerUp.bind(this)),t(e,"cancel",this.pointerUp.bind(this)),t("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(t("key","down",this.keyDown.bind(this)),t("key","up",this.keyUp.bind(this))),this.config.filterTaps&&t("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}},tA="undefined"!=typeof window&&window.document&&window.document.createElement;function tk(){return tA&&"ontouchstart"in window}var tR={isBrowser:tA,gesture:function(){try{return"constructor"in GestureEvent}catch(t){return!1}}(),touch:tk(),touchscreen:tk()||tA&&window.navigator.maxTouchPoints>1,pointer:tA&&"onpointerdown"in window,pointerLock:tA&&"exitPointerLock"in window.document},tP={...tw,device(t,e,{shared:i,pointer:{touch:r=!1}={}}){if(i.target&&!tR.touch&&tR.gesture)return"gesture";if(tR.touch&&r)return"touch";if(tR.touchscreen){if(tR.pointer)return"pointer";if(tR.touch)return"touch"}},bounds(t,e,{scaleBounds:i={},angleBounds:r={}}){let s=t=>{let e=tE(tm(i,t),{min:-1/0,max:1/0});return[e.min,e.max]},n=t=>{let e=tE(tm(r,t),{min:-1/0,max:1/0});return[e.min,e.max]};return"function"!=typeof i&&"function"!=typeof r?[s(),n()]:t=>[s(t),n(t)]},threshold(t,e,i){return this.lockDirection="lock"===i.axis,ti.toVector(t,this.lockDirection?[.1,3]:0)},modifierKey:t=>void 0===t?"ctrlKey":t,pinchOnWheel:(t=!0)=>t},tj={...tT,mouseOnly:(t=!0)=>t},tz={...tT,mouseOnly:(t=!0)=>t},tV=10,tB={mouse:0,touch:0,pen:8},tF={...tT,device(t,e,{pointer:{touch:i=!1,lock:r=!1,mouse:s=!1}={}}){return(this.pointerLock=r&&tR.pointerLock,tR.touch&&i)?"touch":this.pointerLock?"mouse":tR.pointer&&!s?"pointer":tR.touch?"touch":"mouse"},preventScrollAxis(t,e,{preventScroll:i}){if(this.preventScrollDelay="number"==typeof i?i:i||void 0===i&&t?250:void 0,tR.touchscreen&&!1!==i)return t||(void 0!==i?"y":void 0)},pointerCapture(t,e,{pointer:{capture:i=!0,buttons:r=1,keys:s=!0}={}}){return this.pointerButtons=r,this.keys=s,!this.pointerLock&&"pointer"===this.device&&i},threshold(t,e,{filterTaps:i=!1,tapsThreshold:r=3,axis:s}){let n=ti.toVector(t,i?r:s?1:0);return this.filterTaps=i,this.tapsThreshold=r,n},swipe({velocity:t=.5,distance:e=50,duration:i=250}={}){return{velocity:this.transform(ti.toVector(t)),distance:this.transform(ti.toVector(e)),duration:i}},delay(t=0){switch(t){case!0:return 180;case!1:return 0;default:return t}},axisThreshold:t=>t?{...tB,...t}:tB,keyboardDisplacement:(t=tV)=>t},tY=new Map,tU=new Map;function tG(t){tY.set(t.key,t.engine),tU.set(t.key,t.resolver)}var tQ={key:"drag",engine:tO,resolver:tF},tX={key:"hover",engine:tx,resolver:tz},tW={key:"move",engine:tS,resolver:tj},t$={key:"pinch",engine:tN,resolver:tP},tJ={key:"scroll",engine:tb,resolver:tT},tH={key:"wheel",engine:tC,resolver:tT},tK=class{constructor(){this._timeouts=new Map}add(t,e,i=140,...r){this.remove(t),this._timeouts.set(t,window.setTimeout(e,i,...r))}remove(t){let e=this._timeouts.get(t);e&&window.clearTimeout(e)}clean(){this._timeouts.forEach(t=>void window.clearTimeout(t)),this._timeouts.clear()}},tZ=class{constructor(t,e){this._listeners=new Set,this._ctrl=t,this._gestureKey=e}add(t,e,i,r,s){let n=this._listeners,o=function(t,e=""){let i=tn[t];return t+(i&&i[e]||e)}(e,i),a={...this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{},...s};t.addEventListener(o,r,a);let h=()=>{t.removeEventListener(o,r,a),n.delete(h)};return n.add(h),h}clean(){this._listeners.forEach(t=>t()),this._listeners.clear()}},tq={target(t){if(t)return()=>"current"in t?t.current:t},enabled:(t=!0)=>t,window:(t=tR.isBrowser?window:void 0)=>t,eventOptions:({passive:t=!0,capture:e=!1}={})=>({passive:t,capture:e}),transform:t=>t};function t0(t={},e){let i={};for(let[r,s]of Object.entries(e))switch(typeof s){case"function":i[r]=s.call(i,t[r],r,t);break;case"object":i[r]=t0(t[r],s);break;case"boolean":s&&(i[r]=t[r])}return i}var t1=class{constructor(t){this.gestures=new Set,this._targetEventStore=new tZ(this),this.gestureEventStores={},this.gestureTimeoutStores={},this.handlers={},this.config={},this.pointerIds=new Set,this.touchIds=new Set,this.state={shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}},function(t,e){e.drag&&t2(t,"drag"),e.wheel&&t2(t,"wheel"),e.scroll&&t2(t,"scroll"),e.move&&t2(t,"move"),e.pinch&&t2(t,"pinch"),e.hover&&t2(t,"hover")}(this,t)}setEventIds(t){if(tl(t)){var e;return this.touchIds=new Set(Array.from((e=t).touches).filter(t=>t.target===e.currentTarget||e.currentTarget?.contains?.(t.target)).map(t=>t.identifier)),this.touchIds}if("pointerId"in t)return"pointerup"===t.type||"pointercancel"===t.type?this.pointerIds.delete(t.pointerId):"pointerdown"===t.type&&this.pointerIds.add(t.pointerId),this.pointerIds}applyHandlers(t,e){this.handlers=t,this.nativeHandlers=e}applyConfig(t,e){this.config=function(t,e,i={}){let{target:r,eventOptions:s,window:n,enabled:o,transform:a,...h}=t;if(i.shared=t0({target:r,eventOptions:s,window:n,enabled:o,transform:a},tq),e){let t=tU.get(e);i[e]=t0({shared:i.shared,...h},t)}else for(let t in h){let e=tU.get(t);e&&(i[t]=t0({shared:i.shared,...h[t]},e))}return i}(t,e,this.config)}clean(){for(let t of(this._targetEventStore.clean(),this.gestures))this.gestureEventStores[t].clean(),this.gestureTimeoutStores[t].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...t){let e;let i=this.config.shared,r={};if(!i.target||!!(e=i.target())){if(i.enabled){for(let i of this.gestures){let s=this.config[i],n=t4(r,s.eventOptions,!!e);s.enabled&&new(tY.get(i))(this,t,i).bind(n)}let s=t4(r,i.eventOptions,!!e);for(let e in this.nativeHandlers)s(e,"",i=>this.nativeHandlers[e]({...this.state.shared,event:i,args:t}),void 0,!0)}for(let t in r)r[t]=function(...t){return 0===t.length?tv:1===t.length?t[0]:function(){let e;for(let i of t)e=i.apply(this,arguments)||e;return e}}(...r[t]);if(!e)return r;for(let t in r){let{device:i,capture:s,passive:n}=function(t){let e=t.substring(2).toLowerCase(),i=!!~e.indexOf("passive");i&&(e=e.replace("passive",""));let r=th.includes(e)?"capturecapture":"capture",s=!!~e.indexOf(r);return s&&(e=e.replace("capture","")),{device:e,capture:s,passive:i}}(t);this._targetEventStore.add(e,i,"",r[t],{capture:s,passive:n})}}}};function t2(t,e){t.gestures.add(e),t.gestureEventStores[e]=new tZ(t,e),t.gestureTimeoutStores[e]=new tK}var t4=(t,e,i)=>(r,s,n,o={},a=!1)=>{let h=o.capture??e.capture,l=o.passive??e.passive,d=a?r:function(t,e="",i=!1){let r=tn[t],s=r&&r[e]||e;return"on"+to(t)+to(s)+(!function(t=!1,e){return t&&!ta.includes(e)}(i,s)?"":"Capture")}(r,s,h);i&&l&&(d+="Passive"),t[d]=t[d]||[],t[d].push(n)},t3=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function t5(t,e,i,r,s,n){if(!t.has(i)||!tY.has(r))return;let o=i+"Start",a=i+"End";s[r]=t=>{let r;return t.first&&o in e&&e[o](t),i in e&&(r=e[i](t)),t.last&&a in e&&e[a](t),r},n[r]=n[r]||{}}var t6=class{constructor(t,e,i,r,s){this._target=t,this._gestureKey=r,this._ctrl=new t1(e),this._ctrl.applyHandlers(e,s),this._ctrl.applyConfig({...i,target:t},r),this._ctrl.effect()}destroy(){this._ctrl.clean()}setConfig(t){this._ctrl.clean(),this._ctrl.applyConfig({...t,target:this._target},this._gestureKey),this._ctrl.effect()}},t8=function(t,e,i){return([tQ,t$,tJ,tH,tW,tX].forEach(tG),function(t,e,i){let{handlers:r,nativeHandlers:s,config:n}=function(t,e){let[i,r,s]=function(t){let e={},i={},r=new Set;for(let s in t)t3.test(s)?(r.add(RegExp.lastMatch),i[s]=t[s]):e[s]=t[s];return[i,e,r]}(t),n={};return t5(s,i,"onDrag","drag",n,e),t5(s,i,"onWheel","wheel",n,e),t5(s,i,"onScroll","scroll",n,e),t5(s,i,"onPinch","pinch",n,e),t5(s,i,"onMove","move",n,e),t5(s,i,"onHover","hover",n,e),{handlers:n,config:e,nativeHandlers:r}}(e,i||{});return new t6(t,r,n,void 0,s)})(t,e,i||{})},t9=class extends m.Pq{constructor(t,e){super(),this.target=t,this.config=e,this._pinching=!1,this.preventDefault();let i=new t8(t,{onPinch:({origin:[t,e],first:i,last:r,movement:[s],offset:[n,o]})=>{this.handlePinch({first:i,last:r,originX:t,originY:e,newScale:n})}},{pinch:{scaleBounds:()=>this.getScaleBounds(),from:()=>[this.config.finalScale,0],modifierKey:["metaKey","ctrlKey"]}});this.toDispose.push(m.JT.create(()=>{i.destroy()}))}handlePinch(t){let{first:e,last:i,originX:r,originY:s,newScale:n}=t;if(Number.isNaN(t.newScale))return;e&&(this._pinching=!0),i&&(this._pinching=!1);let o=this.config.finalScale,a=this.config.getPosFromMouseEvent({clientX:r,clientY:s},!1),h={x:a.x/o*n,y:a.y/o*n};this.config.updateConfig({scrollX:this.config.config.scrollX+h.x-a.x,scrollY:this.config.config.scrollY+h.y-a.y,zoom:n})}getScaleBounds(){return{min:this.config.config.minZoom,max:this.config.config.maxZoom}}preventDefault(){let t=t=>t.preventDefault();document.addEventListener("gesturestart",t),document.addEventListener("gesturechange",t),this.toDispose.push(m.JT.create(()=>{document.removeEventListener("gesturestart",t),document.removeEventListener("gesturechange",t)}))}get pinching(){return this._pinching}},t7=t=>function(e,i){let r=`${i}Provider`;return(0,D.f3)(t)(e,r),(0,D.jt)()(e,r),{get(){return this[r]?.()},configurable:!0,enumerable:!0}},et=Symbol("LazyInjectContext");Symbol("IS_LAZY_INJECT_CONTEXT_INJECTED");var ee=Symbol("PlaygroundContext"),ei=Symbol("PlaygroundContextProvider"),er=()=>t7(ei),es=t=>{t(ei).toDynamicValue(t=>()=>{if(t.container.isBound(ee))return t.container.get(ee)})},en=Symbol("PlaygroundContainerFactory"),eo=Symbol("EntityManagerContribution"),ea=class extends V{constructor(t){super(t),this.isInitialized=!0,this.ConfigDataRegistry=function(t){class e extends B{getDefaultData(){return t.getDefaultConfig()}checkChanged(e){return t.checkChanged(this.data,e)}toJSON(){return super.toJSON()}}return Object.defineProperty(e,"type",{value:`_${t.type}DataMixin`}),e}(this),this.addData(this.ConfigDataRegistry),this.isInitialized=!1}getDefaultConfig(){return{}}checkChanged(t,e){return V.checkDataChanged(t,e)}get config(){return this.getData(this.ConfigDataRegistry).data}updateConfig(t){this.updateData(this.ConfigDataRegistry,t)}onConfigChanged(t){return this.getData(this.ConfigDataRegistry).onDataChange(e=>t(e.data))}};ea.type="ConfigEntity";var eh=class{constructor(){this.toDispose=new m.K4,this.onEntityChangeEmitter=new m.Q5,this.onEntityLifeCycleEmitter=new m.Q5,this.onEntityDataChangeEmitter=new m.Q5,this.registryMap=new Map,this.dataRegistryMap=new Map,this.dataInjectorMap=new Map,this.entityInstanceMap=new Map,this.entityVersionMap=new Map,this.entityDataVersionMap=new Map,this.entityInstanceMapByType=new Map,this.configEntities=new Map,this.onEntityChange=this.onEntityChangeEmitter.event,this.onEntityDataChange=this.onEntityDataChangeEmitter.event,this.onEntityLifeCycleChange=this.onEntityLifeCycleEmitter.event,this.changeEntityLocked=!1,this.schedule=new J,this.fireEntityChanged=t=>{let e="string"==typeof t?t:t.type,i=this.entityVersionMap.get(e)||0;i===Number.MAX_SAFE_INTEGER&&(i=0),this.entityVersionMap.set(e,i+1),!this.changeEntityLocked&&this.schedule.push(e,()=>{this.onEntityChangeEmitter.fire(e)})},this.fireEntityDataChanged=(t,e)=>{let i=this.entityDataVersionMap.get(e)||0;i===Number.MAX_SAFE_INTEGER&&(i=0),this.entityDataVersionMap.set(e,i+1),this.schedule.push(`${t}/${e}`,()=>{this.onEntityDataChangeEmitter.fire({entityType:t,entityDataType:e})})},this.fireEntityLifeCycleChanged=({type:t,entity:e})=>{this.schedule.push(`${t}/${e.id}`,()=>{this.onEntityLifeCycleEmitter.fire({type:t,entity:e})})},this.toDispose.pushAll([this.onEntityChangeEmitter,this.schedule])}init(){this.contributions.forEach(t=>t.registerEntityManager?.(this))}createEntity(t,e){if(!t.type)throw Error(`[EntityManager] createEntity need a type: ${t}`);if(this.configEntities.has(t.type))return this.configEntities.get(t.type);let i={entityManager:this,savedInManager:!0,...e},r=new t(i);return i.savedInManager&&this.saveEntity(r),r}isConfigEntity(t){return this.configEntities.has(t)}removeEntities(t){for(let e of this.getEntities(t).values())e.dispose()}removeEntityById(t){let e=this.getEntityById(t);return!!e&&(e.dispose(),!0)}resetEntities(t){this.getEntities(t).forEach(t=>{t.reset()})}resetEntity(t,e){let i=this.getEntity(t,e);i?.reset()}updateConfigEntity(t,e){let i=this.configEntities.get(t.type);i&&i.updateConfig(e)}getRegistryByType(t){return this.registryMap.get(t)}registerEntity(t){if(!t.type)throw Error(`Registry entity need a type: ${t.name}`);let e=this.registryMap.get(t.type);if(e){if(e!==t)throw Error(`Entity registry ${t.type} need a new type`);return}this.registryMap.set(t.type,t)}registerEntityData(t,e){if(!t.type)throw Error(`Registry entity data need a type: ${t.name}`);!this.dataRegistryMap.get(t.type)&&this.dataRegistryMap.set(t.type,t),!this.dataInjectorMap.get(t.type)&&e&&this.dataInjectorMap.set(t.type,e)}getDataRegistryByType(t){return this.dataRegistryMap.get(t)}getEntityById(t){return this.entityInstanceMap.get(t)}getEntity(t,e){let i=this.getEntities(t)[0];return!i&&e?this.createEntity(t):i}getEntities(t){return this.entityInstanceMapByType.get(t.type)||[]}getEntityDatas(t,e){return this.getEntities(t).map(t=>t.getData(e)).filter(t=>!!t)}hasEntity(t){return!!this.getEntity(t)}storeState({configOnly:t=!0}={}){let e=[];for(let i of this.entityInstanceMap.values())if((!t||i instanceof ea)&&i.toJSON&&i.toJSON){let t=i.toJSON();t&&e.push(t)}return e}restoreState(t){t&&Array.isArray(t)&&t.forEach(t=>{if(!t||!t.type||!t.id)return;let e=this.getRegistryByType(t.type);if(!e){console.warn(`Playground entity registry lost: ${t.type}`);return}let i=this.createEntity(e,{id:t.id});i.fromJSON&&i.fromJSON(t)})}saveEntity(t){let{id:e}=t;if(e&&this.entityInstanceMap.has(e)){console.error(`Entity ${t.type} ${e} is created before`);return}this.entityInstanceMap.set(t.id,t);let i=this.entityInstanceMapByType.get(t.type);!i&&(i=[],this.entityInstanceMapByType.set(t.type,i)),t instanceof ea&&this.configEntities.set(t.type,t),i.push(t),t.onEntityChange(t=>{this.fireEntityChanged(t),this.fireEntityLifeCycleChanged({type:"update",entity:t})}),t.onDataChange(e=>{this.fireEntityDataChanged(t.type,e.data.type)}),t.toDispose.push(m.JT.create(()=>{this.removeEntity(t),this.fireEntityLifeCycleChanged({type:"delete",entity:t})})),t.getDefaultDataRegistries().forEach(e=>this.fireEntityDataChanged(t.type,e.type)),this.fireEntityChanged(t),this.fireEntityLifeCycleChanged({type:"add",entity:t})}removeEntity(t){if(this.entityInstanceMap.has(t.id)&&this.entityInstanceMapByType.has(t.type)){let e=this.entityInstanceMapByType.get(t.type);-1!==e.indexOf(t)&&(this.entityInstanceMapByType.set(t.type,e.filter(e=>e!==t)),this.entityInstanceMap.delete(t.id),this.configEntities.has(t.type)&&this.configEntities.delete(t.type),this.fireEntityChanged(t))}}reset(){for(let t of this.entityInstanceMap.values())t.reset()}getEntityVersion(t){return this.entityVersionMap.get("string"==typeof t?t:t.type)||0}getEntityDataVersion(t){return this.entityDataVersionMap.get("string"==typeof t?t:t.type)||0}dispose(){this.toDispose.dispose()}getDataInjector(t){return this.dataInjectorMap.get("string"==typeof t?t:t.type)}getService(t){return this.containerFactory?.get(t)}};R([(0,D.nx)(eo),(0,D.jt)()],eh.prototype,"contributions",2),R([er()],eh.prototype,"context",2),R([(0,D.f3)(en),(0,D.jt)()],eh.prototype,"containerFactory",2),R([(0,D.zY)()],eh.prototype,"init",1),eh=R([(0,D.b2)()],eh);var el=Symbol("EntitiesDecorator"),ed=Symbol("EntitiesByDataDecorator"),ec=Symbol("PropertiesInjected");function eu(t,e){return Reflect.getMetadata(e,t.prototype)||[]}function eg(t){return Reflect.getMetadata(ec,t)||[]}function ep(t,e,i,r){return(s,n)=>{let o=Reflect.getMetadata(t,s);if(!o&&Reflect.defineMetadata(t,o=[],s),!Array.isArray(e)&&(e=[e]),e.forEach(t=>{!o.includes(t)&&o.push(t)}),r&&r(s,n),n&&i)return!function(t,e){let i=eg(t);i.push(e),Reflect.defineMetadata(ec,i,t)}(s,n),{enumerable:!1,configurable:!1,get(){return i(this,n)}}}}function ef(t){return ep(el,t,e=>e.observeManager.get(t))}function ey(t){return ep(el,t,e=>e.observeManager.getEntities(t))}function em(t,e){return ep(ed,{entity:t,data:e},i=>i.observeManager.getEntityDatas(t,e))}var ev=Symbol("ProtectWheelArea");var eE=((l=eE||{})[l.BASE_LAYER=-2]="BASE_LAYER",l[l.TOOL_LAYER=-1]="TOOL_LAYER",l[l.NORMAL_LAYER=0]="NORMAL_LAYER",l),eD=Symbol("PipelineLayerFactory"),eM=class{constructor(){this.onSelectionChangedEmitter=new m.Q5,this.onSelectionChanged=this.onSelectionChangedEmitter.event,this.currentSelection=[]}get selection(){return this.currentSelection}isEmpty(){return 0===this.currentSelection.length}set selection(t){m.XJ.isArrayShallowChanged(this.currentSelection,t)&&(this.currentSelection=t,this.onSelectionChangedEmitter.fire(this.currentSelection))}dispose(){this.onSelectionChangedEmitter.dispose()}};eM=R([(0,D.b2)()],eM);var eC=Symbol("StorageService"),eb=class{constructor(){this._prefix="__gedit:"}setData(t,e){this.storage[this.prefix(t)]=JSON.stringify(e)}getData(t,e){let i=this.storage[this.prefix(t)];return void 0===i?e:JSON.parse(i)}prefix(t){return`${this._prefix}${t}`}setPrefix(t){this._prefix=t}init(){"undefined"!=typeof window&&window.localStorage?this.storage=window.localStorage:this.storage={}}};R([(0,D.zY)()],eb.prototype,"init",1),eb=R([(0,D.b2)()],eb);var eN=Symbol("ClipboardService"),eS=class{constructor(){this.onClipboardChangedEmitter=new m.Q5,this.onClipboardChanged=this.onClipboardChangedEmitter.event}readText(){return this._currentData}writeText(t){this._currentData!==t&&(this._currentData=t,this.onClipboardChangedEmitter.fire(t))}};eS=R([(0,D.b2)()],eS);var ex=class{get rightPanelVisible(){return this.isRightPanelVisible}set rightPanelVisible(t){this.isRightPanelVisible=t}};ex=R([(0,D.b2)()],ex);var e_=class{constructor(){this.onLoggerEmitter=new m.Q5,this.onLogger=this.onLoggerEmitter.event}onAllLayersRendered(){this.onLoggerEmitter.fire({event:0})}onFlushRequest(t){if(!(t<=0))this.onLoggerEmitter.fire({event:1,props:{rfi:t,fps:1e3/t}})}dispose(){this.onLoggerEmitter.dispose()}};function ew({originRenderer:t,renderedCb:e}){return(0,b.useEffect)(()=>{e()},[]),t()||null}e_=R([(0,D.b2)()],e_);var eI=class{constructor(){this.layerEntitiesSelectorMap=new WeakMap,this.entityLayerMap=new Map,this.ableLayerMap=new Map}subscribeEntities(t,e){let i=this.getSelector(t);e.forEach(e=>{!i.entities.includes(e)&&i.entities.push(e);let r=this.entityLayerMap.get(e.type);!r&&(r=new Set,this.entityLayerMap.set(e.type,r)),r.add(t)})}subscribleEntityByData(t,e,i){let r=this.getSelector(t),s=this.entityLayerMap.get(e.type);!s&&(s=new Set,this.entityLayerMap.set(e.type,s)),s.add(t);let n=[e,i];!r.datas.find(t=>t[0]===e&&t[1]===i)&&r.datas.push(n)}getSelector(t){let e=this.layerEntitiesSelectorMap.get(t);return!e&&(e={entities:[],datas:[]},this.layerEntitiesSelectorMap.set(t,e)),e}getLayerEntities(t){let e=this.layerEntitiesSelectorMap.get(t);if(!e)return{entities:[],changed:!1};let i=new Set,r=new Map,s=!1;e.entities.forEach(t=>{let e=this.entityManager.getEntities(t),s=this.entityManager.getEntityVersion(t);for(let n of(r.set(t.type,s),e))i.add(n)});let n=[];for(let t of i.values())n.push(t);return eT(r,e.lastEntityVersion)&&(e.lastEntityVersion=r,s=!0),{entities:n,changed:s}}getLayerEntityDatas(t){let e=this.layerEntitiesSelectorMap.get(t);if(!e)return{datas:[],changed:!1};let i=[],r=new Map,s=!1;return e.datas.forEach(t=>{let[e,s]=t,n=this.entityManager.getEntityDatas(e,s),o=this.entityManager.getEntityDataVersion(s);for(let t of(r.set(s.type,o),n))i.push(t)}),eT(r,e.lastDataVersion)&&(e.lastDataVersion=r,s=!0),{datas:i,changed:s}}getLayerData(t){let e=this.getLayerEntities(t),i=this.getLayerEntityDatas(t);return{observeEntities:e.entities,observeDatas:i.datas,changed:i.changed||e.changed}}};function eT(t=new Map,e=new Map){if(t.size!==e.size)return!0;for(let i of t.keys())if(t.get(i)!==e.get(i))return!0;return!1}R([(0,D.f3)(eh)],eI.prototype,"entityManager",2),eI=R([(0,D.b2)()],eI);var eL=0,eO=class extends N.ConflatableMessage{constructor(t){super(`flush-layer-request_layer${eL++}`),this.layer=t}},eA=class{constructor(t,e){this.selector=t,this.isReady=!1,this.onAllLayersRenderedEmitter=new m.Q5,this.toDispose=new m.K4,this.layers=[],this.forceUpdates=new Set,this.layerAutorunMap=new Map,this.layerRenderedMap=new Map,this.layerFlushMessages=new Map,this.reactPortals=[],this.node=m.xF.createDivWithClass("gedit-playground-pipeline"),this.onAllLayersRendered=this.onAllLayersRenderedEmitter.event,this.toDispose.push(e.onEntityChange(t=>{let e=this.selector.entityLayerMap.get(t);e&&e.forEach(t=>this.updateLayer(t))})),this.toDispose.push(this.onAllLayersRenderedEmitter)}reportLayerRendered(t){this.layerRenderedMap.set(t,!0),Array.from(this.layerRenderedMap.values()).every(t=>t)&&(this.loggerService.onAllLayersRendered(),this.onAllLayersRenderedEmitter.fire(),window.REPORT_TTI_FOR_E2E&&window.REPORT_TTI_FOR_E2E(performance.now(),performance.getEntriesByType("resource")))}addLayer(t){if(this.layers.push(t),this.toDispose.push(t),this.layerFlushMessages.set(t,new eO(t)),t.pipelineNode=this.node,t.playgroundNode=this.node.parentElement,(t.autorun||t.render)&&!t.node&&(t.node=document.createElement("div")),t.node&&(this.node.appendChild(t.node),t.node.classList.add("gedit-playground-layer")),t.autorun){let e=t.autorun.bind(t);this.layerAutorunMap.set(t,e),t.autorun=()=>{this.updateLayer(t,!0)}}else if(t.render){this.layerRenderedMap.set(t,!1);let e=t.render.bind(t),i=function(t,e,i,r){let s=m.dG;function n(){let n;let[,o]=(0,b.useState)({}),a=(0,b.useCallback)(()=>{i(t)},[t]);(0,b.useEffect)(()=>(s=()=>o({}),()=>{s=m.dG}));try{n=r.isReady?b.createElement(ew,{originRenderer:e,renderedCb:a}):b.createElement(b.Fragment,null)}catch(e){console.error(`Render Layer "${t.constructor.name}" error `,e),n=b.createElement(b.Fragment,null)}return S.createPortal(n,t.node)}return{autorun:()=>s(),portal:t.renderWithReactMemo?b.memo(n):n}}(t,e,this.reportLayerRendered.bind(this),this);this.reactPortals.push(i.portal),this.layerAutorunMap.set(t,i.autorun);t.render=()=>{this.updateLayer(t,!0)}}}flush(t){this.layers.forEach(e=>{this.updateLayer(e,t)})}ready(){this.layers.forEach(t=>{this.loadLayerEntities(t),t.onReady&&t.onReady()}),this.isReady=!0,this.flush(!0)}dispose(){this.toDispose.dispose(),this.node.remove()}processMessage(t){t instanceof eO&&this.onFlushRequest(t.layer)}loadLayerEntities(t){let e=this.selector.getLayerData(t);return e.changed&&t.observeManager.load(e.observeEntities,e.observeDatas),e.changed}onFlushRequest(t){if(!this.isReady||this.toDispose.disposed)return!1;let e=performance.now(),i=()=>{let t=performance.now()-e;if(!(t<4))this.loggerService.onFlushRequest(t)},r=this.layerAutorunMap.get(t),s=this.loadLayerEntities(t);if(r&&(s||this.forceUpdates.has(t))){this.forceUpdates.delete(t);try{r()}catch(t){console.error(t)}return i(),!0}return i(),!1}updateLayer(t,e){e&&this.forceUpdates.add(t);N.MessageLoop.postMessage(this,this.layerFlushMessages.get(t))}toReactComponent(){if(this.reactComp)return this.reactComp;let t=this.reactPortals,e=()=>b.createElement(b.Fragment,null,t.map((t,e)=>b.createElement(t,{key:e})));return this.reactComp=e,e}};R([(0,D.f3)(e_)],eA.prototype,"loggerService",2),eA=R([(0,D.b2)(),P(0,(0,D.f3)(eI)),P(1,(0,D.f3)(eh))],eA),(d=f||(f={})).STATE_SELECT={id:"STATE_SELECT",cursor:"",shortcut:"",cancelMode:"hold"},d.STATE_MOUSE_FRIENDLY_SELECT={id:"STATE_MOUSE_FRIENDLY_SELECT",cursor:"grab",shortcut:"",cancelMode:"hold"},d.STATE_GRAB={id:"STATE_GRAB",cursor:"grab",shortcut:"SPACE",shortcutAutoEsc:!0,shortcutWorksOnlyOnStateChanged:!0,cancelMode:"hold"};var ek=[f.STATE_SELECT,f.STATE_MOUSE_FRIENDLY_SELECT,f.STATE_GRAB],eR=class extends ea{constructor(t){super(t),this._isPressingSpaceBar=!1,this._isPressingShift=!1,this.states=ek.slice(),this.selected=f.STATE_SELECT.id,this.onStateChangeEmitter=new m.Q5,this.onStateChange=this.onStateChangeEmitter.event,this.toDispose.push(this.onStateChangeEmitter)}get isPressingSpaceBar(){return this._isPressingSpaceBar}set isPressingSpaceBar(t){this._isPressingSpaceBar=t}get isPressingShift(){return this._isPressingShift}set isPressingShift(t){this._isPressingShift=t}onCancel(t,e){return this.onStateChange(i=>{i.lastState&&i.lastState.id===t&&e()})}getCurrentState(){return this.states.find(t=>t.id===this.selected)}is(t){return this.selected===t}changeState(t,e){let i=this.states.find(e=>e.id===t);if(!i)throw Error(`Unknown editor state ${t}`);if(this.selected!==t){let r=this.getCurrentState();this.selected=t,this.onStateChangeEmitter.fire({state:i,event:e,lastState:r}),this.fireChange()}}toDefaultState(){this.changeState(f.STATE_SELECT.id)}registerState(t){this.states.push(t),this.fireChange()}getStates(){return this.states}isMouseFriendlyMode(){return this.getCurrentState()===f.STATE_MOUSE_FRIENDLY_SELECT}getStateFromShortcut(t){return this.states.find(e=>{if(("SPACE"===e.shortcut?" ":(e.shortcut||"").toLowerCase())===t.key.toLowerCase())return e})}};eR.type="EditorStateConfigEntity";var eP=0,ej=class extends ea{constructor(t){super(t),this._loading=!1,this._zoomEnable=!0,this._onReadonlyOrDisabledChangeEmitter=new m.Q5,this._onGrabDisableChangeEmitter=new m.Q5,this.onGrabDisableChange=this._onGrabDisableChangeEmitter.event,this.onReadonlyOrDisabledChange=this._onReadonlyOrDisabledChangeEmitter.event,this.cursor="default",this.toDispose.push(this._onReadonlyOrDisabledChangeEmitter)}get grabDisable(){return this.config.grabDisable}set grabDisable(t){this.updateConfig({grabDisable:t})}getDefaultConfig(){return{scrollX:0,scrollY:0,originX:0,originY:0,width:0,height:0,minZoom:.1,maxZoom:2,zoom:1,clientX:0,clientY:0,reverseScroll:!0,overflowX:"scroll",overflowY:"scroll",disabled:!1,readonly:!1,grabDisable:!1,mouseScrollDelta:.05}}addScrollLimit(t){this._scrollLimitFn=t}updateConfig(t){void 0!==t.zoom&&(t={...t,zoom:this.normalizeZoom(t.zoom)}),!(t={...this.config,...t}).reverseScroll&&(t.scrollX<this.config.originX&&(t.scrollX=this.config.originX),t.scrollY<this.config.originY&&(t.scrollY=this.config.originY)),void 0!==t.scrollLimitX&&t.scrollX<t.scrollLimitX&&(t.scrollX=t.scrollLimitX),void 0!==t.scrollLimitY&&t.scrollY<t.scrollLimitY&&(t.scrollY=t.scrollLimitY),"hidden"===t.overflowX&&(t.scrollX=this.config.originX),"hidden"===t.overflowY&&(t.scrollY=this.config.originY);let{readonly:e,disabled:i,grabDisable:r}=this;super.updateConfig(this._scrollLimitFn?{...t,...this._scrollLimitFn({scrollX:t.scrollX,scrollY:t.scrollY})}:t),(e!==this.readonly||i!==this.disabled)&&this._onReadonlyOrDisabledChangeEmitter.fire({readonly:this.readonly,disabled:this.disabled}),r!==this.grabDisable&&this._onGrabDisableChangeEmitter.fire(this.grabDisable)}get finalScale(){return this.zoomEnable?this.config.zoom:1}get zoom(){return this.zoomEnable?this.config.zoom:1}get scrollData(){return{scrollX:this.config.scrollX,scrollY:this.config.scrollY}}normalizeZoom(t){return this.zoomEnable?(t<this.config.minZoom?t=this.config.minZoom:t>this.config.maxZoom&&(t=this.config.maxZoom),t):1}updateCursor(t){this.cursor!==t&&(this.cursor=t,this.fireChange())}getPosFromMouseEvent(t,e=!0){let{config:i}=this,r=e?this.finalScale:1;return{x:(t.clientX+i.scrollX-i.clientX)/r,y:(t.clientY+i.scrollY-i.clientY)/r}}toFixedPos(t){let{config:e}=this;return{x:t.x-e.scrollX+e.clientX,y:t.y-e.scrollY+e.clientY}}getViewport(t=!0){let{config:e}=this,i=t?this.finalScale:1;return new m.Ae(e.scrollX/i,e.scrollY/i,e.width/i,e.height/i)}isViewportVisible(t,e=0,i=!1){return m.Ae.isViewportVisible(t,this.getViewport(),e,i)}scrollToView(t={}){let e;let{scrollDelta:i,position:r,easing:s=!0,easingDuration:n=300,entities:o}=t,{config:a}=this,h=t.zoom?t.zoom:this.finalScale;if(o&&o.length>0){let t=o.map(t=>{let e=t.getData($);if(e)return e.bounds;let i=t.getData(Y),r=t.getData(Q)||{width:0,height:0};if(i)return new m.Ae(i.x,i.y,r.width,r.height||0)}).filter(t=>!!t);t.length>0&&(e=m.Ae.enlarge(t))}else r?e=new m.Ae(r.x,r.y,0,0):t.bounds&&(e=t.bounds);if(!e){let t=this.getDefaultConfig();e=new m.Ae((t.scrollX+a.width/2)/h,(t.scrollY+a.height/2)/h,0,0)}if(!t.scrollToCenter&&this.getViewport().containsRectangle(e))return Promise.resolve();let l={scrollX:(e.x+e.width/2+(i?i.x:0))*h-a.width/2,scrollY:(e.y+e.height/2+(i?i.y:0))*h-a.height/2,zoom:t.zoom};return this.scroll(l,s,n)}setPageBounds(t){this.updateConfig({pageBounds:{x:t.x,y:t.y,width:t.width,height:t.height}})}getPageBounds(){let{pageBounds:t}=this.config;if(t)return new m.Ae(t.x,t.y,t.width,t.height)}scrollPageBoundsToCenter(t=!0,e=16,i=!0){let r=this.getPageBounds();if(r){let s;let n=2*e;return t&&(s=m.rM.fixSize({width:r.width,height:r.height},{width:n>this.config.width?n:this.config.width-n,height:n>this.config.height?n:this.config.height-n})),this.scrollToView({bounds:r,zoom:s,scrollToCenter:!0,easing:i})}return this.scrollToView({easing:i})}scroll(t,e=!0,i=300){let r=new m.cO;if(this.cancelScrollTeeen&&this.cancelScrollTeeen.dispose(),e){let e={scrollX:this.config.scrollX,scrollY:this.config.scrollY,zoom:this.config.zoom};this.cancelScrollTeeen=tt({from:e,to:{...e,...t},onUpdate:t=>{this.updateConfig(t)},onComplete:()=>{this.cancelScrollTeeen=void 0,r.resolve()},onDispose:()=>{r.resolve()},duration:i})}else this.updateConfig(t),r.resolve();return r.promise}fixLayerPosition(t){m.xF.setStyle(t,{left:this.config.scrollX,top:this.config.scrollY})}get loading(){return this._loading}set loading(t){this.loading!==t&&(this._loading=t,this.fireChange())}get zoomEnable(){return this._zoomEnable}set zoomEnable(t){this._zoomEnable!==t&&(this._zoomEnable=t,this.fireChange())}zoomin(t,e){let i=this.config.zoom/10,r=Math.ceil((this.config.zoom+i)*10)/10;this.updateZoom(r,t,e)}zoomout(t,e){let i=this.config.zoom/10,r=Math.floor((this.config.zoom-i)*10)/10;this.updateZoom(r,t,e)}updateZoom(t,e=!0,i=200){t=this.normalizeZoom(t);let{center:r}=this.getViewport(),s=this.finalScale,n=this.zoomEnable?t:s;if(n!==s){let o={x:r.x*n-r.x*s,y:r.y*n-r.y*s};this.scroll({scrollX:this.config.scrollX+o.x,scrollY:this.config.scrollY+o.y,zoom:t},e,i)}}get disabled(){return this.config.disabled}get readonly(){return this.config.readonly}get readonlyOrDisabled(){return this.config.readonly||this.config.disabled}set readonly(t){this.updateConfig({readonly:t})}set disabled(t){this.updateConfig({disabled:t})}fitView(t,e=!0,i=0){let r=this.getViewport(!1),s=m.rM.fixSize(t.pad(i,i),r);return this.scrollToView({bounds:t,zoom:s,easing:e,scrollToCenter:!0})}};ej.type="PlaygroundConfigEntity";var ez=Symbol("LayerOptions"),eV=class{constructor(){this.toDispose=new m.K4,this.renderWithReactMemo=!0}dispose(){this.toDispose.dispose()}createDOMCache(t,e){if(!this.node)throw Error("DomCache need a parent dom node.");return m.xF.createDOMCache(this.node,t,e)}getPosFromMouseEvent(t,e=!0){let i=this.config.getPosFromMouseEvent(t,e);return{x:i.x,y:i.y}}};R([(0,D.f3)(ez)],eV.prototype,"options",2),R([(0,D.f3)(eh)],eV.prototype,"entityManager",2),R([er()],eV.prototype,"context",2),eV=R([(0,D.b2)()],eV);var eB=class extends eV{constructor(){super(...arguments),this.startGrabScroll={scrollX:0,scrollY:0},this.cursorStyle=document.createElement("style"),this.maskNode=document.createElement("div"),this.grabDragger=new K({onDragStart:t=>{!this.config.grabDisable&&(this.config.updateCursor("grabbing"),this.startGrabScroll={scrollX:this.config.config.scrollX,scrollY:this.config.config.scrollY})},onDrag:t=>{!this.config.grabDisable&&this.config.updateConfig({scrollX:this.startGrabScroll.scrollX-t.endPos.x+t.startPos.x,scrollY:this.startGrabScroll.scrollY-t.endPos.y+t.startPos.y})},onDragEnd:t=>{this.isGrab()&&this.config.updateCursor("grab"),1===t.button&&(this.isMouseMode()?(this.editorStateConfig.changeState(f.STATE_MOUSE_FRIENDLY_SELECT.id),this.config.updateCursor("grab")):(this.editorStateConfig.toDefaultState(),this.config.updateCursor("")))}})}onReady(){if(this.options={preventGlobalGesture:!1,...this.options},this.options.preventGlobalGesture){let t=new t8(document.body,{onPinch:()=>{}});document.documentElement&&(document.documentElement.style.overscrollBehaviorX="none"),document.body.style.overscrollBehaviorX="none",this.toDispose.push(m.JT.create(()=>t.destroy()))}this.toDispose.pushAll([this.config.onGrabDisableChange(t=>{t&&this.grabDragger.stop(0,0)}),m.xF.addStandardDisposableListener(this.playgroundNode,"wheel",t=>{if(!this.getScrollParent(t.target))t.preventDefault(),t.stopPropagation()}),this.listenPlaygroundEvent("wheel",this.handleWheelEvent.bind(this),-2,{passive:!0}),this.listenPlaygroundEvent("mousedown",t=>{let e=1===t.button;e&&!this.isMouseMode()&&this.editorStateConfig.changeState(f.STATE_GRAB.id),this.isGrab()&&(this.editorStateConfig.isPressingSpaceBar||e)&&this.grabDragger.start(t.clientX,t.clientY)},-2),this.listenPlaygroundEvent("mousedown",t=>{let e=this.options?.hoverService?.isSomeHovered();this.isMouseMode()&&!e&&!this.editorStateConfig.isPressingShift&&this.grabDragger.start(t.clientX,t.clientY)},0),this.editorStateConfig.onStateChange(this.onStateChanged.bind(this)),this.listenGlobalEvent("keydown",t=>{t.shiftKey&&(this.editorStateConfig.isPressingShift=!0,this.isMouseMode()&&this.config.updateCursor(""))},-2),this.listenGlobalEvent("keypress",t=>{if(!this.isFocused||t.target!==this.playgroundNode||this.isMouseMode())return;let e=this.editorStateConfig.getStateFromShortcut(t);if(" "===t.key&&(this.editorStateConfig.isPressingSpaceBar=!0),e?.shortcutWorksOnlyOnStateChanged!==!0||e!==this.editorStateConfig.getCurrentState())this.lastShortcutState=e,e&&this.editorStateConfig.changeState(e.id)},-2),this.listenGlobalEvent("keyup",t=>{" "===t.key&&(this.editorStateConfig.isPressingSpaceBar=!1),this.editorStateConfig.isPressingShift=!1,this.lastShortcutState&&this.lastShortcutState.shortcutAutoEsc&&this.editorStateConfig.toDefaultState(),this.lastShortcutState=void 0}),{dispose:()=>{this.maskNode.parentNode&&this.maskNode.parentNode.removeChild(this.maskNode),this.cursorStyle.parentNode&&this.cursorStyle.parentNode.removeChild(this.cursorStyle)}}]),"MOUSE"===this.options.ineractiveType&&this.editorStateConfig.changeState(f.STATE_MOUSE_FRIENDLY_SELECT.id)}getCursor(t){return t?this.playgroundConfigEntity.getCursors?.()?.[t]??t:""}isMouseMode(){return this.editorStateConfig.isMouseFriendlyMode()}onStateChanged(t){let{state:e}=t;if(this.cancelStateListen&&(this.cancelStateListen.dispose(),this.cancelStateListen=void 0),e.handle&&e.handle(this.config,t),e.cursor?(this.playgroundConfigEntity.updateCursor(e.cursor),this.currentGesture&&this.currentGesture.target.parentNode&&(this.currentGesture.target.parentNode.style.cursor=this.getCursor(e.cursor))):(this.playgroundConfigEntity.updateCursor(""),this.currentGesture&&this.currentGesture.target.parentNode&&(this.currentGesture.target.parentNode.style.cursor="")),"grab"===e.cursor||"grabbing"===e.cursor){if(e===f.STATE_MOUSE_FRIENDLY_SELECT)return;this.maskNode.style.cssText=`
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 100;
      `,this.playgroundNode.appendChild(this.maskNode)}else this.maskNode.parentNode&&this.maskNode.parentNode.removeChild(this.maskNode);"esc"===e.cancelMode?this.cancelStateListen=m.xF.addStandardDisposableListener(document.body,"keydown",t=>{("Escape"===t.key||"Enter"===t.key)&&this.editorStateConfig.toDefaultState()},!0):"once"===e.cancelMode&&this.editorStateConfig.toDefaultState()}isGrab(){let t=this.editorStateConfig.getCurrentState();return t===f.STATE_GRAB||t===f.STATE_MOUSE_FRIENDLY_SELECT}createGesture(){!this.currentGesture&&(this.currentGesture=new t9(this.pipelineNode.parentElement,this.config),this.currentGesture.onDispose(()=>{this.currentGesture=void 0}),this.toDispose.push(this.currentGesture))}onResize(t){this.size={...t},this.updateSizeWithRulerConfig()}updateSizeWithRulerConfig(){let{size:t}=this;t&&this.config.updateConfig({width:t.width,height:t.height,clientX:t.clientX,clientY:t.clientY})}handleScrollEvent(t){let{playgroundConfigEntity:e}=this,i=e.config.scrollX+t.deltaX,r=e.config.scrollY+t.deltaY;e.updateConfig({scrollX:i,scrollY:r})}getMouseScaleDelta(){let{mouseScrollDelta:t,zoom:e}=this.config.config;return"function"==typeof t?t(e):t??.05}handleWheelEvent(t){if((!this.currentGesture||!this.currentGesture.pinching)&&!t.ctrlKey&&!t.metaKey){if(!this.getScrollParent(t.target)){if(this.isMouseMode()){let{zoom:e,minZoom:i,maxZoom:r,scrollX:s,scrollY:n}=this.playgroundConfigEntity.config,o=this.getMouseScaleDelta(),a=(Math.abs(t.deltaY)>0?t.deltaY:t.deltaX)>0?-o:o,h=this.config.finalScale,l=t.clientX,d=t.clientY,c=Math.max(i,Math.min(r,e+a)),u=this.config.getPosFromMouseEvent({clientX:l,clientY:d},!1),g={x:u.x/h*c,y:u.y/h*c};this.config.updateConfig({scrollX:s+g.x-u.x,scrollY:n+g.y-u.y,zoom:c});return}this.handleScrollEvent(t)}}}getScrollParent(t){if(!t||t===this.pipelineNode.parentElement)return null;let e=t.scrollWidth>t.clientWidth,i=t.scrollHeight>t.clientHeight,r=window.getComputedStyle(t).overflowX,s=window.getComputedStyle(t).overflowY,n=["auto","scroll","overlay"].includes(r),o=["auto","scroll","overlay"].includes(s);return e&&n||i&&o||this.protectWheelArea?.(t)?t:this.getScrollParent(t.parentElement)}autorun(){let t=this.playgroundConfigEntity.config,{cursor:e}=this.playgroundConfigEntity,i=this.getCursor(e);if(this.config.zoomEnable?this.createGesture():this.currentGesture&&this.currentGesture.dispose(),m.xF.setStyle(this.pipelineNode,{left:-t.scrollX,top:-t.scrollY,width:t.width,height:t.height}),this.pipelineNode.parentElement.style.cursor=i,"grab"===e||"grabbing"===e){let t="";this.playgroundNode.classList.forEach(e=>{t+=`.${e}`}),this.cursorStyle.innerText=`.${t} * { cursor: ${i} }`,!this.cursorStyle.parentNode&&document.head.appendChild(this.cursorStyle)}else this.cursorStyle.parentNode&&this.cursorStyle.parentNode.removeChild(this.cursorStyle)}};R([ef(ej)],eB.prototype,"playgroundConfigEntity",2),R([ef(eR)],eB.prototype,"editorStateConfig",2),R([(0,D.jt)(),(0,D.f3)(ev)],eB.prototype,"protectWheelArea",2),eB=R([(0,D.b2)()],eB);var eF=class{constructor(t){this.entityManager=t,this.observeEntities=[],this.observeDatas=[],this.entitiesTypeCache=new Map,this.entitiesAbleCache=new Map,this.entitiyDataCache=new Map}get size(){return this.observeEntities.length}load(t,e){this.observeEntities=t,this.observeDatas=e,this.entitiesTypeCache.clear(),this.entitiesAbleCache.clear(),this.entitiyDataCache.clear()}get(t,e){let i=this.getEntities(t);return void 0!==e?i.find(t=>t.id===e):i[0]}has(t){return!!this.get(t)}getEntities(t){let e=this.entitiesTypeCache.get(t);return!e&&(e=[],this.observeEntities.forEach(i=>{i.type===t.type&&e.push(i)}),this.entitiesTypeCache.set(t,e)),e.filter(t=>!t.disposed)}getEntityDatas(t,e){let i=`${t.type}:${e.type}`,r=this.entitiyDataCache.get(i);return r?r:(r=this.observeDatas.filter(i=>i.type===e.type&&i.entity.type===t.type),this.entitiyDataCache.set(i,r),r)}updateConfig(t,e){let i=this.get(t);i&&i.updateConfig&&i.updateConfig(e)}getConfig(t){let e=this.get(t);if(e)return e.config}createEntity(t,e){return this.entityManager.createEntity(t,e)}removeEntities(t){this.entityManager.removeEntities(t)}[Symbol.iterator](){let t=0,e=this.observeEntities.length;return{next:()=>{let i=t++;return{value:this.observeEntities[i],done:i===e}}}}},eY=new N.ConflatableMessage("PIPELINE_ZOOM"),eU=new N.ConflatableMessage("PIPELINE_SCROLL"),eG=class{constructor(){this._isFocused=!1,this.toDispose=new m.K4,this.allLayersMap=new Map,this.onResizeEmitter=new m.Q5,this.onFocusEmitter=new m.Q5,this.onBlurEmitter=new m.Q5,this.onZoomEmitter=new m.Q5,this.onScrollEmitter=new m.Q5,this.onFocus=this.onFocusEmitter.event,this.onBlur=this.onBlurEmitter.event,this.onZoom=this.onZoomEmitter.event,this.onScroll=this.onScrollEmitter.event,this.playgroundEvents={},this.globalEvents={},this.onResize=this.onResizeEmitter.event,this.toDispose.pushAll([this.onResizeEmitter,this.onFocusEmitter,this.onZoomEmitter,this.onBlurEmitter,this.onScrollEmitter]),this.onFocusEmitter.event(()=>{this._isFocused=!0}),this.onBlurEmitter.event(()=>{this._isFocused=!1})}_listenEvent(t,e,i,r=0,s){let n=i?this.globalEvents:this.playgroundEvents,o=i?document:this.renderer.node.parentNode,a=n[t];if(!a){let e={handleEvent:t=>{let e=a.handlers;for(let i=0,r=e.length;i<r;i++)if(e[i].handle(t))return}};o.addEventListener(t,e,s),a=n[t]={handlers:[],dispose:()=>{o.removeEventListener(t,e),delete n[t]}}}let{handlers:h}=a,l={handle:e,priority:r};h.unshift(l),h.sort((t,e)=>e.priority-t.priority);let d=m.JT.create(()=>{let t=a.handlers.indexOf(l);-1!==t&&a.handlers.splice(t,1),0===a.handlers.length&&a.dispose()});return this.toDispose.push(d),d}listenPlaygroundEvent(t,e,i,r){return this._listenEvent(t,e,!1,i,r)}listenGlobalEvent(t,e,i,r){return this._listenEvent(t,e,!0,i,r)}registerLayer(t,e){if(this.allLayersMap.has(t))return;let i=this.layerFactory(t,e);this.allLayersMap.set(t,i);let r=eu(t,el),s=eu(t,ed);if(r.forEach(t=>{this.entityManager.registerEntity(t),V.isRegistryOf(t,ea)&&this.entityManager.createEntity(t)}),s.forEach(t=>{this.entityManager.registerEntity(t.entity),this.entityManager.registerEntityData(t.data)}),this.selector.subscribeEntities(i,r),s.forEach(t=>this.selector.subscribleEntityByData(i,t.entity,t.data)),i.observeManager=new eF(this.entityManager),i.reloadEntities=()=>{let t=this.selector.getLayerData(i);return t.changed&&i.observeManager.load(t.observeEntities,t.observeDatas),t.changed},i.listenPlaygroundEvent=this.listenPlaygroundEvent.bind(this),i.listenGlobalEvent=this.listenGlobalEvent.bind(this),i.config=this.configEntity,i.getOtherLayer=this.getLayer.bind(this),Object.defineProperty(i,"isFocused",{get:()=>this._isFocused}),i.onResize&&this.onResize(i.onResize.bind(i)),i.onBlur&&this.onBlurEmitter.event(i.onBlur.bind(i)),i.onFocus&&this.onFocusEmitter.event(i.onFocus.bind(i)),i.onZoom&&this.onZoomEmitter.event(i.onZoom.bind(i)),i.onScroll&&this.onScrollEmitter.event(i.onScroll.bind(i)),i.onViewportChange){let t=i.onViewportChange.bind(i);this.onResize(t),this.onZoomEmitter.event(t),this.onScrollEmitter.event(t)}i.onReadonlyOrDisabledChange&&this.configEntity.onReadonlyOrDisabledChange(i.onReadonlyOrDisabledChange.bind(i)),this.renderer.addLayer(i)}getLayer(t){return this.allLayersMap.get(t)}get configEntity(){return this.entityManager.getEntity(ej,!0)}ready(){let t=this.configEntity,e=t.finalScale,i=t.scrollData;t.onConfigChanged(()=>{let r=t.finalScale,s=t.scrollData;if(r!==e){e=r;N.MessageLoop.postMessage(this,eY)}if(i.scrollX!==s.scrollX||i.scrollY!==s.scrollY){i=s;N.MessageLoop.postMessage(this,eU)}})}processMessage(t){let e=this.configEntity;switch(t.type){case"PIPELINE_SCROLL":this.onScrollEmitter.fire(e.scrollData);break;case"PIPELINE_ZOOM":this.onZoomEmitter.fire(e.finalScale)}}dispose(){this.toDispose.dispose()}};R([(0,D.f3)(eA)],eG.prototype,"renderer",2),R([(0,D.f3)(eI)],eG.prototype,"selector",2),R([(0,D.f3)(eh)],eG.prototype,"entityManager",2),R([er()],eG.prototype,"context",2),R([(0,D.f3)(eD)],eG.prototype,"layerFactory",2),eG=R([(0,D.b2)()],eG);var eQ=b.createContext({}),eX=b.createContext({}),eW=b.createContext({}),e$=b.createContext(void 0),eJ=Symbol("PlaygroundConfig"),eH=Symbol("PlaygroundContribution"),eK=class{config(t){Object.assign(this.playgroundConfig,t)}registerLayer(t){this.pipeline.registerLayer(t)}registerEntity(t){this.entityManager.registerEntity(t)}registerEditorState(t){let e=this.entityManager.getEntity(eR);e?.registerState(t)}};R([(0,D.f3)(eG)],eK.prototype,"pipeline",2),R([(0,D.f3)(eh)],eK.prototype,"entityManager",2),R([(0,D.f3)(eJ)],eK.prototype,"playgroundConfig",2),eK=R([(0,D.b2)()],eK);var eZ=Symbol("PluginContext");Symbol("Plugin");var eq=0;function e0(t){let{contributionKeys:e}=t;eq+=1;let i=`Playground_${eq}`;return r=>{let s=[],n=!1;return{pluginId:i,initPlugin:()=>{if(!n){if(n=!0,t.containerModules&&s.push(...t.containerModules),t.onBind&&s.push(new D.nZ((e,i,s,n)=>{t.onBind({bind:e,unbind:i,isBound:s,rebind:n},r)})),t.onInit||t.onDispose||t.onReady||t.onAllLayersRendered){var e,i;s.push((e=t,i=r,new D.nZ(t=>{t(eH).toDynamicValue(t=>{let r=t.container.get(eZ);return{onInit:()=>{e.onInit?.(r,i)},onReady:()=>{e.onReady?.(r,i)},onDispose:()=>{e.onDispose?.(r,i)},onAllLayersRendered:()=>{e.onAllLayersRendered?.(r,i)}}})})))}}},options:r,contributionKeys:e,containerModules:s}}}var e1=t=>e0(t)(void 0),e2=new Set,e4=new m.Q5,e3=new m.Q5,e5=class{constructor(t,e,i,r,s,n,o,a,h){this.entityManager=t,this.registry=e,this.contextProvider=i,this.pipelineRenderer=r,this.pipelineRegistry=s,this.playgroundConfig=n,this.contributionProvider=o,this.commandService=a,this.selectionService=h,this.toDispose=new m.K4,this._focused=!1,this.playgroundClassName=(0,E.x0)(),this.isReady=!1,this.toDispose.pushAll([this.pipelineRenderer,this.pipelineRegistry,this.entityManager,this.commandService,this.selectionService,m.JT.create(()=>{e2.delete(this),this.node.remove(),e3.fire(this)}),r.onAllLayersRendered(()=>{this.contributions.forEach(t=>t.onAllLayersRendered?.(this))})]);let l=this.entityManager.createEntity(eR);this.entityManager.createEntity(ej),this.node=n.node||document.createElement("div"),this.toDispose.pushAll([m.xF.addStandardDisposableListener(this.node,"scroll",t=>{this.node.scrollTop=0,this.node.scrollLeft=0,t.preventDefault(),t.stopPropagation()})]),this.node.classList.add("gedit-playground");if(this.node.classList.add(this.playgroundClassName),this.node.dataset.testid="sdk.workflow.canvas",n.layers&&n.layers.forEach(t=>this.registry.registerLayer(t)),n.editorStates&&n.editorStates.forEach(t=>l.registerState(t)),void 0!==n.zoomEnable&&(this.zoomEnable=n.zoomEnable),n.entityConfigs)for(let[t,e]of n.entityConfigs){let i=this.entityManager.getEntity(t,!0);i?.updateConfig(e)}this.node.addEventListener("blur",()=>{this.blur()}),this.node.addEventListener("focus",()=>{this.focus()}),this.node.tabIndex=0,this.node.appendChild(this.pipelineRenderer.node),this.onBlur=this.pipelineRegistry.onBlurEmitter.event,this.onFocus=this.pipelineRegistry.onFocusEmitter.event,this.onZoom=this.pipelineRegistry.onZoomEmitter.event,this.onScroll=this.pipelineRegistry.onScrollEmitter.event,e2.add(this)}static getLatest(){let t=e5.getAllInstances();return t[t.length-1]}static getAllInstances(){let t=[];for(let e of e2.values())t.push(e);return t}get context(){return this.contextProvider?.()}get contributions(){return this.contributionProvider.getContributions()}init(){let{contributions:t}=this;for(let e of t)e.registerPlayground&&e.registerPlayground(this.registry);for(let e of t)e.onInit&&e.onInit(this);e4.fire(this)}get pipelineNode(){return this.pipelineRenderer.node}setParent(t){t.appendChild(this.node),this.resize()}get zoomEnable(){return this.config.zoomEnable}set zoomEnable(t){this.config.zoomEnable=t}flush(){this.pipelineRenderer.flush()}ready(){if(this.isReady)return;if(this.isReady=!0,this.playgroundConfig.autoResize){let t=(0,M.debounce)(()=>{!this.disposed&&this.resize()},0);if("undefined"!=typeof ResizeObserver){let e=new ResizeObserver(t);e.observe(this.node),this.toDispose.push(m.JT.create(()=>{e.disconnect()}))}else this.toDispose.push(m.xF.addStandardDisposableListener(window.document.body,"resize",t,{passive:!0}));this.toDispose.push(m.xF.addStandardDisposableListener(window.document,"scroll",t,{passive:!0})),this.resize()}this.pipelineRegistry.ready(),this.pipelineRenderer.ready();let{contributions:t}=this;for(let e of t)e.onReady&&e.onReady(this)}scrollToView(t){return this.entityManager.getEntity(ej).scrollToView(t)}resize(t,e=!0){if(!t){let e=this.node.getBoundingClientRect();t={clientX:e.left,clientY:e.top,width:e.width,height:e.height}}let{width:i,height:r}=this.config.config;if(0===t.width||0===t.height)return;let{scrollX:s,scrollY:n}=this.config.config;e&&i&&Math.round(t.width)!==i&&(s+=(i-t.width)/2),e&&r&&Math.round(t.height)!==r&&(n+=(r-t.height)/2),this.config.updateConfig({...t,scrollX:s,scrollY:n}),this.pipelineRegistry.onResizeEmitter.fire(t)}focus(){!this._focused&&(this._focused=!0,this.pipelineRegistry.onFocusEmitter.fire())}blur(){this._focused&&(this._focused=!1,this.pipelineRegistry.onBlurEmitter.fire())}get focused(){return this._focused}get config(){return this.entityManager.getEntity(ej)}get editorState(){return this.entityManager.getEntity(eR)}getConfigEntity(t){return this.entityManager.getEntity(t,!0)}dispose(){if(this.disposed)return;let{contributions:t}=this;for(let e of t)e.onDispose&&e.onDispose(this);this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}toReactComponent(){return this.pipelineRenderer.toReactComponent()}registerLayer(t,e){this.pipelineRegistry.registerLayer(t,e)}registerLayers(...t){t.forEach(t=>this.pipelineRegistry.registerLayer(t))}getLayer(t){return this.pipelineRegistry.getLayer(t)}get onAllLayersRendered(){return this.pipelineRenderer.onAllLayersRendered}};function e6(t){return{container:t,playground:t.get(e5),get:e=>t.get(e),getAll:e=>t.getAll(e)}}function e8(t,e,i={}){var r;let s=t.createChild();s.bind(e).toSelf().inSingletonScope(),s.bind(ez).toConstantValue(i);let n=s.get(e);return"object"==typeof(r=n)&&eg(r.constructor.prototype).forEach(t=>{r.hasOwnProperty(t)&&void 0===r[t]&&delete r[t]}),n}e5.onInstanceCreate=e4.event,e5.onInstanceDispose=e3.event,e5=R([(0,D.b2)(),P(0,(0,D.f3)(eh)),P(1,(0,D.f3)(eK)),P(2,(0,D.f3)(ei)),P(2,(0,D.jt)()),P(3,(0,D.f3)(eA)),P(4,(0,D.f3)(eG)),P(5,(0,D.f3)(eJ)),P(6,(0,D.f3)(m.Qc)),P(6,(0,D.t6)(eH)),P(6,(0,D.jt)()),P(7,(0,D.f3)(L)),P(8,(0,D.f3)(eM))],e5);var e9=new D.nZ(t=>{t(eh).toSelf().inSingletonScope(),t(eA).toSelf().inSingletonScope(),t(eK).toSelf().inSingletonScope(),t(e5).toSelf().inSingletonScope(),t(eI).toSelf().inSingletonScope(),t(eD).toDynamicValue(t=>(e,i)=>e8(t.container,e,i)).inSingletonScope(),t(eG).toSelf().inSingletonScope(),t(en).toDynamicValue(t=>t.container).inSingletonScope(),t(eJ).toConstantValue({autoFocus:!0,autoResize:!0,zoomEnable:!0,layers:[]}),t(ee).toConstantValue({}),es(t),t(e_).toSelf().inSingletonScope(),t(ex).toSelf().inSingletonScope(),t(eM).toSelf().inSingletonScope(),t(eC).to(eb).inSingletonScope(),t(eN).to(eS).inSingletonScope(),!function(t,e){t(e).toDynamicValue(t=>t.container.get(eh).createEntity(e)).inSingletonScope()}(t,ej),(0,m.yb)(t,eH),t(eZ).toDynamicValue(t=>e6(t.container)).inSingletonScope(),t(et).toService(eZ)});function e7(t,e,i){let r=i||new D.W2({defaultScope:"Singleton"});return e&&(r.parent=e),r.load(e9),!r.isBound(L)&&r.load(O),t&&(r.rebind(eJ).toConstantValue(t),t.context&&r.rebind(ee).toConstantValue(t.context)),r}var it=(0,b.forwardRef)(function(t,e){let{containerModules:i,playgroundContext:r,parentContainer:s,playgroundContainer:n,plugins:o,customPluginContext:a,...h}=t,l=(0,b.useMemo)(()=>{let t;return n?t=n:(t=e7({autoFocus:!0,autoResize:!0,zoomEnable:!0,...h},s),r&&t.rebind(ee).toConstantValue(r),i&&i.forEach(e=>t.load(e))),t},[]),d=(0,b.useMemo)(()=>{let t;let e=l.get(e5);return a?(t=a(l),l.rebind(eZ).toConstantValue(t)):t=l.get(eZ),o&&!function(t,e){let i=new Set;t.reduce((t,e)=>{if(!i.has(e.pluginId)&&(e.initPlugin(),i.add(e.pluginId)),e.containerModules&&e.containerModules.length>0)for(let i of e.containerModules)!t.includes(i)&&t.push(i);return t},[]).forEach(t=>e.load(t)),t.forEach(t=>{if(t.contributionKeys)for(let i of t.contributionKeys)e.bind(i).toConstantValue(t.options)})}(o(t),l),e.init(),e},[]);return(0,b.useImperativeHandle)(e,()=>l.get(eZ),[]),b.createElement(eX.Provider,{value:l},b.createElement(eW.Provider,{value:d},b.createElement(eQ.Provider,{value:r},t.children)))});function ie(){return b.useContext(eW)}function ii(){return b.useContext(eX)}function ir(t=!1){let e=ii().get(eh),i=(0,b.useContext)(e$);if(!i)throw Error('[useEntityFromContext] Unknown entity from "PlaygroundEntityContext"');let r=(0,m.JA)(i.version);return(0,b.useLayoutEffect)(()=>{let e;return t&&(e=i.onEntityChange(()=>r(i.version))),()=>e?.dispose()},[e,r,i,t]),i}function is(...t){let e=(0,m.JA)();(0,b.useLayoutEffect)(()=>{let i=new m.K4;return i.pushAll(t.map(t=>t(()=>e()))),()=>i.dispose()},[t,e])}function io(t){return ii().get(t)}var ia=t=>{let e=ie(),i=io(eJ),r=(0,b.useRef)();(0,b.useEffect)(()=>{if(r.current)return e.setParent(r.current),e.ready(),i.autoFocus&&e.node.focus(),()=>{e.dispose()}},[]);let s=e.toReactComponent();return b.createElement(b.Fragment,null,b.createElement("div",{ref:r,className:`gedit-playground-container${t.className?` ${t.className}`:""}`,style:t.style}),b.createElement(s,null),t.children?S.createPortal(b.createElement(b.Fragment,null,t.children),e.node):null)};(t=>{let e=Symbol("LayerStateProvider");class i{constructor(t,e,i){this.instance=t,this.playground=e,this.container=i,this.hijackMethod(t,"autorun"),this.hijackMethod(t,"render"),this.hijackMethod(t,"onReady"),this.hijackMethod(t,"onResize"),this.hijackMethod(t,"onFocus"),this.hijackMethod(t,"onBlur"),this.hijackMethod(t,"onZoom"),this.hijackMethod(t,"onScroll"),this.hijackMethod(t,"onViewportChange"),this.hijackMethod(t,"onReadonlyOrDisabledChange")}hijackMethod(t,e){"function"==typeof t[e]&&(this[e]=vi.spyOn(t,e))}}function r(t){let r=e7();return r.bind(e).toConstantValue(new WeakMap),r.rebind(eD).toDynamicValue(t=>(s,n)=>{let o=e8(t.container,s,n);return t.container.get(e).set(s,new i(o,r.get(e5),r)),o}),t&&t.forEach(t=>r.load(t)),r}t.LayerTestState=i,t.createContainer=r;function s(t,i){return t.get(e).get(i)}t.createPlayground=function(t){return r(t).get(e5)},t.getLayerTestState=s;t.createLayerTestState=function(t,e,i){let n=r(i),o=n.get(e5);return o.registerLayer(t,e),o.init(),o.ready(),s(n,t)}})(y||(y={}))},215206:function(t,e,i){i.d(e,{C8:function(){return k},D9:function(){return ti},GA:function(){return U},IG:function(){return _},JU:function(){return tt},Lu:function(){return T},Lw:function(){return K},Lz:function(){return j},OT:function(){return b},QU:function(){return tr},Sy:function(){return C},T4:function(){return I},Uy:function(){return ts},VH:function(){return L},VO:function(){return R},Vl:function(){return G},XP:function(){return x},Xr:function(){return Y},Xs:function(){return J},cc:function(){return H},d1:function(){return th},eE:function(){return tn},eG:function(){return V},h3:function(){return $},nx:function(){return w},pQ:function(){return te},y3:function(){return Q},yI:function(){return tl}});var r,s,n,o,a,h,l,d,c,u=i(213153),g=i(177783),p=i(362270),f=i(461932),y=i(433210),m=Object.defineProperty,E=Object.getOwnPropertyDescriptor,D=(t,e,i,r)=>{for(var s=r>1?void 0:r?E(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&m(e,i,s),s},M=(t,e)=>(i,r)=>e(i,r,t);var C=((r=C||{}).START="start",r.DEFAULT="default",r.ROOT="root",r.EMPTY="empty",r.INLINE_BLOCKS="inlineBlocks",r.BLOCK_ICON="blockIcon",r.BLOCK="block",r.BLOCK_ORDER_ICON="blockOrderIcon",r.GROUP="group",r.END="end",r.CONDITION="condition",r.SUB_CANVAS="subCanvas",r);var b=((s=b||{}).DYNAMIC_SPLIT="dynamicSplit",s.STATIC_SPLIT="staticSplit",s),N=["root","inlineBlocks","block"];Symbol("FlowLayout");var S=Symbol("FlowLayoutContribution");var x=((n=x||{}).VERTICAL_FIXED_LAYOUT="vertical-fixed-layout",n.HORIZONTAL_FIXED_LAYOUT="horizontal-fixed-layout",n);(x||(x={})).isVertical=function(t){return"vertical-fixed-layout"===t.name};var _=((o=_||{})[o.STRAIGHT_LINE=0]="STRAIGHT_LINE",o[o.DIVERGE_LINE=1]="DIVERGE_LINE",o[o.MERGE_LINE=2]="MERGE_LINE",o[o.ROUNDED_LINE=3]="ROUNDED_LINE",o[o.CUSTOM_LINE=4]="CUSTOM_LINE",o[o.DRAGGING_LINE=5]="DRAGGING_LINE",o);var w=((a=w||{})[a.ADDER_LABEL=0]="ADDER_LABEL",a[a.TEXT_LABEL=1]="TEXT_LABEL",a[a.COLLAPSE_LABEL=2]="COLLAPSE_LABEL",a[a.COLLAPSE_ADDER_LABEL=3]="COLLAPSE_ADDER_LABEL",a[a.CUSTOM_LABEL=4]="CUSTOM_LABEL",a[a.BRANCH_DRAGGING_LABEL=5]="BRANCH_DRAGGING_LABEL",a),I={NODE_SPACING:"SPACING",ROUNDED_LINE_X_RADIUS:"ROUNDED_LINE_X_RADIUS",ROUNDED_LINE_Y_RADIUS:"ROUNDED_LINE_Y_RADIUS",INLINE_BLOCKS_PADDING_BOTTOM:"INLINE_BLOCKS_PADDING_BOTTOM",COLLAPSED_SPACING:"COLLAPSED_SPACING",HOVER_AREA_WIDTH:"HOVER_AREA_WIDTH"},T={NULL:0,[I.NODE_SPACING]:32,MARGIN_RIGHT:20,INLINE_BLOCK_PADDING_BOTTOM:16,INLINE_BLOCKS_PADDING_TOP:30,[I.INLINE_BLOCKS_PADDING_BOTTOM]:40,MIN_INLINE_BLOCK_SPACING:200,MIN_INLINE_BLOCK_SPACING_HORIZONTAL:80,[I.COLLAPSED_SPACING]:12,[I.ROUNDED_LINE_X_RADIUS]:16,[I.ROUNDED_LINE_Y_RADIUS]:20,[I.HOVER_AREA_WIDTH]:20};var L=((h=L||{}).PRE_BRANCH="pre_branch",h.NORMAL_BRANCH="normal_branch",h),O={width:280,height:60},A=(t,e)=>{let i=N.includes(t);return{isStart:"start"===t,hidden:i,defaultExpanded:e.options.allNodesDefaultExpanded,expandedSize:{width:520,height:300},size:O,origin:e.layout.getDefaultNodeOrigin(),isInlineBlocks:"inlineBlocks"===t,spacing:T.SPACING,inlineSpacingPre:0,inlineSpacingAfter:0,expandable:!0,draggable:!0,selectable:!0,renderKey:"",minInlineBlockSpacing:()=>x.isVertical(e.layout)?T.MIN_INLINE_BLOCK_SPACING:T.MIN_INLINE_BLOCK_SPACING_HORIZONTAL}};(t=>{function e(t,e,i){return{...t,...e,meta:{...t.meta,...e.meta},extend:void 0,type:i}}t.merge=e;t.extend=function(t,i){return i.length?i.reduce((i,r)=>e(i,r,t.type),t):t}})(c||(c={}));var k=((l=k||{}).addFromNode="addFromNode",l.deleteFromNode="deleteFromNode",l.addBlock="addBlock",l.deleteBlock="deleteBlock",l.createGroup="createGroup",l.ungroup="ungroup",l.moveNodes="moveNodes",l.moveBlock="moveBlock",l.moveChildNodes="moveChildNodes",l.addNodes="addNodes",l.deleteNodes="deleteNodes",l.changeNode="changeNode",l.addChildNode="addChildNode",l.deleteChildNode="deleteChildNode",l.addNode="addNode",l.deleteNode="deleteNode",l),R=Symbol("FlowOperationBaseService"),P=class t extends u.RD{constructor(t){super(t),this.onExtInfoChangeEmitter=new g.Q5,this.onExtInfoChange=this.onExtInfoChangeEmitter.event,this.toDispose.push(g.JT.create(()=>{this._node&&this._node.remove()}))}get key(){return this.entity.id}getDefaultData(){let{addable:t,expandable:e,defaultExpanded:i}=this.entity.getNodeMeta();return{addable:t,expandable:e,expanded:i||!1,activated:!1,hovered:!1,dragging:!1}}updateExtInfo(t){if(g.XJ.isChanged(this.data.extInfo,t)){let e=this.data.extInfo;this.update({extInfo:t}),this.onExtInfoChangeEmitter.fire({oldInfo:e,newInfo:t})}}getExtInfo(){return this.data.extInfo}get addable(){return this.data.addable}get expandable(){return this.data.expandable}get draggable(){let{draggable:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this.entity):t}get expanded(){return this.data.expanded}set expanded(t){this.expandable&&this.data.expanded!==t&&(this.data.expanded=t,this.fireChange())}toggleExpand(){this.expanded=!this.expanded}toggleMouseEnter(t=!1){if(this.entity.document.renderState.setNodeHovered(this.entity),t)return;let e=this.entity.getData(V);if(!e.renderState.hidden)this.mouseLeaveTimeout&&(clearTimeout(this.mouseLeaveTimeout),this.mouseLeaveTimeout=void 0),e.renderState.hovered=!0,this.entity.isFirst&&this.entity.parent?.id!=="root"?e.parent.renderState.activated=!0:e.renderState.activated=!0}toggleMouseLeave(t=!1){if(this.entity.document.renderState.setNodeHovered(void 0),t)return;let e=this.entity.getData(V);this.mouseLeaveTimeout=setTimeout(()=>{e.renderState.hovered=!1,this.entity.isFirst&&this.entity.parent?.id!=="root"&&(e.parent.renderState.activated=!1),e.renderState.activated=!1},200)}get hidden(){return this.entity.hidden}set hovered(t){this.data.hovered=t,this.fireChange()}get hovered(){return this.data.hovered}get dragging(){return this.data.dragging}set dragging(t){this.data.dragging!==t&&(this.data.dragging=t,this.fireChange())}set activated(e){if("blockIcon"===this.entity.flowNodeType&&this.entity.parent){this.entity.parent.getData(t).activated=e;return}this.data.activated!==e&&(this.data.activated=e,this.fireChange())}get activated(){let{entity:e}=this;return!!e.parent&&!!e.parent.getData(t).activated||this.data.activated}get lineActivated(){let{activated:e}=this;return!!e&&!!(this.entity.parent?.getData(t)?.activated||this.entity.isInlineBlock||this.entity.next?.getData(t).activated)}get node(){return this._node?this._node:(this._node=g.xF.createDivWithClass("gedit-flow-activity-node"),this._node.dataset.testid="sdk.workflow.canvas.node",this._node.dataset.nodeId=this.entity.id,this._node)}dispose(){super.dispose(),this.onExtInfoChangeEmitter.dispose()}};P.type="FlowNodeRenderData";var j=P,z=class t extends u.RD{constructor(t){super(t),this.localDirty=!0;let{origin:e}=this.entity.getNodeMeta();this.transform=this.entity.addData(u.VO),this.transform.changeLocked=!0,this.transform.update({origin:{...e}}),this.transform.changeLocked=!1,this.renderState=this.entity.addData(j),this.bindChange(this.transform),this.toDispose.push(g.JT.create(()=>{let{next:t,parent:e}=this;t&&(t.localDirty=!0),e&&(e.localDirty=!0)}))}get origin(){return this.transform.origin}get key(){return this.entity.id}getDefaultData(){let{size:t,defaultExpanded:e,expandedSize:i,hidden:r}=this.entity.getNodeMeta();return{size:r?{width:0,height:0}:{...e?i:t}}}get collapsed(){return this.entity.collapsed}set collapsed(t){this.entity.collapsed=t,this.localDirty=!0,this.firstChild&&(this.firstChild.localDirty=!0),this.fireChange()}get size(){return this.entity.memoGlobal("size",()=>this.isContainer?this.transform.localSize:this.data.size)}get position(){let{position:t}=this.transform;return{x:t.x,y:t.y}}set size(t){let{width:e,height:i}=this.data.size;!this.isContainer&&(t.width!==e||t.height!==i)&&(this._data.size={...t},this.localDirty=!0,this.fireChange())}get inputPoint(){return this.entity.memoGlobal("inputPoint",()=>{let{getInputPoint:t}=this.entity.getNodeRegistry();return t?t(this,this.entity.document.layout):this.defaultInputPoint})}get defaultInputPoint(){return this.entity.memoGlobal("defaultInputPoint",()=>this.entity.document.layout.getDefaultInputPoint(this.entity))}get defaultOutputPoint(){return this.entity.memoGlobal("defaultOutputPoint",()=>this.entity.document.layout.getDefaultOutputPoint(this.entity))}get outputPoint(){return this.entity.memoGlobal("outputPoint",()=>{let{getOutputPoint:t}=this.entity.getNodeRegistry();return t?t(this,this.entity.document.layout):this.defaultOutputPoint})}get originDeltaX(){return this.entity.memoLocal("originDeltaX",()=>{let{children:t}=this,{getOriginDeltaX:e}=this.entity.getNodeRegistry();return e?e(this,this.entity.document.layout):0===t.length?-this.size.width*this.origin.x:1===t.length?t[0].originDeltaX:this.entity.isInlineBlocks&&t.length>1?t[0].originDeltaX+this.transform.position.x:t.reduce((t,e)=>{let i=e.originDeltaX;return void 0===t||i<t?i:t},void 0)})}get originDeltaY(){return this.entity.memoLocal("originDeltaY",()=>{let{children:t}=this,{getOriginDeltaY:e}=this.entity.getNodeRegistry();return e?e(this,this.entity.document.layout):0===t.length?-this.size.height*this.origin.y:1===t.length?t[0].originDeltaY:this.entity.isInlineBlocks&&t.length>1?t[0].originDeltaY+this.transform.position.y:t.reduce((t,e)=>{let i=e.originDeltaY;return void 0===t||i<t?i:t},void 0)})}get bounds(){return this.entity.memoGlobal("bounds",()=>{let{transform:e}=this;if(this.isContainer){let i=e.children.map(e=>e.entity.getData(t).boundsWithPadding);return g.Ae.enlarge(i).withPadding(this.padding)}return e.bounds})}get boundsWithPadding(){return this.entity.memoGlobal("boundsWithPadding",()=>{let{transform:e}=this;if(this.isContainer){let i=e.children.map(e=>e.entity.getData(t).boundsWithPadding);return g.Ae.enlarge(i).withPadding(this.padding)}return e.bounds.clone().withPadding(this.padding)})}get isContainer(){return this.transform.isContainer}get localBounds(){return this.entity.memoLocal("localBounds",()=>{let{transform:e}=this;if(this.isContainer){let i=e.children.map(e=>e.entity.getData(t).localBounds),r=g.Ae.enlarge(i).withPadding(this.padding);return u.YZ.applyMatrix(r,e.localTransform)}return e.localBounds.clone().withPadding(this.padding)})}get padding(){return this.entity.document.layout.getPadding(this.entity)}setParentTransform(t){this.transform.parent!==t?.transform&&(this.localDirty=!0),this.transform.setParent(t?.transform)}get spacing(){let{spacing:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get inlineSpacingPre(){let{inlineSpacingPre:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get inlineSpacingAfter(){let{inlineSpacingAfter:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get minInlineBlockSpacing(){let{minInlineBlockSpacing:t}=this.entity.getNodeMeta();return"function"==typeof t?t(this):t}get children(){return this.entity.children.map(e=>e.getData(t))}get pre(){return this.entity.pre?.getData(t)}get originParent(){return this.entity.originParent?.getData(t)}get isFirst(){return this.entity.isFirst}get isLast(){return this.entity.isLast}get lastChild(){return this.entity.lastChild?.getData(t)}get firstChild(){return this.entity.firstChild?.getData(t)}get next(){return this.entity.next?.getData(t)}get parent(){return this.entity.parent?.getData(t)}};z.type="FlowNodeTransformData";var V=z,B=t=>{let{transform:e}=t,i=e.outputPoint;return e.next?[{type:0,from:i,to:e.next.inputPoint}]:[]},F=t=>{let{transform:e}=t,i=e.outputPoint,r=e.parent?.outputPoint;return e.next||!r||new g.E9().copyFrom(i).equals(r)||t.isNodeEnd?[]:[{type:0,from:i,to:r}]},Y=class extends u.RD{getDefaultData(){return{}}formatLines(t){return this.entity.document.options?.formatNodeLines?this.entity.document.options?.formatNodeLines?.(this.entity,t):t}formatLabels(t){return this.entity.document.options.formatNodeLabels?this.entity.document.options?.formatNodeLabels?.(this.entity,t):t}get lines(){return this.entity.memoGlobal("lines",()=>{let{getChildLines:t}=this.entity.parent?.getNodeRegistry()||{};if(t)return this.formatLines(t(this,this.entity.document.layout));let{getLines:e}=this.entity.getNodeRegistry();return e?this.formatLines(e(this,this.entity.document.layout)):this.transform.entity.isInlineBlock?[]:this.formatLines([...B(this),...F(this)])})}get labels(){return this.entity.memoGlobal("labels",()=>{let{getChildLabels:t}=this.entity.parent?.getNodeRegistry()||{};if(t)return this.formatLabels(t(this,this.entity.document.layout));let{getLabels:e}=this.entity.getNodeRegistry();if(e)return this.formatLabels(e(this,this.entity.document.layout));if(this.transform.entity.isInlineBlock)return[];let i=this.transform.outputPoint;if(this.transform.next)return this.formatLabels([{offset:g.E9.getMiddlePoint(i,this.transform.next.inputPoint),type:0}]);let r=this.transform.parent?.outputPoint;return!r||new g.E9().copyFrom(i).equals(r)||this.isNodeEnd?[]:this.formatLabels([{offset:r,type:0}])})}constructor(t){super(t),this.transform=this.entity.addData(V),this.renderData=this.entity.addData(j),this.bindChange(this.transform),this.bindChange(this.renderData)}get collapsed(){return this.entity.collapsed}get isNodeEnd(){return this.entity.isNodeEnd}};Y.type="FlowNodeTransitionData";var U=class extends u.JH{constructor(t){super(t),this._memoLocalCache=new Map,this._memoGlobalCache=new Map,this.flowNodeType="unknown",this._hidden=!1,this.index=-1,this.document=t.document,this.flowNodeType=t.flowNodeType,this.originParent=t.originParent,this.metaFromJSON=t.meta,this.onDispose(()=>{this.document.originTree.getChildren(this).slice().forEach(t=>{t.dispose()}),this.document.originTree.remove(this,!1),this.originParent=void 0})}initData(t){t.originParent!==this.originParent&&(this.originParent=t.originParent,this._registerCache=void 0),t.parent&&t.parent.addChild(this,t.index),t.meta!==this.metaFromJSON&&(this._metaCache=void 0,this.metaFromJSON=t.meta),this._hidden=!!(this.getNodeMeta().hidden||t.hidden)}get isStart(){return this.getNodeMeta().isStart}get isFirst(){return!this.pre}get isLast(){return!this.next}get isInlineBlocks(){let t=this.getNodeMeta().isInlineBlocks;return"function"==typeof t?t(this):t}get isInlineBlock(){let t=this.document.renderTree.getParent(this);return!!(t&&t.isInlineBlocks)}get isNodeEnd(){return this.memoLocal("isNodeEnd",()=>!!this.getNodeMeta().isNodeEnd||(this.isInlineBlocks&&this.collapsedChildren.length?this.collapsedChildren.every(t=>t.isNodeEnd):!!this.lastCollapsedChild&&this.lastCollapsedChild.isNodeEnd))}addChild(t,e){t.parent!==this&&this.document.originTree.addChild(this,t,e)}get hasChild(){return this.children.length>0}get pre(){return this.document.renderTree.getPre(this)}get next(){return this.document.renderTree.getNext(this)}get parent(){return this.document.renderTree.getParent(this)}getNodeRegistry(){return this._registerCache?this._registerCache:(this._registerCache=this.document.getNodeRegistry(this.flowNodeType,this.originParent),this._registerCache)}getNodeRegister(){return this.getNodeRegistry()}getNodeMeta(){return this._metaCache?this._metaCache:(this.metaFromJSON?this._metaCache={...this.getNodeRegistry().meta,...this.metaFromJSON}:this._metaCache=this.getNodeRegistry().meta,this._metaCache)}get allChildren(){let t=[];for(let e of this.children)t.push(e),t.push(...e.allChildren);return t}get allCollapsedChildren(){let t=[];for(let e of this.collapsedChildren)t.push(e),t.push(...e.allCollapsedChildren);return t}get collapsedChildren(){return this.document.renderTree.getCollapsedChildren(this)}get blocks(){return this.collapsedChildren}get lastBlock(){return this.lastCollapsedChild}get lastCollapsedChild(){let{collapsedChildren:t}=this;return t[t.length-1]}get children(){return this.document.renderTree.getChildren(this)}get lastChild(){let{children:t}=this;return t[t.length-1]}get firstChild(){return this.children[0]}memoLocal(t,e){if(this._memoLocalCache.has(t))return this._memoLocalCache.get(t);let i=e();return this._memoLocalCache.set(t,i),i}memoGlobal(t,e){if(this._memoGlobalCache.has(t))return this._memoGlobalCache.get(t);let i=e();return this._memoGlobalCache.set(t,i),i}clearMemoGlobal(){this._memoGlobalCache.clear()}clearMemoLocal(){this._memoLocalCache.clear()}get childrenLength(){return this.children.length}get collapsed(){return!!this.document.renderTree.isCollapsed(this)||!!this.parent?.collapsed}set collapsed(t){this.document.renderTree.setCollapsed(this,t),this.clearMemoGlobal(),this.clearMemoLocal()}get hidden(){return this._hidden}openInsideCollapsed(){this.document.renderTree.openNodeInsideCollapsed(this)}getJSONData(){return this.getExtInfo()}toJSON(){let t;if(this.document.options.toNodeJSON)return this.document.options.toNodeJSON(this);let e={};return this.document.traverse(i=>{if(i.id.startsWith("$"))return;let r=this.getJSONData(),s={id:i.id,type:i.flowNodeType};void 0!==r&&(s.data=r),!t&&(t=s);let{parent:n}=i;n&&n.id.startsWith("$")&&(n=n.originParent);let o=n?e[n.id]:void 0;o&&(!o.blocks&&(o.blocks=[]),o.blocks.push(s)),e[i.id]=s},this),t}get isVertical(){return"vertical-fixed-layout"===this.document.layout.name}updateExtInfo(t){this.getData(j).updateExtInfo(t)}getExtInfo(){return this.getData(j).getExtInfo()}get onExtInfoChange(){return this.renderData.onExtInfoChange}get renderData(){return this.getData(j)}get transform(){return this.getData(V)}get bounds(){return this.transform.bounds}};U.type="FlowNodeEntity",(d=U||(U={})).is=function(t){return t instanceof d};var G=class extends u.cv{constructor(t){super(t),this.onRefreshEmitter=new g.Q5,this.lastTransformVersion=-1,this.lastTreeVersion=-1,this.onRefresh=this.onRefreshEmitter.event,this.document=t.document,this.toDispose.push(this.document.originTree.onTreeChange(()=>{this.config.treeVersion+=1,this.fireChange()})),this.toDispose.push(this.onRefreshEmitter)}getDefaultConfig(){return{loading:!0,treeVersion:0}}get loading(){return this.config.loading}set loading(t){this.config.loading!==t&&(this.config.loading=t,this.fireChange())}updateTransformsTree(){this.document.renderTree.traverse((t,e,i)=>{let r=t.getData(V);r.collapsed&&r.transform.clearChildren(),t.parent&&r.setParentTransform(t.parent.getData(V)),t.index=i})}clear(){this.lastTreeVersion=-1,this.lastTransformVersion=-1}isTreeDirty(){let t=this.entityManager.getEntityDataVersion(V),e=this.lastTreeVersion!==this.config.treeVersion,i=this.lastTransformVersion!==t;return e||i}refresh(){let t=this.entityManager.getEntityDataVersion(V),e=this.lastTreeVersion!==this.config.treeVersion,i=this.lastTransformVersion!==t;this.entityManager.changeEntityLocked=!0,e&&(this.document.renderTree.updateRenderStruct(),this.updateTransformsTree(),this.lastTreeVersion=this.config.treeVersion),(e||i)&&(this.document.layout.update(),this.lastTransformVersion=this.entityManager.getEntityDataVersion(V),this.lastTreeVersion=this.config.treeVersion,this.onRefreshEmitter.fire()),this.entityManager.changeEntityLocked=!1}};G.type="FlowDocumentTransformerEntity";var Q=class extends u.cv{getDefaultConfig(){return{}}constructor(t){super(t)}getNodeHovered(){return this.config.nodeHoveredId?this.entityManager.getEntityById(this.config.nodeHoveredId):void 0}setNodeHovered(t){this.updateConfig({nodeHoveredId:t?.id})}getDragLabelSide(){return this.config.dragLabelSide}setDragLabelSide(t){this.updateConfig({dragLabelSide:t})}getNodeDroppingId(){return this.config.nodeDroppingId}setNodeDroppingId(t){this.updateConfig({nodeDroppingId:t})}getDragStartEntity(){let{nodeDragStartId:t}=this.config;return this.entityManager.getEntityById(t)}setDragStartEntity(t){this.updateConfig({nodeDragStartId:t?.id})}getDragEntities(){let{nodeDragIds:t}=this.config;return(t||[]).map(t=>this.entityManager.getEntityById(t))}setDragEntities(t){this.updateConfig({nodeDragIds:t.map(t=>t.id),nodeDragIdsWithChildren:t.map(t=>[t.id,...t.allCollapsedChildren.map(t=>t.id)]).flat()})}onNodeHoveredChange(t,e=100){return this.onConfigChanged((0,p.debounce)(()=>t(this.getNodeHovered()),e))}};Q.type="FlowRendererStateEntity";var X=class t{constructor(t){this.root=t,this.onTreeChangeEmitter=new g.Q5,this.onTreeChange=this.onTreeChangeEmitter.event,this.map=new Map}dispose(){this.map.clear(),this.onTreeChangeEmitter.dispose()}getInfo(t){let e=this.map.get(t);return!e&&(e={children:[]},this.map.set(t,e)),e}clear(){this.map.clear()}cloneMap(){let t=new Map;for(let[e,i]of this.map)t.set(e,{...i,children:i.children.slice()});return t}clone(){let e=new t(this.root);return e.map=this.cloneMap(),e}remove(t,e=!0){this.removeParent(t),e&&this._removeChildren(t),this.map.delete(t),this.fireTreeChange()}addChild(t,e,i){let r=this.getInfo(t),s=this.getInfo(e);if(s.parent){if(s.parent===t)return e;s.parent!==t&&this.removeParent(e)}let n=r.children.length,o=void 0===i?n-1:i-1,a=r.children[o],h=r.children[o+1];return a&&(this.getInfo(a).next=e),h&&(this.getInfo(h).pre=e),s.pre=a,s.next=h,r.children.splice(o+1,0,e),s.parent=t,this.fireTreeChange(),e}moveChilds(t,e,i){let r=this.getInfo(t),s=r.children.length,n=i??s;return e.forEach(t=>{this.getInfo(t).parent&&this.removeParent(t)}),e.forEach(e=>{let i=this.getInfo(e),s=r.children[n-1],o=r.children[n];s&&(this.getInfo(s).next=e),o&&(this.getInfo(o).pre=e),i.pre=s,i.next=o,r.children.splice(n,0,e),i.parent=t,n++}),this.fireTreeChange(),e}getById(t){for(let e of this.map.keys())if(e.id===t)return e}insertAfter(t,e){let i=this.getInfo(t),r=this.getInfo(e);if(this.removeParent(e),i.parent){let s=this.getInfo(i.parent);s.children.splice(s.children.indexOf(t)+1,0,e);let{next:n}=i;n&&(this.getInfo(n).pre=e),r.next=n,i.next=e,r.pre=t,r.parent=i.parent}this.fireTreeChange()}removeParent(t){let e=this.getInfo(t);if(!e.parent)return;let i=this.getInfo(e.parent),r=i.children.indexOf(t);i.children.splice(r,1);let{pre:s,next:n}=e;s&&(this.getInfo(s).next=n),n&&(this.getInfo(n).pre=s),this.fireTreeChange()}_removeChildren(t){let e=this.getChildren(t);e.length>0&&e.forEach(t=>{this._removeChildren(t),this.map.delete(t)})}getParent(t){return this.getInfo(t).parent}getPre(t){return this.getInfo(t).pre}getNext(t){return this.getInfo(t).next}getChildren(t){return this.getInfo(t).children}traverse(t,e=this.root,i=0,r=0){if(t(e,i,r)||this.getInfo(e).children.find((e,r)=>this.traverse(t,e,i+1,r)))return!0}fireTreeChange(){this.onTreeChangeEmitter.fire()}get size(){return this.map.size}toString(){let t=[];return this.traverse((e,i)=>{0===i?t.push(e.id):t.push(`|${Array(i).fill("--").join("")} ${e.id}`)}),`${t.join("\n")}`}},W=class extends X{constructor(t,e,i){super(t),this.root=t,this.nodesCollapsed=new Set,this.originTree=e,this.onTreeChange=this.originTree.onTreeChange,this.document=i}isCollapsed(t){return this.nodesCollapsed.has(t)}get collapsedNodeList(){return Array.from(this.nodesCollapsed)}setCollapsed(t,e){e?this.nodesCollapsed.add(t):this.nodesCollapsed.delete(t),this.originTree.fireTreeChange()}openNodeInsideCollapsed(t){let e=this.originTree.getInfo(t)?.parent;for(;e;){this.nodesCollapsed.has(e)&&this.nodesCollapsed.delete(e);let{parent:t}=this.originTree.getInfo(e)||{};e=t}this.originTree.fireTreeChange()}updateRenderStruct(){this.map=this.originTree.cloneMap(),this.document.config.get("END_NODES_REFINE_BRANCH")&&this.refineBranch(this.root),this.hideCollapsed()}hideCollapsed(){this.nodesCollapsed.forEach(t=>{let e=this.getInfo(t);if(!e){this.nodesCollapsed.delete(t);return}let i=e.children.find(t=>"blockIcon"===t.flowNodeType||"blockOrderIcon"===t.flowNodeType);if(i){let t=this.getInfo(i);t.next=void 0,t.pre=void 0,e.children=[i];return}e.children=[]})}isNodeEnd(t){if(t.getNodeMeta().isNodeEnd)return!0;let{children:e}=this.getInfo(t);return e.length>0&&t.isInlineBlocks?e.every(t=>this.isNodeEnd(t)):!!t.isInlineBlock&&this.isNodeEnd(e[e.length-1])}refineBranch(t){let e=this.getInfo(t).children[0];for(;e;){if("dynamicSplit"===e.flowNodeType||"staticSplit"===e.flowNodeType){let{next:t,children:i}=this.getInfo(e),{children:r}=this.getInfo(i[1]),s=(r||[]).filter(t=>!this.isNodeEnd(t)),n=1===s.length;if(n&&t&&this.dragNextNodesToBlock(s[0],t),r?.forEach(t=>{this.refineBranch(t)}),n)break}e=e.next}}dragNextNodesToBlock(t,e){let i=this.getInfo(t),r=this.getInfo(e),s=i.children[t.children.length-1];if(r.parent){let n=this.getInfo(r.parent);r.pre&&(this.getInfo(r.pre).next=void 0),s&&(this.getInfo(s).next=e,r.pre=s);let o=n.children.indexOf(e),a=n.children.slice(o);for(let e of(n.children=n.children.slice(0,o),a)){let r=this.getInfo(e);i.children.push(e),r.parent=t}}}getInfo(t){return this.map.get(t)||this.originTree.getInfo(t)}getOriginInfo(t){return this.originTree.getInfo(t)}getCollapsedChildren(t){return this.getOriginInfo(t).children||[]}remove(){throw Error("Render Tree cannot use remove node")}addChild(){throw Error("Render tree cannot use add child")}insertAfter(){throw Error("Render tree cannot use insert after")}removeParent(){throw Error("Render tree cannot use remove parent")}},$=Symbol("FlowDocumentOptions"),J={allNodesDefaultExpanded:!1},H={...I,INLINE_SPACING_BOTTOM:"INLINE_SPACING_BOTTOM",INLINE_BLOCKS_INLINE_SPACING_TOP:"INLINE_BLOCKS_INLINE_SPACING_TOP",INLINE_BLOCKS_INLINE_SPACING_BOTTOM:"INLINE_BLOCKS_INLINE_SPACING_BOTTOM",BASE_COLOR:"BASE_COLOR",BASE_ACTIVATED_COLOR:"BASE_ACTIVATED_COLOR"},K=Symbol("FlowDocumentContribution"),Z=Symbol("FlowDocumentConfigDefaultData"),q=class{constructor(t={}){this._data=t,this.onDataChangeEmitter=new g.Q5,this.onChange=this.onDataChangeEmitter.event}get(t){return this._data[t]}set(t,e){this.get(t)!==e&&(this._data[t]=e,this.onDataChangeEmitter.fire(t))}registerConfigs(t){Object.keys(t).forEach(e=>{this.set(e,t[e])})}};q=D([(0,f.b2)(),M(0,(0,f.f3)(Z)),M(0,(0,f.jt)())],q);var tt=Symbol("FlowDocumentProvider"),te=class{constructor(){this.contributions=[],this.registers=new Map,this.nodeRegistryCache=new Map,this.nodeDataRegistries=[],this.layouts=[],this.currentLayoutKey="",this.onNodeUpdateEmitter=new g.Q5,this.onNodeCreateEmitter=new g.Q5,this.onNodeDisposeEmitter=new g.Q5,this.onLayoutChangeEmitter=new g.Q5,this.onNodeUpdate=this.onNodeUpdateEmitter.event,this.onNodeCreate=this.onNodeCreateEmitter.event,this.onNodeDispose=this.onNodeDisposeEmitter.event,this.onLayoutChange=this.onLayoutChangeEmitter.event}init(){!this.options&&(this.options=J),this.currentLayoutKey=this.options.defaultLayout||"vertical-fixed-layout",this.contributions.forEach(t=>t.registerDocument?.(this)),this.root=this.addNode({id:"root",type:"root"}),this.originTree=new X(this.root),this.transformer=this.entityManager.createEntity(G,{document:this}),this.renderState=this.entityManager.createEntity(Q),this.renderTree=new W(this.root,this.originTree,this),this.layout.reload?.()}fromJSON(t,e=!0){this.originTree.clear(),this.renderTree.clear(),this.entityManager.changeEntityLocked=!0;let i=this.entityManager.getEntities(U),r=[this.root];this.addBlocksAsChildren(this.root,t.nodes||[],r),i.forEach(t=>{!r.includes(t)&&t.dispose()}),this.entityManager.changeEntityLocked=!1,this.transformer.loading=!1,e&&this.fireRender()}get layout(){let t=this.layouts.find(t=>t.name==this.currentLayoutKey);if(!t)throw Error(`Unknown flow layout: ${this.currentLayoutKey}`);return t}async load(){await Promise.all(this.contributions.map(t=>t.loadDocument?.(this)))}get loading(){return this.transformer.loading}fireRender(){this.transformer.isTreeDirty()&&(this.entityManager.fireEntityChanged(U.type),this.entityManager.fireEntityChanged(G.type))}addFromNode(t,e){let i="string"==typeof t?this.getNode(t):t;this.entityManager.changeEntityLocked=!0;let{parent:r}=i,s=this.addNode({...e,parent:r});return this.originTree.insertAfter(i,s),this.entityManager.changeEntityLocked=!1,this.entityManager.fireEntityChanged(U.type),s}removeNode(t){"string"==typeof t?this.getNode(t)?.dispose():t.dispose()}addNode(t,e,i){let{id:r,type:s="block",originParent:n,parent:o,meta:a,hidden:h,index:l}=t,d=this.getNode(r),c=!1,u=this.getNodeRegistry(s,t.originParent);if(d&&d.flowNodeType!==t.type&&(d.dispose(),d=void 0),!d){let{dataRegistries:e}=u;d=this.entityManager.createEntity(U,{id:r,document:this,flowNodeType:s,originParent:n,meta:a});let i=e?this.nodeDataRegistries.concat(...e):this.nodeDataRegistries;d.addInitializeData(i),d.onDispose(()=>this.onNodeDisposeEmitter.fire({node:d})),this.options.fromNodeJSON&&this.options.fromNodeJSON(d,t),c=!0}if(d.initData({originParent:n,parent:o,meta:a,hidden:h,index:l}),d.isStart&&this.root.addChild(d),this.onNodeUpdateEmitter.fire({node:d,data:t}),e?.push(d),u.onCreate){let i=u.onCreate(d,t);i&&e&&e.push(...i)}else t.blocks&&t.blocks.length>0&&(t.blocks[0].type?this.addBlocksAsChildren(d,t.blocks,e):this.addInlineBlocks(d,t.blocks,e));return c&&!i&&this.onNodeCreateEmitter.fire({node:d,data:t}),d}addBlocksAsChildren(t,e,i){for(let r of e)this.addNode({...r,parent:t},i)}addInlineBlocks(t,e,i=[]){let r=this.addNode({id:`$blockIcon$${t.id}`,type:"blockIcon",originParent:t,parent:t});if(i.push(r),e.length>0){let r=this.addNode({id:`$inlineBlocks$${t.id}`,type:"inlineBlocks",originParent:t,parent:t});i.push(r),e.forEach(e=>{this.addBlock(t,e,i)})}return i}addBlock(t,e,i,r,s){let n="string"==typeof t?this.getNode(t):t,{onBlockChildCreate:o}=n.getNodeRegistry();if(o)return o(n,e,i);r=r||this.getNode(`$inlineBlocks$${n.id}`);let a=this.addNode({...(0,p.omit)(e,"blocks"),type:e.type||"block",originParent:n,parent:r,index:s});e.meta?.defaultCollapsed&&(a.collapsed=!0);let h=this.addNode({id:`$blockOrderIcon$${e.id}`,type:"blockOrderIcon",originParent:n,meta:e.meta,data:e.data,parent:a});return i?.push(a,h),e.blocks&&this.addBlocksAsChildren(a,e.blocks,i),a}getNode(t){if(t)return this.entityManager.getEntityById(t)}registerFlowNodes(...t){t.forEach(t=>{if(!t)throw Error("[FlowDocument] registerFlowNodes parameters get undefined registry.");let e=this.registers.get(t.type);this.registers.set(t.type,{...e,...t,meta:{...e?.meta,...t?.meta}})})}toJSON(){return{nodes:this.root.toJSON().blocks}}getNodeRegister(t,e){return this.getNodeRegistry(t,e)}getNodeRegistry(t,e){let i=`${t}_${e?.flowNodeType||""}`;if(this.nodeRegistryCache.has(i))return this.nodeRegistryCache.get(i);let r=this.options.getNodeDefaultRegistry?.(t),s=this.registers.get(t)||{type:t},n=[];if(s.extend&&this.registers.has(s.extend)&&(s=c.merge(this.getNodeRegistry(s.extend),s,s.type)),e){let i=this.getNodeRegistry(e.flowNodeType).extendChildRegistries?.find(e=>e.type===t);i&&(i.extend&&this.registers.has(i.extend)&&n.push(this.registers.get(i.extend)),n.push(i))}s=c.extend(s,n);let o=A(t,this);o.spacing=this.options?.constants?.[H.NODE_SPACING]||o.spacing;let a={...r,...s,meta:{...o,...r?.meta,...s.meta}};return this.nodeRegistryCache.set(i,a),a}registerNodeDatas(...t){this.nodeDataRegistries.push(...t)}traverse(t,e=this.root,i=0){return this.originTree.traverse(t,e,i)}get size(){return this.getAllNodes().length}hasNode(t){return!!this.entityManager.getEntityById(t)}getAllNodes(){return this.entityManager.getEntities(U)}toString(){return this.originTree.toString()}getRenderDatas(t,e=!0){let i=[];return this.renderTree.traverse(r=>{(e||!r.hidden)&&i.push(r.getData(t))}),i}moveNodes({dropNodeId:t,sortNodeIds:e,inside:i=!1}){let r=this.getNode(t);if(!r)return;let s=e.map(t=>this.getNode(t));for(let t of(this.entityManager.changeEntityLocked=!0,s.reverse()))i?this.originTree.addChild(r,t,0):this.originTree.insertAfter(r,t);this.entityManager.changeEntityLocked=!1,this.fireRender()}moveChildNodes({toParentId:t,toIndex:e,nodeIds:i}){if(0===i.length)return;let r=this.getNode(t);if(!!r)this.entityManager.changeEntityLocked=!0,this.originTree.moveChilds(r,i.map(t=>this.getNode(t)),e),this.entityManager.changeEntityLocked=!1,this.fireRender()}registerLayout(t){this.layouts.push(t)}setLayout(t){if(this.currentLayoutKey===t)return;let e=this.layouts.find(e=>e.name===t);e&&(this.currentLayoutKey=t,this.transformer.clear(),e.reload?.(),this.fireRender(),this.onLayoutChangeEmitter.fire(this.layout))}toggleFixedLayout(){this.setLayout("horizontal-fixed-layout"===this.layout.name?"vertical-fixed-layout":"horizontal-fixed-layout")}dispose(){this.registers.clear(),this.nodeRegistryCache.clear(),this.originTree.dispose(),this.renderTree.dispose(),this.onNodeUpdateEmitter.dispose(),this.onNodeCreateEmitter.dispose(),this.onNodeDisposeEmitter.dispose(),this.onLayoutChangeEmitter.dispose()}};D([(0,f.f3)(u.v2)],te.prototype,"entityManager",2),D([(0,f.f3)(q)],te.prototype,"config",2),D([(0,f.f3)($),(0,f.jt)()],te.prototype,"options",2),D([(0,f.nx)(K),(0,f.jt)()],te.prototype,"contributions",2),D([(0,f.zY)()],te.prototype,"init",1),te=D([(0,f.b2)()],te);var ti=class{constructor(){this.onNodeAddEmitter=new g.Q5,this.onNodeAdd=this.onNodeAddEmitter.event,this.toDispose=new g.K4}init(){this.toDispose.push(this.onNodeAddEmitter)}addNode(t,e={}){let i,r,s;let{parent:n,index:o,hidden:a}=e;n&&(i=this.toNodeEntity(n)),i&&(r=i.getNodeRegistry());let h={...t,type:t.type||"block"},l={...h,parent:i,index:o,hidden:a};return s=i&&r?.addChild?r.addChild(i,h,{index:o,hidden:a}):this.document.addNode(l),this.onNodeAddEmitter.fire({node:s,data:l}),s}addFromNode(t,e){return this.document.addFromNode(t,e)}deleteNode(t){this.document.removeNode(t)}deleteNodes(t){(t||[]).forEach(t=>{this.deleteNode(t)})}addBlock(t,e,i={}){let{parent:r,index:s}=i;return this.document.addBlock(t,e,void 0,r,s)}moveNode(t,e={}){let{parent:i,index:r}=e,s=this.toNodeEntity(t),n=s?.parent;if(!n)return;let o=i?this.toNodeEntity(i):n;if(!o){console.warn("no new parent found",i);return}let a=void 0===r?n.children.length:r;return this.doMoveNode(s,o,a)}dragNodes({dropNode:t,nodes:e}){if(0===e.length)return;let i=e[0],r=i.parent,s=t.parent;if(!r||!s)return;let n=r.children.findIndex(t=>t===i),o=s.children.findIndex(e=>e===t),a=o+1;r===s&&n<o&&(a-=e.length);let h={nodeIds:e.map(t=>t.id),fromParentId:r.id,toParentId:s.id,fromIndex:n,toIndex:a};return this.apply({type:"moveChildNodes",value:h})}apply(t){let e=this.document;switch(t.type){case"addFromNode":return e.addFromNode(t.value.fromId,t.value.data);case"deleteFromNode":return e.getNode(t.value?.data?.id)?.dispose();case"addBlock":{let i;return t.value.parentId&&(i=e.getNode(t.value.parentId)),e.addBlock(t.value.targetId,t.value.blockData,void 0,i,t.value.index)}case"deleteBlock":{let i=e.getNode(t.value?.blockData.id);return i?.dispose()}case"createGroup":{let i=e.addFromNode(t.value.targetId,{id:t.value.groupId,type:"group"});return e.moveNodes({dropNodeId:t.value.groupId,sortNodeIds:t.value.nodeIds,inside:!0}),i}case"ungroup":return e.moveNodes({dropNodeId:t.value.groupId,sortNodeIds:t.value.nodeIds}),e.getNode(t.value.groupId)?.dispose();case"moveNodes":return e.moveNodes({dropNodeId:t.value.toId,sortNodeIds:t.value.nodeIds});case"moveBlock":return e.moveChildNodes({...t.value,nodeIds:[t.value.nodeId]});case"addNodes":{let i=t.value.fromId;(t.value.nodes||[]).forEach(t=>{i=e.addFromNode(i,t).id});break}case"deleteNodes":(t.value.nodes||[]).forEach(t=>{let i=e.getNode(t.id);i?.dispose()});break;case"addChildNode":return e.addNode({...t.value.data,parent:t.value.parentId?e.getNode(t.value.parentId):void 0,originParent:t.value.originParentId?e.getNode(t.value.originParentId):void 0,index:t.value.index,hidden:t.value.hidden});case"deleteChildNode":return e.getNode(t.value.data.id)?.dispose();case"moveChildNodes":return e.moveChildNodes(t.value);default:throw Error("unknown operation type")}}transact(t){t()}dispose(){this.toDispose.dispose()}toId(t){return"string"==typeof t?t:t.id}toNodeEntity(t){return"string"==typeof t?this.document.getNode(t):t}getNodeIndex(t){let e=this.toNodeEntity(t),i=e?.parent;return i?i.children.findIndex(t=>t===e):-1}doMoveNode(t,e,i){return this.document.moveChildNodes({nodeIds:[this.toId(t)],toParentId:this.toId(e),toIndex:i})}};D([(0,f.f3)(u.v2)],ti.prototype,"entityManager",2),D([(0,f.f3)(te)],ti.prototype,"document",2),D([(0,f.zY)()],ti.prototype,"init",1),ti=D([(0,f.b2)()],ti);var tr=class{createGroup(t){if(!t||!Array.isArray(t)||0===t.length||!ts.validate(t))return;let e=t.sort((t,e)=>t.index-e.index)[0],i=`group_${(0,y.x0)(5)}`;this.operationService.apply({type:"createGroup",value:{targetId:e.id,groupId:i,nodeIds:t.map(t=>t.id)}});let r=this.entityManager.getEntityById(i);if(!r)return;let s=this.groupController(r);if(!!s)return s.expand(),r}deleteGroup(t){let e=t.toJSON();if(!!t.pre&&!!e)this.operationService.apply({type:"deleteNodes",value:{fromId:t.pre.id,nodes:[e]}})}ungroup(t){let e=this.groupController(t);if(!e)return;let i=e.nodes;if(!!t.pre)e.collapse(),this.operationService.apply({type:"ungroup",value:{groupId:t.id,targetId:t.pre.id,nodeIds:i.map(t=>t.id)}})}getAllGroups(){return this.entityManager.getEntities(U).filter(t=>"group"===t.flowNodeType).map(t=>this.groupController(t)).filter(Boolean)}groupController(t){return ts.create(t)}static validate(t){return ts.validate(t)}};D([(0,f.f3)(u.v2)],tr.prototype,"entityManager",2),D([(0,f.f3)(R)],tr.prototype,"operationService",2),tr=D([(0,f.b2)()],tr);var ts=class t{constructor(t){this.groupNode=t}get nodes(){return this.groupNode.collapsedChildren||[]}get collapsed(){return this.groupNode.getData(V).collapsed}collapse(){this.collapsed=!0}expand(){this.collapsed=!1}get bounds(){return this.groupNode.getData(V).bounds}isStartNode(t){if(!t)return!1;let e=this.nodes;return!!e[0]&&t.id===e[0].id}isEndNode(t){if(!t)return!1;let e=this.nodes;return!!e[e.length-1]&&t.id===e[e.length-1].id}set note(t){this.groupNode.getNodeMeta().note=t}get note(){return this.groupNode.getNodeMeta().note||""}set noteHeight(t){this.groupNode.getNodeMeta().noteHeight=t}get noteHeight(){return this.groupNode.getNodeMeta().noteHeight||0}get positionConfig(){return this.groupNode.getNodeMeta().positionConfig}set collapsed(t){let e=this.groupNode.getData(V);e.collapsed=t,e.localDirty=!0,e.parent&&(e.parent.localDirty=!0),e.parent?.firstChild&&(e.parent.firstChild.localDirty=!0)}set hovered(t){let e=this.groupNode.getData(j);if(t?e.toggleMouseEnter():e.toggleMouseLeave(),e.hovered!==t)e.hovered=t}get hovered(){return this.groupNode.getData(j).hovered}static create(e){if(!!e&&!!t.isGroupNode(e))return new t(e)}static validate(e){if(!e||!Array.isArray(e)||0===e.length||e.some(e=>t.isGroupNode(e))||e.some(t=>t&&this.isNodeInGroup(t)))return!1;let i=e[0].parent;return!(!e.every(t=>t.parent===i)||!e.map(t=>t.index).sort((t,e)=>t-e).every((t,e,i)=>0===e||t===i[e-1]+1)||this.findNodeParents(e[0]).some(t=>this.isNodeInGroup(t)))&&!0}static getNodeGroupController(e){if(!e||!this.isNodeInGroup(e))return;let i=e?.parent;return t.create(i)}static getNodeRecursionGroupController(t){if(!t)return;let e=this.getNodeGroupController(t);return e?e:t.parent?this.getNodeRecursionGroupController(t.parent):void 0}static isGroupNode(t){return"group"===t.flowNodeType}static findNodeParents(t){let e=[],i=t.parent;for(;i;)e.push(i),i=i.parent;return e}static isNodeInGroup(t){return t?.parent?.flowNodeType==="group"||!1}},tn=class{constructor(){this.onDropEmitter=new g.Q5,this.onDrop=this.onDropEmitter.event}get renderState(){return this.document.renderState}get dragStartNode(){return this.renderState.getDragStartEntity()}get dragNodes(){return this.renderState.getDragEntities()}get dropNodeId(){return this.renderState.getNodeDroppingId()}get isDragBranch(){return this.dragStartNode?.isInlineBlock}get nodeDragIdsWithChildren(){return this.renderState.config.nodeDragIdsWithChildren||[]}get dragging(){let t=this.dragStartNode?.getData(j);return!!t?.dragging}get labelSide(){return this.renderState.config.dragLabelSide}dropBranch(){this.dropNode()}dropNode(){let t=this.document.getNode(this.dropNodeId);if(!t)return;let e=[],i=this.dragStartNode;for(;i&&this.dragNodes.includes(i);)e.push(i),i=i.next;this.operationService.dragNodes({dropNode:t,nodes:e}),e.length>0&&this.onDropEmitter.fire({dropNode:t,dragNodes:e})}isDroppableNode(t){return!(!this.dragging||this.isDragBranch||this.nodeDragIdsWithChildren.includes(t.id)||t.next&&this.nodeDragIdsWithChildren.includes(t.next.id)||t.isInlineBlocks||t.isInlineBlock||this.dragNodes.some(t=>"group"===t.flowNodeType)&&ts.getNodeRecursionGroupController(t))&&!0}isDroppableBranch(t,e="normal_branch"){if(this.isDragBranch){if(!t.isInlineBlock||t.parent!==this.dragStartNode.parent||t===this.dragStartNode)return!1;if("normal_branch"===e&&t.next!==this.dragStartNode||"pre_branch"===e&&t.pre!==this.dragStartNode)return!0}return!1}};D([(0,f.f3)(te)],tn.prototype,"document",2),D([(0,f.f3)(R)],tn.prototype,"operationService",2),D([(0,f.f3)(u.v2)],tn.prototype,"entityManager",2),tn=D([(0,f.b2)()],tn);var to=class{constructor(){this.name="vertical-fixed-layout",this.structDataMap=new WeakMap}get document(){return this.documentProvider()}reload(){this.structDataMap=new WeakMap}update(){this.updateLocalTransform(this.document.root)}updateLocalTransform(t,e=!1){var i,r;let{children:s,parent:n,isInlineBlock:o}=t,a=t.getData(V),{getDelta:h,getOrigin:l}=t.getNodeRegistry(),d=this.structDataMap.get(t)||{childrenLength:0,index:-1};t.clearMemoGlobal();let c=a.localDirty||e,u={index:t.index,childrenLength:t.children.length};if(i=d,r=u,i.childrenLength!==r.childrenLength||i.index!==r.index)c=!0,this.structDataMap.set(t,u);let g=!1;if(s.length>0)for(let t of s)this.updateLocalTransform(t,g)&&(g=!0,c=!0);if(!c)return!1;t.clearMemoLocal(),a.transform.update({origin:l?l(a,this):this.getDefaultNodeOrigin()});let p=a.pre,f=h?.(a,this)||{x:0,y:0},y=o&&a.parent?.inlineSpacingPre?a.parent?.inlineSpacingPre:0,m=n?.getNodeRegistry().getChildDelta?.(a,this)||{x:0,y:0};f.x+=m.x,f.y+=m.y;let E={x:f.x,y:f.y};return o?E.y+=y:(E.y+=p?.localBounds.bottom||0,E.y+=p?.spacing||0),a.transform.update({size:a.data.size,position:E}),this.onAfterUpdateLocalTransform(a),a.localDirty=!1,!0}onAfterUpdateLocalTransform(t){let{onAfterUpdateLocalTransform:e}=t.entity.getNodeRegistry();e?.(t,this),this.contribs?.forEach(e=>{e?.onAfterUpdateLocalTransform?.(t,this)})}getNodeTransform(t){return t.getData(V)}getPadding(t){let{inlineSpacingPre:e,inlineSpacingAfter:i,padding:r}=t.getNodeMeta(),s=this.getNodeTransform(t);if(r)return"function"==typeof r?r(s):r;let n="function"==typeof e?e(s):e;return{left:0,top:n,right:0,bottom:"function"==typeof i?i(s):i}}getInitScroll(t){return{scrollX:-t.width/2,scrollY:-36}}getDefaultInputPoint(t){return this.getNodeTransform(t).bounds.topCenter}getDefaultOutputPoint(t){return this.getNodeTransform(t).bounds.bottomCenter}getDefaultNodeOrigin(){return{x:.5,y:0}}};D([(0,f.f3)(tt)],to.prototype,"documentProvider",2),D([(0,f.nx)(S),(0,f.jt)()],to.prototype,"contribs",2),to=D([(0,f.b2)()],to);var ta=class{constructor(){this.name="horizontal-fixed-layout",this.structDataMap=new WeakMap}get document(){return this.documentProvider()}reload(){this.structDataMap=new WeakMap}update(){this.updateLocalTransform(this.document.root)}updateLocalTransform(t,e=!1){var i,r;let{children:s,parent:n,isInlineBlock:o}=t,a=t.getData(V),{getDelta:h,getOrigin:l}=t.getNodeRegistry(),d=this.structDataMap.get(t)||{childrenLength:0,index:-1};t.clearMemoGlobal();let c=a.localDirty||e,u={index:t.index,childrenLength:t.children.length};if(i=d,r=u,i.childrenLength!==r.childrenLength||i.index!==r.index)c=!0,this.structDataMap.set(t,u);let g=!1;if(s.length>0)for(let t of s)this.updateLocalTransform(t,g)&&(g=!0,c=!0);if(!c)return!1;t.clearMemoLocal(),a.transform.update({origin:l?l(a,this):this.getDefaultNodeOrigin()});let p=a.pre,f=h?.(a,this)||{x:0,y:0},y=o&&a.parent?.inlineSpacingPre?a.parent?.inlineSpacingPre:0,m=n?.getNodeRegistry().getChildDelta?.(a,this)||{x:0,y:0};f.x+=m.x,f.y+=m.y;let E={x:f.x,y:f.y};return o?E.x+=y:(E.x+=p?.localBounds.right||0,E.x+=p?.spacing||0),a.transform.update({size:a.data.size,position:E}),this.onAfterUpdateLocalTransform(a),a.localDirty=!1,!0}onAfterUpdateLocalTransform(t){let{onAfterUpdateLocalTransform:e}=t.entity.getNodeRegistry();e?.(t,this),this.contribs?.forEach(e=>{e?.onAfterUpdateLocalTransform?.(t,this)})}getNodeTransform(t){return t.getData(V)}getPadding(t){let{inlineSpacingPre:e,inlineSpacingAfter:i,padding:r}=t.getNodeMeta(),s=this.getNodeTransform(t);if(r)return"function"==typeof r?r(s):r;let n="function"==typeof e?e(s):e;return{left:n,top:0,right:"function"==typeof i?i(s):i,bottom:0}}getInitScroll(t){return{scrollX:-36,scrollY:-t.height/2}}getDefaultInputPoint(t){return this.getNodeTransform(t).bounds.leftCenter}getDefaultOutputPoint(t){return this.getNodeTransform(t).bounds.rightCenter}getDefaultNodeOrigin(){return{x:0,y:.5}}};D([(0,f.f3)(tt)],ta.prototype,"documentProvider",2),D([(0,f.nx)(S),(0,f.jt)()],ta.prototype,"contribs",2),ta=D([(0,f.b2)()],ta);var th=new f.nZ(t=>{t(te).toSelf().inSingletonScope(),t(tt).toDynamicValue(t=>()=>t.container.get(te)).inSingletonScope(),t(q).toSelf().inSingletonScope(),t(to).toSelf().inSingletonScope(),t(ta).toSelf().inSingletonScope(),t(tn).toSelf().inSingletonScope(),t(R).to(ti).inSingletonScope(),t(tr).toSelf().inSingletonScope(),t(K).toDynamicValue(t=>({registerDocument:e=>{e.registerLayout(t.container.get(to)),e.registerLayout(t.container.get(ta))}}))}),tl=(t,e,i)=>{let r=t.getService($);return r?.constants?.[e]||i||T[e]}},682264:function(t,e,i){i.d(e,{Z1:()=>R,dm:()=>G,ps:()=>P,Qu:()=>w,e2:()=>V,fY:()=>Y,YC:()=>tr,jg:()=>U,iw:()=>K,v6:()=>ts,_s:()=>to,XH:()=>F,gw:()=>M.gw,KU:()=>p.KU,G2:()=>p.G2,em:()=>j,Dc:()=>p.Dc,FD:()=>O,SP:()=>d,fT:()=>l,CT:()=>L,ZO:()=>q,x0:()=>_,PV:()=>ti,gO:()=>tt,L4:()=>J,uB:()=>x,oJ:()=>B});var r,s,n,o,a,h=Symbol("");var l=((r=l||{}).ADD_NODE="ADD_NODE",r.DELETE_NODE="DELETE_NODE",r.MOVE_NODE="MOVE_NODE",r.NODE_DATA_CHANGE="NODE_DATA_CHANGE",r.ADD_LINE="ADD_LINE",r.DELETE_LINE="DELETE_LINE",r.META_CHANGE="META_CHANGE",r);var d=((s=d||{})[s.BEZIER=0]="BEZIER",s[s.LINE_CHART=1]="LINE_CHART",s),c=Object.defineProperty,u=Object.getOwnPropertyDescriptor,g=(t,e,i,r)=>{for(var s=r>1?void 0:r?u(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&c(e,i,s),s},p=i("213153"),f=i("908600"),y=i("474414"),m=i("133253"),E=i("215206"),D=i("461932"),M=i("177783"),C=i("433210"),b=i("589496"),N=i("374488"),S=i("664881");var x=((n=x||{}).DELETE_NODES="DELETE_NODES",n.COPY_NODES="COPY_NODES",n.PASTE_NODES="PASTE_NODES",n.ZOOM_IN="ZOOM_IN",n.ZOOM_OUT="ZOOM_OUT",n.UNDO="UNDO",n.REDO="REDO",n);function _(t){return(0,C.x0)(t)}var w=(t,e,i=!0)=>{let r=M.Ae.enlarge(t.getAllNodes().map(t=>t.getData(p.VO).bounds));return e.fitView(r,i,30)},I=(t,e,i="")=>`port_${e}_${t.id}_${i}`,T="WorkflowLineEntity",L=E.GA,O=class extends p.JH{constructor(t){super(t),this.portID="",this._disabled=!1,this._hasError=!1,this._onErrorChangedEmitter=new M.Q5,this.onErrorChanged=this._onErrorChangedEmitter.event,this.portID=t.portID||"",this.portType=t.type,this._disabled=t.disabled??!1,this.node=t.node,this.updateTargetElement(t.targetElement),this.toDispose.push(this.node.getData(p.VO).onDataChange(()=>this.fireChange())),this.toDispose.push(this.node.onDispose(this.dispose.bind(this)))}static getPortEntityId(t,e,i=""){return I(t,e,i)}get hasError(){return this._hasError}set hasError(t){this._hasError=t,this._onErrorChangedEmitter.fire()}validate(){let t=this.allLines.some(t=>!t.disposed&&!t.isHidden&&(t.validateSelf(),t.hasError)),e=this.node.document.isErrorPort(this);this.hasError=t||e}isErrorPort(){return this.node.document.isErrorPort(this)}get point(){let{targetElement:t}=this,{bounds:e}=this.node.getData(p.VO);if(t){var i;let e=(i=t.getBoundingClientRect(),new M.Ae(i.x,i.y,i.width,i.height)).center;return this.entityManager.getEntity(p.ER).getPosFromMouseEvent({clientX:e.x,clientY:e.y})}return"input"===this.portType?e.leftCenter:e.rightCenter}get bounds(){let{point:t}=this,e=12;return new M.Ae(t.x-e,t.y-e,24,24)}isHovered(t,e){return this.bounds.contains(t,e)}get relativePosition(){let{point:t}=this,{bounds:e}=this.node.getData(p.VO);return{x:t.x-e.x,y:t.y-e.y}}updateTargetElement(t){t!==this.targetElement&&(this.targetElement=t,this.fireChange())}get disabled(){let t=this.node.document;if("function"==typeof t.options.isDisabledPort)return t.options.isDisabledPort(this);if(this._disabled)return!0;let e=this.node.getNodeMeta();return"input"===this.portType?!!e.inputDisable:!!e.outputDisable}get lines(){return this.allLines.filter(t=>!t.isDrawing)}get allLines(){let t=[];return this.entityManager.getEntities({type:T}).forEach(e=>{(e.toPort===this||e.fromPort===this)&&t.push(e)}),t}dispose(){this.lines.forEach(t=>t.dispose()),super.dispose()}};O.type="WorkflowPortEntity";var A=class extends p.RD{constructor(t){super(t),this._staticPorts=[],this._portIDSet=new Set,this.entity=t;let e=t.getNodeMeta(),i=e.useDynamicPort?[]:[{type:"input"},{type:"output"}];this._staticPorts=e.defaultPorts?.slice()||i,this.updatePorts(this._staticPorts),e.useDynamicPort&&this.toDispose.push(t.getData(p._z).onDataChange(()=>{t.getData(p._z).width&&t.getData(p._z).height&&this.updateDynamicPorts()})),this.onDispose(()=>{this.allPorts.forEach(t=>t.dispose())})}getDefaultData(){return{}}updateStaticPorts(t){let e=this.entity.getNodeMeta();this._staticPorts=t,e.useDynamicPort?this.updateDynamicPorts():this.updatePorts(this._staticPorts)}updateDynamicPorts(){let t=this.entity.getData(E.Lz).node.querySelectorAll("[data-port-id]"),e=this._staticPorts,i=[];t.length>0&&i.push(...Array.from(t).map(t=>({portID:t.getAttribute("data-port-id"),type:t.getAttribute("data-port-type"),targetElement:t}))),this.updatePorts(e.concat(i))}getPortEntityByKey(t,e){return this.getOrCreatePortEntity({type:t,portID:e})}updatePorts(t){if(!(0,b.Z)(this._prePorts,t)){let e=t.map(t=>this.getPortId(t.type,t.portID));this._portIDSet.forEach(t=>{!e.includes(t)&&this.getPortEntity(t)?.dispose()}),t.forEach(t=>this.updatePortEntity(t)),this._prePorts=t,this.fireChange()}this.allPorts.forEach(t=>{t.allLines.forEach(t=>{t.validate()}),t.validate()})}get allPorts(){return Array.from(this._portIDSet).map(t=>this.getPortEntity(t)).filter(Boolean)}get inputPorts(){return this.allPorts.filter(t=>"input"===t.portType)}get outputPorts(){return this.allPorts.filter(t=>"output"===t.portType)}get inputPoints(){return this.inputPorts.map(t=>t.point)}get outputPoints(){return this.inputPorts.map(t=>t.point)}getInputPoint(t){return this.getPortEntityByKey("input",t).point}getOutputPoint(t){return this.getPortEntityByKey("output",t).point}getPortEntity(t){if(!!this._portIDSet.has(t))return this.entity.entityManager.getEntityById(t)}getPortId(t,e=""){return I(this.entity,t,e)}createPortEntity(t){let e=this.getPortId(t.type,t.portID),i=this.entity.entityManager.getEntityById(e);return!i&&(i=this.entity.entityManager.createEntity(O,{id:e,node:this.entity,...t})),i.onDispose(()=>{this._portIDSet.delete(e)}),this._portIDSet.add(e),i}getOrCreatePortEntity(t){let e=this.getPortId(t.type,t.portID);return this.getPortEntity(e)??this.createPortEntity(t)}updatePortEntity(t){let e=this.getOrCreatePortEntity(t);return t.targetElement&&e.updateTargetElement(t.targetElement),e}};A.type="WorkflowNodePortsData";var k=class t extends p.RD{getDefaultData(){return{inputLines:[],outputLines:[]}}constructor(t){super(t),this.entity=t,this.toDispose.push(M.JT.create(()=>{this.inputLines.slice().forEach(t=>t.dispose()),this.outputLines.slice().forEach(t=>t.dispose())}))}get inputLines(){return this.data.inputLines}get outputLines(){return this.data.outputLines}get inputNodes(){return this.inputLines.map(t=>t.from).filter(Boolean)}get allInputNodes(){let e=new Set,i=r=>{if(e.has(r))return;e.add(r);let{inputNodes:s}=r.getData(t);if(!!s&&!!s.length)s.forEach(t=>{if(t?.parent!==r&&r?.parent!==t)i(t)})};return i(this.entity),e.delete(this.entity),Array.from(e)}get outputNodes(){return this.outputLines.map(t=>t.to).filter(Boolean)}get allOutputNodes(){let e=new Set,i=r=>{if(e.has(r))return;e.add(r);let{outputNodes:s}=r.getData(t);if(!!s&&!!s.length)s.forEach(t=>{if(t?.parent!==r&&r?.parent!==t)i(t)})};return i(this.entity),e.delete(this.entity),Array.from(e)}addLine(t){t.from===this.entity?this.outputLines.push(t):this.inputLines.push(t),this.fireChange()}removeLine(t){let{inputLines:e,outputLines:i}=this,r=e.indexOf(t),s=i.indexOf(t);-1!==r&&(e.splice(r,1),this.fireChange()),-1!==s&&(i.splice(s,1),this.fireChange())}};k.type="WorkflowNodeLinesData";var R=k,P=class extends p.RD{constructor(t){super(t),this.syncContributions()}getDefaultData(){return{version:"",contributions:new Map,position:{from:{x:0,y:0},to:{x:0,y:0}}}}get renderVersion(){return this.data.version}get position(){return this.data.position}get path(){return this.currentLine?.path??""}calcDistance(t){return this.currentLine?.calcDistance(t)??Number.MAX_SAFE_INTEGER}get bounds(){return this.currentLine?.bounds??new M.Ae}update(){this.syncContributions();let t=this.data.version;this.updatePosition();let e=this.data.version;if(t!==e)this.data.version=e,this.currentLine?.update({fromPos:this.data.position.from,toPos:this.data.position.to})}get lineType(){return this.entity.renderType??this.entity.linesManager.lineType}updatePosition(){this.data.position.from=this.entity.from.getData(A).getOutputPoint(this.entity.info.fromPort),this.data.position.to=this.entity.info.drawingTo??this.entity.to?.getData(A)?.getInputPoint(this.entity.info.toPort)??{x:this.data.position.from.x,y:this.data.position.from.y},this.data.version=[this.lineType,this.data.position.from.x,this.data.position.from.y,this.data.position.to.x,this.data.position.to.y].join("-")}get currentLine(){return this.data.contributions.get(this.lineType)}syncContributions(){if(this.entity.linesManager.contributionFactories.length!==this.data.contributions.size)this.entity.linesManager.contributionFactories.forEach(t=>{this.registerContribution(t)})}registerContribution(t){if(this.data.contributions.has(t.type))return;let e=new t(this.entity);this.data.contributions.set(t.type,e)}};P.type="WorkflowLineRenderData";var j=10,z=class t extends p.JH{constructor(t){super(t),this._processing=!1,this._hasError=!1,this.info={from:""},this.document=t.document,this.linesManager=t.linesManager,this.initInfo({from:t.from,to:t.to,drawingTo:t.drawingTo,fromPort:t.fromPort,toPort:t.toPort}),t.drawingTo&&(this.isDrawing=!0)}static portInfoToLineId(t){let{from:e,to:i,fromPort:r,toPort:s}=t;return`${e}_${r||""}-${i||""}_${s||""}`}get from(){return this._from}get to(){return this._to}get isHidden(){return this.highlightColor===this.linesManager.lineColor.hidden}get inContainer(){let t=t=>!!t?.parent&&"root"!==t.parent.flowNodeType;return t(this.from)||t(this.to)}get processing(){return this._processing}set processing(t){this._processing!==t&&(this._processing=t,this.fireChange())}get hasError(){return this._hasError}set hasError(t){this._hasError!==t&&(this._hasError=t,this.fireChange()),this._node&&(this._node.dataset.hasError=this.hasError?"true":"false")}setToPort(t){if(!this.isDrawing)throw Error("[setToPort] only support drawing line.");if(this.toPort!==t){if(t&&"input"===t.portType&&this.linesManager.canAddLine(this.fromPort,t,!0)){let{node:e,portID:i}=t;this._to=e,this.info.drawingTo=void 0,this.info.isDefaultLine=!1,this.info.to=e.id,this.info.toPort=i}else this._to=void 0,this.info.to=void 0,this.info.toPort="";this.fireChange()}}set drawingTo(t){let e=this.info.drawingTo;if(!t){this.info.drawingTo=void 0,this.fireChange();return}(!e||t.x!==e.x||t.y!==e.y)&&(this.info.to=void 0,this.info.isDefaultLine=!1,this.info.drawingTo=t,this.fireChange())}get drawingTo(){return this.info.drawingTo}get highlightColor(){return this.info.highlightColor||""}set highlightColor(t){this.info.highlightColor!==t&&(this.info.highlightColor=t,this.fireChange())}get bounds(){return this.getData(P).bounds}getHoverDist(t){return this.getData(P).calcDistance(t)}get fromPort(){return this.from.getData(A).getPortEntityByKey("output",this.info.fromPort)}get toPort(){if(!!this.to)return this.to.getData(A).getPortEntityByKey("input",this.info.toPort)}get position(){return this.getData(P).position}get reverse(){return this.linesManager.isReverseLine(this)}get hideArrow(){return this.linesManager.isHideArrowLine(this)}get flowing(){return this.linesManager.isFlowingLine(this)}get disabled(){return this.linesManager.isDisabledLine(this)}get vertical(){return this.linesManager.isVerticalLine(this)}get renderType(){return this.linesManager.setLineRenderType(this)}get className(){return this.linesManager.setLineClassName(this)??""}get color(){return this.linesManager.getLineColor(this)}initInfo(t){!(0,b.Z)(t,this.info)&&(this.info=t,this._from=this.document.getNode(t.from),this._to=t.to?this.document.getNode(t.to):void 0,this.fireChange())}validate(){let{fromPort:t,toPort:e}=this;this.validateSelf(),t?.validate(),e?.validate()}validateSelf(){let{fromPort:t,toPort:e}=this;t&&(this.hasError=this.linesManager.isErrorLine(t,e))}is(e){return e instanceof t?this===e:t.portInfoToLineId(e)===this.id}canRemove(t){return this.linesManager.canRemove(this,t)}get node(){return this._node?this._node:(this._node=M.xF.createDivWithClass("gedit-flow-activity-line"),this._node.dataset.testid="sdk.workflow.canvas.line",this._node.dataset.lineId=this.id,this._node.dataset.fromNodeId=this.from.id,this._node.dataset.fromPortId=this.fromPort?.id??"",this._node.dataset.toNodeId=this.to?.id??"",this._node.dataset.toPortId=this.toPort?.id??"",this._node.dataset.hasError=this.hasError?"true":"false",this._node)}toJSON(){let t={sourceNodeID:this.info.from,targetNodeID:this.info.to,sourcePortID:this.info.fromPort,targetPortID:this.info.toPort};return!t.sourcePortID&&delete t.sourcePortID,!t.targetPortID&&delete t.targetPortID,t}fireRender(){this.fireChange()}};z.type=T;var V=z,B=class{get onSelectionChanged(){return this.selectionService.onSelectionChanged}get selection(){return this.selectionService.selection}set selection(t){this.selectionService.selection=t}get activatedNode(){let{selectedNodes:t}=this;if(1===t.length)return t[0]}isSelected(t){return this.selectionService.selection.some(e=>e.id===t)}isActivated(t){return this.activatedNode?.id===t}get selectedNodes(){return this.selectionService.selection.filter(t=>t instanceof L)}selectNode(t){this.selectionService.selection=[t]}toggleSelect(t){this.selectionService.selection.includes(t)?this.selectionService.selection=this.selectionService.selection.filter(e=>e!==t):this.selectionService.selection=this.selectionService.selection.concat(t)}select(t){this.selectionService.selection=[t]}clear(){this.selectionService.selection=[]}async selectNodeAndScrollToView(t,e){this.selectNodeAndFocus(t);await (0,M.gw)(30);let i={entities:[t]};if(e){let e=M.Ae.enlarge([t.getData(p.VO).bounds]).pad(30,30),r=this.playground.config.getViewport(!1),s=M.rM.fixSize(e,r);i.zoom=s,i.scrollToCenter=!0,i.easing=!0}return this.playground.config.scrollToView(i)}selectNodeAndFocus(t){this.select(t),this.playground.node.focus()}};g([(0,D.f3)(p.z2)],B.prototype,"selectionService",2),g([(0,D.f3)(p.XQ)],B.prototype,"playground",2),B=g([(0,D.b2)()],B);var F=class{constructor(){this.onHoveredChangeEmitter=new M.Q5,this.onHoveredChange=this.onHoveredChangeEmitter.event,this.hoveredPos={x:0,y:0},this.hoveredKey=""}updateHoveredKey(t){this.hoveredKey!==t&&(this.hoveredKey=t,this.onHoveredChangeEmitter.fire(t))}clearHovered(){this.updateHoveredKey("")}isHovered(t){return t===this.hoveredKey}isSomeHovered(){return!!this.hoveredKey}get hoveredNode(){return this.entityManager.getEntityById(this.hoveredKey)}};g([(0,D.f3)(p.v2)],F.prototype,"entityManager",2),F=g([(0,D.b2)()],F);var Y=Symbol("WorkflowDocumentOptions"),U={cursors:{grab:'url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAyMCAyMSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0xMC40ODczIDIuNjIzNzhDOS45MDczMSAyLjYyMzc4IDkuNDM3MTMgMy4wOTM5NiA5LjQzNzEzIDMuNjczOTZWNS4xNDM3NkM5LjM5NDI4IDQuNDAyNzQgOC43Nzk3OCAzLjgxNTA0IDguMDI4MDIgMy44MTUwNEM3LjI0ODQ4IDMuODE1MDQgNi42MTY1MyA0LjQ0Njk5IDYuNjE2NTMgNS4yMjY1M1YxMS44Mjg5TDUuNjc0MTggMTEuMDA0OUM1LjE1NDg3IDEwLjU1MDkgNC40MDk1IDEwLjQ2MzYgMy43OTkzOCAxMC43ODU1TDMuNjk2OTQgMTAuODM5NkMzLjA2MjE3IDExLjE3NDUgMi45MjI2IDEyLjAyMjggMy40MTY2MiAxMi41NDM0TDcuMzM5NTkgMTYuNjc3NVYxNy4zMjU5QzcuMzM5NTkgMTcuNzg2MiA3LjcxMjY5IDE4LjE1OTMgOC4xNzI5MiAxOC4xNTkzSDEzLjgwODRDMTQuMjY4NyAxOC4xNTkzIDE0LjY0MTcgMTcuNzg2MiAxNC42NDE3IDE3LjMyNTlWMTYuNzkzNUMxNS44MDk0IDE1LjY0ODUgMTYuNDY3MyAxNC4wODE5IDE2LjQ2NzMgMTIuNDQ2NVYxMS40OTY3TDE2LjQ2NzEgNi42MzY4NUMxNi40NjcxIDUuOTU2MyAxNS45MTU0IDUuNDA0NjEgMTUuMjM0OCA1LjQwNDYxQzE0LjU1NDMgNS40MDQ2MSAxNC4wMDI2IDUuOTU2MyAxNC4wMDI2IDYuNjM2ODVMMTQuMDAyMSA1LjA0NzI4QzE0LjAwMjEgNC4zNjY3MyAxMy40NTA0IDMuODE1MDQgMTIuNzY5OCAzLjgxNTA0QzEyLjA4OTMgMy44MTUwNCAxMS41Mzc2IDQuMzY2NzMgMTEuNTM3NiA1LjA0NzI4TDExLjUzNzUgMy42NzM5NUMxMS41Mzc1IDMuMDkzOTYgMTEuMDY3MyAyLjYyMzc4IDEwLjQ4NzMgMi42MjM3OFoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMTAuNDg3NCAxLjM3NDAyQzExLjM2MTIgMS4zNzQwMiAxMi4xMjExIDEuODYxMTggMTIuNTEwNSAyLjU3ODY4QzEyLjU5NTggMi41Njk4MyAxMi42ODIzIDIuNTY1MjggMTIuNzcgMi41NjUyOEMxMy44Mjc4IDIuNTY1MjggMTQuNzMxMSAzLjIyNzAxIDE1LjA4ODUgNC4xNTkxMUMxNS4xMzcgNC4xNTYyOSAxNS4xODU4IDQuMTU0ODYgMTUuMjM1IDQuMTU0ODZDMTYuNjA1OSA0LjE1NDg2IDE3LjcxNzIgNS4yNjYxOSAxNy43MTcyIDYuNjM3MDlMMTcuNzE3NCAxMi40NDY3QzE3LjcxNzQgMTQuMjM1NSAxNy4wNjQ0IDE1Ljk1NTkgMTUuODkxOSAxNy4yOTA0VjE3LjMyNjJDMTUuODkxOSAxOC40NzY4IDE0Ljk1OTEgMTkuNDA5NSAxMy44MDg1IDE5LjQwOTVIOC4xNzMwNkM3LjAyMjQ3IDE5LjQwOTUgNi4wODk3MyAxOC40NzY4IDYuMDg5NzMgMTcuMzI2MlYxNy4xNzY0TDIuNTEwMDMgMTMuNDA0MUMxLjQ0NTk5IDEyLjI4MjggMS43NDY2IDEwLjQ1NTUgMy4xMTM3OSA5LjczNDI0TDMuMjE2MjQgOS42ODAxOUMzLjg5MTY4IDkuMzIzODMgNC42NjE4NSA5LjI1NDAxIDUuMzY2NjYgOS40NTE5OFY1LjIyNjc4QzUuMzY2NjYgMy43NTY4NyA2LjU1ODI2IDIuNTY1MjggOC4wMjgxNiAyLjU2NTI4QzguMTcyOTMgMi41NjUyOCA4LjMxNDk5IDIuNTc2ODQgOC40NTM0NyAyLjU5OTA3QzguODM5NDMgMS44NzA0MiA5LjYwNTQ2IDEuMzc0MDIgMTAuNDg3NCAxLjM3NDAyWk0xMi40NDc2IDMuODU3ODdWOS40NzY0NkMxMi40NDc2IDkuNzI4NTIgMTIuMjQzMyA5LjkzMjg1IDExLjk5MTMgOS45MzI4NUMxMS43MzkyIDkuOTMyODUgMTEuNTM0OSA5LjcyODUyIDExLjUzNDkgOS40NzY0NlYzLjc5NjU1QzExLjUzNDkgMy43Nzk1NiAxMS41MzU4IDMuNzYyNzcgMTEuNTM3NiAzLjc0NjI2VjMuNjc0MkMxMS41Mzc2IDMuNDMyODIgMTEuNDU2MiAzLjIxMDQ2IDExLjMxOTMgMy4wMzMwOUMxMS4xMjcyIDIuNzg0MjggMTAuODI2MSAyLjYyNDAyIDEwLjQ4NzQgMi42MjQwMkMxMC4xMjM4IDIuNjI0MDIgOS44MDMzMiAyLjgwODg2IDkuNjE0ODMgMy4wODk3QzkuNTAyNjkgMy4yNTY3OSA5LjQzNzI2IDMuNDU3ODUgOS40MzcyNiAzLjY3NDJWMy43ODU3M0M5LjQzNzM1IDMuNzg5MzMgOS40MzczOSAzLjc5Mjk0IDkuNDM3MzkgMy43OTY1NVY5LjkwMTdDOS40MzczOSAxMC4xNTM3IDkuMjMzMDYgMTAuMzU4MSA4Ljk4MTAxIDEwLjM1ODFDOC43Mjg5NSAxMC4zNTgxIDguNTI0NjIgMTAuMTUzNyA4LjUyNDYyIDkuOTAxN1YzLjkwNTA3QzguNDE3NzMgMy44NjQ5IDguMzA0NjggMy44MzczMiA4LjE4NzI2IDMuODI0MTVDOC4xMzUwNCAzLjgxODI5IDguMDgxOTUgMy44MTUyOCA4LjAyODE2IDMuODE1MjhDNy4yNDg2MSAzLjgxNTI4IDYuNjE2NjYgNC40NDcyMyA2LjYxNjY2IDUuMjI2NzhWMTEuODI5Mkw1LjY3NDMxIDExLjAwNTJDNS41Nzg2OCAxMC45MjE2IDUuNDc1MzcgMTAuODUwNCA1LjM2NjY2IDEwLjc5MTlDNC44ODUwNiAxMC41MzI5IDQuMjk3MjggMTAuNTIzMSAzLjc5OTUyIDEwLjc4NThMMy42OTcwNyAxMC44Mzk4QzMuMDYyMzEgMTEuMTc0NyAyLjkyMjczIDEyLjAyMzEgMy40MTY3NSAxMi41NDM3TDcuMzM5NzMgMTYuNjc3N1YxNy4zMjYyQzcuMzM5NzMgMTcuNzg2NCA3LjcxMjgyIDE4LjE1OTUgOC4xNzMwNiAxOC4xNTk1SDEzLjgwODVDMTQuMjY4OCAxOC4xNTk1IDE0LjY0MTkgMTcuNzg2NCAxNC42NDE5IDE3LjMyNjJWMTYuNzkzOEMxNS43Mzc5IDE1LjcxOSAxNi4zODQ3IDE0LjI3MjggMTYuNDYgMTIuNzQ3QzE2LjQ2NDEgMTIuNjY0MSAxNi40NjY1IDEyLjU4MDkgMTYuNDY3MiAxMi40OTc1TDE2LjQ2NzQgMTIuNDQ2N0wxNi40NjcyIDYuNjM3MDlDMTYuNDY3MiA1Ljk2MjMgMTUuOTI0OCA1LjQxNDE5IDE1LjI1MjIgNS40MDQ5N0wxNS4yMzUgNS40MDQ4NkMxNS4xMjQ2IDUuNDA0ODYgMTUuMDE3NyA1LjQxOTM2IDE0LjkxNTkgNS40NDY1NlY5LjYwMjI2QzE0LjkxNTkgOS44NTQzMSAxNC43MTE2IDEwLjA1ODYgMTQuNDU5NSAxMC4wNTg2QzE0LjIwNzUgMTAuMDU4NiAxNC4wMDMxIDkuODU0MzEgMTQuMDAzMSA5LjYwMjI2VjYuNjA1MTRDMTQuMDAyOSA2LjYxNTc2IDE0LjAwMjcgNi42MjY0MSAxNC4wMDI3IDYuNjM3MDlWOS4yNzcwNUwxNC4wMDIyIDUuMDQ3NTJDMTQuMDAyMiA0Ljg2OTEzIDEzLjk2NDMgNC42OTk2IDEzLjg5NjEgNC41NDY1M0MxMy43MDY0IDQuMTIwNzIgMTMuMjgyMiAzLjgyMjM1IDEyLjc4NzYgMy44MTU0MUwxMi43NyAzLjgxNTI4QzEyLjY1ODQgMy44MTUyOCAxMi41NTA0IDMuODMwMSAxMi40NDc2IDMuODU3ODdaIiBmaWxsPSIjMUQxQzIzIi8+Cjwvc3ZnPg=="), auto',grabbing:'url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjEiIHZpZXdCb3g9IjAgMCAyMCAyMSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik02LjYxODE3IDUuNTk4NzVDNi42MTgxNyA0LjgxOTIgNy4yNTAxMiA0LjE4NzI2IDguMDI5NjcgNC4xODcyNkM4Ljc3ODczIDQuMTg3MjYgOS4zOTE1MiA0Ljc3MDc1IDkuNDM4MjkgNS41MDgwMUM5LjQ1OTkyIDQuOTQ3MSA5LjkyMTQ3IDQuNDk5MDIgMTAuNDg3NyA0LjQ5OTAyQzExLjA2NzcgNC40OTkwMiAxMS41Mzc4IDQuOTY5MiAxMS41Mzc4IDUuNTQ5MTlWOC43NjI0NkwxMS41Mzc5IDYuNzExNUMxMS41Mzc5IDYuMDMwOTUgMTIuMDg5NiA1LjQ3OTI2IDEyLjc3MDIgNS40NzkyNkMxMy40NTA3IDUuNDc5MjYgMTQuMDAyNCA2LjAzMDk1IDE0LjAwMjQgNi43MTE1TDE0LjAwMjQgOC43NjI0NkwxNC4wMDI5IDguMDE5ODNDMTQuMDAyOSA3LjMzOTI5IDE0LjU1NDYgNi43ODc1OSAxNS4yMzUyIDYuNzg3NTlDMTUuOTE1NyA2Ljc4NzU5IDE2LjQ2NzQgNy4zMzkyOCAxNi40Njc0IDguMDE5ODNWMTEuNDk3TDE2LjQ2NzUgMTIuNDQ2N0MxNi40Njc1IDE0LjA4MjEgMTUuODA5NiAxNS42NDg3IDE0LjY0MiAxNi43OTM4VjE3LjMyNjJDMTQuNjQyIDE3Ljc4NjQgMTQuMjY4OSAxOC4xNTk1IDEzLjgwODcgMTguMTU5NUg4LjE3MzE3QzcuNzEyOTMgMTguMTU5NSA3LjMzOTg0IDE3Ljc4NjQgNy4zMzk4NCAxNy4zMjYyVjE1Ljk0MjRMNS4zNDU2MiAxNC43NTM0QzQuNTg5MjQgMTQuMzAyNCA0LjEyNTkxIDEzLjQ4NjcgNC4xMjU4OSAxMi42MDYxTDQuMTI1ODMgOS4yODM4M0M0LjEyNTgyIDguOTU0MjcgNC4zMjAwMyA4LjY1NTY2IDQuNjIxMjkgOC41MjIwNUw2LjYxODE3IDcuNjM2MzRWNS41OTg3NVoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMTAuNDg3OCAzLjI0OTAyQzExLjI3OTYgMy4yNDkwMiAxMS45Nzc4IDMuNjQ5MDIgMTIuMzkxNyA0LjI1Nzk2QzEyLjUxNTEgNC4yMzkwNiAxMi42NDE2IDQuMjI5MjYgMTIuNzcwMyA0LjIyOTI2QzEzLjcyMjQgNC4yMjkyNiAxNC41NDkzIDQuNzY1MzEgMTQuOTY1NyA1LjU1MjA3QzE1LjA1NDMgNS41NDI1IDE1LjE0NDIgNS41Mzc1OSAxNS4yMzUzIDUuNTM3NTlDMTYuNjA2MiA1LjUzNzU5IDE3LjcxNzYgNi42NDg5MyAxNy43MTc2IDguMDE5ODNMMTcuNzE3NyAxMi40NDY3QzE3LjcxNzcgMTQuMjM1NSAxNy4wNjQ3IDE1Ljk1NTkgMTUuODkyMSAxNy4yOTA0VjE3LjMyNjJDMTUuODkyMSAxOC40NzY4IDE0Ljk1OTQgMTkuNDA5NSAxMy44MDg4IDE5LjQwOTVIOC4xNzMzMkM3LjAyMjczIDE5LjQwOTUgNi4wODk5OCAxOC40NzY4IDYuMDg5OTggMTcuMzI2MlYxNi42NTI0TDQuNzA1NjMgMTUuODI3QzMuNTcxMDYgMTUuMTUwNSAyLjg3NjA3IDEzLjkyNzEgMi44NzYwNCAxMi42MDYxTDIuODc1OTggOS4yODM4NUMyLjg3NTk2IDguNDU5OTYgMy4zNjE0OSA3LjcxMzQ1IDQuMTE0NjIgNy4zNzk0TDUuMzY4MzIgNi44MjMzM1Y1LjU5ODc1QzUuMzY4MzIgNC4xMjg4NSA2LjU1OTkxIDIuOTM3MjYgOC4wMjk4MiAyLjkzNzI2QzguNjA4MzEgMi45MzcyNiA5LjE0MzU1IDMuMTIxNyA5LjU4MDA1IDMuNDM1MDVDOS44NTg1MyAzLjMxNTMyIDEwLjE2NTQgMy4yNDkwMiAxMC40ODc4IDMuMjQ5MDJaTTEyLjQ0NzkgNS41MjE4NlY5LjQ3NTU3QzEyLjQ0NzkgOS43Mjc2MiAxMi4yNDM2IDkuOTMxOTUgMTEuOTkxNiA5LjkzMTk1QzExLjc1NjggOS45MzE5NSAxMS41NjM0IDkuNzU0NjUgMTEuNTM4IDkuNTI2NjNDMTEuNTM2MSA5LjUwOTg3IDExLjUzNTIgOS40OTI4MyAxMS41MzUyIDkuNDc1NTdWNS40NzE1OEMxMS41MTU0IDUuMjAwODMgMTEuMzkzIDQuOTU4NTggMTEuMjA2NiA0Ljc4MzU4QzExLjAxODggNC42MDcxMSAxMC43NjU5IDQuNDk5MDIgMTAuNDg3OCA0LjQ5OTAyQzEwLjQ3NjYgNC40OTkwMiAxMC40NjU0IDQuNDk5MTkgMTAuNDU0MiA0LjQ5OTU0QzkuOTAzNDcgNC41MTY4NCA5LjQ1OTY0IDQuOTU4MjQgOS40Mzg0NCA1LjUwODAxQzkuNDM4MiA1LjUwNDMgOS40Mzc5NSA1LjUwMDU4IDkuNDM3NjkgNS40OTY4OFY5LjkwMjQzQzkuNDM3NjkgMTAuMTU0NSA5LjIzMzM2IDEwLjM1ODggOC45ODEzMSAxMC4zNTg4QzguNzI5MjUgMTAuMzU4OCA4LjUyNDkyIDEwLjE1NDUgOC41MjQ5MiA5LjkwMjQzVjQuMjc2NTNDOC4zNzA4NiA0LjIxODgyIDguMjA0MDIgNC4xODcyNiA4LjAyOTgyIDQuMTg3MjZDNy4yNTAyNyA0LjE4NzI2IDYuNjE4MzIgNC44MTkyIDYuNjE4MzIgNS41OTg3NUw2LjYxODI3IDkuOTc1OTlDNi42MTgyNyAxMC4yMjggNi40MTM5NCAxMC40MzI0IDYuMTYxODkgMTAuNDMyNEM1LjkwOTgzIDEwLjQzMjQgNS43MDU1IDEwLjIyOCA1LjcwNTUgOS45NzU5OVY4LjA0MTIyTDQuNjIxNDQgOC41MjIwNUM0LjMyMDE4IDguNjU1NjYgNC4xMjU5NyA4Ljk1NDI3IDQuMTI1OTggOS4yODM4M0w0LjEyNjA0IDEyLjYwNjFDNC4xMjYwNiAxMy40ODY3IDQuNTg5MzkgMTQuMzAyNCA1LjM0NTc2IDE0Ljc1MzRMNy4zMzk5OCAxNS45NDI0VjE3LjMyNjJDNy4zMzk5OCAxNy43ODY0IDcuNzEzMDggMTguMTU5NSA4LjE3MzMyIDE4LjE1OTVIMTMuODA4OEMxNC4yNjkgMTguMTU5NSAxNC42NDIxIDE3Ljc4NjQgMTQuNjQyMSAxNy4zMjYyVjE2Ljc5MzhDMTUuNzM4MSAxNS43MTkgMTYuMzg1IDE0LjI3MjggMTYuNDYwMyAxMi43NDdDMTYuNDY0NiAxMi42NiAxNi40NjcgMTIuNTcyOCAxNi40Njc2IDEyLjQ4NTRMMTYuNDY3NyAxMi40NDY3TDE2LjQ2NzYgOC4wMTk4M0MxNi40Njc2IDcuMzQ1MDQgMTUuOTI1MiA2Ljc5NjkzIDE1LjI1MjUgNi43ODc3MUwxNS4yMzUzIDYuNzg3NTlDMTUuMTI1IDYuNzg3NTkgMTUuMDE4IDYuODAyMSAxNC45MTYyIDYuODI5MzFWOS42MDEzNkMxNC45MTYyIDkuODUzNDIgMTQuNzExOSAxMC4wNTc3IDE0LjQ1OTggMTAuMDU3N0MxNC4yMDc4IDEwLjA1NzcgMTQuMDAzNCA5Ljg1MzQxIDE0LjAwMzQgOS42MDEzNlY3Ljk4OTg1QzE0LjAwMzIgNy45OTk4MiAxNC4wMDMxIDguMDA5ODEgMTQuMDAzMSA4LjAxOTgzTDE0LjAwMzQgOS42MDEzNkwxNC4wMDI1IDYuNzExNUMxNC4wMDI1IDYuNDQ5NzQgMTMuOTIwOSA2LjIwNzA1IDEzLjc4MTggNi4wMDc0OEMxMy41NjIgNS42OTI0MiAxMy4xOTg5IDUuNDg0ODMgMTIuNzg3IDUuNDc5MzdMMTIuNzcwMyA1LjQ3OTI2QzEyLjY1ODggNS40NzkyNiAxMi41NTA3IDUuNDk0MDggMTIuNDQ3OSA1LjUyMTg2WiIgZmlsbD0iIzFEMUMyMyIvPgo8L3N2Zz4="), auto'},toNodeJSON(t){let e=t.getData(S.fu)?.getError();if(e)throw e;let i=t.getData(p.VO),r=function(t){let e=t.getData(S.Ps);if(e&&t.getNodeRegistry().formMeta)return e.toJSON()}(t),s={},n=t.getNodeMeta(),o=n.subCanvas?.(t);if(o?.isCanvas===!1){let{x:t,y:e}=o.canvasNode.getData(E.eG).transform.position;s.canvasPosition={x:t,y:e}}return{id:t.id,type:t.flowNodeType,meta:{position:{x:i.position.x,y:i.position.y},...s},data:r}}},G=class{constructor(){this.toDispose=new M.K4,this._lineType=0,this.onAvailableLinesChangeEmitter=new M.Q5,this.onForceUpdateEmitter=new M.Q5,this.onAvailableLinesChange=this.onAvailableLinesChangeEmitter.event,this.onForceUpdate=this.onForceUpdateEmitter.event,this.contributionFactories=[],this.isDrawing=!1}init(t){this.document=t}forceUpdate(){this.onForceUpdateEmitter.fire()}get lineType(){return this._lineType}get lineColor(){let t={default:"#4d53e8",error:"red",hidden:"transparent",drawing:"#5DD6E3",hovered:"#37d0ff",selected:"#37d0ff"};return this.options.lineColor&&Object.assign(t,this.options.lineColor),t}switchLineType(t){return void 0===t&&(t=0===this._lineType?1:0),t!==this._lineType&&(this._lineType=t,this.getAllLines().forEach(t=>{t.getData(P).update()}),window.requestAnimationFrame(()=>{this.entityManager.fireEntityChanged(V.type)})),this._lineType}getAllLines(){return this.entityManager.getEntities(V)}hasLine(t){return!!this.entityManager.getEntityById(V.portInfoToLineId(t))}getLine(t){return this.entityManager.getEntityById(V.portInfoToLineId(t))}replaceLine(t,e){let i=this.getLine(t);return i&&i.dispose(),this.createLine(e)}createLine(t){let{from:e,to:i,drawingTo:r,fromPort:s,toPort:n}=t,o=!!(e&&i),a=t.key||V.portInfoToLineId(t),h=this.entityManager.getEntityById(a);if(h)return h.highlightColor="",h.validate(),h;let l=this.entityManager.getEntityById(e)?.getData(R),d=i?this.entityManager.getEntityById(i).getData(R):void 0;if(!!l)return this.isDrawing=!!r,h=this.entityManager.createEntity(V,{id:a,document:this.document,linesManager:this,from:e,fromPort:s,toPort:n,to:i,drawingTo:r}),this.registerData(h),l.addLine(h),d?.addLine(h),h.onDispose(()=>{r&&(this.isDrawing=!1),l.removeLine(h),d?.removeLine(h),h.validate()}),h.toDispose.push(M.JT.create(()=>{o&&this.onAvailableLinesChangeEmitter.fire({type:"DELETE_LINE",toJSON:()=>h.toJSON(),entity:h})})),o&&this.onAvailableLinesChangeEmitter.fire({type:"ADD_LINE",toJSON:()=>h.toJSON(),entity:h}),h.validate(),h}getCloseInLineFromMousePos(t,e=8){let i,r;return this.getAllLines().forEach(s=>{let n=s.getHoverDist(t);n<=e&&(!r||r>=n)&&(r=n,i=s)}),i}dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}isErrorLine(t,e){return!!this.options.isErrorLine&&this.options.isErrorLine(t,e,this)}isReverseLine(t){return!!this.options.isReverseLine&&this.options.isReverseLine(t)}isHideArrowLine(t){return!!this.options.isHideArrowLine&&this.options.isHideArrowLine(t)}isFlowingLine(t){return!!this.options.isFlowingLine&&this.options.isFlowingLine(t)}isDisabledLine(t){return!!this.options.isDisabledLine&&this.options.isDisabledLine(t)}isVerticalLine(t){return!!this.options.isVerticalLine&&this.options.isVerticalLine(t)}setLineRenderType(t){if(this.options.setLineRenderType)return this.options.setLineRenderType(t)}setLineClassName(t){if(this.options.setLineClassName)return this.options.setLineClassName(t)}getLineColor(t){return t.isHidden?this.lineColor.hidden:t.hasError?this.lineColor.error:t.highlightColor?t.highlightColor:t.drawingTo?this.lineColor.drawing:this.hoverService.isHovered(t.id)?this.lineColor.hovered:this.selectService.isSelected(t.id)?this.lineColor.selected:this.lineColor.default}canAddLine(t,e,i){return t!==e&&t.node!==e.node&&"output"===t.portType&&"input"===e.portType&&!e.disabled&&(this.options.canAddLine?this.options.canAddLine(t,e,this,i):t.node!==e.node)}toJSON(){return this.getAllLines().filter(t=>!t.isDrawing).map(t=>t.toJSON())}getPortById(t){return this.entityManager.getEntityById(t)}canRemove(t,e,i){return(!this.options||!this.options.canDeleteLine||!!this.options.canDeleteLine(t,e,i))&&!0}canReset(t,e,i){return(!this.options||!this.options.canResetLine||!!this.options.canResetLine(t,e,i,this))&&!0}getPortFromMousePos(t){let e=this.entityManager.getEntities(O).filter(t=>"root"!==t.node.flowNodeType).find(e=>e.isHovered(t.x,t.y));if(e){let i=this.document.getAllNodes().slice().reverse().filter(t=>e.node?.parent?.id!==t.id).find(e=>e.getData(p.VO).contains(t.x,t.y));if(i&&i!==e.node)return}return e}getNodeFromMousePos(t){let e=this.document.getAllNodes(),i=[],{selection:r}=this.selectService,s=this.entityManager.getEntity(p.ER)?.config?.zoom||1;if(e.forEach(e=>{let{bounds:r}=e.getData(E.eG);r.clone().pad(4/s).contains(t.x,t.y)&&i.push(e)}),r?.length){let t=i.filter(t=>r.some(e=>t.id===e.id));if(t?.length)return(0,N.Z)(t)}return(0,N.Z)(i)}registerContribution(t){return this.contributionFactories.push(t),this}registerData(t){t.addData(P)}};g([(0,D.f3)(F)],G.prototype,"hoverService",2),g([(0,D.f3)(B)],G.prototype,"selectService",2),g([(0,D.f3)(p.v2)],G.prototype,"entityManager",2),g([(0,D.f3)(Y)],G.prototype,"options",2),G=g([(0,D.b2)()],G);var Q="free-layout",X=class{constructor(){this.name=Q}get document(){return this.documentProvider()}update(){this.document.root.getData(E.eG)?.localDirty&&this.document.root.clearMemoGlobal()}syncTransform(t){let e=t.getData(E.eG);if(!e.localDirty)return;if(t.clearMemoGlobal(),t.clearMemoLocal(),e.transform.update({size:e.data.size}),!!t.parent)t.parent.clearMemoGlobal(),t.parent.clearMemoLocal(),t.parent.getData(E.eG).transform.fireChange()}getPadding(t){let{padding:e}=t.getNodeMeta(),i=t.getData(E.eG);return e?"function"==typeof e?e(i):e:M.sI.empty()}getInitScroll(t){let e=M.Ae.enlarge(this.document.getAllNodes().map(t=>t.getData(p.VO).bounds)).pad(30,30),i=this.playgroundConfig.getViewport(!1),r=M.rM.fixSize(e,i);return{scrollX:(e.x+e.width/2)*r-this.playgroundConfig.config.width/2,scrollY:(e.y+e.height/2)*r-this.playgroundConfig.config.height/2}}getDefaultInputPoint(t){return t.getData(p.VO).bounds.leftCenter}getDefaultOutputPoint(t){return t.getData(p.VO).bounds.rightCenter}getDefaultNodeOrigin(){return{x:.5,y:0}}};g([(0,D.f3)(p.ER)],X.prototype,"playgroundConfig",2),g([(0,D.f3)(E.JU)],X.prototype,"documentProvider",2),X=g([(0,D.b2)()],X);var W=(0,C.kP)("1234567890",5),$=Symbol("WorkflowDocumentProvider"),J=class extends E.pQ{constructor(){super(...arguments),this._onContentChangeEmitter=new M.Q5,this.onLoadedEmitter=new M.Q5,this.onContentChange=this._onContentChangeEmitter.event,this._onReloadEmitter=new M.Q5,this.onReload=this._onReloadEmitter.event,this.disposed=!1,this.onLoaded=this.onLoadedEmitter.event,this._loading=!1,this.options={}}get loading(){return this._loading}async fitView(t){return w(this,this.playgroundConfig,t).then(()=>{this.linesManager.forceUpdate()})}init(){super.init(),this.currentLayoutKey=this.options.defaultLayout||Q,this.linesManager.init(this),this.playgroundConfig.getCursors=()=>this.options.cursors,this.linesManager.onAvailableLinesChange(t=>this.fireContentChange(t)),this.playgroundConfig.onReadonlyOrDisabledChange(({readonly:t})=>{this.nodeEngineContext&&(this.nodeEngineContext.readonly=t)})}async load(){this._loading=!0,await super.load(),this._loading=!1,this.onLoadedEmitter.fire()}async reload(t,e=0){this._loading=!0,this.clear(),this.fromJSON(t),await (0,M.gw)(e),this._loading=!1,this._onReloadEmitter.fire(this)}fromJSON(t,e=!0){let{flattenJSON:i,nodeBlocks:r,nodeEdges:s}=this.flatJSON(t),n=this.nestJSON(i,r,s);this.entityManager.changeEntityLocked=!0,this.renderJSON(n),this.entityManager.changeEntityLocked=!1,this.transformer.loading=!1,e&&this.fireRender()}clear(){this.getAllNodes().map(t=>t.dispose()),this.linesManager.getAllLines().map(t=>t.dispose()),this.getAllPorts().map(t=>t.dispose()),this.selectServices.clear()}createWorkflowNode(t,e=!1,i){let r=this.getNode(t.id),s=this.getNode(i??this.root.id)??this.root,n=this.addNode({...t,parent:s},void 0,!0),{formMeta:o}=n.getNodeRegistry(),a=n.getNodeMeta(),h=n.getData(S.Ps),l=n.getData(E.eG),d=this.layout;l.onDataChange(()=>{d.syncTransform(n)});let{position:c}=a;!c&&(c=this.getNodeDefaultPosition(t.type)),n.getData(p.VO).update({position:c}),o&&h&&(h.createForm(o,t.data),h.onDataChange(()=>{this.fireContentChange({type:"NODE_DATA_CHANGE",toJSON:()=>h.toJSON(),entity:n})}));let u=n.getData(p.WV);u.onDataChange(()=>{this.fireContentChange({type:"MOVE_NODE",toJSON:()=>u.toJSON(),entity:n})});let g=this.getNodeSubCanvas(n);return!r&&!g?.isCanvas&&(this.fireContentChange({type:"ADD_NODE",entity:n,toJSON:()=>this.toNodeJSON(n)}),n.toDispose.push(M.JT.create(()=>{this.fireContentChange({type:"DELETE_NODE",entity:n,toJSON:()=>this.toNodeJSON(n)})})),n.toDispose.push(M.JT.create(()=>{if(!n.parent||n.parent.flowNodeType===E.Sy.ROOT)return;let t=n.parent.getData(E.eG);setTimeout(()=>{t.fireChange()},0)}))),t.blocks&&this.renderJSON({nodes:t.blocks,edges:t.edges??[]},{parent:n,isClone:e}),g&&(g.canvasNode.getData(p.VO).update({position:g.parentNode.getNodeMeta()?.canvasPosition}),g.parentNode.onDispose(()=>{g.canvasNode.dispose()}),g.canvasNode.onDispose(()=>{g.parentNode.dispose()})),this.onNodeCreateEmitter.fire({node:n,data:t}),n}getNodeDefaultPosition(t){let{size:e}=this.getNodeRegistry(t).meta||{},i=this.playgroundConfig.getViewport(!0).center;return e&&(i={x:i.x,y:i.y-e.height/2}),function(t,e,i){let{x:r,y:s}=e,n=t.getAllNodes().map(t=>{let e=t.getData(p.VO);return{x:e.position.x,y:e.position.y}}).sort((t,e)=>t.y-e.y);for(let t of n){let{x:e,y:i}=t;if(s-i<-3)break;let n=Math.abs(s-i);3>=Math.abs(r-e)&&n<=3&&(r+=30,s+=30)}return{x:r,y:s}}(this,i)}createWorkflowNodeByType(t,e,i={},r){let s=i.id;if(void 0===s)do s=`1${W()}`;while(this.entityManager.getEntityById(s));else if(this.entityManager.getEntityById(s))throw Error(`[WorkflowDocument.createWorkflowNodeByType] Node Id "${s}" duplicated.`);return this.createWorkflowNode({id:s,type:t,meta:{position:e,...i?.meta},data:i?.data,blocks:i?.blocks,edges:i?.edges},!1,r)}getAllNodes(){return this.entityManager.getEntities(L).filter(t=>t.id!==E.Sy.ROOT)}getAllPorts(){return this.entityManager.getEntities(O).filter(t=>t.node.id!==E.Sy.ROOT)}getAssociatedNodes(){let t=this.getAllNodes(),e=this.linesManager.getAllLines().filter(t=>t.from&&t.to).map(t=>({from:t.from.id,to:t.to.id})),i=t.find(t=>t.isStart).id,r=t.find(t=>t.isNodeEnd).id,s=new Set([r,...t.filter(t=>t.parent?.flowNodeType===E.Sy.SUB_CANVAS).map(t=>t.id)]),n=t=>{if(!s.has(t))s.add(t),e.reduce((e,{from:i,to:r})=>(i===t&&!s.has(r)&&e.push(r),e),[]).forEach(n)};return n(i),t.filter(t=>s.has(t.id))}fireRender(){this.entityManager.fireEntityChanged(L.type),this.entityManager.fireEntityChanged(V.type),this.entityManager.fireEntityChanged(O.type)}fireContentChange(t){if(!this._loading&&!this.disposed&&!this.entityManager.changeEntityLocked)this._onContentChangeEmitter.fire(t)}toNodeJSON(t){let e=this.getNodeSubCanvas(t);if(e?.isCanvas===!0)return this.toNodeJSON(e.parentNode);let i=this.toNodeJSONFromOptions(t),r=this.getNodeChildren(t),s=r.map(t=>this.toNodeJSON(t)),n=new Map;r.forEach(t=>{let e=t.getData(R);[...e.inputLines,...e.outputLines].filter(Boolean).forEach(t=>{let e=this.toLineJSON(t);if(!(!e||n.has(t.id)))n.set(t.id,e)})});let o=Array.from(n.values());return s.length>0&&(i.blocks=s),o.length>0&&(i.edges=o),i}toNodeJSONFromOptions(t){return this.options.toNodeJSON?this.options.toNodeJSON(t):U.toNodeJSON(t)}copyNode(t,e,i,r){let s=this.toNodeJSON(t);return i&&(s=i(s)),r=r||{x:s.meta.position.x+30,y:s.meta.position.y+30},this.createWorkflowNode({id:e||`1${W()}`,type:t.flowNodeType,meta:{...s.meta,position:r},data:s.data,blocks:s.blocks,edges:s.edges},!0,t.parent?.id)}copyNodeFromJSON(t,e,i,r,s){return r=r||{x:e.meta.position.x+30,y:e.meta.position.y+30},this.createWorkflowNode({id:i||`1${W()}`,type:t,meta:{...e.meta,position:r},data:e.data,blocks:e.blocks,edges:e.edges},!0,s)}canRemove(t,e){return!t.getNodeMeta().deleteDisable&&(!this.options.canDeleteNode||!!this.options.canDeleteNode(t,e))&&!0}isErrorPort(t){return"function"==typeof this.options.isErrorPort&&this.options.isErrorPort(t)}toJSON(){let t=this.toNodeJSON(this.root);return{nodes:t.blocks??[],edges:t.edges??[]}}dispose(){if(!this.disposed)super.dispose(),this.disposed=!0,this._onReloadEmitter.dispose()}getEdgeID(t){return V.portInfoToLineId({from:t.sourceNodeID,to:t.targetNodeID,fromPort:t.sourcePortID,toPort:t.targetPortID})}flatJSON(t={nodes:[],edges:[]}){let e=new Map,i=new Map,r=t.nodes??[],s=t.edges??[],n=[...r],o=[...s],a=r.map(t=>t.id),h=s.map(t=>this.getEdgeID(t));return e.set(E.Sy.ROOT,a),i.set(E.Sy.ROOT,h),r.forEach(t=>{let{blocks:r,edges:s}=t;if(r){n.push(...r);let i=[];r.forEach(t=>{i.push(t.id)}),e.set(t.id,i),delete t.blocks}if(s){o.push(...s);let e=[];s.forEach(t=>{let i=this.getEdgeID(t);e.push(i)}),i.set(t.id,e),delete t.edges}}),{flattenJSON:{nodes:n,edges:o},nodeBlocks:e,nodeEdges:i}}nestJSON(t,e,i){let r={nodes:[],edges:[]},s=new Map,n=new Map,o=new Set(e.get(E.Sy.ROOT)??[]),a=new Set(i.get(E.Sy.ROOT)??[]);return t.nodes.forEach(t=>{s.set(t.id,t)}),t.edges.forEach(t=>{let e=this.getEdgeID(t);n.set(e,t)}),t.nodes.forEach(t=>{if(o.has(t.id)&&r.nodes.push(t),e.has(t.id)){let i=e.get(t.id).map(t=>s.get(t)).filter(Boolean);t.blocks=i}if(i.has(t.id)){let e=i.get(t.id).map(t=>n.get(t)).filter(Boolean);t.edges=e}}),t.edges.forEach(t=>{let e=this.getEdgeID(t);a.has(e)&&r.edges.push(t)}),r}renderJSON(t,e){let{parent:i=this.root,isClone:r=!1}=e??{},s=this.getNodeSubCanvas(i)?.canvasNode.id??i.id;t.nodes.forEach(t=>{this.createWorkflowNode(t,r,s)}),t.edges.forEach(t=>this.createWorkflowLine(t,s))}getNodeSubCanvas(t){if(!t)return;let e=t.getNodeMeta();return e.subCanvas?.(t)}getNodeChildren(t){if(!t)return[];let e=this.getNodeSubCanvas(t);return(e?e.canvasNode.collapsedChildren:t.collapsedChildren).filter(e=>{let i=e.getNodeMeta();return!i.subCanvas?.(t)?.isCanvas}).filter(Boolean)}toLineJSON(t){let e=t.toJSON();if(!t.to||!t.info.to||!t.toPort)return;let i=this.getNodeSubCanvas(t.from),r=this.getNodeSubCanvas(t.to);return i&&!i.isCanvas&&r&&r.isCanvas?void 0:t.from===t.to.parent&&i?{...e,sourceNodeID:i.parentNode.id}:t.to===t.from.parent&&r?{...e,targetNodeID:r.parentNode.id}:e}createWorkflowLine(t,e){let i=this.getNode(t.sourceNodeID),r=this.getNode(t.targetNodeID);if(!i||!r)return;let s={from:t.sourceNodeID,fromPort:t.sourcePortID,to:t.targetNodeID,toPort:t.targetPortID};if(!e)return this.linesManager.createLine(s);let n=this.getNode(e);if(!n)return this.linesManager.createLine(s);let o=this.getNodeSubCanvas(n);return o?s.from===o.parentNode.id?this.linesManager.createLine({...s,from:o.canvasNode.id}):s.to===o.parentNode.id?this.linesManager.createLine({...s,to:o.canvasNode.id}):this.linesManager.createLine(s):this.linesManager.createLine(s)}};g([(0,D.f3)(G)],J.prototype,"linesManager",2),g([(0,D.f3)(p.ER)],J.prototype,"playgroundConfig",2),g([(0,p.el)()],J.prototype,"playgroundContext",2),g([(0,D.f3)(Y)],J.prototype,"options",2),g([(0,D.f3)(S.j0),(0,D.jt)()],J.prototype,"nodeEngineContext",2),g([(0,D.f3)(B)],J.prototype,"selectServices",2),g([(0,D.zY)()],J.prototype,"init",1),J=g([(0,D.b2)()],J);function H(t,e,i){return!!(!i||t>100||Math.abs(e.endPos.x-e.startPos.x)>=5||Math.abs(e.endPos.y-e.startPos.y)>=5)||!1}var K=class{constructor(){this._onDragLineEventEmitter=new M.Q5,this.onDragLineEventChange=this._onDragLineEventEmitter.event,this.isDragging=!1,this._nodesDragEmitter=new M.Q5,this.onNodesDrag=this._nodesDragEmitter.event,this._toDispose=new M.K4,this._droppableTransforms=[],this.posAdjusters=new Set,this._onDragLineEndCallbacks=new Map}init(){this._toDispose.pushAll([this._onDragLineEventEmitter,this._nodesDragEmitter])}dispose(){this._toDispose.dispose()}startDragSelectedNodes(t){let{selectedNodes:e}=this.selectService;if(0===e.length||this.playgroundConfig.readonly||this.playgroundConfig.disabled)return Promise.resolve(!1);let i=this.childrenOfContainer(e);i&&i.flowNodeType!==E.Sy.ROOT&&(e=[i]);let{altKey:r}=t,s=this.getNodesPosition(e),n=e.map(t=>{let e=t.getData(p.VO);return{x:e.position.x,y:e.position.y}}),o=!1,a=Date.now();return new p.s5({onDragStart:()=>{this.isDragging=!0},onDrag:t=>{if(!o&&H(Date.now()-a,t)&&(o=!0,r)){let t=e;t.length>0&&this.commandService.executeCommand("PASTE_NODES",t,!0).then(i=>{i&&Array.isArray(i)&&i.length>0&&(e=i,s=this.getNodesPosition(t),n=t.filter(t=>!t.getNodeMeta().copyDisable).map(t=>{let e=t.getData(p.VO);return{x:e.position.x,y:e.position.y}}))})}let i=this.getDragPosOffset({event:t,selectedNodes:e,startPosition:s});e.forEach((t,e)=>{let r=t.getData(p.VO),s=n[e],o={x:s.x+i.x,y:s.y+i.y};t.collapsedChildren?.length>0&&t.collapsedChildren.forEach(t=>{t.getData(E.eG).fireChange()}),r.update({position:o})})},onDragEnd:()=>{this.isDragging=!1,this._nodesDragEmitter.fire({type:"onDragEnd",nodes:e,startPositions:n,altKey:r})}}).start(t.clientX,t.clientY,this.playgroundConfig).then(()=>o)}async dropCard(t,e,i,r){let s=this.playgroundConfig.getPosFromMouseEvent(e);if(!this.playgroundConfig.getViewport().contains(s.x,s.y))return;let n=this.adjustSubNodePosition(t,r,s);return await this.document.createWorkflowNodeByType(t,n,i,r?.id)}async startDragCard(t,e,i,r){let s;let n={x:0,y:0},o=new M.cO,a=new p.s5({onDragStart:t=>{let i=e.currentTarget;s=r?r(t):i.cloneNode(!0);let o=i.getBoundingClientRect();n={x:o.left,y:o.top},M.xF.setStyle(s,{zIndex:1e3,position:"absolute",left:n.x,top:n.y,boxShadow:"0 6px 8px 0 rgba(28, 31, 35, .2)"}),document.body.appendChild(s),this.updateDroppableTransforms()},onDrag:t=>{let e=t.endPos.x-t.startPos.x,i=t.endPos.y-t.startPos.y,r=n.x+e,o=n.y+i;s.style.left=`${r}px`,s.style.top=`${o}px`;let{x:a,y:h}=this.playgroundConfig.getPosFromMouseEvent(t),l=new M.Ae(a,h,170,90),d=this._droppableTransforms.find(t=>{let{bounds:e,entity:i}=t,r=this.document.layout.getPadding(i),s=new M.Ae(e.x+r.left+r.right,e.y,e.width,e.height);return M.Ae.intersects(l,s)});this.updateDropNode(d?.entity)},onDragEnd:async e=>{let r=this._dropNode,a=await this.dropCard(t,e,i,r);if(this.clearDrop(),a)s.remove(),o.resolve(a);else{s.style.transition="all ease .2s",s.style.left=`${n.x}px`,s.style.top=`${n.y}px`;await (0,M.gw)(200),s.remove(),o.resolve()}}});return await a.start(e.clientX,e.clientY),o.promise}adjustSubNodePosition(t,e,i,r=!0){if(!i)return{x:0,y:0};if(!t||!e||e.flowNodeType===E.Sy.ROOT)return i;let s=!e.children||0===e.children.length,n=this.document.layout.getPadding(e),o=e.getData(p.VO);return s&&r?{x:0,y:n.top}:{x:i.x-o.position.x,y:i.y-o.position.y}}registerPosAdjuster(t){return this.posAdjusters.add(t),{dispose:()=>this.posAdjusters.delete(t)}}getDragPosOffset(t){let{event:e,selectedNodes:i,startPosition:r}=t,{finalScale:s}=this.playgroundConfig,n={x:(e.endPos.x-e.startPos.x)/s,y:(e.endPos.y-e.startPos.y)/s},o={x:r.x+n.x,y:r.y+n.y};return Array.from(this.posAdjusters.values()).map(t=>t({selectedNodes:i,position:o})).reduce((t,e)=>({x:t.x+e.x,y:t.y+e.y}),n)}updateDroppableTransforms(){this._droppableTransforms=this.document.getRenderDatas(E.eG,!1).filter(t=>{let{entity:e}=t;return e.originParent?this.nodeSelectable(e)&&this.nodeSelectable(e.originParent):this.nodeSelectable(e)}).filter(t=>{let{entity:e}=t;return e.flowNodeType===E.Sy.SUB_CANVAS})}getNodesPosition(t){let e=M.Ae.enlarge(t.map(t=>t.getData(E.eG).bounds));return{x:e.x,y:e.y}}nodeSelectable(t){let e=t.getNodeMeta().selectable;return"function"==typeof e?e(t):e}updateDropNode(t){if(this._dropNode){if(this._dropNode.id===t?.id)return;this.selectService.clear()}t&&this.selectService.selectNode(t),this._dropNode=t}clearDrop(){this._dropNode&&this.selectService.clear(),this._dropNode=void 0,this._droppableTransforms=[]}setLineColor(t,e){t.highlightColor=e,this.hoverService.clearHovered()}handleDragOnNode(t,e,i,r,s){return r&&(s?.toPort===r||"input"===r.portType&&this.linesManager.canAddLine(e,r,!0))?(this.hoverService.updateHoveredKey(r.id),i.setToPort(r),this._onDragLineEventEmitter.fire({type:"onDrag",onDragNodeId:t.id}),{hasError:!1}):t.flowNodeType===E.Sy.SUB_CANVAS?{hasError:!1}:(this.setLineColor(i,this.linesManager.lineColor.error),{hasError:!0})}childrenOfContainer(t){if(0===t.length)return;let e=t[0]?.parent;if(!!e&&e.collapsedChildren.length===t.length&&!!t.every(t=>t?.parent===e))return e}async startDrawingLine(t,e,i){let r=!i&&t.isErrorPort()&&t.disabled;if(i?.disabled||r||this.playgroundConfig.readonly||this.playgroundConfig.disabled)return{dragSuccess:!1,newLine:void 0};let s=this.playgroundConfig,n=new M.cO,o=s.cursor,a,h,l,d=!1,c=Date.now(),u=!1,g=new p.s5({onDrag:r=>{if(!a&&H(Date.now()-c,r,i)){if(i&&(i.highlightColor=this.linesManager.lineColor.hidden),u=!0,!(a=this.linesManager.createLine({from:t.node.id,fromPort:t.portID,drawingTo:s.getPosFromMouseEvent(e)})))return;s.updateCursor("grab"),a.highlightColor=this.linesManager.lineColor.drawing,this.hoverService.updateHoveredKey("")}if(!a)return;d=!1;let n=s.getPosFromMouseEvent(r);if(l=this.linesManager.getNodeFromMousePos(n),(h=this.linesManager.getPortFromMousePos(n))?this.linesManager.canAddLine(t,h,!0)?a.setToPort(h):(a.highlightColor=this.linesManager.lineColor.error,d=!0,a.setToPort(void 0)):a.setToPort(void 0),this._onDragLineEventEmitter.fire({type:"onDrag"}),this.setLineColor(a,this.linesManager.lineColor.drawing),l&&l.flowNodeType!==E.Sy.SUB_CANVAS){h=l.getData(A).inputPorts[0];let{hasError:e}=this.handleDragOnNode(l,t,a,h,i);d=e}a.toPort?a.drawingTo={x:a.toPort.point.x,y:a.toPort.point.y}:a.drawingTo={x:n.x,y:n.y},i?.validate(),a.validate()},onDragEnd:async e=>{let r=s.getPosFromMouseEvent(e),l=Array.from(this._onDragLineEndCallbacks.values());s.updateCursor(o),await Promise.all(l.map(s=>s({fromPort:t,toPort:h,mousePos:r,line:a,originLine:i,event:e}))),a?.dispose(),this._onDragLineEventEmitter.fire({type:"onDragEnd"}),i&&(i.highlightColor="");let c=()=>{i?.validate(),n.resolve({dragSuccess:u})};if(u){if(i&&i.toPort===h||h&&"input"!==h.portType)return c();let e=h?{from:t.node.id,fromPort:t.portID,to:h.node.id,toPort:h.portID}:void 0;if(i&&h&&!this.linesManager.canReset(i.fromPort,i.toPort,h))return c();if(i&&(!this.linesManager.canRemove(i,e,!1)||d))return c();i?.dispose();if(!h||!this.linesManager.canAddLine(t,h,!1))return c();let r=this.linesManager.createLine(e);!r&&c(),n.resolve({dragSuccess:u,newLine:r})}else c()}});return await g.start(e.clientX,e.clientY,s),n.promise}async resetLine(t,e){let{fromPort:i}=t,{dragSuccess:r}=await this.startDrawingLine(i,e,t);!r&&this.selectService.select(t)}onDragLineEnd(t){let e=(0,C.x0)();return this._onDragLineEndCallbacks.set(e,t),{dispose:()=>{this._onDragLineEndCallbacks.delete(e)}}}};g([(0,D.f3)(p.ER)],K.prototype,"playgroundConfig",2),g([(0,D.f3)(F)],K.prototype,"hoverService",2),g([(0,D.f3)(J)],K.prototype,"document",2),g([(0,D.f3)(G)],K.prototype,"linesManager",2),g([(0,D.f3)(p.VD)],K.prototype,"commandService",2),g([(0,D.f3)(B)],K.prototype,"selectService",2),g([(0,D.f3)(E.VO)],K.prototype,"operationService",2),g([(0,D.zY)()],K.prototype,"init",1),K=g([(0,D.b2)()],K);var Z=async(t,e)=>{let i={};return t.forEach(t=>{let e=t.getData(p.VO),r=t.getData(E.eG);i[t.id]={x:e.position.x,y:e.position.y+r.bounds.height/2}}),new Promise(r=>{(0,p.p4)({from:{d:0},to:{d:100},duration:300,onUpdate:i=>{t.forEach(t=>{let r=t.getData(p.VO),s=(e[t.id].x-r.position.x)*i.d/100,n=(e[t.id].y-r.bounds.height/2-r.position.y)*i.d/100;t.collapsedChildren?.length>0&&t.collapsedChildren.forEach(t=>{t.getData(E.eG).fireChange()}),r.update({position:{x:r.position.x+s,y:r.position.y+n}})})},onComplete:()=>{r(i)}})})},q=class{constructor(){this._resetLayoutEmitter=new M.Q5,this.onResetLayout=this._resetLayoutEmitter.event,this._toDispose=new M.K4}init(){this._toDispose.push(this._resetLayoutEmitter)}fireResetLayout(t,e,i){this._resetLayoutEmitter.fire({nodeIds:t,positionMap:e,oldPositionMap:i})}async layoutToPositions(t,e){let i=t.map(t=>this._entityManager.getEntityById(t)).filter(Boolean),r=await Z(i,e);return w(this._document,this._config,!0),r}dispose(){this._toDispose.dispose()}};function tt(t){let e=(0,p.Dc)(),i=(0,p.JA)();return(0,f.useEffect)(()=>{let r;return t&&(r=e.config.onReadonlyOrDisabledChange(()=>i())),()=>r?.dispose()},[t]),e.config.readonly}function te(t){return t&&"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&!t.closest(".flow-canvas-not-draggable")}function ti(t){let e=t||(0,f.useContext)(p.rQ),i=e.getData(E.Lz),r=e.getData(A),s=tt(),n=(0,p.G2)(K),o=(0,p.G2)(B),a=(0,f.useRef)(!1),h=(0,f.useRef)(null),[l,d]=(0,f.useState)("");(0,f.useEffect)(()=>{let t=n.onDragLineEventChange(({type:t,onDragNodeId:e})=>{"onDrag"===t?d(e||""):d("")});return()=>{t.dispose()}},[]);let c=(0,f.useCallback)(t=>{if(t.preventDefault(),!o.isSelected(e.id)&&u(t),!!te(t.target)&&!!te(document.activeElement))a.current=!0,n.startDragSelectedNodes(t).finally(()=>setTimeout(()=>{a.current=!1}))},[n,e]),u=(0,f.useCallback)(t=>{if(!a.current)t.metaKey||t.shiftKey||t.ctrlKey?o.toggleSelect(e):o.selectNode(e),t.target&&t.target.focus()},[e]),g=(0,f.useCallback)(()=>e.dispose(),[e]);(0,p.H$)(o.onSelectionChanged,r.onDataChange);let D=navigator?.userAgent?.includes?.("Firefox"),M=(0,f.useCallback)(()=>{D&&h.current?.setAttribute("draggable","false")},[]),C=(0,f.useCallback)(()=>{D&&h.current?.setAttribute("draggable","true")},[]),b=(0,f.useCallback)(()=>e.getExtInfo(),[e]),N=(0,f.useCallback)(t=>{e.updateExtInfo(t)},[e]),S=(0,f.useMemo)(()=>(0,m.CM)(e),[e]),x=(0,y.Re)(S?.state),_=(0,f.useCallback)(()=>{i.toggleExpand()},[i]);return{node:e,selected:o.isSelected(e.id),activated:o.isActivated(e.id),expanded:i.expanded,startDrag:c,ports:r.allPorts,deleteNode:g,selectNode:u,readonly:s,linkingNodeId:l,nodeRef:h,onFocus:M,onBlur:C,getExtInfo:b,updateExtInfo:N,toggleExpand:_,get form(){if(!S)return;return{...S,get values(){return S.values},get state(){return x}}}}}g([(0,D.f3)(p.ER)],q.prototype,"_config",2),g([(0,D.f3)(J)],q.prototype,"_document",2),g([(0,D.f3)(p.v2)],q.prototype,"_entityManager",2),g([(0,D.zY)()],q.prototype,"init",1),q=g([(0,D.b2)()],q);var tr=((o=tr||{}).GRAB="GRAB",o.SELECT="SELECT",o);var ts=((a=ts||{}).MOUSE="MOUSE",a.PAD="PAD",a),tn=class{registerDocument(t){t.registerNodeDatas(E.eG,E.Lz,A,R),t.registerLayout(this.freeLayout)}};g([(0,D.f3)(X)],tn.prototype,"freeLayout",2),tn=g([(0,D.b2)()],tn);var to=new D.nZ((t,e,i,r)=>{t(J).toSelf().inSingletonScope(),t(G).toSelf().inSingletonScope(),t(X).toSelf().inSingletonScope(),t(K).toSelf().inSingletonScope(),t(B).toSelf().inSingletonScope(),t(F).toSelf().inSingletonScope(),t(q).toSelf().inSingletonScope(),t(h).toDynamicValue(()=>location.search.replace(/^\?/,"").split("&").reduce((t,e)=>{let[i,r]=e.split("=");return t[i]=r,t},{})).inSingletonScope(),(0,M.KV)(t,tn,[E.Lw]),t(Y).toConstantValue({...U}),r(E.pQ).toService(J),t($).toDynamicValue(t=>()=>t.container.get(J)).inSingletonScope()});(class{constructor(t){this.entity=t}get path(){return this.data?.path??""}calcDistance(t){if(!this.data)return Number.MAX_SAFE_INTEGER;let[e,i]=this.data.points;return M.E9.getDistance(t,this.projectPointOnLine(t,e,i))}get bounds(){return this.data?this.data.bbox:new M.Ae}update(t){let{fromPos:e,toPos:i}=t,{vertical:r}=this.entity,s={x:r?0:j,y:r?j:0},n={x:r?0:-j,y:r?-j:0},o=[{x:e.x+s.x,y:e.y+s.y},{x:i.x+n.x,y:i.y+n.y}],a=M.Ae.createRectangleWithTwoPoints(o[0],o[1]),h=o.map(t=>({x:t.x-a.x+12,y:t.y-a.y+12})),l=`M ${h[0].x} ${h[0].y} L ${h[1].x} ${h[1].y}`;this.data={points:o,path:l,bbox:a}}projectPointOnLine(t,e,i){let r=i.x-e.x,s=i.y-e.y;if(0===r)return{x:e.x,y:t.y};if(0===s)return{x:t.x,y:e.y};let n=Math.max(0,Math.min(1,((t.x-e.x)*r+(t.y-e.y)*s)/(r*r+s*s)));return{x:e.x+n*r,y:e.y+n*s}}}).type="WorkflowSimpleLineContribution"},775832:function(t,e,i){i.d(e,{EU:function(){return ts},Em:function(){return A},Eq:function(){return K},HW:function(){return U},Kz:function(){return tn},NQ:function(){return N},OK:function(){return I},Rf:function(){return O},V7:function(){return w},aK:function(){return to},kD:function(){return T},lV:function(){return tr},oC:function(){return L},qf:function(){return tl},qq:function(){return th}});var r,s,n=i(215206),o=i(213153),a=i(177783),h=i(362270),l=i(461932),d=i(89802),c=i(908600),u=i(339196),g=Object.defineProperty,p=Object.getOwnPropertyDescriptor,f=(t,e,i,r)=>{for(var s=r>1?void 0:r?p(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&g(e,i,s),s},y="#BBBFC4";function m(){let t=(0,o.G2)(n.h3);return{baseColor:t.constants?.[n.cc.BASE_COLOR]||y,baseActivatedColor:t.constants?.[n.cc.BASE_ACTIVATED_COLOR]||"#82A7FC"}}var E={stroke:y,fill:"transparent",strokeLinecap:"round",strokeLinejoin:"round"};function D(t){let{isVertical:e}=t.entity;if(e){let e=t.entity.next?.firstChild&&!t.entity.next.isInlineBlocks?t.entity.next.firstChild.getData(n.eG).size.width:t.entity.next?.getData(n.eG).size.width;return Math.max(t.entity.getData(n.eG)?.size.width??n.Lu[n.T4.HOVER_AREA_WIDTH],e||0)}return t.transform.next?t.transform.next.inputPoint.x-t.transform.outputPoint.x:32}function M(t){let{isVertical:e}=t.entity;if(e)return t.transform.next?t.transform.next.inputPoint.y-t.transform.outputPoint.y:32;let i=t.entity.next?.firstChild&&!t.entity.next.isInlineBlocks?t.entity.next.firstChild.getData(n.eG).size.height:t.entity.next?.getData(n.eG).size.height;return Math.max(t.entity.getData(n.eG)?.size.height||280,i||0)}var C=class extends o.cv{constructor(t){super(t),this.containerX=0,this.containerY=0,this.playgroundConfigEntity=this.entityManager.getEntity(o.ER,!0)}get hasScroll(){return!!(this._scrollXInterval||this._scrollYInterval)}isCollision(t,e,i){let r=this.playgroundConfigEntity.finalScale||0;return i?this.isBranchCollision(t,e,r):this.isNodeCollision(t,e,r)}isNodeCollision(t,e,i){let{labels:r}=t,{isVertical:s}=t.entity;return{hasCollision:r.some(r=>{if(!r||![n.nx.ADDER_LABEL,n.nx.COLLAPSE_ADDER_LABEL].includes(r.type))return!1;let o=s?t.transform.bounds.width:32,h=s?32:t.transform.bounds.height,l=new a.Ae((r.offset.x-o/2)*i,(r.offset.y-h/2)*i,o*i,h*i);return a.Ae.intersects(l,e)}),labelOffsetType:void 0}}isBranchCollision(t,e,i){let{labels:r}=t,{isVertical:s}=t.entity,o=n.VH.NORMAL_BRANCH;return{hasCollision:r.some(t=>{if(!t||t.type!==n.nx.BRANCH_DRAGGING_LABEL)return!1;let r=s?64:t.width||0,h=s?t.width||0:64,l=new a.Ae((t.offset.x-h/2)*i,(t.offset.y-r/2)*i,h*i,r*i),d=a.Ae.intersects(l,e);return d&&(o=t.props.side),d}),labelOffsetType:o}}_startScrollX(t,e){if(this._scrollXInterval)return;let i=window.setInterval(()=>{let t=this._scrollXInterval;if(!t)return;let i=t.origin=e?t.origin+4:t.origin-4;this.playgroundConfigEntity.updateConfig({scrollX:i});let r=this.playgroundConfigEntity.config;r?.scrollX===i&&(e?this.containerX+=4:this.containerX-=4,this.setDomStyle())},20);this._scrollXInterval={interval:i,origin:t}}_stopScrollX(){this._scrollXInterval&&(clearInterval(this._scrollXInterval.interval),this._scrollXInterval=void 0)}_startScrollY(t,e){if(this._scrollYInterval)return;let i=window.setInterval(()=>{let t=this._scrollYInterval;if(!t)return;let i=t.origin=e?t.origin+4:t.origin-4;this.playgroundConfigEntity.updateConfig({scrollY:i});let r=this.playgroundConfigEntity.config;r?.scrollY===i&&(e?this.containerY+=4:this.containerY-=4,this.setDomStyle())},20);this._scrollYInterval={interval:i,origin:t}}_stopScrollY(){this._scrollYInterval&&(clearInterval(this._scrollYInterval.interval),this._scrollYInterval=void 0)}stopAllScroll(){this._stopScrollX(),this._stopScrollY()}setDomStyle(){this.containerDom.style.left=`${this.containerX}px`,this.containerDom.style.top=`${this.containerY}px`}scrollDirection(t,e,i,r){let s=this.playgroundConfigEntity.config,n=s.scrollX,o=s.scrollY;return(this.containerDom=e,this.containerX=i,this.containerY=r,s.height+s.clientY-t.clientY<20)?(this._startScrollY(o,!0),1):t.clientY-s.clientY<20?(this._startScrollY(o,!1),0):(this._stopScrollY(),s.width+s.clientX-t.clientX<20)?(this._startScrollX(n,!0),3):t.clientX-s.clientX<80?(this._startScrollX(n,!1),2):void this._stopScrollX()}dispose(){this.toDispose.dispose()}};C.type="FlowDragEntity";var b=class extends o.cv{constructor(){super(...arguments),this.boundsPadding=10}getDefaultConfig(){return{selectedNodes:[]}}get selectedNodes(){return this.config.selectedNodes}set selectedNodes(t){((t=function(t){if(0===t.length)return[];let e=t.map(t=>(function(t){let e=[t];for(t=t.parent;t;)e.push(t),t=t.parent;return e.reverse()})(t)),i=Math.min(...e.map(t=>t.length)),r=0,s=[];for(;r<i&&!((s=(0,h.uniq)(e.map(t=>t[r]))).length>1);){;r+=1}return(0,h.uniq)(s.map(t=>(function(t){for(;t.originParent;)t=t.originParent;return t})(t)))}(t)).length!==this.config.selectedNodes.length||t.some(t=>!this.config.selectedNodes.includes(t)))&&(this.config.selectedNodes.forEach(e=>{!t.includes(e)&&(e.getData(n.Lz).activated=!1)}),t.forEach(t=>{t.getData(n.Lz).activated=!0}),a.XJ.isArrayShallowChanged(this.config.selectedNodes,t)&&this.updateConfig({selectedNodes:t}))}clearSelectedNodes(){0!==this.config.selectedNodes.length&&(this.config.selectedNodes.forEach(t=>{t.getData(n.Lz).activated=!1}),this.updateConfig({selectedNodes:[]}))}selectFromBounds(t,e){let i=[];e.forEach(e=>{a.Ae.intersects(t,e.bounds)&&(e.entity.originParent?i.push(e.entity.originParent):i.push(e.entity))}),this.selectedNodes=i}getSelectedBounds(){let t=this.selectedNodes;return 0===t.length?a.Ae.EMPTY:a.Ae.enlarge(t.map(t=>t.getData(n.eG).bounds)).pad(this.boundsPadding)}};b.type="FlowSelectConfigEntity";var N=class extends o.cv{get dragInfo(){return this.config}setDragInfo(t){this.updateConfig(t)}get disabled(){return this.config&&!!this.config.disabled}set disabled(t){this.updateConfig({disabled:t})}get isStart(){return this.dragInfo.isStart}get isMoving(){return this.dragInfo.isMoving}get position(){let{dragInfo:t}=this;return{x:t.startPos.x<t.endPos.x?t.startPos.x:t.endPos.x,y:t.startPos.y<t.endPos.y?t.startPos.y:t.endPos.y}}get size(){let{dragInfo:t}=this;return{width:Math.abs(t.startPos.x-t.endPos.x),height:Math.abs(t.startPos.y-t.endPos.y)}}get collapsed(){let{size:t}=this;return 0===t.width&&0===t.height}collapse(){this.setDragInfo({...this.dragInfo,isMoving:!1,isStart:!1})}toRectangle(t){let{position:e,size:i}=this;return new a.Ae(e.x/t,e.y/t,i.width/t,i.height/t)}};N.type="SelectorBoxConfigEntity";var S=t=>{let e=window.getComputedStyle(t);return(0,h.isNil)(t?.offsetParent)||e?.display==="none"},x=t=>!!t&&(0!==t.bottom||0!==t.height||0!==t.left||0!==t.right||0!==t.top||0!==t.width||0!==t.x||0!==t.y)||!1,_=class{observe(t,e){let i=new ResizeObserver(t=>{window.requestAnimationFrame(()=>{if(!Array.isArray(t)||!t.length)return;let{contentRect:i,target:r}=t[0],s=x(i),n=!r.parentNode,o=S(r.parentNode);s&&!n&&!o&&(e.size={width:Math.round(10*i.width)/10,height:Math.round(10*i.height)/10})})});return i.observe(t),a.JT.create(()=>{i.unobserve(t)})}};_=f([(0,l.b2)()],_);var w=class extends o.mh{constructor(){super(...arguments),this.node=a.xF.createDivWithClass("gedit-flow-nodes-layer"),this.renderCache=a.Ct.create(t=>{let e;let{renderState:i}=t,{node:r}=i,{entity:s}=t;return r.id=s.id,(()=>{!e&&(this.renderElement.appendChild(r),e=this.resizeObserver.observe(r,t))})(),{dispose:()=>{e&&(r.parentElement&&this.renderElement.removeChild(r),e.dispose(),e=void 0)},updateBounds:()=>{let{bounds:e}=t;(r.style.left!==`${e.x}px`||r.style.top!==`${e.y}px`)&&(r.style.left=`${e.x}px`,r.style.top=`${e.y}px`)}}})}get transformVisibles(){return this.document.getRenderDatas(n.eG,!1)}onZoom(t){this.node.style.transform=`scale(${t})`}dispose(){this.renderCache.dispose(),super.dispose()}onReady(){this.node.style.zIndex="10"}get visibeBounds(){return this.transformVisibles.map(t=>t.bounds)}updateNodesBounds(){this.renderCache.getMoreByItems(this.transformVisibles).forEach(t=>t.updateBounds())}autorun(){!this.documentTransformer.loading&&(this.documentTransformer.refresh(),this.updateNodesBounds())}get renderElement(){if("function"==typeof this.options.renderElement){let t=this.options.renderElement();if(t)return t}else if(void 0!==this.options.renderElement)return this.options.renderElement;return this.node}};f([(0,l.f3)(n.pQ)],w.prototype,"document",2),f([(0,l.f3)(_)],w.prototype,"resizeObserver",2),f([(0,o.O0)(n.Vl)],w.prototype,"documentTransformer",2),f([(0,o.aI)(n.GA,n.eG)],w.prototype,"_transforms",2),w=f([(0,l.b2)()],w);var I=Symbol("FlowRendererContribution");var T=((r=T||{}).NODE_RENDER="node-render",r.ADDER="adder",r.COLLAPSE="collapse",r.BRANCH_ADDER="branch-adder",r.TRY_CATCH_COLLAPSE="try-catch-collapse",r.DRAG_NODE="drag-node",r.DRAGGABLE_ADDER="draggable-adder",r.DRAG_HIGHLIGHT_ADDER="drag-highlight-adder",r.DRAG_BRANCH_HIGHLIGHT_ADDER="drag-branch-highlight-adder",r.SELECTOR_BOX_POPOVER="selector-box-popover",r.CONTEXT_MENU_POPOVER="context-menu-popover",r.SUB_CANVAS="sub-canvas",r.MARKER_ARROW="marker-arrow",r.MARKER_ACTIVATE_ARROW="marker-active-arrow",r);var L=((s=L||{}).LOOP_END_TEXT="loop-end-text",s.LOOP_TRAVERSE_TEXT="loop-traverse-text",s.LOOP_WHILE_TEXT="loop-while-text",s.TRY_START_TEXT="try-start-text",s.TRY_END_TEXT="try-end-text",s.CATCH_TEXT="catch-text",s),O=class{constructor(){this.componentsMap=new Map,this.textMap=new Map,this.contribs=[]}init(){this.contribs.forEach(t=>t.registerRenderer?.(this))}registerRendererComponents(t,e){this.componentsMap.set(t,e)}registerReactComponent(t,e){this.componentsMap.set(t,{type:0,renderer:e})}registerText(t){Object.entries(t).forEach(([t,e])=>{this.textMap.set(t,e)})}getText(t){return u.o.t(t,{disableReturnKey:!0})||this.textMap.get(t)}getRendererComponent(t){let e=this.componentsMap.get(t);if(!e)throw Error(`Unknown render key ${t}`);return e}tryToGetRendererComponent(t){return this.componentsMap.get(t)}registerLayers(...t){t.forEach(t=>this.pipeline.registerLayer(t))}registerLayer(t,e){this.pipeline.registerLayer(t,e)}};f([(0,l.nx)(I),(0,l.jt)()],O.prototype,"contribs",2),f([(0,l.f3)(o.Rm)],O.prototype,"pipeline",2),O=f([(0,l.b2)()],O);var A=class extends o.mh{constructor(){super(...arguments),this.renderMemoCache=new WeakMap,this.node=a.xF.createDivWithClass("gedit-flow-nodes-layer"),this.reactPortals=a.Ct.create(t=>{let{node:e,entity:i}=t,{config:r}=this,s=this.getPortalRenderer(t);return{id:e.id||i.id,dispose:()=>{},Portal:function(){return c.useEffect(()=>{if(e.clientWidth&&e.clientHeight){let t=i.getData(n.eG);t&&(t.size={width:e.clientWidth,height:e.clientHeight})}},[]),d.createPortal(c.createElement(o.rQ.Provider,{value:i},c.createElement(s,{node:i,version:t?.version,activated:t?.activated,readonly:r.readonly,disabled:r.disabled})),e)}}})}get renderStatesVisible(){return this.document.getRenderDatas(n.Lz,!1)}getPortalRenderer(t){let e=t.entity.getNodeMeta(),i=this.rendererRegistry.getRendererComponent(e.renderKey||"node-render").renderer,r=this.renderMemoCache.get(i);return!r&&(r=c.memo(i),this.renderMemoCache.set(i,r)),r}onZoom(t){this.node.style.transform=`scale(${t})`}dispose(){this.reactPortals.dispose(),super.dispose()}onReady(){this.node.style.zIndex="10"}onReadonlyOrDisabledChange(){this.render()}getPortals(){return this.reactPortals.getMoreByItems(this.renderStatesVisible)}render(){return this.documentTransformer.loading?c.createElement(c.Fragment,null):(this.documentTransformer.refresh(),c.createElement(c.Fragment,null,this.getPortals().map(t=>c.createElement(t.Portal,{key:t.id}))))}};f([(0,l.f3)(n.pQ)],A.prototype,"document",2),f([(0,l.f3)(O)],A.prototype,"rendererRegistry",2),f([(0,o.O0)(n.Vl)],A.prototype,"documentTransformer",2),f([(0,o.aI)(n.GA,n.Lz)],A.prototype,"_renderStates",2),A=f([(0,l.b2)()],A);var k="line-marker-arrow",R=`url(#${k})`,P=function(){let{baseColor:t}=m();return c.createElement("marker",{id:k,markerWidth:"11",markerHeight:"14",refX:"10",refY:"7",orient:"auto"},c.createElement("path",{d:"M9.6 5.2C10.8 6.1 10.8 7.9 9.6 8.8L3.6 13.3C2.11672 14.4125 0 13.3541 0 11.5L0 2.5C0 0.645898 2.11672 -0.412461 3.6 0.7L9.6 5.2Z",fill:t}))},j="line-marker-arrow-activated",z=`url(#${j})`,V=function(){let{baseActivatedColor:t}=m();return c.createElement("marker",{id:j,markerWidth:"11",markerHeight:"14",refX:"10",refY:"7",orient:"auto"},c.createElement("path",{d:"M9.6 5.2C10.8 6.1 10.8 7.9 9.6 8.8L3.6 13.3C2.11672 14.4125 0 13.3541 0 11.5L0 2.5C0 0.645898 2.11672 -0.412461 3.6 0.7L9.6 5.2Z",fill:t}))},B=function(t){let{from:e,to:i,activated:r,style:s}=t,{baseColor:n,baseActivatedColor:o}=m();return c.createElement("path",{d:`M ${e.x} ${e.y} L ${i.x} ${i.y}`,...E,stroke:r?o:n,style:s})},F=function(t){let{vertices:e,radius:i=16,hide:r,xRadius:s,yRadius:o,...l}=t,{from:d,to:u,arrow:g,activated:p,style:f}=l||{},{baseActivatedColor:y,baseColor:D}=m(),M=e||(t.isHorizontal?function(t,e=16,i=20){let{from:r,to:s,type:o}=t||{},a=Math.abs(s.y-r.y),h=Math.abs(s.x-r.x),l=h/e,d=a/i,c=[];if(l<1)return[];switch(o){case n.IG.DIVERGE_LINE:case n.IG.DRAGGING_LINE:if(l<=1)return[{x:s.x,y:r.y,radiusX:h}];if(c=[{x:r.x+i,y:r.y},{x:r.x+i,y:s.y}],l<2){let t=h-i;c=[{x:r.x+t,y:r.y,radiusX:t},{x:r.x+t,y:s.y}]}return d<2&&(c[0].moveY=a/2,c[1].moveY=a/2),c;case n.IG.MERGE_LINE:if(l<2)return[{x:s.x,y:r.y}];return c=[{x:s.x-i,y:r.y},{x:s.x-i,y:s.y}],d<2&&(c[0].moveY=a/2,c[1].moveY=a/2),c}return[]}(l,s,o):function(t,e=16,i=20){let{from:r,to:s,type:o}=t||{},a=Math.abs(s.y-r.y),h=Math.abs(s.x-r.x),l=a/i,d=h/e,c=[];if(l<1)return[];switch(o){case n.IG.DIVERGE_LINE:case n.IG.DRAGGING_LINE:if(l<=1)return[{x:s.x,y:r.y,radiusY:a}];if(c=[{x:r.x,y:r.y+i},{x:s.x,y:r.y+i}],l<2){let t=a-i;c=[{x:r.x,y:r.y+t,radiusY:t},{x:s.x,y:r.y+t}]}return d<2&&(c[0].moveX=h/2,c[1].moveX=h/2),c;case n.IG.MERGE_LINE:if(l<2)return[{x:r.x,y:s.y}];return c=[{x:r.x,y:s.y-i},{x:s.x,y:s.y-i}],d<2&&(c[0].moveX=h/2,c[1].moveX=h/2),c}return[]}(l,s,o)),C=(0,c.useMemo)(()=>M.map((t,e)=>{let r=M[e-1]||d,s=M[e+1]||u,n={x:Math.abs(r.x-t.x),y:Math.abs(r.y-t.y)},o={x:Math.abs(s.x-t.x),y:Math.abs(s.y-t.y)},l=0===n.x&&0===o.y,c=0===n.y&&0===o.x;!(l||c)&&console.error(`vertex ${t.x},${t.y} is not right angle`);let g=new a.E9().copyFrom(t),p=new a.E9().copyFrom(t),f=(0,h.isNil)(t.radiusX)?i:t.radiusX,y=(0,h.isNil)(t.radiusY)?i:t.radiusY,m=f,E=y;if(l){E=Math.min(n.y,y);let e=(0,h.isNil)(t.moveY)?E:t.moveY;g.y+=d.y<t.y?-e:+e,m=Math.min(o.x,f);let i=(0,h.isNil)(t.moveX)?m:t.moveX;p.x+=u.x<t.x?-i:+i}if(c){m=Math.min(n.x,f);let e=(0,h.isNil)(t.moveX)?m:t.moveX;g.x+=d.x<t.x?-e:+e,E=Math.min(o.y,y);let i=(0,h.isNil)(t.moveY)?E:t.moveY;p.y+=u.y<t.y?-i:+i}let D=(t.x-g.x)*(p.y-g.y)-(t.y-g.y)*(p.x-g.x);return`L ${g.x} ${g.y} A ${m} ${E} 0 0 ${D>0?1:0} ${p.x} ${p.y}`}).join(" "),[M]);if(r)return null;let b=`M ${d.x} ${d.y} ${C} L ${u.x} ${u.y}`;return c.createElement("path",{d:b,...E,stroke:p?y:D,...g?{markerEnd:p?z:R}:{},style:f})},Y=function(t){let{renderKey:e,rendererRegistry:i,...r}=t;if(!e)return c.createElement(c.Fragment,null);let s=i.getRendererComponent(e);if(!s)return c.createElement(c.Fragment,null);let n=s.renderer;return c.createElement(n,{...r})},U=class extends o.mh{constructor(){super(...arguments),this.node=a.xF.createDivWithClass("gedit-flow-lines-layer"),this.onViewportChange=(0,h.throttle)(()=>{this.render()},100)}get transitions(){return this.document.getRenderDatas(n.Xr)}onZoom(){let t=this.node.querySelector("svg.flow-lines-container");t?.setAttribute?.("viewBox",this.viewBox)}onReady(){this.node.style.zIndex="1"}get viewBox(){let t=1e3/this.config.finalScale;return`0 0 ${t} ${t}`}render(){let t=[],e=this.config.isViewportVisible.bind(this.config);if(this.documentTransformer.loading)return c.createElement(c.Fragment,null);this.documentTransformer.refresh(),this.transitions.forEach(i=>{!function(t){let{data:e,rendererRegistry:i,linesSave:r,dragService:s}=t,{lines:o,entity:h}=e||{},l=(0,n.yI)(h,n.T4.ROUNDED_LINE_X_RADIUS),d=(0,n.yI)(h,n.T4.ROUNDED_LINE_Y_RADIUS),u=(t,r)=>{let{renderData:o}=e,{isVertical:a}=e.entity,{lineActivated:h}=o||{},u=t.type===n.IG.DRAGGING_LINE&&!s.isDroppableBranch(e.entity,t.side),g=t.type===n.IG.DRAGGING_LINE&&e.entity?.id===s.dropNodeId&&t.side===s.labelSide;switch(t.type){case n.IG.STRAIGHT_LINE:return c.createElement(B,{key:`${e.entity.id}${r}`,activated:h,...t});case n.IG.DIVERGE_LINE:case n.IG.DRAGGING_LINE:case n.IG.MERGE_LINE:case n.IG.ROUNDED_LINE:return c.createElement(F,{key:`${e.entity.id}${r}`,isHorizontal:!a,activated:h||g,...t,xRadius:l,yRadius:d,hide:u});case n.IG.CUSTOM_LINE:return c.createElement(Y,{key:`${e.entity.id}${r}`,...t,rendererRegistry:i})}};o.forEach((e,i)=>{let s=a.Ae.createRectangleWithTwoPoints(e.from,e.to).pad(10);if(t.isViewportVisible(s)){let t=u(e,i);t&&r.push(t)}})}({data:i,rendererRegistry:this.rendererRegistry,isViewportVisible:e,linesSave:t,dragService:this.dragService})});let{activateLines:i=[],normalLines:r=[]}=(0,h.groupBy)(t,t=>t.props.activated?"activateLines":"normalLines"),s=[...r,...i],o=this.rendererRegistry.tryToGetRendererComponent("marker-arrow"),l=this.rendererRegistry.tryToGetRendererComponent("marker-active-arrow"),d=o?c.createElement(o.renderer):null,u=l?c.createElement(l.renderer):null;return c.createElement("svg",{className:"flow-lines-container",width:"1000",height:"1000",overflow:"visible",viewBox:this.viewBox,xmlns:"http://www.w3.org/2000/svg"},c.createElement("defs",null,o?d:c.createElement(P,null),u||c.createElement(V,null)),s)}};function G(t){let{data:e,rendererRegistry:i,forceVisible:r,hoverHeight:s=M(e),hoverWidth:o=D(e),wrapperStyle:a,...h}=t,{activateNode:l}=h,[d,u]=(0,c.useState)(!1),g=l?.getData(n.Lz),p=(0,c.useCallback)(()=>{u(!0),g?.toggleMouseEnter()},[]),f=(0,c.useCallback)(()=>{u(!1),g?.toggleMouseLeave()},[]),y=i.getRendererComponent("collapse"),m=e.entity,E=c.createElement(y.renderer,{node:m,collapseNode:m,...h,hoverActivated:d}),C=e.collapsed||g?.hovered||d||r;return c.createElement("div",{className:"flow-canvas-collapse",onMouseEnter:p,onMouseLeave:f,style:{width:o,height:s,display:"flex",justifyContent:"center",alignItems:"center",...a}},C?E:null)}f([(0,l.f3)(n.pQ)],U.prototype,"document",2),f([(0,l.f3)(n.eE)],U.prototype,"dragService",2),f([(0,l.f3)(O)],U.prototype,"rendererRegistry",2),f([(0,o.O0)(n.Vl)],U.prototype,"documentTransformer",2),f([(0,o.O0)(n.y3)],U.prototype,"flowRenderState",2),f([(0,o.aI)(n.GA,n.Xr)],U.prototype,"_transitions",2),U=f([(0,l.b2)()],U);var Q=(t,{dragService:e})=>{if(e&&e.dragging&&e.isDroppableNode(t))return e.dropNodeId===t.id?"drag-highlight-adder":"draggable-adder";return"adder"};function X(t){let{data:e,rendererRegistry:i,hoverHeight:r=M(e),hoverWidth:s=D(e),...a}=t,[h,l]=(0,c.useState)(!1),d=(0,c.useCallback)(()=>l(!0),[]),u=(0,c.useCallback)(()=>l(!1),[]),g=e.entity,p=Q(g,{dragService:(0,o.G2)(n.eE)}),f=i.getRendererComponent(p),y=e.entity.document.renderTree.getOriginInfo(g).next,m=g.next,E=c.createElement(f.renderer,{node:g,from:g,to:y,renderTo:m,hoverActivated:h,setHoverActivated:l,hoverWidth:s,hoverHeight:r,...a});return c.createElement("div",{className:"flow-canvas-adder","data-testid":"sdk.flowcanvas.line.adder","data-from":g.id,"data-to":y?.id??"",onMouseEnter:d,onMouseLeave:u,style:{width:s,height:r,display:"flex",justifyContent:"center",alignItems:"center"}},E)}function W(t){let{data:e,rendererRegistry:i,...r}=t,{activateNode:s}=r,[o,a]=(0,c.useState)(!1),h=s?.getData(n.Lz),l=(0,c.useCallback)(()=>{a(!0)},[]),d=(0,c.useCallback)(()=>{a(!1)},[]),u=s?.isVertical,g=h?.hovered||o;return u?c.createElement("div",{className:"flow-canvas-collapse-adder",onMouseEnter:l,onMouseLeave:d},(g||e.collapsed)&&c.createElement(G,{forceVisible:!0,...t,wrapperStyle:{alignItems:"flex-end"},hoverHeight:20}),!e.collapsed&&c.createElement(X,{...t,hoverHeight:g?20:40,hoverActivated:g})):c.createElement("div",{className:"flow-canvas-collapse-adder",onMouseEnter:l,onMouseLeave:d,style:{display:e.collapsed?"block":"flex"}},(g||e.collapsed)&&c.createElement(G,{forceVisible:!0,...t,wrapperStyle:{justifyContent:"flex-end"},hoverWidth:20}),!e.collapsed&&c.createElement(X,{...t,hoverWidth:g?20:40,hoverActivated:g}))}var $=(t,{dragService:e,side:i})=>{if(e.isDragBranch&&i&&e.labelSide===i&&e.isDroppableBranch(t,i))return e.dropNodeId===t.id?"drag-branch-highlight-adder":"draggable-adder";return""};function J(t){let{data:e,rendererRegistry:i,side:r,...s}=t,a=e.entity,h=$(a,{side:r,dragService:(0,o.G2)(n.eE)});if(!h)return null;let l=i.getRendererComponent(h),d=e.entity.document.renderTree.getOriginInfo(a).next,u=a.next,g=c.createElement(l.renderer,{node:a,from:a,to:d,renderTo:u,...s});return c.createElement("div",{className:"flow-canvas-branch-draggable-adder"},g)}var H={fontSize:12,color:"#8F959E",textAlign:"center",whiteSpace:"nowrap",backgroundColor:"var(--g-editor-background)",lineHeight:"20px"},K=class extends o.mh{constructor(){super(...arguments),this.node=a.xF.createDivWithClass("gedit-flow-labels-layer"),this.onViewportChange=(0,h.throttle)(()=>{this.render()},100)}get transitions(){return this.document.getRenderDatas(n.Xr)}onZoom(t){this.node.style.transform=`scale(${t})`}onReady(){this.node.style.zIndex="9"}onReadonlyOrDisabledChange(){this.render()}render(){let t=[];if(this.documentTransformer?.loading)return c.createElement(c.Fragment,null);this.documentTransformer?.refresh?.();let{baseActivatedColor:e,baseColor:i}=m(),r=this.config.isViewportVisible.bind(this.config);return this.transitions.forEach(s=>{!function(t){let{data:e,rendererRegistry:i,labelsSave:r,getLabelColor:s}=t,{labels:o,renderData:h}=e||{},{activated:l}=h||{},d=(t,r)=>{let{offset:o,renderKey:a,props:h,rotate:d,type:u}=t||{},g=o.x,p=o.y,f=null;switch(u){case n.nx.BRANCH_DRAGGING_LABEL:f=c.createElement(J,{rendererRegistry:i,data:e,...h});break;case n.nx.ADDER_LABEL:f=c.createElement(X,{rendererRegistry:i,data:e,...h});break;case n.nx.COLLAPSE_LABEL:f=c.createElement(G,{rendererRegistry:i,data:e,...h});break;case n.nx.COLLAPSE_ADDER_LABEL:f=c.createElement(W,{rendererRegistry:i,data:e,...h});break;case n.nx.TEXT_LABEL:if(!a)return null;let y=i.getText(a)||a;f=c.createElement("div",{style:{...H,...h?.style,color:s(l),transform:d?`rotate(${d})`:void 0}},y);break;case n.nx.CUSTOM_LABEL:if(!a)return null;try{let t=i.getRendererComponent(a);f=c.createElement(t.renderer,{node:e.entity,...h})}catch(t){console.error(t),f=a}}return c.createElement("div",{key:`${e.entity.id}${r}`,style:{position:"absolute",left:g,top:p,transform:"translate(-50%, -50%)"}},f)};o.forEach((e,i)=>{var s;if(t.isViewportVisible((s=e.offset,new a.Ae(s.x-75,s.y-30,150,60))))r.push(d(e,i))})}({data:s,rendererRegistry:this.rendererRegistry,isViewportVisible:r,labelsSave:t,getLabelColor:t=>t?e:i})}),c.createElement(c.Fragment,null,t)}};f([(0,l.f3)(n.pQ)],K.prototype,"document",2),f([(0,l.f3)(O)],K.prototype,"rendererRegistry",2),f([(0,o.O0)(n.Vl)],K.prototype,"documentTransformer",2),f([(0,o.O0)(n.y3)],K.prototype,"flowRenderState",2),f([(0,o.aI)(n.GA,n.Xr)],K.prototype,"_transitions",2),K=f([(0,l.b2)()],K);function Z(t,e){let i=e.finalScale;return new a.Ae(t.scrollX/i,t.scrollY/i,e.config.width/i,e.config.height/i).pad(-120/i,-120/i)}var q=Symbol("ScrollBarEvents"),tt=0;function te(t){let e=Math.min(t/10*255,255),i=(tt+=1)%3,r=()=>Math.floor(Math.random()*e);return`rgb(${0===i?r():0}, ${1===i?r():0}, ${2===i?r():0})`}var ti=class extends o.mh{constructor(){super(...arguments),this.node=document.createElement("div"),this.viewport=a.xF.createDivWithClass("gedit-flow-debug-bounds"),this.boundsNodes=a.xF.createDivWithClass("gedit-flow-debug-bounds"),this.pointsNodes=a.xF.createDivWithClass("gedit-flow-debug-points"),this.versionNodes=a.xF.createDivWithClass("gedit-flow-debug-versions gedit-hidden"),this.filterKey=window.location.search.match(/debug=([^&]+)/)?.[1]||"",this.originLine=document.createElement("div"),this.domCache=new WeakMap}get transforms(){return this.document.getRenderDatas(n.eG)}onReady(){this.node.style.zIndex="20",a.xF.setStyle(this.originLine,{position:"absolute",width:1,height:"100%",left:this.pipelineNode.style.left,top:0,borderLeft:"1px dashed rgba(255, 0, 0, 0.5)"}),this.pipelineNode.parentElement.appendChild(this.originLine),this.node.appendChild(this.viewport),this.node.appendChild(this.versionNodes),this.node.appendChild(this.boundsNodes),this.node.appendChild(this.pointsNodes),this.renderScrollViewportBounds()}onScroll(){this.originLine.style.left=this.pipelineNode.style.left,this.renderScrollViewportBounds()}onResize(){this.renderScrollViewportBounds()}onZoom(t){this.node.style.transform=`scale(${t})`,this.renderScrollViewportBounds()}createBounds(t,e,i){if(this.filterKey&&-1===t.key.indexOf(this.filterKey))return;let r=this.domCache.get(t),{bounds:s,inputPoint:n,outputPoint:o}=t;if(!r){let i=a.xF.createDivWithClass(""),s=a.xF.createDivWithClass(""),n=a.xF.createDivWithClass(""),o=a.xF.createDivWithClass("");i.title=t.key,s.title=t.key+"(input)",n.title=t.key+"(output)",o.title=t.key,this.boundsNodes.appendChild(i),this.pointsNodes.appendChild(s),this.pointsNodes.appendChild(n),this.versionNodes.appendChild(o),t.onDispose(()=>{i.remove(),s.remove(),n.remove()}),r={bbox:i,input:s,output:n,version:o,color:e},this.domCache.set(t,r)}a.xF.setStyle(r.version,{position:"absolute",marginLeft:"-9px",marginTop:"-10px",borderRadius:12,background:"#f54a45",padding:4,color:"navajowhite",display:t.renderState.hidden?"none":"block",zIndex:i+1e3,left:s.center.x,top:s.center.y}),r.version.innerHTML=t.version.toString(),a.xF.setStyle(r.input,{position:"absolute",width:10,height:10,marginLeft:-5,marginTop:-5,borderRadius:5,left:n.x,top:n.y,opacity:.4,zIndex:i,backgroundColor:r.color,whiteSpace:"nowrap",overflow:"visible"}),r.input.innerHTML=`${n.x},${n.y}`,a.xF.setStyle(r.output,{position:"absolute",width:10,height:10,marginLeft:-5,marginTop:-5,borderRadius:5,left:o.x,top:o.y,opacity:.4,zIndex:i,backgroundColor:r.color,whiteSpace:"nowrap",overflow:"visible"}),r.output.innerHTML=`${o.x},${o.y}`,a.xF.setStyle(r.bbox,{position:"absolute",width:s.width,height:s.height,left:s.left,top:s.top,opacity:`${i/30}`,backgroundColor:r.color})}renderScrollViewportBounds(){let t=Z({scrollX:this.config.config.scrollX,scrollY:this.config.config.scrollY},this.config);a.xF.setStyle(this.viewport,{position:"absolute",width:t.width-2,height:t.height-2,left:t.left+1,top:t.top+1,border:"1px solid rgba(200, 200, 255, 0.5)"})}autorun(){if(this.documentTransformer.loading)return;this.documentTransformer.refresh();let t=te(0);this.document.traverse((e,i)=>{let r=e.getData(n.eG);t=te(i),this.createBounds(r,t,i)}),this.renderScrollViewportBounds()}};f([(0,l.f3)(n.pQ)],ti.prototype,"document",2),f([(0,o.O0)(n.Vl)],ti.prototype,"documentTransformer",2),f([(0,o.aI)(n.GA,n.eG)],ti.prototype,"_transforms",2),ti=f([(0,l.b2)()],ti);var tr=class extends o.mh{constructor(){super(...arguments),this.rightScrollBar=a.xF.createDivWithClass("gedit-playground-scroll-right"),this.rightScrollBarBlock=a.xF.createDivWithClass("gedit-playground-scroll-right-block"),this.bottomScrollBar=a.xF.createDivWithClass("gedit-playground-scroll-bottom"),this.bottomScrollBarBlock=a.xF.createDivWithClass("gedit-playground-scroll-bottom-block"),this.sum=0,this.initialScrollX=0,this.initialScrollY=0,this.bottomGrabDragger=new o.s5({onDragStart:t=>{this.config.updateCursor("grabbing"),this.sum=0,this.initialScrollX=this.config.getViewport().x,this.onBoardingToast()},onDrag:t=>{this.sum+=t.movingDelta.x,this.playgroundConfigEntity.scroll({scrollX:(this.initialScrollX+this.sum*this.viewportFullWidth/(this.clientViewportWidth-this.scrollBottomWidth))*this.scale},!1)},onDragEnd:t=>{this.config.updateCursor("default")}}),this.rightGrabDragger=new o.s5({onDragStart:t=>{this.config.updateCursor("grabbing"),this.sum=0,this.initialScrollY=this.config.getViewport().y,this.onBoardingToast()},onDrag:t=>{this.sum+=t.movingDelta.y,this.playgroundConfigEntity.scroll({scrollY:(this.initialScrollY+this.sum*this.viewportFullHeight/(this.clientViewportHeight-this.scrollRightHeight))*this.scale},!1)},onDragEnd:t=>{this.config.updateCursor("default")}})}get clientViewportWidth(){return this.viewportWidth*this.scale-11}get clientViewportHeight(){return this.viewportHeight*this.scale-11}get viewportFullWidth(){return this.mostLeft-this.mostRight}get viewportFullHeight(){return this.mostTop-this.mostBottom}get viewportMoveWidth(){return this.mostLeft-this.mostRight+this.width}get viewportMoveHeight(){return this.mostTop-this.mostBottom+this.height}getToLeft(t){return(t-this.mostRight)/this.viewportMoveWidth*this.clientViewportWidth}getToTop(t){return(t-this.mostBottom)/this.viewportMoveHeight*this.clientViewportHeight}clickRightScrollBar(t){t.preventDefault(),t.stopPropagation();let e=1-(t?.y||0)/this.clientViewportHeight,i=(this.mostTop-this.viewportFullHeight*e)*this.scale;this.playgroundConfigEntity.scroll({scrollY:i},!1)}clickBottomScrollBar(t){t.preventDefault(),t.stopPropagation();let e=1-(t?.x||0)/this.clientViewportWidth,i=(this.mostLeft-this.viewportFullWidth*e)*this.scale;this.playgroundConfigEntity.scroll({scrollX:i},!1)}onBoardingToast(){this.events?.dragStart()}changeScrollBarVisibility(t,e){a.xF.addClass(t,"show"===e?"gedit-playground-scroll-show":"gedit-playground-scroll-hidden"),a.xF.delClass(t,"show"===e?"gedit-playground-scroll-hidden":"gedit-playground-scroll-show")}onReady(){!this.options.getBounds&&(this.options={getBounds:()=>{let t=this.flowDocument;return t?(t.transformer.refresh(),t.root.getData(n.eG).bounds):a.Ae.EMPTY},showScrollBars:"whenScrolling"}),this.pipelineNode.parentNode.appendChild(this.rightScrollBar),this.pipelineNode.parentNode.appendChild(this.rightScrollBarBlock),this.pipelineNode.parentNode.appendChild(this.bottomScrollBar),this.pipelineNode.parentNode.appendChild(this.bottomScrollBarBlock),this.rightScrollBar.onclick=this.clickRightScrollBar.bind(this),this.bottomScrollBar.onclick=this.clickBottomScrollBar.bind(this),"whenScrolling"===this.options.showScrollBars&&(this.rightScrollBar.addEventListener("mouseenter",t=>{this.changeScrollBarVisibility(this.rightScrollBarBlock,"show")}),this.rightScrollBar.addEventListener("mouseleave",t=>{this.changeScrollBarVisibility(this.rightScrollBarBlock,"hidden")}),this.bottomScrollBar.addEventListener("mouseenter",t=>{this.changeScrollBarVisibility(this.bottomScrollBarBlock,"show")}),this.bottomScrollBar.addEventListener("mouseleave",t=>{this.changeScrollBarVisibility(this.bottomScrollBarBlock,"hidden")})),this.bottomScrollBarBlock.addEventListener("mousedown",t=>{this.bottomGrabDragger.start(t.clientX,t.clientY),t.stopPropagation()}),this.rightScrollBarBlock.addEventListener("mousedown",t=>{this.rightGrabDragger.start(t.clientX,t.clientY),t.stopPropagation()})}autorun(){this.hideTimeout&&clearTimeout(this.hideTimeout);let t=Z({scrollX:this.config.config.scrollX,scrollY:this.config.config.scrollY},this.config),e=this.config.getViewport();this.viewportWidth=e.width,this.viewportHeight=e.height;let i=this.options.getBounds();this.width=i?.width||0,this.height=i?.height||0;let r=(this.viewportWidth-t.width)/2-2,s=(this.viewportHeight-t.height)/2-2,n=this.width+t.width,o=this.height+t.height,h=i.x,l=i.y;this.mostLeft=this.width+h-r,this.mostRight=this.mostLeft-n,this.mostTop=this.height+l-s,this.mostBottom=this.mostTop-o,this.scale=this.config.finalScale;let d=this.clientViewportWidth,c=this.clientViewportHeight;this.scrollBottomWidth=d-d*(this.mostLeft-this.mostRight)/this.viewportMoveWidth,this.scrollRightHeight=c-c*(this.mostTop-this.mostBottom)/this.viewportMoveHeight;let u=this.getToLeft(e.x),g=this.getToTop(e.y);a.xF.setStyle(this.rightScrollBarBlock,{right:2,top:g,background:"#1F2329",zIndex:10,height:this.scrollRightHeight,width:"7px"}),a.xF.setStyle(this.bottomScrollBarBlock,{left:u,bottom:2,background:"#1F2329",zIndex:10,height:"7px",width:this.scrollBottomWidth}),this.changeScrollBarVisibility(this.rightScrollBarBlock,"show"),this.changeScrollBarVisibility(this.bottomScrollBarBlock,"show"),"whenScrolling"===this.options.showScrollBars&&(this.hideTimeout=window.setTimeout(()=>{this.changeScrollBarVisibility(this.rightScrollBarBlock,"hidden"),this.changeScrollBarVisibility(this.bottomScrollBarBlock,"hidden"),this.hideTimeout=void 0},1e3))}};f([(0,l.jt)(),(0,l.f3)(q)],tr.prototype,"events",2),f([(0,l.f3)(n.pQ),(0,l.jt)()],tr.prototype,"flowDocument",2),f([(0,o.O0)(o.ER)],tr.prototype,"playgroundConfigEntity",2),tr=f([(0,l.b2)()],tr);var ts=class extends o.mh{constructor(){super(...arguments),this.dragOffset={x:8,y:8},this.containerRef=c.createRef(),this.draggingNodeMask=document.createElement("div"),this._dragger=new o.s5({onDrag:t=>{this.handleMouseMove(t)},onDragEnd:()=>{this.handleMouseUp()},stopGlobalEventNames:["contextmenu"]})}get transitions(){let t=[];return this.document.traverse(e=>{t.push(e.getData(n.Xr))}),t}get dragStartEntity(){return this.flowRenderStateEntity.getDragStartEntity()}set dragStartEntity(t){this.flowRenderStateEntity.setDragStartEntity(t)}get dragEntities(){return this.flowRenderStateEntity.getDragEntities()}set dragEntities(t){this.flowRenderStateEntity.setDragEntities(t)}isGrab(){return this.editorStateConfig.getCurrentState()===o.yy.STATE_GRAB}setDraggingStatus(t){this.service.nodeDragIdsWithChildren.length&&this.service.nodeDragIdsWithChildren.forEach(e=>{let i=this.entityManager.getEntityById(e);(i?.getData(n.Lz)).dragging=t})}dragEnable(t){return Math.abs(t.clientX-this.initialPosition.x)>10||Math.abs(t.clientY-this.initialPosition.y)>10}handleMouseMove(t){if(this.dragStartEntity&&this.dragEnable(t)){this.setDraggingStatus(!0);let e=this.playgroundConfigEntity.finalScale;if(this.containerRef.current){let i;let r=this.containerRef.current.children?.[0],s=t.clientX-(this.pipelineNode.offsetLeft||0)-this.playgroundConfigEntity.config.clientX-(r.clientWidth-this.dragOffset.x)*e,n=t.clientY-(this.pipelineNode.offsetTop||0)-this.playgroundConfigEntity.config.clientY-(r.clientHeight-this.dragOffset.y)*e,o=this.service.isDragBranch,h=new a.Ae(s,n,r.clientWidth*e,r.clientHeight*e),l=this.transitions.find(t=>{if(t?.entity?.parent?.collapsed)return!1;let{hasCollision:e,labelOffsetType:r}=this.flowDragConfigEntity.isCollision(t,h,o);return i=r,e});l&&(o?this.service.isDroppableBranch(l.entity,i):this.service.isDroppableNode(l.entity))&&(!this.options.canDrop||this.options.canDrop({dragNodes:this.dragEntities,dropNode:l.entity,isBranch:o}))?this.flowRenderStateEntity.setNodeDroppingId(l.entity.id):this.flowRenderStateEntity.setNodeDroppingId(""),this.flowRenderStateEntity.setDragLabelSide(i),this.containerRef.current.style.visibility="visible",this.pipelineNode.parentElement.appendChild(this.draggingNodeMask),this.containerRef.current.style.left=`${s}px`,this.containerRef.current.style.top=`${n}px`,this.containerRef.current.style.transformOrigin="top left",this.containerRef.current.style.transform=`scale(${e})`,this.flowDragConfigEntity.scrollDirection(t,this.containerRef.current,s,n)}}}handleMouseUp(){this.setDraggingStatus(!1),this.dragStartEntity&&(this.service.dropNodeId&&(this.service.isDragBranch?this.service.dropBranch():(this.service.dropNode(),this.selectConfigEntity.clearSelectedNodes())),this.flowRenderStateEntity.setNodeDroppingId(""),this.flowRenderStateEntity.setDragLabelSide(),this.dragStartEntity=void 0,this.dragEntities=[],this.flowDragConfigEntity.stopAllScroll()),this.containerRef.current&&(this.containerRef.current.style.visibility="hidden",this.pipelineNode.parentElement.contains(this.draggingNodeMask)&&this.pipelineNode.parentElement.removeChild(this.draggingNodeMask))}async startDrag(t,{dragStartEntity:e,dragEntities:i},r){if(this.isGrab()||this.config.disabled||this.config.readonly)return;this.dragOffset.x=r?.dragOffsetX||8,this.dragOffset.y=r?.dragOffsetY||8;let s=e.flowNodeType===n.Sy.BLOCK_ICON,o=e.flowNodeType===n.Sy.BLOCK_ORDER_ICON,a=s||o?e.parent:e;if(!!a.getData(n.Lz).draggable)return this.initialPosition={x:t.clientX,y:t.clientY},this.dragStartEntity=a,this.dragEntities=i||[this.dragStartEntity],this._dragger.start(t.clientX,t.clientY)}onReady(){this.draggingNodeMask.style.width="100%",this.draggingNodeMask.style.height="100%",this.draggingNodeMask.style.position="absolute",this.draggingNodeMask.classList.add("dragging-node"),this.draggingNodeMask.style.zIndex="99",this.draggingNodeMask.style.cursor="pointer",this.dragNodeComp=this.rendererRegistry.getRendererComponent("drag-node"),this.options.onDrop&&this.toDispose.push(this.service.onDrop(this.options.onDrop))}render(){let t=this.dragNodeComp.renderer;return c.createElement("div",{ref:this.containerRef,style:{position:"absolute",zIndex:99999,visibility:"hidden"},onMouseEnter:t=>t.stopPropagation()},c.createElement(t,{dragStart:this.dragStartEntity,dragNodes:this.dragEntities}))}};f([(0,l.f3)(n.pQ)],ts.prototype,"document",2),f([(0,l.f3)(n.eE)],ts.prototype,"service",2),f([(0,o.aI)(n.GA,n.eG)],ts.prototype,"transforms",2),f([(0,o.O0)(o.Zs)],ts.prototype,"editorStateConfig",2),f([(0,o.O0)(o.ER)],ts.prototype,"playgroundConfigEntity",2),f([(0,o.O0)(C)],ts.prototype,"flowDragConfigEntity",2),f([(0,o.O0)(n.y3)],ts.prototype,"flowRenderStateEntity",2),f([(0,o.O0)(b)],ts.prototype,"selectConfigEntity",2),f([(0,l.f3)(O)],ts.prototype,"rendererRegistry",2),ts=f([(0,l.b2)()],ts);var tn=class extends o.mh{constructor(){super(...arguments),this.node=a.xF.createDivWithClass("gedit-selector-box-layer"),this.selectorBox=this.createDOMCache("gedit-selector-box"),this.selectorBoxBlock=this.createDOMCache("gedit-selector-box-block"),this.selectboxDragger=new o.s5({onDragStart:t=>{this.selectConfigEntity.clearSelectedNodes();let e=this.playgroundConfigEntity.getPosFromMouseEvent(t);this.transformVisibles=this.flowDocument.getRenderDatas(n.eG,!1).filter(t=>{let{entity:i}=t;return i.originParent?this.nodeSelectable(i,e)&&this.nodeSelectable(i.originParent,e):this.nodeSelectable(i,e)}),this.selectorBoxConfigEntity.setDragInfo(t),this.updateSelectorBox(this.selectorBoxConfigEntity)},onDrag:t=>{this.selectorBoxConfigEntity.setDragInfo(t),this.selectConfigEntity.selectFromBounds(this.selectorBoxConfigEntity.toRectangle(this.playgroundConfigEntity.finalScale),this.transformVisibles),this.updateSelectorBox(this.selectorBoxConfigEntity)},onDragEnd:t=>{this.selectorBoxConfigEntity.setDragInfo(t),this.transformVisibles.length=0,this.updateSelectorBox(this.selectorBoxConfigEntity)}})}onReady(){!this.options.canSelect&&(this.options.canSelect=t=>{let e=t.target;return e===this.pipelineNode||e===this.playgroundNode}),this.toDispose.pushAll([this.selectConfigEntity.onConfigChanged(()=>{this.selectionService.selection=this.selectConfigEntity.selectedNodes}),this.selectionService.onSelectionChanged(()=>{let t=this.selectionService.selection.filter(t=>t instanceof n.GA);this.selectConfigEntity.selectedNodes=t})]),this.listenPlaygroundEvent("mousedown",t=>{if(!!this.isEnabled()&&(!this.options.canSelect||!!this.options.canSelect(t,this.selectorBoxConfigEntity)))return this.editorStateConfig.getCurrentState()===o.yy.STATE_MOUSE_FRIENDLY_SELECT&&this.selectConfigEntity.clearSelectedNodes(),this.selectboxDragger.start(t.clientX,t.clientY,this.config),!0},o.nn.BASE_LAYER)}isEnabled(){let t=this.editorStateConfig.getCurrentState(),e=t===o.yy.STATE_MOUSE_FRIENDLY_SELECT;return!this.config.disabled&&!this.config.readonly&&(e&&this.editorStateConfig.isPressingShift||t===o.yy.STATE_SELECT)&&!this.selectorBoxConfigEntity.disabled}dispose(){this.selectorBox.dispose(),this.selectorBoxBlock.dispose(),super.dispose()}updateSelectorBox(t){let e=this.selectorBox.get(),i=this.selectorBoxBlock.get();!this.isEnabled()&&t.isMoving&&this.selectorBoxConfigEntity.collapse(),this.isEnabled()&&t.isMoving?(e.setStyle({display:"block",left:t.position.x,top:t.position.y,width:t.size.width,height:t.size.height}),i.setStyle({display:"block",left:t.position.x-10,top:t.position.y-10,width:t.size.width+20,height:t.size.height+20})):(e.setStyle({display:"none"}),i.setStyle({display:"none"}))}nodeSelectable(t,e){let i=t.getNodeMeta().selectable;return"function"==typeof i?i(t,e):i}};f([(0,l.f3)(n.pQ)],tn.prototype,"flowDocument",2),f([(0,l.f3)(o.Lk)],tn.prototype,"contextMenuService",2),f([(0,o.O0)(o.ER)],tn.prototype,"playgroundConfigEntity",2),f([(0,l.f3)(o.z2)],tn.prototype,"selectionService",2),f([(0,o.O0)(N)],tn.prototype,"selectorBoxConfigEntity",2),f([(0,o.O0)(b)],tn.prototype,"selectConfigEntity",2),f([(0,o.O0)(o.Zs)],tn.prototype,"editorStateConfig",2),tn=f([(0,l.b2)()],tn);var to=class extends o.mh{constructor(){super(...arguments),this.node=a.xF.createDivWithClass("gedit-selector-bounds-layer"),this.selectBoundsBackground=a.xF.createDivWithClass("gedit-selector-bounds-background")}onReady(){this.node.style.zIndex="20";let{firstChild:t}=this.pipelineNode;void 0!==this.options.boundsPadding&&(this.flowSelectConfigEntity.boundsPadding=this.options.boundsPadding),this.options.backgroundClassName&&this.selectBoundsBackground.classList.add(this.options.backgroundClassName);let e=a.xF.createDivWithClass("gedit-playground-layer");e.appendChild(this.selectBoundsBackground),this.pipelineNode.insertBefore(e,t)}onZoom(t){this.node.style.transform=`scale(${t})`,this.selectBoundsBackground.parentElement.style.transform=`scale(${t})`}onViewportChange(){this.render()}isEnabled(){return this.editorStateConfig.getCurrentState()===o.yy.STATE_SELECT}render(){let{ignoreOneSelect:t,SelectorBoxPopover:e,disableBackground:i,CustomBoundsRenderer:r}=this.options,s=this.flowSelectConfigEntity.getSelectedBounds(),n=this.flowSelectConfigEntity.selectedNodes,o=this.selectBoundsBackground,h=!this.selectorBoxConfigEntity.isStart;if(0===s.width||0===s.height||t&&1===n.length&&n[0].childrenLength<=1)return a.xF.setStyle(o,{display:"none"}),c.createElement(c.Fragment,null);if(r)return c.createElement(r,{bounds:s,config:this.config,flowSelectConfig:this.flowSelectConfigEntity,commandRegistry:this.commandRegistry});let l={display:"block",left:s.left,top:s.top,width:s.width,height:s.height};!i&&a.xF.setStyle(o,l);let d="gedit-selector-bounds-foreground";this.options.foregroundClassName&&(d+=" "+this.options.foregroundClassName);let u=e||this.rendererRegistry.tryToGetRendererComponent("selector-box-popover")?.renderer;return h&&u?c.createElement(u,{bounds:s,config:this.config,flowSelectConfig:this.flowSelectConfigEntity,commandRegistry:this.commandRegistry},c.createElement("div",{className:d,style:l})):c.createElement("div",{className:d,style:l})}};f([(0,l.f3)(O)],to.prototype,"rendererRegistry",2),f([(0,l.f3)(o.Ho)],to.prototype,"commandRegistry",2),f([(0,o.O0)(b)],to.prototype,"flowSelectConfigEntity",2),f([(0,o.O0)(o.Zs)],to.prototype,"editorStateConfig",2),f([(0,o.O0)(N)],to.prototype,"selectorBoxConfigEntity",2),f([(0,o.aI)(n.GA,n.Lz)],to.prototype,"renderStates",2),f([(0,o.aI)(n.GA,n.eG)],to.prototype,"_transforms",2),to=f([(0,l.b2)()],to);var ta=class extends o.mh{constructor(){super(...arguments),this.node=a.xF.createDivWithClass("gedit-context-menu-layer"),this.nodeRef=c.createRef()}isEnabled(){let t=this.editorStateConfig.getCurrentState();return!this.config.disabled&&!this.config.readonly&&t===o.yy.STATE_SELECT&&!this.selectorBoxConfigEntity.disabled}onReady(){this.node.style.zIndex="30",this.node.style.display="block",this.toDispose.pushAll([this.listenPlaygroundEvent("contextmenu",t=>{if(!this.isEnabled())return;this.contextMenuService.rightPanelVisible=!0;let e=this.flowSelectConfigEntity.getSelectedBounds();if(0===e.width||0===e.height)return;t.stopPropagation(),t.preventDefault(),this.nodeRef.current?.setVisible(!0);let i=t.clientX-(this.pipelineNode.offsetLeft||0)-this.playgroundConfigEntity.config.clientX,r=t.clientY-(this.pipelineNode.offsetTop||0)-this.playgroundConfigEntity.config.clientY;this.node.style.left=`${i}px`,this.node.style.top=`${r}px`},o.nn.BASE_LAYER),this.listenPlaygroundEvent("mousedown",()=>{this.nodeRef.current?.setVisible(!1),this.contextMenuService.rightPanelVisible=!1})])}onScroll(){this.nodeRef.current?.setVisible(!1)}onZoom(){this.nodeRef.current?.setVisible(!1)}dispose(){super.dispose()}renderCommandMenus(){return this.commandRegistry.commands.filter(t=>"SELECTOR_BOX"===t.category).map(t=>{let e=this.rendererRegistry.getRendererComponent(t.icon||t.id)?.renderer;return c.createElement(e,{key:t.id,command:t,isContextMenu:!0,disabled:!this.commandRegistry.isEnabled(t.id),onClick:e=>this.commandRegistry.executeCommand(t.id,e)})}).filter(t=>t)}render(){let t=this.rendererRegistry.getRendererComponent("context-menu-popover").renderer;return c.createElement(t,{ref:this.nodeRef,content:this.renderCommandMenus()})}};f([(0,l.f3)(o.Ho)],ta.prototype,"commandRegistry",2),f([(0,l.f3)(O)],ta.prototype,"rendererRegistry",2),f([(0,l.f3)(o.Lk)],ta.prototype,"contextMenuService",2),f([(0,o.O0)(b)],ta.prototype,"flowSelectConfigEntity",2),f([(0,l.f3)(o.z2)],ta.prototype,"selectionService",2),f([(0,o.O0)(o.ER)],ta.prototype,"playgroundConfigEntity",2),f([(0,o.O0)(o.Zs)],ta.prototype,"editorStateConfig",2),f([(0,o.O0)(N)],ta.prototype,"selectorBoxConfigEntity",2),ta=f([(0,l.b2)()],ta);var th=class extends o.mh{getInitScroll(){return this.document.layout.getInitScroll(this.pipelineNode.getBoundingClientRect())}onReady(){let t=()=>this.getInitScroll();this.config.updateConfig(t()),this.config.addScrollLimit(e=>(function(t,e,i,r){t={...t};let s=i.config,n={scrollX:s.scrollX,scrollY:s.scrollY};if(0===e.length||0===s.width||0===s.height)return t;let o=Z(t,i);if(!e.find(t=>a.Ae.isViewportVisible(t,o))){let t=Z(n,i);return e.find(e=>a.Ae.isViewportVisible(e,t))?n:r()}return t})(e,[this.document.root.getData(n.eG).bounds],this.config,t))}};f([(0,l.f3)(n.pQ)],th.prototype,"document",2),th=f([(0,l.b2)()],th);var tl=new l.nZ(t=>{t(O).toSelf().inSingletonScope(),t(_).toSelf().inSingletonScope()})},832920:function(t,e,i){i.d(e,{XPE:()=>c.XP,V7e:()=>u.V7,SyX:()=>c.Sy,d3V:()=>d.d3,Zn3:()=>d.Zn,M1y:()=>d.M1,lVg:()=>u.lV,yyW:()=>d.yy,LzJ:()=>c.Lz,z2R:()=>d.z2,Fu1:()=>ew,Hxo:()=>Y,FwO:()=>d.Fw,tsW:()=>J,YvH:()=>d.Yv,qRT:()=>n,rQR:()=>d.rQ,JAk:()=>l.JA,kDE:()=>u.kD,eGM:()=>c.eG,R6T:()=>d.iX,HoL:()=>d.Ho,Dcz:()=>d.Dc,GAy:()=>c.GA,VOn:()=>d.VO,mYg:()=>d.mY,Psq:()=>tQ.Ps,KUq:()=>d.KU,oC4:()=>u.oC,C8:()=>c.C8,LPb:()=>te,F26:()=>tJ.F2,rVg:()=>tS,XQj:()=>d.XQ,h3M:()=>c.h3,C$T:()=>tJ.C$,Ys9:()=>tR,qq0:()=>u.qq,_J4:()=>tL,D9C:()=>c.D9,W6u:()=>d.W6,CMu:()=>h.CM,cL:()=>tG,G2Z:()=>d.G2,Emw:()=>u.Em,JTr:()=>l.JT,gNE:()=>X,XsM:()=>c.Xs,gNt:()=>tJ.gN,QUv:()=>c.QU,pQ4:()=>c.pQ,OTb:()=>c.OT,nYJ:()=>o,THq:()=>h.TH}),i("543789");var r,s,n,o,a,h=i("133253"),l=i("177783"),d=i("213153"),c=i("215206"),u=i("775832"),g=i("461932"),p=i("672429"),f=i("362270"),y=i("191443"),m=i("383419"),E=i("412151"),D=i("660594"),M=i("837338"),C=i("208730"),b=i("934074"),N=i("433210"),S=i("268479"),x=i("401502"),_=i("346747"),w=i("473482"),I=i("130582"),T=i("219163"),L=i("562135"),O=i("908600"),A=Object.defineProperty,k=Object.getOwnPropertyDescriptor,R=(t,e,i,r)=>{for(var s=r>1?void 0:r?k(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&A(e,i,s),s},P=(t,e)=>(i,r)=>e(i,r,t);function j(t){return l.JT.create(()=>t.unsubscribe())}var z=()=>{let t=new Map,e=(e,i)=>{if(t.has(e))return t.get(e);let r=i();return t.set(e,r),r};return e.clear=e=>{e?t.delete(e):t.clear()},e},V=Symbol("DynamicVariableEngine"),B=Symbol("ContainerProvider"),F=class{constructor(){this.toDispose=new l.K4}get variableEngine(){return this.variableEngineProvider()}refreshAllChange(){this.variableEngine.getAllScopes().forEach(t=>{t.refreshCovers(),t.refreshDeps()})}dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}get onDispose(){return this.toDispose.onDispose}};R([(0,g.f3)(V)],F.prototype,"variableEngineProvider",2),F=R([(0,g.b2)()],F);var Y=((r=Y||{}).String="String",r.Number="Number",r.Integer="Integer",r.Boolean="Boolean",r.Object="Object",r.Array="Array",r.Map="Map",r.Union="Union",r.Any="Any",r.Property="Property",r.VariableDeclaration="VariableDeclaration",r.VariableDeclarationList="VariableDeclarationList",r.KeyPathExpression="KeyPathExpression",r.EnumerateExpression="EnumerateExpression",r.ExpressionList="ExpressionList",r.ListNode="ListNode",r.DataNode="DataNode",r.MapNode="MapNode",r),U=Symbol("post_construct_ast");function G({getChildNode:t,updateChildNode:e,removeChildNode:i,nextJSON:r}){let s=t(),n=s?.kind!==r?.kind,o=r?.key&&r?.key!==s?.key;if(n||o){if(s&&(s.dispose(),i()),r){let t=this.createChildNode(r);return e(t),this.fireChange(),t}this.fireChange()}else r&&s?.fromJSON(r);return s}function Q(t){return"string"==typeof t?{kind:t}:t}function X(t,e){return t?.kind===e?.kind}var W=class t{constructor({key:t,parent:e,scope:i},r){this.flags=0,this._version=0,this.changeLocked=!1,this._batch={batching:!1,hasChangesInBatch:!1},this.value$=new y.X(this),this._children=new Set,this.toDispose=new l.K4(l.JT.create(()=>{this.parent?.fireChange(),this.children.forEach(t=>t.dispose())})),this.onDispose=this.toDispose.onDispose,this.scope=i,this.parent=e,this.opts=r,this.key=t||(0,N.x0)(),this.fromJSON=this.withBatchUpdate(this.fromJSON.bind(this)),this.dispatchGlobalEvent({type:"NewAST"})}get kind(){if(!this.constructor.kind)throw Error(`ASTNode Registry need a kind: ${this.constructor.name}`);return this.constructor.kind}get children(){return Array.from(this._children)}toJSON(){return console.warn("[VariableEngine] Please Implement toJSON method for "+this.kind),{kind:this.kind}}createChildNode(t){let e=this.scope.variableEngine.astRegisters.createAST(t,{parent:this,scope:this.scope});return this._children.add(e),e.toDispose.push(l.JT.create(()=>{this._children.delete(e)})),e}updateChildNodeByKey(t,e){this.withBatchUpdate(G).call(this,{getChildNode:()=>this[t],updateChildNode:e=>this[t]=e,removeChildNode:()=>this[t]=void 0,nextJSON:e})}withBatchUpdate(t){return(...e)=>{if(this._batch.batching)return t.call(this,...e);this._batch.hasChangesInBatch=!1,this._batch.batching=!0;let i=t.call(this,...e);return this._batch.batching=!1,this._batch.hasChangesInBatch&&this.fireChange(),this._batch.hasChangesInBatch=!1,i}}fireChange(){if(!this.changeLocked&&!this.disposed){if(this._batch.batching){this._batch.hasChangesInBatch=!0;return}this._version++,this.value$.next(this),this.dispatchGlobalEvent({type:"UpdateAST"}),this.parent?.fireChange()}}get version(){return this._version}get hash(){return`${this._version}${this.kind}${this.key}`}subscribe(e,{selector:i,debounceAnimation:r,triggerOnInit:s}={}){return j(this.value$.pipe((0,m.U)(()=>i?i(this):this),(0,E.x)((t,e)=>(0,S.shallowEqual)(t,e),e=>e instanceof t?e.hash:e),s?(0,D.b)(()=>null):(0,M.T)(1),r?(0,C.b)(0,b.Z):(0,D.b)(()=>null)).subscribe(e))}dispatchGlobalEvent(t){this.scope.event.dispatch({...t,ast:this})}dispose(){if(!this.toDispose.disposed)this.toDispose.dispose(),this.dispatchGlobalEvent({type:"DisposeAST"}),this.value$.complete(),this.value$.unsubscribe()}get disposed(){return this.toDispose.disposed}},$=class extends W{constructor(){super(...arguments),this.flags=8}isTypeEqual(t){let e=Q(t);return e?.kind==="Union"?(e?.types||[])?.some(t=>this.isTypeEqual(t)):this.kind===e?.kind}getByKeyPath(t=[]){throw Error(`Get By Key Path is not implemented for Type: ${this.kind}`)}toJSON(){return{kind:this.kind}}},J=class extends ${constructor(){super(...arguments),this.flags=48}fromJSON({items:t}){this.updateChildNodeByKey("items",Q(t))}get canDrilldownItems(){return!!(this.items?.flags&16)}getByKeyPath(t){let[e,...i]=t||[];if("0"===e&&this.canDrilldownItems)return this.items.getByKeyPath(i)}isTypeEqual(t){let e=Q(t),i=super.isTypeEqual(t);return e?.weak||e?.kind==="Union"?i:e&&i&&(e?.weak||this.customStrongEqual(e))}customStrongEqual(t){return this.items?this.items?.isTypeEqual(t.items):!t?.items}toJSON(){return{kind:"Array",items:this.items?.toJSON()}}};J.kind="Array";var H=class extends ${constructor(){super(...arguments),this.flags=8}fromJSON(){}};H.kind="String";var K=class extends ${constructor(){super(...arguments),this.flags=8}fromJSON(){}};K.kind="Integer";var Z=class extends ${fromJSON(){}};Z.kind="Boolean";var q=class extends ${fromJSON(){}};q.kind="Number";var tt=class extends ${fromJSON({keyType:t="String",valueType:e}){this.updateChildNodeByKey("keyType",Q(t)),this.updateChildNodeByKey("valueType",Q(e))}isTypeEqual(t){let e=Q(t),i=super.isTypeEqual(t);return e?.weak||e?.kind==="Union"?i:e&&i&&(e?.weak||this.customStrongEqual(e))}customStrongEqual(t){let{keyType:e="String",valueType:i}=t;return(!i&&!this.valueType||this.valueType?.isTypeEqual(i))&&this.keyType?.isTypeEqual(e)}toJSON(){return{kind:"Map",keyType:this.keyType?.toJSON(),valueType:this.valueType?.toJSON()}}};tt.kind="Map";var te=class extends ${constructor(){super(...arguments),this.flags=16,this.propertyTable=new Map}fromJSON({properties:t}){let e=new Set(this.propertyTable.keys()),i=[...this.properties||[]];this.properties=(t||[]).map(t=>{let i=this.propertyTable.get(t.key);if(e.delete(t.key),i)return i.fromJSON(t),i;{let e=this.createChildNode({...t,kind:"Property"});return this.fireChange(),this.propertyTable.set(t.key,e),e}}),e.forEach(t=>{let e=this.propertyTable.get(t);e?.dispose(),this.propertyTable.delete(t),this.fireChange()}),this.dispatchGlobalEvent({type:"ObjectPropertiesChange",payload:{prev:i,next:[...this.properties]}})}toJSON(){return{kind:"Object",properties:this.properties.map(t=>t.toJSON())}}getByKeyPath(t){let[e,...i]=t,r=this.propertyTable.get(e);return i.length?r?.type&&r?.type?.flags&16?r.type.getByKeyPath(i):void 0:r}isTypeEqual(t){let e=Q(t),i=super.isTypeEqual(t);return e?.weak||e?.kind==="Union"?i:e&&i&&(e?.weak||this.customStrongEqual(e))}customStrongEqual(t){let e=t.properties||[],i=Array.from(this.propertyTable.keys()),r=e.map(t=>t.key);return!(0,f.xor)(i,r).length&&e.every(t=>{let e=this.propertyTable.get(t.key);return e&&e.key===t.key&&e.type?.isTypeEqual(t?.type)})}};function ti(t){let e=t.parent,i=[];for(;e;)1&e.flags&&i.push(e),e=e.parent;return i}te.kind="Object";var tr=class extends W{constructor(t,e){super(t,e),this.flags=4,this._refs=[],this.refreshRefs$=new p.x,this.refs$=this.refreshRefs$.pipe((0,m.U)(()=>this.getRefFields()),(0,E.x)(S.shallowEqual),(0,x.w)(t=>t?.length?(0,w.a)(t.map(t=>t?t.value$:(0,_.of)(void 0))):(0,_.of)([])),(0,I.B)()),this.toDispose.push(j(this.refs$.subscribe(t=>{this._refs=t,this.fireChange()})))}get globalVariableTable(){return this.scope.variableEngine.globalVariableTable}get parentFields(){return ti(this)}get refs(){return this._refs}refreshRefs(){this.refreshRefs$.next()}},ts=class extends W{fromJSON({expressions:t}){this.expressions=t.map((t,e)=>{let i=this.expressions[e];return i.kind!==t.kind?(i.dispose(),this.fireChange(),this.createChildNode(t)):(i.fromJSON(t),i)})}toJSON(){return{kind:"ExpressionList",properties:this.expressions.map(t=>t.toJSON())}}};ts.kind="ExpressionList";var tn=class extends tr{constructor(t,e){super(t,e),this._keyPath=[],this.toDispose.pushAll([this.scope.available.onVariableListChange(()=>{this.refreshRefs()}),this.scope.available.onAnyVariableChange(t=>{t.key===this._keyPath[0]&&this.refreshRefs()})])}get keyPath(){return this._keyPath}getRefFields(){let t=this.scope.available.getByKeyPath(this._keyPath);return t?[t]:[]}get returnType(){let[t]=this._refs||[];if(t&&1&t.flags)return t.type}parseToKeyPath(t){return t.keyPath}fromJSON(t){let e=this.parseToKeyPath(t);!(0,S.shallowEqual)(e,this._keyPath)&&(this._keyPath=e,this.refreshRefs())}toJSON(){return{kind:"KeyPathExpression",keyPath:this._keyPath}}};tn.kind="KeyPathExpression";var to=class extends tr{get enumerateFor(){return this._enumerateFor}get returnType(){let t=this.enumerateFor?.returnType;if(t?.kind==="Array")return t.items}getRefFields(){return[]}fromJSON({enumerateFor:t}){this.updateChildNodeByKey("_enumerateFor",t)}toJSON(){return{kind:"EnumerateExpression",enumerateFor:this.enumerateFor?.toJSON()}}};to.kind="EnumerateExpression";(class extends tr{constructor(t,e){super(t,e),this._keyPath=[],this.toDispose.pushAll([this.scope.available.onVariableListChange(()=>{this.refreshRefs()}),this.scope.available.onAnyVariableChange(t=>{t.key===this._keyPath[0]&&this.refreshRefs()}),j(this.refs$.subscribe(t=>{let[e]=this._refs;this.prevRefTypeHash!==e?.type?.hash&&(this.prevRefTypeHash=e?.type?.hash,this.updateChildNodeByKey("_returnType",this.getReturnTypeJSONByRef(e)))}))])}get keyPath(){return this._keyPath}getRefFields(){let t=this.scope.available.getByKeyPath(this._keyPath);return function(t,e){if(0===(0,f.intersection)(t.scope.coverScopes,e.map(t=>t?.scope).filter(Boolean)).length)return!1;let i=new Set,r=[...e];for(;r.length;){let t=r.shift();for(let e of(i.add(t),(function t(e){return[...e.children,...e.children.map(e=>t(e)).flat()]})(t).filter(t=>4&t.flags).map(t=>t.refs).flat().filter(Boolean).filter(t=>!i.has(t))))r.push(e)}return(0,f.intersection)(Array.from(i),ti(t)).length>0}(this,[t])?(console.warn("[CustomKeyPathExpression] checkRefCycle: Reference Cycle Existed",this.parentFields.map(t=>t.key).reverse()),[]):t?[t]:[]}get returnType(){return this._returnType}parseToKeyPath(t){return t.keyPath}fromJSON(t){let e=this.parseToKeyPath(t);!(0,S.shallowEqual)(e,this._keyPath)&&(this._keyPath=e,this.refreshRefs())}getReturnTypeJSONByRef(t){return t?.type?.toJSON()}toJSON(){return{kind:"KeyPathExpression",keyPath:this._keyPath}}}).kind="KeyPathExpression";var ta=class extends W{constructor(){super(...arguments),this.flags=1,this._meta={}}get parentFields(){return ti(this)}get meta(){return this._meta}get type(){return this._initializer?.returnType||this._type}get initializer(){return this._initializer}fromJSON({type:t,initializer:e,meta:i}){this.updateType(t),this.updateInitializer(e),this.updateMeta(i)}updateType(t){this.updateChildNodeByKey("_type","string"==typeof t?{kind:t}:t)}updateInitializer(t){this.updateChildNodeByKey("_initializer",t)}updateMeta(t){!(0,S.shallowEqual)(t,this._meta)&&(this._meta=t,this.fireChange())}getByKeyPath(t){if(this.type?.flags&16)return this.type.getByKeyPath(t)}onTypeChange(t){return this.subscribe(t,{selector:t=>t.type})}toJSON(){return{kind:this.kind,key:this.key,type:this.type?.toJSON(),initializer:this.initializer?.toJSON(),meta:this._meta}}},th=class extends ta{constructor(t){super(t),this._order=0,this.scope.output.addVariableToTable(this),this.toDispose.push(l.JT.create(()=>{this.scope.output.setHasChanges(),this.scope.output.removeVariableFromTable(this.key)}))}get order(){return this._order}fromJSON({order:t,...e}){this.updateOrder(t),super.fromJSON(e)}updateOrder(t=0){t!==this._order&&(this._order=t,this.scope.output.setHasChanges(),this.fireChange())}onTypeChange(t){return this.subscribe(t,{selector:t=>t.type})}};th.kind="VariableDeclaration";var tl=class extends W{constructor(){super(...arguments),this.declarationTable=new Map}fromJSON({declarations:t,startOrder:e}){let i=new Set(this.declarationTable.keys()),r=[...this.declarations||[]];this.declarations=(t||[]).map((t,r)=>{let s=(e||0)+r,n=t.key||this.declarations?.[r]?.key,o=this.declarationTable.get(n);if(n&&i.delete(n),o)return o.fromJSON({order:s,...t}),o;{let e=this.createChildNode({order:s,...t,kind:"VariableDeclaration"});return this.fireChange(),this.declarationTable.set(e.key,e),e}}),i.forEach(t=>{let e=this.declarationTable.get(t);e?.dispose(),this.declarationTable.delete(t)}),this.dispatchGlobalEvent({type:"VariableListChange",payload:{prev:r,next:[...this.declarations]}})}toJSON(){return{kind:"VariableDeclarationList",properties:this.declarations.map(t=>t.toJSON())}}};tl.kind="VariableDeclarationList";var td=class extends ta{};td.kind="Property";var tc=class extends W{get data(){return this._data}fromJSON(t){let{kind:e,...i}=t;!(0,S.shallowEqual)(i,this._data)&&(this._data=i,this.fireChange())}toJSON(){return{kind:"DataNode",...this._data}}partialUpdate(t){!(0,S.shallowEqual)(t,this._data)&&(this._data={...this._data,...t},this.fireChange())}};tc.kind="DataNode",(class extends W{get list(){return this._list}fromJSON({list:t}){this._list.slice(t.length).forEach(t=>{t.dispose(),this.fireChange()}),this._list=t.map((t,e)=>{let i=this._list[e];return i.kind!==t.kind?(i.dispose(),this.fireChange(),this.createChildNode(t)):(i.fromJSON(t),i)})}toJSON(){return{kind:"ListNode",list:this._list.map(t=>t.toJSON())}}}).kind="ListNode";var tu=class extends W{constructor(){super(...arguments),this.map=new Map}fromJSON({map:t}){let e=new Set(this.map.keys());for(let[i,r]of t||[])e.delete(i),this.set(i,r);for(let t of Array.from(e))this.remove(t)}toJSON(){return{kind:"MapNode",map:Array.from(this.map.entries())}}set(t,e){return this.withBatchUpdate(G).call(this,{getChildNode:()=>this.get(t),removeChildNode:()=>this.map.delete(t),updateChildNode:e=>this.map.set(t,e),nextJSON:e})}remove(t){this.get(t)?.dispose(),this.map.delete(t),this.fireChange()}get(t){return this.map.get(t)}};tu.kind="MapNode";var tg=class{constructor(){this.injectors=new Map,this.astMap=new Map,this.registerAST(H),this.registerAST(q),this.registerAST(Z),this.registerAST(K),this.registerAST(te),this.registerAST(J),this.registerAST(tt),this.registerAST(td),this.registerAST(th),this.registerAST(tl),this.registerAST(tn),this.registerAST(to),this.registerAST(ts),this.registerAST(tu),this.registerAST(tc)}createAST(t,{parent:e,scope:i}){let r=this.astMap.get(t.kind);if(!r)throw Error(`ASTKind: ${String(t.kind)} can not find its ASTNode Registry`);let s=this.injectors.get(t.kind),n=new r({key:t.key,scope:i,parent:e},s?.()||{});if(n.changeLocked=!0,n.fromJSON((0,f.omit)(t,["key","kind"])),n.changeLocked=!1,Reflect.hasMetadata(U,n)){let t=Reflect.getMetadata(U,n);n[t]?.()}return n}getASTRegistryByKind(t){return this.astMap.get(t)}registerAST(t,e){this.astMap.set(t.kind,t),e&&this.injectors.set(t.kind,e)}};tg=R([(0,g.b2)()],tg),(s=n||(n={})).createString=()=>({kind:"String"}),s.createNumber=()=>({kind:"Number"}),s.createBoolean=()=>({kind:"Boolean"}),s.createInteger=()=>({kind:"Integer"}),s.createObject=t=>({kind:"Object",...t}),s.createArray=t=>({kind:"Array",...t}),s.createMap=t=>({kind:"Map",...t}),s.createUnion=t=>({kind:"Union",...t}),s.createVariableDeclaration=t=>({kind:"VariableDeclaration",...t}),s.createProperty=t=>({kind:"Property",...t}),s.createVariableDeclarationList=t=>({kind:"VariableDeclarationList",...t}),s.createEnumerateExpression=t=>({kind:"EnumerateExpression",...t}),s.createKeyPathExpression=t=>({kind:"KeyPathExpression",...t});var tp=class{constructor(t){this.parentTable=t,this.table=new Map,this.onDataChangeEmitter=new l.Q5,this.variables$=new p.x,this.anyVariableChange$=this.variables$.pipe((0,x.w)(t=>(0,T.T)(...t.map(t=>t.value$.pipe((0,M.T)(1))))),(0,I.B)()),this.onDataChange=this.onDataChangeEmitter.event,this._version=0}onAnyVariableChange(t){return j(this.anyVariableChange$.subscribe(t))}onAnyChange(t){let e=new l.K4;return e.pushAll([this.onDataChange(t),this.onAnyVariableChange(t)]),e}fireChange(){this._version++,this.onDataChangeEmitter.fire(),this.parentTable?.fireChange()}get version(){return this._version}get variables(){return Array.from(this.table.values())}get variableKeys(){return Array.from(this.table.keys())}getByKeyPath(t){let[e,...i]=t||[];if(!e)return;let r=this.getVariableByKey(e);return i.length?r?.getByKeyPath(i):r}getVariableByKey(t){return this.table.get(t)}addVariableToTable(t){this.table.set(t.key,t),this.parentTable&&this.parentTable.addVariableToTable(t),this.variables$.next(this.variables)}removeVariableFromTable(t){this.table.delete(t),this.parentTable&&this.parentTable.removeVariableFromTable(t),this.variables$.next(this.variables)}dispose(){this.variableKeys.forEach(t=>this.parentTable?.removeVariableFromTable(t)),this.onDataChangeEmitter.dispose()}},tf=class{constructor(t){this.scope=t,this.memo=z(),this._hasChanges=!1,this.variableTable=new tp(t.variableEngine.globalVariableTable),this.scope.toDispose.pushAll([this.scope.ast.subscribe(()=>{this._hasChanges&&(this.memo.clear(),this.notifyCoversChange(),this.variableTable.fireChange(),this._hasChanges=!1)}),this.variableTable])}get variableEngine(){return this.scope.variableEngine}get globalVariableTable(){return this.scope.variableEngine.globalVariableTable}get onDataChange(){return this.variableTable.onDataChange.bind(this.variableTable)}get onAnyVariableChange(){return this.variableTable.onAnyVariableChange.bind(this.variableTable)}get variables(){return this.memo("variables",()=>this.variableTable.variables.sort((t,e)=>t.order-e.order))}get variableKeys(){return this.memo("variableKeys",()=>this.variableTable.variableKeys)}addVariableToTable(t){if(t.scope!==this.scope)throw Error("VariableDeclaration must be a ast node in scope");this.variableTable.addVariableToTable(t),this._hasChanges=!0}setHasChanges(){this._hasChanges=!0}removeVariableFromTable(t){this.variableTable.removeVariableFromTable(t),this._hasChanges=!0}getVariableByKey(t){return this.variableTable.getVariableByKey(t)}notifyCoversChange(){this.scope.coverScopes.forEach(t=>t.available.refresh())}},ty=class{constructor(t){this.scope=t,this.memo=z(),this.refresh$=new p.x,this._variables=[],this.variables$=this.refresh$.pipe((0,m.U)(()=>(0,f.flatten)(this.depScopes.map(t=>t.output.variables||[]))),(0,E.x)(S.shallowEqual),(0,I.B)()),this.anyVariableChange$=this.variables$.pipe((0,x.w)(t=>(0,T.T)(...t.map(t=>t.value$.pipe((0,M.T)(1))))),(0,I.B)()),this.onDataChangeEmitter=new l.Q5,this.onDataChange=this.onDataChangeEmitter.event,this.scope.toDispose.pushAll([this.onVariableListChange(t=>{this._variables=t,this.memo.clear(),this.onDataChangeEmitter.fire(this._variables)}),this.onAnyVariableChange(()=>{this.onDataChangeEmitter.fire(this._variables)}),l.JT.create(()=>{this.refresh$.complete(),this.refresh$.unsubscribe()})])}get globalVariableTable(){return this.scope.variableEngine.globalVariableTable}refresh(){if(!this.scope.disposed)this.refresh$.next()}onAnyVariableChange(t){return j(this.anyVariableChange$.subscribe(t))}onVariableListChange(t){return j(this.variables$.subscribe(t))}get variables(){return this._variables}get variableKeys(){return this.memo("availableKeys",()=>this._variables.map(t=>t.key))}get depScopes(){return this.scope.depScopes}getByKeyPath(t=[]){if(!!this.variableKeys.includes(t[0]))return this.globalVariableTable.getByKeyPath(t)}},tm=class{constructor(t){this.scope=t,this.event$=new p.x,t.toDispose.pushAll([this.subscribe(e=>{t.variableEngine.fireGlobalEvent(e)})])}dispatch(t){if(!this.scope.disposed)this.event$.next(t)}subscribe(t){return j(this.event$.subscribe(t))}on(t,e){return j(this.event$.pipe((0,L.h)(e=>e.type===t)).subscribe(e))}},tv=class{constructor(t){this.memo=z(),this.toDispose=new l.K4,this.onDispose=this.toDispose.onDispose,this.id=t.id,this.meta=t.meta||{},this.variableEngine=t.variableEngine,this.event=new tm(this),this.ast=this.variableEngine.astRegisters.createAST({kind:"MapNode",key:this.id},{scope:this}),this.output=new tf(this),this.available=new ty(this)}refreshCovers(){this.memo.clear("covers")}refreshDeps(){this.memo.clear("deps"),this.available.refresh()}get depScopes(){return this.memo("deps",()=>this.variableEngine.chain.getDeps(this).filter(t=>!!t&&!t?.disposed))}get coverScopes(){return this.memo("covers",()=>this.variableEngine.chain.getCovers(this).filter(t=>!!t&&!t?.disposed))}dispose(){this.ast.dispose(),this.toDispose.dispose(),this.coverScopes.forEach(t=>t.refreshDeps()),this.depScopes.forEach(t=>t.refreshCovers())}get disposed(){return this.toDispose.disposed}},tE=class{constructor(t,e){this.chain=t,this.astRegisters=e,this.toDispose=new l.K4,this.memo=z(),this.scopeMap=new Map,this.globalEvent$=new p.x,this.onScopeChangeEmitter=new l.Q5,this.globalVariableTable=new tp,this.onScopeChange=this.onScopeChangeEmitter.event,this.toDispose.pushAll([t,l.JT.create(()=>{this.getAllScopes().forEach(t=>t.dispose()),this.globalVariableTable.dispose()})])}get container(){return this.containerProvider()}dispose(){this.toDispose.dispose()}getScopeById(t){return this.scopeMap.get(t)}removeScopeById(t){this.getScopeById(t)?.dispose()}createScope(t,e){let i=this.getScopeById(t);return!i&&(i=new tv({variableEngine:this,meta:e,id:t}),this.scopeMap.set(t,i),this.onScopeChangeEmitter.fire({type:"add",scope:i}),i.toDispose.pushAll([i.ast.subscribe(()=>{this.onScopeChangeEmitter.fire({type:"update",scope:i})}),i.available.onDataChange(()=>{this.onScopeChangeEmitter.fire({type:"available",scope:i})})]),i.onDispose(()=>{this.scopeMap.delete(t),this.onScopeChangeEmitter.fire({type:"delete",scope:i})})),i}getAllScopes({sort:t}={}){let e=Array.from(this.scopeMap.values());if(t){let t=this.chain.sortAll(),i=new Set(e);return t.forEach(t=>i.delete(t)),[...t,...Array.from(i)]}return[...e]}fireGlobalEvent(t){this.globalEvent$.next(t)}onGlobalEvent(t,e){return j(this.globalEvent$.subscribe(i=>{i.type===t&&e(i)}))}};R([(0,g.f3)(B)],tE.prototype,"containerProvider",2),R([(0,g.Pj)()],tE.prototype,"dispose",1),tE=R([(0,g.b2)(),P(0,(0,g.f3)(F)),P(1,(0,g.f3)(tg))],tE);var tD=class{constructor(){this.toDispose=new l.K4,this.renameEmitter=new l.Q5,this.disposeInListEmitter=new l.Q5,this.onRename=this.renameEmitter.event,this.onDisposeInList=this.disposeInListEmitter.event}handleFieldListChange(t,e,i){if(!t||!e?.length||!i?.length||e.length!==i.length){this.notifyFieldsDispose(e,i);return}let r=null,s=!1;for(let[t,n]of e.entries()){let o=i[t];if(n.key!==o.key){if(s){this.notifyFieldsDispose(e,i);return}s=!0,n.type?.kind===o.type?.kind&&(r={before:n,after:o})}}if(!r){this.notifyFieldsDispose(e,i);return}this.renameEmitter.fire(r)}notifyFieldsDispose(t,e){(0,f.difference)(t||[],e||[]).forEach(t=>this.disposeInListEmitter.fire(t))}init(){this.toDispose.pushAll([this.variableEngine.onGlobalEvent("VariableListChange",t=>{this.handleFieldListChange(t.ast,t.payload?.prev,t.payload?.next)}),this.variableEngine.onGlobalEvent("ObjectPropertiesChange",t=>{this.handleFieldListChange(t.ast,t.payload?.prev,t.payload?.next)})])}dispose(){this.toDispose.dispose()}};R([(0,g.f3)(tE)],tD.prototype,"variableEngine",2),R([(0,g.zY)()],tD.prototype,"init",1),R([(0,g.Pj)()],tD.prototype,"dispose",1),tD=R([(0,g.b2)()],tD);var tM=new g.nZ(t=>{t(tE).toSelf().inSingletonScope(),t(tg).toSelf().inSingletonScope(),t(tD).toSelf().inSingletonScope(),t(V).toDynamicValue(t=>()=>t.container.get(tE)),t(B).toDynamicValue(t=>()=>t.container)}),tC=(0,O.createContext)(null),tb=tC.Provider,tN=()=>O.useContext(tC)?.scope;function tS(){let t=tN(),e=(0,d.JA)();return(0,O.useEffect)(()=>{let i=t.available.onDataChange(()=>{e()});return()=>i.dispose()},[]),t.available}var tx=i("682264"),t_=Object.defineProperty,tw=Object.getOwnPropertyDescriptor,tI=(t,e,i,r)=>{for(var s=r>1?void 0:r?tw(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&t_(e,i,s),s},tT=(t,e)=>(i,r)=>e(i,r,t),tL=class extends d.RD{constructor(t,e){super(t),this.opts=e;let{variableEngine:i}=e||{};this.variableEngine=i,this._public=this.variableEngine.createScope(this.entity.id,{node:this.entity,type:"public"}),this.toDispose.push(this._public)}get private(){return this._private}get public(){return this._public}setVar(t,e){if("string"==typeof t&&void 0!==e)return this.public.ast.set(t,e);if("object"==typeof t&&void 0===e)return this.public.ast.set("outputs",t);throw Error("Invalid arguments")}getVar(t="outputs"){return this.public.ast.get(t)}clearVar(t="outputs"){return this.public.ast.remove(t)}setPrivateVar(t,e){if("string"==typeof t&&void 0!==e)return this.initPrivate().ast.set(t,e);if("object"==typeof t&&void 0===e)return this.initPrivate().ast.set("outputs",t);throw Error("Invalid arguments")}getPrivateVar(t="outputs"){return this.private?.ast.get(t)}clearPrivateVar(t="outputs"){return this.private?.ast.remove(t)}get allScopes(){let t=[];return this._public&&t.push(this._public),this._private&&t.push(this._private),t}getDefaultData(){return{}}initPrivate(){return!this._private&&(this._private=this.variableEngine.createScope(`${this.entity.id}_private`,{node:this.entity,type:"private"}),this._private.coverScopes.forEach(t=>{t.refreshDeps()}),this._private.depScopes.forEach(t=>{t.refreshCovers()}),this._private.available.refresh(),this.toDispose.push(this._private)),this._private}};tL.type="FlowNodeVariableData";var tO=Symbol("VariableLayoutConfig"),tA=class extends F{get tree(){return this.flowDocument.originTree}onInit(){this.toDispose.pushAll([this.entityManager.onEntityDataChange(({entityDataType:t})=>{t===tx.Z1.type&&this.refreshAllChange()}),this.tree.onTreeChange(()=>{this.refreshAllChange()})])}getAllInputLayerNodes(t){return(t.getData(tx.Z1)?.allInputNodes||[]).filter(e=>e.parent===t.parent)}getAllOutputLayerNodes(t){return(t.getData(tx.Z1)?.allOutputNodes||[]).filter(e=>e.parent===t.parent)}getDeps(t){let{node:e}=t.meta||{};if(!e)return this.transformDeps([],{scope:t});let i=[],r=e;for(;r;){let e=this.getAllInputLayerNodes(r);i.push(...e.map(t=>t.getData(tL).public).filter(Boolean));let s=r.getData(tL);s?.private&&t!==s.private&&i.push(s.private),r=this.getParent(r)}let s=Array.from(new Set(i));return this.transformDeps(s,{scope:t})}getCovers(t){let{node:e}=t.meta||{};if(!e)return this.transformCovers([],{scope:t});let i="private"===t.meta.type,r=[];i?r.push(...this.getChildren(e)):r.push(...this.getAllOutputLayerNodes(e)||[]);let s=[];for(;r.length;){let t=r.shift(),e=t.getData(tL);s.push(...e.allScopes);let i=t&&this.getChildren(t);i?.length&&r.push(...i)}let n=e.getData(tL);i&&n.public&&s.push(n.public);let o=Array.from(new Set(s));return this.transformCovers(o,{scope:t})}transformCovers(t,{scope:e}){return this.configs?.transformCovers?this.configs.transformCovers(t,{scope:e,document:this.flowDocument,variableEngine:this.variableEngine}):t}transformDeps(t,{scope:e}){return this.configs?.transformDeps?this.configs.transformDeps(t,{scope:e,document:this.flowDocument,variableEngine:this.variableEngine}):t}getChildren(t){if(this.configs?.getFreeChildren)return this.configs.getFreeChildren?.(t);let e=t.getNodeMeta(),i=e.subCanvas?.(t);if(i)return i.isCanvas?[]:i.canvasNode.collapsedChildren;return this.tree.getChildren(t)}getParent(t){if(this.configs?.getFreeParent)return this.configs.getFreeParent(t);let e=t.document.originTree.getParent(t);if(!e)return e;let i=e.getNodeMeta(),r=i.subCanvas?.(e);return r?.isCanvas?r.parentNode:e}sortAll(){return console.warn("FreeLayoutScopeChain.sortAll is not implemented"),[]}};tI([(0,g.f3)(d.v2)],tA.prototype,"entityManager",2),tI([(0,g.f3)(c.pQ)],tA.prototype,"flowDocument",2),tI([(0,g.jt)(),(0,g.f3)(tO)],tA.prototype,"configs",2),tI([(0,g.zY)()],tA.prototype,"onInit",1);var tk=class extends F{constructor(t,e){super(),this.flowDocument=t,this.configs=e,this.bindTree(t.originTree),this.toDispose.push(t.originTree.onTreeChange(()=>{this.refreshAllChange()}))}bindTree(t){this.tree=t}getDeps(t){if(!this.tree)return this.transformDeps([],{scope:t});let e=t.meta.node;if(!e)return this.transformDeps([],{scope:t});let i=[],r=e;for(;r;){let{parent:s,pre:n}=this.tree.getInfo(r),o=this.getVariableData(r);if(r===e?"public"===t.meta.type&&o?.private&&i.unshift(o.private):this.hasChildren(r)&&!this.isNodeChildrenPrivate(r)&&i.unshift(...this.getAllSortedChildScope(r,{ignoreNodeChildrenPrivate:!0})),o&&r!==e&&i.unshift(o.public),n){r=n;continue}if(s){let t=s,e=this.tree.getPre(t);for(;t;){let r=this.getVariableData(t);if(r&&i.unshift(...r.allScopes),e)break;e=(t=this.tree.getParent(t))?this.tree.getPre(t):void 0}r=e;continue}r=void 0}return this.transformDeps(i,{scope:t})}getCovers(t){if(!this.tree)return this.transformCovers([],{scope:t});let e=t.meta.node;if(!e)return this.transformCovers([],{scope:t});let i=[];if("private"===t.meta.type)return i.push(...this.getAllSortedChildScope(e,{addNodePrivateScope:!0})),this.transformCovers(i,{scope:t});let r=e;for(;r;){let{next:s,parent:n}=this.tree.getInfo(r),o=this.getVariableData(r);if(r!==e&&(this.hasChildren(r)?i.push(...this.getAllSortedChildScope(r,{addNodePrivateScope:!0})):o&&i.push(...o.allScopes)),s){r=s;continue}if(n){let e=n,s=this.tree.getNext(e);for(;e;){if(this.isNodeChildrenPrivate(e))return this.transformCovers(i,{scope:t});if(s)break;s=(e=this.tree.getParent(e))?this.tree.getNext(e):void 0}if(!s&&e)break;r=s;continue}r=void 0}return this.transformCovers(i,{scope:t})}transformCovers(t,{scope:e}){return this.configs?.transformCovers?this.configs.transformCovers(t,{scope:e,document:this.flowDocument,variableEngine:this.variableEngine}):t}transformDeps(t,{scope:e}){return this.configs?.transformDeps?this.configs.transformDeps(t,{scope:e,document:this.flowDocument,variableEngine:this.variableEngine}):t}sortAll(){let{startNodeId:t}=this.configs||{},e=t?this.flowDocument?.getNode(t):void 0;if(!e)return[];let i=e.getData(tL);return[i.public,...this.getCovers(i.public)]}getVariableData(t){if(!("virtualNode"===t.flowNodeType||t.id.startsWith("$")))return t.getData(tL)}isNodeChildrenPrivate(t){return this.configs?.isNodeChildrenPrivate?!!t&&this.configs?.isNodeChildrenPrivate(t):!t?.id.startsWith("$")&&this.hasChildren(t)}hasChildren(t){return!!(this.tree&&t&&this.tree.getChildren(t).length>0)}getAllSortedChildScope(t,{ignoreNodeChildrenPrivate:e,addNodePrivateScope:i}={}){let r=[],s=this.getVariableData(t);if(s&&r.push(s.public),e&&this.isNodeChildrenPrivate(t))return r;i&&s?.private&&r.push(s.private);let n=this.tree?.getChildren(t)||[];return r.push(...n.map(t=>this.getAllSortedChildScope(t,{ignoreNodeChildrenPrivate:e,addNodePrivateScope:i})).flat()),r}};tk=tI([tT(0,(0,g.f3)(c.pQ)),tT(1,(0,g.jt)()),tT(1,(0,g.f3)(tO))],tk);var tR=(0,d.M1)({onBind({bind:t},e){let{layout:i,layoutConfig:r}=e;"free"===i&&t(F).to(tA).inSingletonScope(),"fixed"===i&&t(F).to(tk).inSingletonScope(),r&&t(tO).toConstantValue(r||{})},onInit(t,e){let{extendASTNodes:i}=e||{},r=t.get(tE),s=t.get(tg),n=t.get(d.v2),o=t.get(c.pQ);(i||[]).forEach(e=>{if(Array.isArray(e)){let[i,r]=e;s.registerAST(i,r?()=>r(t):void 0);return}s.registerAST(e)}),n.registerEntityData(tL,()=>({variableEngine:r})),o.registerNodeDatas(tL)},containerModules:[tM]}),tP=Object.defineProperty,tj=Object.getOwnPropertyDescriptor,tz=(t,e,i,r)=>{for(var s=r>1?void 0:r?tj(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&tP(e,i,s),s},tV=Symbol("ShortcutsContribution"),tB=class{constructor(){this.shortcutsHandlers=[]}addHandlers(...t){t.forEach(t=>{this.commandRegistry.getCommand(t.commandId)?this.commandRegistry.registerHandler(t.commandId,{execute:t.execute,isEnabled:t.isEnabled}):this.commandRegistry.registerCommand({id:t.commandId,...t.commandDetail||{}},{execute:t.execute,isEnabled:t.isEnabled})}),this.shortcutsHandlers.push(...t)}addHandlersIfNotFound(...t){t.forEach(t=>{!this.has(t.commandId)&&this.addHandlers(t)})}has(t){return this.shortcutsHandlers.some(e=>e.commandId===t)}init(){this.contribs?.forEach(t=>t.registerShortcuts(this))}};tz([(0,g.f3)(d.Qc),(0,g.t6)(tV),(0,g.jt)()],tB.prototype,"contribs",2),tz([(0,g.f3)(d.Ho)],tB.prototype,"commandRegistry",2),tz([(0,g.zY)()],tB.prototype,"init",1),tB=tz([(0,g.b2)()],tB);var tF={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pausebreak:19,capslock:20,esc:27,space:32,pageup:33,pagedown:34,end:35,home:36,leftarrow:37,uparrow:38,rightarrow:39,downarrow:40,insert:45,delete:46,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,leftwindowkey:91,rightwindowkey:92,meta:/(mac|iphone|ipod|ipad)/i.test("undefined"!=typeof navigator?navigator?.platform:"")?[91,93]:[91,92],selectkey:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimalpoint:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,semicolon:186,equalsign:187,"=":187,comma:188,dash:189,"-":189,period:190,forwardslash:191,graveaccent:192,openbracket:219,backslash:220,closebracket:221,singlequote:222},tY={ctrl:t=>t.ctrlKey,shift:t=>t.shiftKey,alt:t=>t.altKey,meta:t=>"keyup"===t.type?tF.meta.includes(t.keyCode):t.metaKey},tU=class extends d.mh{onReady(){this.shortcuts.addHandlersIfNotFound({commandId:d.mY.Default.ZOOM_IN,shortcuts:["meta =","ctrl ="],execute:()=>{this.config.zoomin()}},{commandId:d.mY.Default.ZOOM_OUT,shortcuts:["meta -","ctrl -"],execute:()=>{this.config.zoomout()}}),this.toDispose.pushAll([this.listenPlaygroundEvent("keydown",t=>{if(!!this.isFocused&&t.target===this.playgroundNode)this.shortcuts.shortcutsHandlers.some(e=>{var i;if(i=t,e.shortcuts.some(t=>(function(t,e,i=!0){if(!t.key||!e)return!1;let r=e.split(/\s+/),s=0;for(let e of r){let i=tY[e],r=tF[e.toLowerCase()];(i&&i(t)||r&&r===t.keyCode)&&s++}return i?s===r.length&&function(t){let e=Object.keys(tY).reduce((e,i)=>tY[i](t)?e+1:e,0);return[16,17,18,91,92].includes(t.keyCode)?e:e+1}(t)===r.length:s===r.length})(i,t))&&(!e.isEnabled||e.isEnabled(t)))return e.execute(t),t.preventDefault(),!0})})])}};tU.type="ShortcutsLayer",tz([(0,g.f3)(tB)],tU.prototype,"shortcuts",2),tz([(0,g.f3)(d.z2)],tU.prototype,"selection",2),tU=tz([(0,g.b2)()],tU);var tG=(0,d.M1)({onBind:({bind:t})=>{t(tB).toSelf().inSingletonScope(),(0,d.yb)(t,tV)},onInit:t=>{t.playground.registerLayer(tU)},contributionKeys:[tV]}),tQ=i("664881"),tX=(0,d.M1)({onInit(t,e){t.get(c.pQ).registerNodeDatas(...(0,tQ.Co)());let i=t=>new h.wL(t);if(t.get(d.v2).registerEntityData(tQ.Ps,()=>({formModelFactory:i})),!e.materials)return;let r=t.get(tQ.Bl),s=t.get(tQ.yf);if(!r||!s)throw Error("NodeCorePlugin Error: nodeManager or formManager not found");!function({nodeManager:t,formManager:e,material:i}){let{setters:r=[],decorators:s=[],effects:n=[],validators:o=[],nodeErrorRender:a,nodePlaceholderRender:h}=i;a&&(0,tQ.kq)(t,a),h&&(0,tQ.FC)(t,h),r.forEach(t=>{e.registerAbilityExtension(tQ.Bw.type,t)}),s.forEach(t=>{e.registerAbilityExtension(tQ.GH.type,t)}),n.forEach(t=>{e.registerAbilityExtension(tQ.ps.type,t)}),o.forEach(t=>{e.registerAbilityExtension(tQ.Us.type,t)})}({nodeManager:r,formManager:s,material:e.materials})},onDispose(t){t.get(tQ.yf)?.dispose()},containerModules:(0,tQ.pm)()}),tW=i("339196"),t$=(0,d.M1)({onInit:(t,e)=>{e.onLanguageChange&&t.playground.toDispose.push(tW.o.onLanguageChange(e.onLanguageChange)),e.languages&&e.languages.forEach(t=>tW.o.addLanguage(t)),e.localLanguage&&tW.o.setLocalLanguage(e.localLanguage)}}),tJ=i("112168"),tH=Object.defineProperty,tK=Object.getOwnPropertyDescriptor,tZ=(t,e,i,r)=>{for(var s=r>1?void 0:r?tK(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&tH(e,i,s),s},tq=class{constructor(){this.devTools=window.__REDUX_DEVTOOLS_EXTENSION__?.connect({name:this.getName()})}init(){this.devTools&&(this.devTools.init(this.getState()),this.devTools.subscribe(t=>{t?.payload?.type==="COMMIT"&&this.devTools.init(this.getState())}),this.onInit())}send(t,e){this.devTools&&this.devTools.send(t,e||this.getState())}};tZ([(0,g.zY)()],tq.prototype,"init",1),tq=tZ([(0,g.b2)()],tq);var t0=class extends tq{getName(){return"@flowgram.ai/EntityManager"}getState(){return this.entityManager.storeState({configOnly:!1})}onInit(){this.entityManager.onEntityLifeCycleChange(t=>{this.send(`${t.type}/${t.entity.type}/${t.entity.id}`)})}};tZ([(0,g.f3)(d.v2)],t0.prototype,"entityManager",2),t0=tZ([(0,g.b2)()],t0);var t1=class extends tq{constructor(){super(...arguments),this.scopes={}}getName(){return"@flowgram.ai/VariableEngine"}getState(){return{scopes:this.scopes,variables:this.variableEngine.globalVariableTable.variables}}getScopeState(t){return{ast:t?.ast.toJSON(),output:t.output.variables,available:t.available.variables}}onInit(){this.variableEngine.onScopeChange(t=>{let{scope:e,type:i}=t;"delete"===i?delete this.scopes[e.id]:this.scopes={...this.scopes,[e.id]:this.getScopeState(e)},this.send(`${i}/${e.id}`)})}};tZ([(0,g.f3)(tE)],t1.prototype,"variableEngine",2),t1=tZ([(0,g.b2)()],t1);var t2=(0,d.M1)({onBind({bind:t},e){let{enable:i}=e;if(!!i)t(t0).toSelf().inSingletonScope(),t(t1).toSelf().inSingletonScope()},onInit(t,e){let{enable:i,ecs:r=!0,variable:s=!1}=e;if(!!i)r&&t.get(t0),s&&t.get(t1)}}),t4=Object.defineProperty,t3=Object.getOwnPropertyDescriptor,t5=0,t6=class extends d.mh{constructor(){super(...arguments),this._patternId=`gedit-background-pattern-${t5++}`,this.node=l.xF.createDivWithClass("gedit-flow-background-layer"),this.grid=document.createElement("div")}get zoom(){return this.config.finalScale}onReady(){let{firstChild:t}=this.pipelineNode;this.pipelineNode.insertBefore(this.node,t),this.playgroundConfigEntity.updateConfig({minZoom:.1,maxZoom:2}),this.grid.style.zIndex="-1",this.grid.style.position="relative",this.node.appendChild(this.grid),this.grid.className="gedit-grid-svg"}getScaleUnit(){let{zoom:t}=this;return{realSize:20,renderSize:Math.round(20*t*100)/100,zoom:t}}autorun(){let t=this.playgroundConfigEntity.config,e=this.getScaleUnit(),i=10*e.renderSize,r=t.width+2*i,s=t.height+2*i,{scrollX:n}=t,{scrollY:o}=t,a=this.getScrollDelta(n,i),h=this.getScrollDelta(o,i);l.xF.setStyle(this.node,{left:n-d.JW,top:o-d.JW}),this.drawGrid(e),this.setSVGStyle(this.grid,{width:r,height:s,left:d.JW-a-i,top:d.JW-h-i})}drawGrid(t){let e=t.renderSize;if(!this.grid)return;let i=1*this.zoom,r=`
    <svg width="100%" height="100%">
      <pattern id="${this._patternId}" width="${e}" height="${e}" patternUnits="userSpaceOnUse">
        <circle
          cx="${i}"
          cy="${i}"
          r="${i}"
          stroke="#eceeef"
          fill-opacity="0.5"
        />
      </pattern>
      <rect width="100%" height="100%" fill="url(#${this._patternId})"/>
    </svg>`;this.grid.innerHTML=r}setSVGStyle(t,e){if(!!t)t.style.width=`${e.width}px`,t.style.height=`${e.height}px`,t.style.left=`${e.left}px`,t.style.top=`${e.top}px`}getScrollDelta(t,e){return t>=0?t%e:e-Math.abs(t)%e}};t6.type="WorkflowBackgroundLayer",((t,e,i,r)=>{for(var s=r>1?void 0:r?t3(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&t4(e,i,s)})([(0,d.O0)(d.ER)],t6.prototype,"playgroundConfigEntity",2);var t8=(0,d.M1)({onInit:(t,e)=>{t.playground.registerLayer(t6,e)}}),t9=Object.defineProperty,t7=Object.getOwnPropertyDescriptor;function et(t,e=[]){return i=>(e=e.slice(),t.shortcuts&&e.push(tG({registerShortcuts:e=>t.shortcuts(e,i)})),t.plugins&&e.push(...t.plugins(i)),e.push((0,d.d3)({onBind:e=>{t.onBind?.(e)},onInit:e=>{let i=e.get(d.W4);t.playground&&(void 0!==t.playground.autoFocus&&(i.autoFocus=t.playground.autoFocus),void 0!==t.playground.autoResize&&(i.autoResize=t.playground.autoResize)),i.autoFocus=!1,e.playground.registerLayer(d.wY,t.playground),t.layers&&e.playground.registerLayers(...t.layers),t.onInit&&t.onInit(e)},onReady(e){t.onReady&&t.onReady(e)},onAllLayersRendered(){t.onAllLayersRendered&&t.onAllLayersRendered(i)},onDispose(){t.onDispose&&t.onDispose(i)},containerModules:t.containerModules||[]})),(t.background||void 0===t.background)&&e.push(t8(t.background||{})),e)}var ee=class extends d.mh{constructor(){super(...arguments),this.node=l.xF.createDivWithClass("gedit-playground-layer gedit-playground-content-layer")}onZoom(t){this.node.style.transform=`scale(${t})`}onReady(){this.node.style.left="0px",this.node.style.top="0px"}updateOptions(t){this.options=t,this.render()}render(){return O.createElement("div",{className:this.options.className,style:{position:"absolute",...this.options.style}},this.options.children)}};ee.type="PlaygroundContentLayer",ee=((t,e,i,r)=>{for(var s=r>1?void 0:r?t7(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&t9(e,i,s),s})([(0,g.b2)()],ee),(0,O.forwardRef)(function(t,e){let{parentContainer:i,children:r,...s}=t,n=(0,O.useMemo)(()=>(0,d.d3)({onInit(t){t.playground.registerLayer(ee)}}),[]),o=(0,O.useMemo)(()=>et(s,[n]),[]);return O.createElement(d.W6,{ref:e,plugins:o,parentContainer:i},O.createElement(d.iX,null,r))});var ei=({children:t})=>{let e=(0,d.km)(),i=(0,O.useMemo)(()=>e.getData(tL).public,[e]);return O.createElement(tb,{value:{scope:i}},t)},er=t=>e=>O.createElement(ei,null,O.createElement(t,{...e})),es=(0,d.M1)({onInit(t){t.get(tQ.Bl).registerNodeRenderHoc(er)}});(0,h.CR)("VariableProviderPlugin",{onInit:(t,e)=>{},effect:{arr:[{event:h.zE.onValueInitOrChange,effect:()=>{}}]},onDispose:(t,e)=>{}});var en=(0,d.M1)({onInit(t,e){let i=t.get(u.Rf);i.registerReactComponent(u.kD.NODE_RENDER,e.renderDefaultNode||(()=>null)),e.renderTexts&&i.registerText(e.renderTexts),e.renderNodes&&Object.keys(e.renderNodes).forEach(t=>i.registerReactComponent(t,e.renderNodes[t]))}}),eo=i("246038"),ea=Object.defineProperty,eh=Object.getOwnPropertyDescriptor;function el(t){if(!t)return;let e=t?.getData(tQ.Ps)?.getFormModel();if(!!e&&!!(0,h.TH)(e))return e}var ed=[{type:"changeFormValues",inverse:t=>({...t,value:{...t.value,value:t.value.oldValue,oldValue:t.value.value}}),apply:({value:{value:t,path:e,id:i}},r)=>{let s=el(r.get(c.pQ).getNode(i));if(!!s)s.setValueIn(e,t)},shouldMerge:function(t,e,i){if(!e)return!1;if(Date.now()-i.getTimestamp()<500)return t.type!==e.type||t.value?.id!==e.value?.id||t.value?.path!==e.value?.path||{type:t.type,value:{...t.value,value:t.value?.value,oldValue:e.value?.oldValue}};return!1}}],ec=class{registerOperationMeta(t){ed.forEach(e=>{t.registerOperationMeta(e)})}};ec=((t,e,i,r)=>{for(var s=r>1?void 0:r?eh(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&ea(e,i,s),s})([(0,g.b2)()],ec);var eu=(0,d.M1)({onBind:({bind:t})=>{(0,d.KV)(t,ec,[eo.FU])},onInit:(t,e)=>{let i=t.get(c.pQ),r=t.get(eo.qp);i.onNodeCreate(({node:t})=>{let e=el(t);if(!!e)!function(t,e,i){t.onFormValuesChange(t=>{i.pushOperation({type:"changeFormValues",value:{id:e.id,path:t.name,value:(0,f.get)(t.values,t.name),oldValue:(0,f.get)(t.prevValues,t.name)}},{noApply:!0})})}(e,t,r)})},containerModules:[eo.Xn]}),eg=Object.defineProperty,ep=Object.getOwnPropertyDescriptor,ef=(t,e,i,r)=>{for(var s=r>1?void 0:r?ep(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&eg(e,i,s),s},ey=Symbol("EditorOptions");(o||(o={})).DEFAULT={background:{},fromNodeJSON(t,e){let i=t.getData(tQ.Ps);if(i){let r=t.getService(ey).nodeEngine?.createDefaultFormMeta?.(t),s=t.getNodeRegistry()?.formMeta||r;s&&i.createForm(s,e.data)}else e.data&&t.updateExtInfo(e.data)},toNodeJSON(t){let e;let i={};return t.document.traverse(t=>{if(t.id.startsWith("$"))return;let r=t.getData(tQ.Ps),s=r&&r.formModel&&r.formModel.initialized?r.toJSON():void 0,n={id:t.id,type:t.flowNodeType,data:r?s:t.getExtInfo(),blocks:[]};!e&&(e=n);let{parent:o}=t;o&&o.id.startsWith("$")&&(o=o.originParent);let a=o?i[o.id]:void 0;a&&a.blocks?.push(n),i[t.id]=n},t),e}};var em=t=>(e,i)=>{let r=t.filter(Boolean);return r.length?r.reduce((t,i)=>i(e,t),i):i},ev="flowide-highlight",eE=`
@keyframes flowide-fade {
  from {
   opacity: 1.0;
  }
  to {
    opacity: 0;
  }
}
@-webkit-keyframes flowide-fade {
  from {
   opacity: 1.0;
  }
  to {
    opacity: 0;
  }
}
.${ev} {
  background-color: rgba(238, 245, 40, 0.5);
  animation: flowide-fade 2s 1 forwards;
  -webkit-animation: flowide-fade 2s 1 forwards;
}
`,eD=class{highlightNodeFormItem(t,e){this.previousOverlay=function(t,e){let i=t.formModel.flowNodeEntity.getData(c.Lz).node,r=t.domRef.current;if(!r)return;let s=document.createElement("div"),{padding:n=0,overlayClassName:o}=e||{};s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.width="100%",s.style.height="100%",s.style.zIndex="9999",i.appendChild(s);let a=i.getBoundingClientRect(),h=r.getBoundingClientRect();return s.style.top=h.top-a.top-n+"px",s.style.left=h.left-a.left-n+"px",s.style.width=h.width+2*n+"px",s.style.height=h.height+2*n+"px",s.className=o||ev,setTimeout(()=>{s.remove()},2e3),s}(t,e)}focusNodeFormItem(t,e){let i=t.formModel.flowNodeEntity,{canvas:r={},highlight:s}=e||{};this.previousOverlay&&(this.previousOverlay.remove(),this.previousOverlay=void 0);let n=this.playground.scrollToView({entities:[i],scrollToCenter:!0,...r}).then(()=>{if(!!t&&!!s&&this.currentPromise===n)this.highlightNodeFormItem(t,"boolean"==typeof s?{}:s)});return this.currentPromise=n,this.currentPromise}};ef([(0,g.f3)(d.XQ)],eD.prototype,"playground",2),eD=ef([(0,g.b2)()],eD);var eM=class{};ef([(0,g.f3)(eD)],eM.prototype,"nodeFocusService",2),eM=ef([(0,g.b2)()],eM);var eC=(0,d.M1)({onInit(){a||((a=document.createElement("style")).innerHTML=eE,document.head.appendChild(a))},onDispose(){a?.remove(),a=void 0}}),eb=(0,d.M1)({onBind({bind:t}){t(eD).toSelf().inSingletonScope(),t(eM).toSelf().inSingletonScope()}}),eN=()=>[eC({}),eb({})],eS=class{focusNodeFormItem(t,e){this.nodeClient.nodeFocusService.focusNodeFormItem(t,e)}focusNode(t,e){this.playground.scrollToView({entities:[t],...e})}};ef([(0,g.f3)(eM)],eS.prototype,"nodeClient",2),ef([(0,g.f3)(d.XQ)],eS.prototype,"playground",2),eS=ef([(0,g.b2)()],eS);var ex=(0,d.M1)({onBind({bind:t}){t(eS).toSelf().inSingletonScope()}}),e_=()=>[...eN(),ex({})];function ew(t,e=[]){return i=>{t={...o.DEFAULT,...t},i.container.bind(ey).toConstantValue(t),t.i18n&&e.push(t$(t.i18n)),e.push(...e_()),t.reduxDevTool?.enable&&e.push(t2(t.reduxDevTool));let r=[c.d1,u.qf];return e.push(en(t.materials||{})),t.nodeEngine&&!1!==t.nodeEngine.enable&&(e.push(tX({materials:t.nodeEngine.materials})),t.variableEngine?.enable&&e.push(es({})),t.history?.enable&&e.push(eu({}))),e.push((0,d.d3)({onInit:e=>{t.nodeRegistries&&e.document.registerFlowNodes(...t.nodeRegistries),t.constants&&(e.document.options.constants=t.constants),t.formatNodeLines&&(e.document.options.formatNodeLines=em([e.document.options.formatNodeLines,t.formatNodeLines])),t.formatNodeLabels&&(e.document.options.formatNodeLabels=em([e.document.options.formatNodeLabels,t.formatNodeLabels])),t.getNodeDefaultRegistry&&(e.document.options.getNodeDefaultRegistry=t.getNodeDefaultRegistry),e.get(u.Rf).init()},onReady(e){t.initialData&&e.document.fromJSON(t.initialData),t.readonly&&(e.playground.config.readonly=t.readonly),e.document.load().then(()=>{t.onLoad&&t.onLoad(e)})},onDispose(t){t.document.dispose()},containerModules:r})),et(t,e)(i)}}},246038:function(t,e,i){i.d(e,{CD:function(){return u},FU:function(){return c},Xn:function(){return C},f9:function(){return f},qp:function(){return M}});var r=i(461932),s=i(177783),n=i(433210),o=i(362270),a=i(213153),h=Object.defineProperty,l=Object.getOwnPropertyDescriptor,d=(t,e,i,r)=>{for(var s=r>1?void 0:r?l(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&h(e,i,s),s},c=Symbol("OperationContribution"),u=class{constructor(){this._operationMetas=new Map,this.contributions=[]}init(){for(let t of this.contributions)t.registerOperationMeta?.(this)}registerOperationMeta(t){return this._operationMetas.has(t.type)?(console.warn(`A operation meta ${t.type} is already registered.`),s.JT.NULL):new s.K4(this._doRegisterOperationMetaMeta(t))}getOperationMeta(t){return this._operationMetas.get(t)}_doRegisterOperationMetaMeta(t){return this._operationMetas.set(t.type,t),{dispose:()=>{this._operationMetas.delete(t.type)}}}};d([(0,r.nx)(c),(0,r.jt)()],u.prototype,"contributions",2),d([(0,r.zY)()],u.prototype,"init",1),u=d([(0,r.b2)()],u);var g=class{};g=d([(0,r.b2)()],g);var p=class{constructor(){this.generateId=()=>(0,n.x0)(),this.getSnapshot=()=>""}};p=d([(0,r.b2)()],p);var f=class{constructor(){this.applyEmitter=new s.Q5,this.onApply=this.applyEmitter.event,this._toDispose=new s.K4}init(){this._toDispose.push(this.applyEmitter)}applyOperation(t,e){let i;let r=this.operationRegistry.getOperationMeta(t.type);if(!r)throw Error(`Operation meta ${t.type} has not registered.`);return!e?.noApply&&(i=r.apply(t,this.context.source)),this.applyEmitter.fire(t),i}getOperationLabel(t){let e=this.operationRegistry.getOperationMeta(t.type);if(e&&e.getLabel)return e.getLabel(t,this.context.source)}getOperationDescription(t){let e=this.operationRegistry.getOperationMeta(t.type);if(e&&e.getDescription)return e.getDescription(t,this.context.source)}inverseOperations(t){return t.map(t=>this.inverseOperation(t)).reverse()}inverseOperation(t){let e=this.operationRegistry.getOperationMeta(t.type);if(!e)throw Error(`Operation meta ${t.type} has not registered.`);return e.inverse(t)}dispose(){this._toDispose.dispose()}};d([(0,r.f3)(u)],f.prototype,"operationRegistry",2),d([(0,r.f3)(g)],f.prototype,"context",2),d([(0,r.f3)(p)],f.prototype,"config",2),d([(0,r.zY)()],f.prototype,"init",1),f=d([(0,r.b2)()],f);var y=class{constructor(){this._undoing=!1,this._redoing=!1,this._limit=100,this.onChangeEmitter=new s.Q5,this.onChange=this.onChangeEmitter.event,this._toDispose=new s.K4,this._undoStack=[],this._redoStack=[],this._toDispose.push(this.onChangeEmitter)}setLimit(t){this._limit=t}pushElement(t){this._redoStack=[],this._stackPush(this._undoStack,t),this._toDispose.push(t),this._emitChange("push",t)}getUndoStack(){return this._undoStack}getRedoStack(){return this._redoStack}getLastElement(){return this._undoStack[this._undoStack.length-1]}async undo(){if(!this.canUndo()||this._undoing)return;this._undoing=!0;let t=this._undoStack.pop();try{await t.undo()}finally{this._stackPush(this._redoStack,t),this._emitChange("undo",t),this._undoing=!1}}async redo(){if(!this.canRedo()||this._redoing)return;this._redoing=!0;let t=this._redoStack.pop();try{await t.redo()}finally{this._stackPush(this._undoStack,t),this._emitChange("redo",t),this._redoing=!1}}canUndo(){return this._undoStack.length>0}canRedo(){return this._redoStack.length>0}canPush(){return!this._redoing&&!this._undoing}clear(){this.clearRedoStack(),this.clearUndoStack(),this._emitChange("clear")}clearRedoStack(){this._redoStack.forEach(t=>{t.dispose()}),this._redoStack=[]}clearUndoStack(){this._undoStack.forEach(t=>{t.dispose()}),this._undoStack=[]}dispose(){this.clear(),this._toDispose.dispose()}_stackPush(t,e){t.push(e),t.length>this._limit&&t.shift()}_emitChange(t,e){e?this.onChangeEmitter.fire({type:t,element:e}):this.onChangeEmitter.fire({type:t})}};y=d([(0,r.b2)()],y);var m=class{constructor(t,e=[]){this._toDispose=new s.K4,this._timestamp=Date.now(),this._operationService=t,this._operations=e.map(t=>this._operation(t)),this._id=t.config.generateId()}get id(){return this._id}getTimestamp(){return this._timestamp}pushOperation(t){let e=this._operation(t);return this._operations.push(e),e}getOperations(){return this._operations}getChangeOperations(t){return"undo"===t?this._operationService.inverseOperations(this._operations):this._operations}getFirstOperation(){return this._operations[0]}getLastOperation(){return this._operations[this._operations.length-1]}async undo(){for(let t of this._operationService.inverseOperations(this._operations))await this._apply(t)}async redo(){for(let t of this._operations)await this._apply(t)}revert(t){let e=this._operations;for(let i of("undo"!==t&&(e=this._operations.map(t=>this._inverse(t)).reverse()),e))this._apply(i)}_inverse(t){return this._operationService.inverseOperation(t)}async _apply(t){await this._operationService.applyOperation(t)}_operation(t){return{...t,value:(0,o.cloneDeep)(t.value),id:this._operationService.config.generateId()}}dispose(){this._toDispose.dispose()}},E=class{constructor(){this._items=[],this.onChangeEmitter=new s.Q5,this.onChange=this.onChangeEmitter.event,this._toDispose=new s.K4,this.limit=100,this._toDispose.push(this.onChangeEmitter)}get items(){return this._items}add(t,e){let i=this._getHistoryItem(t,e);return this._items.unshift(i),this._items.length>this.limit&&this._items.pop(),this.onChangeEmitter.fire({type:"add",value:i,service:t}),i}findById(t){return this._items.find(e=>e.id===t)}changeByIndex(t,e,i){let r=this._getHistoryItem(e,i);this._items[t]=r,this.onChangeEmitter.fire({type:"update",value:r,service:e})}addOperation(t,e,i){let r=this._items.find(t=>t.id===e);if(!r){console.warn("no history item found");return}let s=this._getHistoryOperation(t,i);r.operations.push(s),this.onChangeEmitter.fire({type:"add_operation",value:{historyItem:r,operation:s},service:t})}updateOperation(t,e,i){let r=this._items.find(t=>t.id===e);if(!r){console.warn("no history item found");return}let s=r.operations.findIndex(t=>t.id==t.id);if(s<0){console.warn("no operation found");return}let n=this._getHistoryOperation(t,i);r.operations.splice(s,1,n),this.onChangeEmitter.fire({type:"update_operation",value:{historyItem:r,operation:n},service:t})}clear(){this._items=[]}dispose(){this._items=[],this._toDispose.dispose()}_getHistoryItem(t,e){return{...e,uri:t.context.uri,time:E.dateFormat(e.timestamp),operations:e.operations.map(i=>this._getHistoryOperation(t,i,"push"!==e.type))}}_getHistoryOperation(t,e,i=!1){let r;if(i)r=this.historyConfig.generateId();else{let t=e.id;if(!t)throw Error("no operation id found");r=t}return{...(0,o.cloneDeep)(e),id:r,label:t.operationService.getOperationLabel(e),description:t.operationService.getOperationDescription(e),timestamp:Date.now()}}static dateFormat(t){return new Date(t).toLocaleString()}};d([(0,r.f3)(p)],E.prototype,"historyConfig",2),E=d([(0,r.b2)()],E);var D=class{constructor(){this._historyServices=new Map,this._toDispose=new s.K4}registerHistoryService(t){let e=new s.K4;e.pushAll([t.undoRedoService.onChange(e=>{if("clear"===e.type)return;let{type:i,element:r}=e,s=r.getChangeOperations(i),n={id:"push"===i?r.id:this.historyConfig.generateId(),type:i,uri:t.context.uri,operations:s,timestamp:Date.now()};this.historyStack.add(t,n)}),t.onMerge(e=>{this._handleMerge(t,e)})]),this._historyServices.set(t,e),this._toDispose.push(t.onWillDispose(()=>{this.unregisterHistoryService(t)}))}unregisterHistoryService(t){let e=this._historyServices.get(t);if(!!e)e.dispose(),this._historyServices.delete(t)}getHistoryServiceByURI(t){for(let e of this._historyServices.keys())if(e.context.uri===t)return e}getFirstHistoryService(){for(let t of this._historyServices.keys())return t}dispose(){this._toDispose.dispose(),this.historyStack.dispose(),this._historyServices.forEach(t=>t.dispose()),this._historyServices.clear()}_handleMerge(t,e){let{element:i,operation:r}=e.value;if(!!this.historyStack.findById(i.id)){if(!r.id){console.warn("no operation id found");return}"UPDATE"===e.type&&this.historyStack.updateOperation(t,i.id,r),"ADD"===e.type&&this.historyStack.addOperation(t,i.id,r)}}};d([(0,r.f3)(E)],D.prototype,"historyStack",2),d([(0,r.f3)(p)],D.prototype,"historyConfig",2),D=d([(0,r.b2)()],D);var M=class{constructor(){this._toDispose=new s.K4,this._transacting=!1,this._transactOperation=null,this._locked=!1,this._willDisposeEmitter=new s.Q5,this._mergeEmitter=new s.Q5,this.onWillDispose=this._willDisposeEmitter.event,this.onMerge=this._mergeEmitter.event}get onApply(){return this.operationService.onApply}init(){this._toDispose.push(this._willDisposeEmitter),this._toDispose.push(this._mergeEmitter)}start(){this._locked=!1}stop(){this._locked=!0}limit(t){this.undoRedoService.setLimit(t)}startTransaction(){if(this._transacting)return;this._transacting=!0;let t=new m(this.operationService,[]);this._transactOperation=t}endTransaction(){let t=this._transactOperation;if(!!t){if(0===t.getOperations().length)throw Error("no operation be pushed");this._pushStackOperation(t),this._transactOperation=null,this._transacting=!1}}transact(t){if(!this._transacting)this.startTransaction(),t(),this.endTransaction()}pushOperation(t,e){if(!this._canPush())return;let i=this._transactOperation||this.undoRedoService.getLastElement(),r=this.operationRegistry.getOperationMeta(t.type);if(!r)throw Error(`Operation meta ${t.type} has not registered.`);if(r.shouldSave&&!r.shouldSave(t))return r.apply(t,this.context.source);let s=this.operationService.applyOperation(t,{noApply:e?.noApply});r.getURI&&!t.uri&&(t.uri=r.getURI(t,this.context.source));let n=this._shouldMerge(t,i,r);if(n){if("object"==typeof n){let t=i.getLastOperation();t.value=n.value,this._mergeEmitter.fire({type:"UPDATE",value:{element:i,operation:t,value:n.value}})}else{let e=i.pushOperation(t);this._mergeEmitter.fire({type:"ADD",value:{element:i,operation:e}})}}else{let e=new m(this.operationService,[t]);this._pushStackOperation(e)}return s}getHistoryOperations(){return this.historyManager.historyStack.items.reverse().map(t=>t.operations.map(t=>({...(0,o.pick)(t,["type","value"]),label:t.label||t.type}))).flat()}async undo(){await this.undoRedoService.undo()}async redo(){await this.undoRedoService.redo()}canUndo(){return this.undoRedoService.canUndo()}canRedo(){return this.undoRedoService.canRedo()}getSnapshot(){return this.config.getSnapshot()}getRecords(){throw Error("Method not implemented.")}restore(t){throw Error("Method not implemented.")}clear(){this.undoRedoService.clear()}dispose(){this._willDisposeEmitter.fire(this),this._toDispose.dispose()}_canPush(){return!this._locked&&this.undoRedoService.canPush()}_pushStackOperation(t){this.undoRedoService.pushElement(t),this.undoRedoService.clearRedoStack()}_shouldMerge(t,e,i){return!!e&&(!!this._transacting||i.shouldMerge&&i.shouldMerge(t,e.getLastOperation(),e))}};d([(0,r.f3)(y)],M.prototype,"undoRedoService",2),d([(0,r.f3)(u)],M.prototype,"operationRegistry",2),d([(0,r.f3)(f)],M.prototype,"operationService",2),d([(0,r.f3)(g)],M.prototype,"context",2),d([(0,r.f3)(p)],M.prototype,"config",2),d([(0,r.f3)(D)],M.prototype,"historyManager",2),d([(0,r.zY)()],M.prototype,"init",1),M=d([(0,r.b2)()],M);var C=new r.nZ((t,e,i,r,s,n,o)=>{t(u).toSelf().inSingletonScope(),t(f).toSelf().inSingletonScope(),t(y).toSelf().inSingletonScope(),t(M).toSelf().inSingletonScope(),t(g).toSelf().inSingletonScope(),t(D).toSelf().inSingletonScope(),t(E).toSelf().inSingletonScope(),t(p).toSelf().inSingletonScope(),n(M,(t,e)=>{let i=t.container?.parent?.get(D)||t.container.get(D);return i?(e.historyManager=i,i.registerHistoryService(e),e):e})});(0,a.M1)({onInit:(t,e)=>{e.onApply&&t.get(f).onApply(e.onApply.bind(null,t))},containerModules:[C]})},339196:function(t,e,i){i.d(e,{o:function(){return s}});var r=i(177783),s=new class{constructor(t){this._languages=new Map,this._localLanguage="en-US",this._onLanguageChangeEmitter=new r.Q5,this.onLanguageChange=this._onLanguageChangeEmitter.event,t.forEach(t=>this.addLanguage(t))}t(t,e){let i=this._languages.get(this._localLanguage)?.contents||{};return i[t]?i[t]:e?.disableReturnKey?"":t}getLocalLanguage(){return this._localLanguage}setLocalLanguage(t){t!==this._localLanguage&&(this._localLanguage=t,this._onLanguageChangeEmitter.fire(t))}getLangauges(){return this._languages}addLanguage(t){let e=this._languages.get(t.languageId);e?this._languages.set(t.languageId,{...e,...t,contents:{...e.contents,...t.contents}}):this._languages.set(t.languageId,t)}}([{languageId:"en-US",languageName:"English",localizedLanguageName:"English",contents:{Yes:"Yes",No:"No"}},{languageId:"zh-CN",languageName:"Chinese",localizedLanguageName:"中文(中国)",contents:{Yes:"是",No:"否"}}])},474414:function(t,e,i){i.d(e,{BP:function(){return l},Re:function(){return d},nt:function(){return c}});var r,s=i(908600),n=i(177783);(t=>{let e,i=[],r=[],s=!1,n=!1,o=!1;let a=!1;function h(t,e){if(a)throw e;console.error(`[Tracker error] ${t}`,e)}function l(t){if(function(){return n}())throw Error("Can't call Tracker.flush while flushing");if(o)throw Error("Can't flush inside Tracker.autorun");n=!0,s=!0,a=!!(t=t||{}).throwFirstError;var e=0,c=!1;try{for(;i.length||r.length;){for(;i.length;){var u=i.shift();if(u._recompute(),u._needsRecompute()&&i.unshift(u),!t.finishSynchronously&&++e>100){c=!0;return}}if(r.length){var g=r.shift();try{g()}catch(t){h("afterFlush",t)}}}c=!0}finally{if(!c&&(n=!1,l({finishSynchronously:t.finishSynchronously,throwFirstError:!1})),s=!1,n=!1,i.length||r.length){if(t.finishSynchronously)throw Error("still have more to do?");setTimeout(d,10)}}}function d(){!s&&(setTimeout(l,0),s=!0)}function c(t){let i=e;e=void 0;try{return t(void 0)}finally{e=i}}function u(){return!!e}t.withComputation=function(t,i){let r=e;e=t;try{return i.call(null,t)}finally{e=r}},t.withoutComputation=c,t.isActive=u;t.getCurrentComputation=function(){return e};t.autorun=function(i,r){var s=new p(i,e,r?.onError);return u()&&t.onInvalidate(function(){s.stop()}),s};function g(){return n}t.onInvalidate=function(t){if(!e)throw Error("Tracker.onInvalidate requires a currentComputation");e.onInvalidate(t)},t.inFlush=g;t.flush=function(t){l({finishSynchronously:!0,throwFirstError:t&&t.throwFirstError})};t.afterFlush=function(t){r.push(t),d()};class p{constructor(t,e,i){this._fn=t,this.parent=e,this._onError=i,this._onInvalidateCallbacks=[],this._onStopCallbacks=[],this._recomputing=!1,this.stopped=!1,this.invalidated=!1,this.firstRun=!0;let r=!0;try{this._compute(),r=!1}finally{this.firstRun=!1,r&&this.stop()}}onInvalidate(t){this.invalidated?c(t.bind(null,this)):this._onInvalidateCallbacks.push(t)}invalidate(){if(!this.invalidated){!this._recomputing&&!this.stopped&&(d(),i.push(this)),this.invalidated=!0;for(var t,e=0;t=this._onInvalidateCallbacks[e];e++)c(t.bind(null,this));this._onInvalidateCallbacks=[]}}stop(){if(!this.stopped){this.stopped=!0,this.invalidate();for(let t=0,e;e=this._onStopCallbacks[t];t++)c(e.bind(null,this));this._onStopCallbacks=[]}}onStop(t){this.stopped?c(t.bind(null,this)):this._onStopCallbacks.push(t)}_compute(){this.invalidated=!1;var e=o;o=!0;try{this._result=t.withComputation(this,this._fn)}finally{o=e}}_needsRecompute(){return this.invalidated&&!this.stopped}_recompute(){this._recomputing=!0;try{if(this._needsRecompute())try{this._compute()}catch(t){this._onError?this._onError(t):h("recompute",t)}}finally{this._recomputing=!1}}flush(){!this._recomputing&&this._recompute()}run(){this.invalidate(),this.flush()}get result(){return this._result}}t.Computation=p;t.Dependency=class t{constructor(){this._dependents=new Set}depend(t){if(!t){if(!u())return!1;t=e}return!this._dependents.has(t)&&(this._dependents.add(t),t.onInvalidate(()=>{this._dependents.delete(t)}),!0)}changed(){for(let t of this._dependents)t.invalidate()}hasDependents(){return 0!==this._dependents.size}}})(r||(r={}));var o=class{constructor(t,e){this._dep=new r.Dependency,this._isEqual=(t,e)=>t==e,this._value=t,e?.isEqual&&(this._isEqual=e.isEqual)}_addDepend(t){r.isActive()&&t.depend()}hasDependents(){return this._dep.hasDependents()}get value(){return this._addDepend(this._dep),this._value}set value(t){!this._isEqual(this._value,t)&&(this._value=t,this._dep.changed())}};function a(t,e){let i="Proxy"in window;if(i)return new Proxy(t,e);let r={};for(let i in t)Object.defineProperty(r,i,{enumerable:!0,get:e.get?()=>e.get(t,i):void 0,set:e.set?r=>e.set(t,i,r):void 0});return r}var h=r.Dependency,l=class extends o{constructor(){super(...arguments),this._keyDeps=new Map}set(t,e){this._ensureKey(t);let i=this._value[t];return!this._isEqual(i,e)&&(this._value[t]=e,this._keyDeps.get(t).changed(),!0)}get(t){return this._ensureKey(t),this._addDepend(this._keyDeps.get(t)),this._value[t]}_ensureKey(t){!this._keyDeps.has(t)&&this._keyDeps.set(t,new h)}hasDependents(){if(this._dep.hasDependents())return!0;for(let t of this._keyDeps.values())if(t.hasDependents())return!0;return!1}keys(){return Object.keys(this._value)}set value(t){!this._isEqual(this._value,t)&&(this._value=t,this._keyDeps.clear(),this._dep.changed())}get value(){return this._addDepend(this._dep),!this._proxyValue&&(this._proxyValue=a(this._value,{get:(t,e)=>this.get(e),set:(t,e,i)=>(this.set(e,i),!0)})),this._proxyValue}get readonlyValue(){return this._addDepend(this._dep),!this._proxyReadonlyValue&&(this._proxyReadonlyValue=a(this._value,{get:(t,e)=>this.get(e),set:(t,e)=>{throw Error(`[ReactiveState] Cannnot set readonly field "${e}"`)}})),this._proxyReadonlyValue}};function d(t){let e=(0,n.JA)(),i=(0,s.useMemo)(()=>new Map,[]),o=(0,s.useCallback)(()=>{i.forEach(t=>t.stop()),i.clear()},[]);return(0,s.useEffect)(()=>o,[]),o(),(0,s.useMemo)(()=>void 0===t?{}:a(t,{get(s,n){let o=i.get(n);return!o&&(o=new r.Computation(i=>{if(!i.firstRun){e();return}return t[n]}),i.set(n,o)),t[n]}}),[t])}function c(t){return d(t.readonlyValue)}var{Dependency:u,Computation:g}=r},177783:function(t,e,i){i.d(e,{Ae:function(){return T},Cd:function(){return O},Ct:function(){return p},E9:function(){return I},JA:function(){return tu},JT:function(){return c},K4:function(){return X},KV:function(){return th},Of:function(){return te},Pq:function(){return Q},Q5:function(){return G},Qc:function(){return tl},RZ:function(){return l},S9:function(){return ti},V_:function(){return y},XJ:function(){return g},Zp:function(){return q},_b:function(){return x},cO:function(){return J},dG:function(){return F},gE:function(){return K},gw:function(){return H},hY:function(){return tr},i1:function(){return Z},jl:function(){return _},oN:function(){return ta},pL:function(){return m},r9:function(){return ts},rM:function(){return E},sI:function(){return D},xF:function(){return C},y3:function(){return A},yb:function(){return tc},z:function(){return tt}});var r,s,n,o,a,h,l,d,c,u,g,p,f,y,m,E,D,M,C,b=i(65881),N=i(908600),{PI:S}=Math,x=2*S,_=180/S,w=class t{constructor(t=0,e=0){this.x=t,this.y=e}sub(e){return new t(this.x-e.x,this.y-e.y)}dot(t){return this.x*t.x+this.y*t.y}},I=class t{constructor(t=0,e=0){this.x=t,this.y=e}clone(){return new t(this.x,this.y)}copyFrom(t){return this.set(t.x,t.y),this}copyTo(t){return t.x=this.x,t.y=this.y,t}equals(t){return t.x===this.x&&t.y===this.y}set(t=0,e=t){return this.x=t,this.y=e,this}};(t=>{t.EMPTY={x:0,y:0};t.getDistance=function(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)};function e(t,e,i){return{x:t.x+i*(e.x-t.x),y:t.y+i*(e.y-t.y)}}t.getMiddlePoint=function(t,i){return e(t,i,.5)},t.getRatioPoint=e;t.fixZero=function(t){return 0===t.x&&(t.x=0),0===t.y&&(t.y=0),t};t.move=function(t,e){return{x:t.x+(e.x||0),y:t.y+(e.y||0)}};t.moveDistanceToDirection=function(t,e,i){let r=e.x-t.x,s=e.y-t.y,n=0===r?0:Math.sqrt(i**2/(1+s**2/r**2)),o=0===r?i:Math.abs(n*s/r);return{x:t.x+(r>0?n:-n),y:t.y+(s>0?o:-o)}}})(I||(I={}));var T=class t{constructor(t=0,e=0,i=0,r=0){this.x=t,this.y=e,this.width=i,this.height=r,this.type=1}static get EMPTY(){return new t(0,0,0,0)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}clone(){return new t(this.x,this.y,this.width,this.height)}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}copyTo(t){return t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t}contains(t,e){return!(this.width<=0)&&!(this.height<=0)&&(!!(t>=this.x)&&!!(t<=this.right)&&!!(e>=this.y)&&!!(e<=this.bottom)||!1)}isEqual(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}containsRectangle(t){return t.left>=this.left&&t.right<=this.right&&t.top>=this.top&&t.bottom<=this.bottom}pad(t=0,e=t){return this.x-=t,this.y-=e,this.width+=2*t,this.height+=2*e,this}fit(t){let e=Math.max(this.x,t.x),i=Math.min(this.x+this.width,t.x+t.width),r=Math.max(this.y,t.y),s=Math.min(this.y+this.height,t.y+t.height);return this.x=e,this.width=Math.max(i-e,0),this.y=r,this.height=Math.max(s-r,0),this}ceil(t=1,e=.001){let i=Math.ceil((this.x+this.width-e)*t)/t,r=Math.ceil((this.y+this.height-e)*t)/t;return this.x=Math.floor((this.x+e)*t)/t,this.y=Math.floor((this.y+e)*t)/t,this.width=i-this.x,this.height=r-this.y,this}enlarge(t){let e=Math.min(this.x,t.x),i=Math.max(this.x+this.width,t.x+t.width),r=Math.min(this.y,t.y),s=Math.max(this.y+this.height,t.y+t.height);return this.x=e,this.width=i-e,this.y=r,this.height=s-r,this}get center(){return{x:this.x+this.width/2,y:this.y+this.height/2}}get rightBottom(){return{x:this.right,y:this.bottom}}get leftBottom(){return{x:this.left,y:this.bottom}}get rightTop(){return{x:this.right,y:this.top}}get leftTop(){return{x:this.left,y:this.top}}get bottomCenter(){return{x:this.x+this.width/2,y:this.bottom}}get topCenter(){return{x:this.x+this.width/2,y:this.top}}get rightCenter(){return{x:this.right,y:this.y+this.height/2}}get leftCenter(){return{x:this.left,y:this.y+this.height/2}}update(t){return t(this)}get crossDistance(){return I.getDistance(this.leftTop,this.rightBottom)}toStyleStr(){return`left: ${this.x}px; top: ${this.y}px; width: ${this.width}px; height: ${this.height}px;`}withPadding(t){return this.x-=t.left,this.y-=t.top,this.width+=t.left+t.right,this.height+=t.top+t.bottom,this}withoutPadding(t){return this.x+=t.left,this.y+=t.top,this.width=this.width-t.left-t.right,this.height=this.height-t.top-t.bottom,this}withHeight(t){return this.height=t,this}clearSpace(){return this.width=0,this.height=0,this}};(t=>{function e(e){let i=t.EMPTY.clone();if(!e.length)return i;let r=[],s=[],n=[],o=[];e.forEach(t=>{r.push(t.left),n.push(t.right),o.push(t.bottom),s.push(t.top)});let a=Math.min.apply(Math,r),h=Math.max.apply(Math,n),l=Math.min.apply(Math,s),d=Math.max.apply(Math,o);return i.x=a,i.width=h-a,i.y=l,i.height=d-l,i}t.align=function(t,i){if(t.length<=1)return t;switch(i){case"align-bottom":let r=Math.max(...t.map(t=>t.bottom));t.forEach(t=>{t.y=r-t.height});break;case"align-center":let s=e(t).center.x;t.forEach(t=>{t.x=s-t.width/2});break;case"align-left":let n=Math.min(...t.map(t=>t.left));t.forEach(t=>{t.x=n});break;case"align-middle":let o=e(t).center.y;t.forEach(t=>{t.y=o-t.height/2});break;case"align-right":let a=Math.max(...t.map(t=>t.right));t.forEach(t=>{t.x=a-t.width});break;case"align-top":let h=Math.min(...t.map(t=>t.top));t.forEach(t=>{t.y=h});break;case"distribute-horizontal":if(t.length<=2)break;let l=t.slice().sort((t,e)=>t.left-e.left),d=e(t),c=t.reduce((t,e)=>t-e.width,d.width)/(t.length-1);l.reduce((t,e)=>(e.x=t,t+e.width+c),d.x);break;case"distribute-vertical":if(t.length<=2)break;let u=t.slice().sort((t,e)=>t.top-e.top),g=e(t),p=t.reduce((t,e)=>t-e.height,g.height)/(t.length-1);u.reduce((t,e)=>(e.y=t,t+e.height+p),g.y)}return t},t.enlarge=e;t.intersects=function(t,e,i){let r=t.left,s=t.top,n=t.right,o=t.bottom,a=e.left,h=e.top,l=e.right,d=e.bottom;return"horizontal"===i?n>a&&r<l:"vertical"===i?o>h&&s<d:!!(n>a)&&!!(r<l)&&!!(o>h)&&!!(s<d)||!1};t.intersectsWithRotation=function(t,e,i,r){let s=new L(t.center,t.width,t.height,e),n=new L(i.center,i.width,i.height,r),o=s.centerPoint.sub(n.centerPoint),a=s.axesX;if(s.getProjectionRadius(a)+n.getProjectionRadius(a)<=Math.abs(o.dot(a)))return!1;let h=s.axesY;if(s.getProjectionRadius(h)+n.getProjectionRadius(h)<=Math.abs(o.dot(h)))return!1;let l=n.axesX;if(s.getProjectionRadius(l)+n.getProjectionRadius(l)<=Math.abs(o.dot(l)))return!1;let d=n.axesY;return!(s.getProjectionRadius(d)+n.getProjectionRadius(d)<=Math.abs(o.dot(d)))&&!0};t.isViewportVisible=function(e,i,r=0,s=!1){return s?i.containsRectangle(e):0===r?t.intersects(e,i):t.intersectsWithRotation(e,r,i,0)};t.setViewportVisible=function(t,e,i=0){let{left:r,right:s,top:n,bottom:o,width:a,height:h}=t,{left:l,right:d,top:c,bottom:u}=e;return r<=l?t.x=l+i:s>=d&&(t.x=d-i-a),n<=c?t.y=c+i:o>=u&&(t.y=u-i-h),t};t.createRectangleWithTwoPoints=function(e,i){let r=e.x<i.x?e.x:i.x,s=e.y<i.y?e.y:i.y,n=Math.abs(e.x-i.x);return new t(r,s,n,Math.abs(e.y-i.y))}})(T||(T={}));var L=class{constructor(t,e,i,r){this.width=e,this.height=i,this.centerPoint=new w(t.x,t.y),this.axesX=new w(Math.cos(r),Math.sin(r)),this.axesY=new w(-1*this.axesX.y,this.axesX.x)}getProjectionRadius(t){return this.width/2*Math.abs(t.dot(this.axesX))+this.height/2*Math.abs(t.dot(this.axesY))}},O=class t{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.radius=i,this.type=2}clone(){return new t(this.x,this.y,this.radius)}contains(t,e){if(this.radius<=0)return!1;let i=this.radius*this.radius,r=this.x-t,s=this.y-e;return r*=r,s*=s,r+s<=i}getBounds(){return new T(this.x-this.radius,this.y-this.radius,2*this.radius,2*this.radius)}},A=class t{constructor(t=1,e=0,i=0,r=1,s=0,n=0){this.a=t,this.b=e,this.c=i,this.d=r,this.tx=s,this.ty=n,this.array=null}static get IDENTITY(){return new t}static get TEMP_MATRIX(){return new t}fromArray(t){return t.length<6?this:(this.a=t[0],this.b=t[1],this.c=t[3],this.d=t[4],this.tx=t[2],this.ty=t[5],this)}set(t,e,i,r,s,n){return this.a=t,this.b=e,this.c=i,this.d=r,this.tx=s,this.ty=n,this}toArray(t,e){!this.array&&(this.array=new Float32Array(9));let i=e||this.array;return t?(i[0]=this.a,i[1]=this.b,i[2]=0,i[3]=this.c,i[4]=this.d,i[5]=0,i[6]=this.tx,i[7]=this.ty):(i[0]=this.a,i[1]=this.c,i[2]=this.tx,i[3]=this.b,i[4]=this.d,i[5]=this.ty,i[6]=0,i[7]=0),i[8]=1,i}apply(t,e){let{x:i,y:r}=t;return(e=e||{x:0,y:0}).x=this.a*i+this.c*r+this.tx,e.y=this.b*i+this.d*r+this.ty,e}applyInverse(t,e){e=e||{x:0,y:0};let i=1/(this.a*this.d+-(this.c*this.b)),{x:r}=t,{y:s}=t;return e.x=this.d*i*r+-this.c*i*s+(this.ty*this.c-this.tx*this.d)*i,e.y=this.a*i*s+-this.b*i*r+(-this.ty*this.a+this.tx*this.b)*i,e}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this}rotate(t){let e=Math.cos(t),i=Math.sin(t),r=this.a,s=this.c,n=this.tx;return this.a=r*e-this.b*i,this.b=r*i+this.b*e,this.c=s*e-this.d*i,this.d=s*i+this.d*e,this.tx=n*e-this.ty*i,this.ty=n*i+this.ty*e,this}append(t){let e=this.a,i=this.b,r=this.c,s=this.d;return this.a=t.a*e+t.b*r,this.b=t.a*i+t.b*s,this.c=t.c*e+t.d*r,this.d=t.c*i+t.d*s,this.tx=t.tx*e+t.ty*r+this.tx,this.ty=t.tx*i+t.ty*s+this.ty,this}setTransform(t,e,i,r,s,n,o,a,h){return this.a=Math.cos(o+h)*s,this.b=Math.sin(o+h)*s,this.c=-Math.sin(o-a)*n,this.d=Math.cos(o-a)*n,this.tx=t-(i*this.a+r*this.c),this.ty=e-(i*this.b+r*this.d),this}prepend(t){let e=this.tx;if(1!==t.a||0!==t.b||0!==t.c||1!==t.d){let e=this.a,i=this.c;this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d}return this.tx=e*t.a+this.ty*t.c+t.tx,this.ty=e*t.b+this.ty*t.d+t.ty,this}decompose(t){let{a:e}=this,{b:i}=this,{c:r}=this,{d:s}=this,n=-Math.atan2(-r,s),o=Math.atan2(i,e),a=Math.abs(n+o);return a<1e-5||1e-5>Math.abs(x-a)?(t.rotation=o,t.skew.x=0,t.skew.y=0):(t.rotation=0,t.skew.x=n,t.skew.y=o),t.scale.x=Math.sqrt(e*e+i*i),t.scale.y=Math.sqrt(r*r+s*s),t.position.x=this.tx,t.position.y=this.ty,t}invert(){let t=this.a,e=this.b,i=this.c,r=this.d,s=this.tx,n=t*r-e*i;return this.a=r/n,this.b=-e/n,this.c=-i/n,this.d=t/n,this.tx=(i*this.ty-r*s)/n,this.ty=-(t*this.ty-e*s)/n,this}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}isSimple(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d}clone(){let e=new t;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyTo(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t}copyFrom(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this}},k=class t{constructor(t,e,i=0,r=0){this._x=i,this._y=r,this.cb=t,this.scope=e}get x(){return this._x}set x(t){this._x!==t&&(this._x=t,this.cb.call(this.scope))}get y(){return this._y}set y(t){this._y!==t&&(this._y=t,this.cb.call(this.scope))}clone(e=this.cb,i=this.scope){return new t(e,i,this._x,this._y)}set(t=0,e=t){return(this._x!==t||this._y!==e)&&(this._x=t,this._y=e,this.cb.call(this.scope)),this}copyFrom(t){return(this._x!==t.x||this._y!==t.y)&&(this._x=t.x,this._y=t.y,this.cb.call(this.scope)),this}copyTo(t){return t.x=this._x,t.y=this._y,t}equals(t){return t.x===this._x&&t.y===this._y}},R=class{constructor(){this.worldTransform=new A,this.localTransform=new A,this.position=new k(this.onChange,this,0,0),this.scale=new k(this.onChange,this,1,1),this.pivot=new k(this.onChange,this,0,0),this.skew=new k(this.updateSkew,this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._localID=0,this._currentLocalID=0,this._worldID=0,this._parentID=0}onChange(){this._localID++}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this._localID++}updateLocalTransform(){let t=this.localTransform;this._localID!==this._currentLocalID&&(t.a=this._cx*this.scale.x,t.b=this._sx*this.scale.x,t.c=this._cy*this.scale.y,t.d=this._sy*this.scale.y,t.tx=this.position.x-(this.pivot.x*t.a+this.pivot.y*t.c),t.ty=this.position.y-(this.pivot.x*t.b+this.pivot.y*t.d),this._currentLocalID=this._localID,this._parentID=-1)}updateTransform(t){let e=this.localTransform;if(this._localID!==this._currentLocalID&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this._currentLocalID=this._localID,this._parentID=-1),this._parentID!==t._worldID){let i=t.worldTransform,r=this.worldTransform;r.a=e.a*i.a+e.b*i.c,r.b=e.a*i.b+e.b*i.d,r.c=e.c*i.a+e.d*i.c,r.d=e.c*i.b+e.d*i.d,r.tx=e.tx*i.a+e.ty*i.c+i.tx,r.ty=e.tx*i.b+e.ty*i.d+i.ty,this._parentID=t._worldID,this._worldID++}}setFromMatrix(t){t.decompose(this),this._localID++}get rotation(){return this._rotation}set rotation(t){this._rotation!==t&&(this._rotation=t,this.updateSkew())}};function P(t,e,i){let r=i-e;return e+((t-e)%r+r)%r}R.IDENTITY=new R,(r=l||(l={})).wrap=function(t){return P(t,-Math.PI,Math.PI)},r.wrapDegrees=function(t){return P(t,-180,180)},r.betweenPoints=function(t,e,i={x:0,y:0}){let r={x:t.x-i.x,y:t.y-i.y},s={x:e.x-i.x,y:e.y-i.y};return Math.atan2(r.x*s.y-r.y*s.x,r.x*s.x+r.y*s.y)};var{keys:j}=Object;Object.prototype.hasOwnProperty;var z=(t,e)=>j(t).forEach(i=>e(t[i],i)),V=(t,e,i={})=>j(t).reduce((i,r)=>e(i,t[r],r),i),B=(t,e)=>V(t,(t,i,r)=>Object.assign(t,{[r]:e(i,r)})),F=()=>{};Object.prototype.toString;var Y=Object.freeze({dispose:F});(d||(d={})).None=()=>Y;var U=class t{constructor(){this._disposed=!1}get event(){return!this._event&&(this._event=(e,i)=>{if(this._disposed)return Y;!this._listeners&&(this._listeners=[]);let r=i?e.bind(i):e;this._listeners.length>=t.LEAK_WARNING_THRESHHOLD&&console.warn(`[Emitter] Listeners length >= ${t.LEAK_WARNING_THRESHHOLD}`),this._listeners.push(r);let s={dispose:()=>{if(s.dispose=F,!this._disposed){let t=this._listeners.indexOf(r);-1!==t&&this._listeners.splice(t,1)}}};return s}),this._event}fire(t){this._listeners&&this._listeners.forEach(e=>e(t))}get disposed(){return this._disposed}dispose(){this._listeners&&(this._listeners=void 0),this._disposed=!0}};U.LEAK_WARNING_THRESHHOLD=175;var G=U;(t=>{function e(t){return{dispose:t}}t.is=function(t){return"object"==typeof t&&null!==t&&"function"==typeof t.dispose},t.create=e,t.NULL=Object.freeze(e(()=>{}))})(c||(c={}));var Q=class{constructor(){this.toDispose=new X}dispose(){this.toDispose.dispose()}get disposed(){return this.toDispose.disposed}get onDispose(){return this.toDispose.onDispose}},X=class{constructor(...t){this.disposables=[],this.onDisposeEmitter=new G,this._disposed=!1,t.forEach(t=>this.push(t))}get onDispose(){return this.onDisposeEmitter.event}get disposed(){return this._disposed}dispose(){if(!this.disposed)this._disposed=!0,this.disposables.slice().reverse().forEach(t=>{try{t.dispose()}catch(t){console.error(t)}}),this.onDisposeEmitter.fire(void 0),this.onDisposeEmitter.dispose()}push(t){let e;if(this.disposed)return c.NULL;let{disposables:i}=this;if(i.find(e=>e._origin===t))return c.NULL;let r=c.create(()=>{let t=i.indexOf(e);-1!==t&&i.splice(t,1)});return e={dispose:()=>{r.dispose(),t.dispose()},_origin:t},i.push(e),r}pushAll(t){return t.map(t=>this.push(t))}},W=Object.freeze(function(t,e){let i=setTimeout(t.bind(e),0);return{dispose(){clearTimeout(i)}}});(s=u||(u={})).isCancellationToken=function(t){return t===s.None||t===s.Cancelled||t instanceof $||!!t&&"object"==typeof t&&"boolean"==typeof t.isCancellationRequested&&"function"==typeof t.onCancellationRequested},s.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:d.None}),s.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:W});var $=class{constructor(){this._isCancelled=!1}cancel(){!this._isCancelled&&(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?W:(!this._emitter&&(this._emitter=new G),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=void 0)}},J=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};function H(t,e=u.None){let i=new J,r=setTimeout(()=>i.resolve(),t);return e.onCancellationRequested(()=>{clearTimeout(r),i.reject(Error("Cancelled"))}),i.promise}(t=>{function e(t,i,r=1,s=!0){if(t===i)return!1;if(0===r||"object"!=typeof t||"object"!=typeof i)return t!==i;let n=Object.keys(i);if(!s){let e=Object.keys(t);if(n.length!==e.length)return!0}for(let o=0,a=n.length;o<a;o++){let a=n[o];if(e(t[a],i[a],r-1,s))return!0}return!1}t.isChanged=e;t.isDeepChanged=function(t,i,r){return e(t,i,1/0,r)};t.isArrayShallowChanged=function(t,e){if(t.length!==e.length)return!0;for(let i=0,r=t.length;i<r;i++)if(t[i]!==e[i])return!0;return!1}})(g||(g={})),(n=p||(p={})).create=function(t,e={}){let i=[];return{getFromCache:()=>i,getMore(r,s=!0){if(r===i.length);else if(r>i.length){let e=r-i.length;for(;e>0;)i.push(t()),e--}else if(s){let t=e.deleteLimit??0;i.length-r>t&&i.splice(r).forEach(t=>t.dispose&&t.dispose())}return i.slice(0,r)},getMoreByItemKeys(e){let r=[],s=new Map;return i.forEach(t=>{e.find(e=>e.key===t.key)?s.set(t.key,t):t.dispose?.()}),e.forEach(e=>{if(!e.key)throw Error("getMoreByItemKeys need a key");let i=s.get(e.key);i?r.push(i):r.push(t(e))}),i=r},getMoreByItems(e){let r=[],s=new Map;return i.forEach(t=>{e.find(e=>e===t.key)?s.set(t.key,t):t.dispose?.()}),e.forEach(e=>{let i=s.get(e);i?r.push(i):r.push({...t(e),key:e})}),i=r},get:()=>i.length>0?i[0]:(i.push(t()),i[0]),getFromCacheByKey:t=>i.find(e=>e.key===t),dispose(){i.forEach(t=>t.dispose&&t.dispose()),i.length=0},clear(){this.dispose()}}},n.assign=function(t,e){return Object.assign(t,e)},n.createShortCache=function(t=1e3){let e,i;function r(){i&&clearTimeout(i),i=setTimeout(()=>{i=void 0,e=void 0},t)}return{get:t=>e?(r(),e):(e=t(),r(),e)}},n.createWeakCache=function(){let t=new WeakMap;return{get:e=>t.get(e),save:(e,i)=>t.set(e,i),isChanged:(e,i)=>g.isChanged(t.get(e),i)}},(f||(f={})).create=function(t,e,i){return{type:"object",properties:{...e?.properties,...t},mixinDefaults:{...e?.mixinDefaults,...i}}},(o=y||(y={})).createDefault=function t(e,i,r){i={...e.mixinDefaults,...i};let s=r?`${r}.`:"";return e.properties?B(e.properties,(e,r)=>{let n=s+r;return i&&void 0!==i[n]?i[n]:t(e,i,n)}):"function"==typeof e.default?e.default():e.default},o.isBaseType=function(t){return"string"===t.type||"float"===t.type||"integer"===t.type||"boolean"===t.type||"enum"===t.type||"color"===t.type||"range"===t.type};var K={label:"大小",properties:{width:{label:"宽",default:0,type:"float"},height:{label:"高",default:0,type:"float"},locked:{label:"等比锁",default:!1,type:"boolean"}},type:"object"},Z={label:"原点",description:"用于设置旋转的中心位置",properties:{x:{label:"x",default:.5,type:"float"},y:{label:"y",default:.5,type:"float"}},type:"object"},q={label:"位置",properties:{x:{label:"x",default:0,type:"float"},y:{label:"y",default:0,type:"float"}},type:"object"},tt={label:"旋转",type:"float",default:0},te={label:"缩放",properties:{x:{label:"x",default:1,type:"float"},y:{label:"y",default:1,type:"float"}},type:"object"},ti={label:"倾斜",properties:{x:{label:"x",default:0,type:"float"},y:{label:"y",default:0,type:"float"}},type:"object"},tr={properties:{position:q,size:K,origin:Z,scale:te,skew:ti,rotation:tt},type:"object"};(a=m||(m={})).createDefault=function(){return y.createDefault(tr)},a.toJSON=function(t){return{position:{x:t.position.x,y:t.position.y},size:{width:t.size.width,height:t.size.height,locked:t.size.locked},origin:{x:t.origin.x,y:t.origin.y},scale:{x:t.scale.x,y:t.scale.y},skew:{x:t.skew.x,y:t.skew.y},rotation:t.rotation}},a.getDelta=function(t,e){return{position:{x:e.position.x-t.position.x,y:e.position.y-t.position.y},size:{width:e.size.width-t.size.width,height:e.size.height-t.size.height},origin:{x:e.origin.x-t.origin.x,y:e.origin.y-t.origin.y},scale:{x:e.scale.x-t.scale.x,y:e.scale.y-t.scale.y},skew:{x:e.skew.x-t.skew.x,y:e.skew.y-t.skew.y},rotation:e.rotation-t.rotation}},a.mergeDelta=function(t,e,i){let r=void 0!==i?t=>Math.round(100*t)/100:t=>t;return{position:{x:r(e.position.x+t.position.x),y:r(e.position.y+t.position.y)},size:{width:r(e.size.width+t.size.width),height:r(e.size.height+t.size.height),locked:t.size.locked},origin:{x:r(e.origin.x+t.origin.x),y:r(e.origin.y+t.origin.y)},scale:{x:r(e.scale.x+t.scale.x),y:r(e.scale.y+t.scale.y)},skew:{x:r(e.skew.x+t.skew.x),y:r(e.skew.y+t.skew.y)},rotation:e.rotation+t.rotation}},a.is=function(t){return t&&t.position&&t.size&&"number"==typeof t.position.x&&"number"==typeof t.size.width},(h=E||(E={})).fixSize=function(t,e){if(t.width<=e.width&&t.height<=e.height)return 1;let i=t.width/e.width,r=t.height/e.height;return 1/(i>r?i:r)},h.coverSize=function(t,e){let i=t.width/e.width,r=t.height/e.height;return 1/(i<r?i:r)},h.empty=function(){return{width:0,height:0}},(D||(D={})).empty=()=>({left:0,right:0,top:0,bottom:0}),(M||(M={})).isEmpty=function(t){return!t||void 0===t.topLeft&&void 0===t.topRight&&void 0===t.bottomLeft&&void 0===t.bottomRight};var ts={label:"透明度",type:"float",min:0,max:1,default:1},tn=t=>t.replace(/([A-Z])/,t=>`-${t.toLowerCase()}`);(t=>{function e(t){return`${t}px`}t.toPixel=e;t.fromPercent=function(t){return parseFloat(t.substring(0,t.length-1))};t.toPercent=function(t){return`${t}%`};t.enableEvent=function(t){t.style.pointerEvents="all"};function i(t,...e){let r=document.createElement(t);return e.length>0&&(r.className=(0,b.Z)(e)),r}t.disableEvent=function(t){t.style.pointerEvents="none"},t.createElement=i;t.createDivWithClass=function(...t){return i("div",...t)};t.addClass=function(t,...e){t.className=(0,b.Z)(e.concat(t.className.split(" ")))};t.delClass=function(t,...e){e.forEach(e=>{t.classList.remove(e)}),t.className=t.classList.toString()};t.coverClass=function(t,...e){t.className=(0,b.Z)(e)};t.clearChildren=function(t){t.innerHTML=""};t.translatePercent=function(t,e,i){t.style.transform=`translate(${e}%, ${i}%)`};t.translateXPercent=function(t,e){t.style.transform=`translateX(${e}%)`};t.translateYPercent=function(t,e){t.style.transform=`translateY(${e}%)`};t.setStyle=function(t,i){let r=[];z(i,(t,i)=>{void 0!==t&&("number"==typeof t&&"opacity"!==i&&"zIndex"!==i&&"scale"!==i&&(t=e(t)),r.push(`${tn(i)}:${t}`))});let s=t.getAttribute("style"),n=r.join(";");s!==n&&t.setAttribute("style",n)};t.classNameWithPrefix=function(t){return(e,i)=>(0,b.Z)(e.split(/\s+/).map(e=>`${t}-${e}`).join(" "),i)};t.addStandardDisposableListener=function(t,e,i,r){return t.addEventListener(e,i,r),c.create(()=>{t.removeEventListener(e,i)})};t.createDOMCache=function(e,i,r){return p.create(()=>{let s="string"==typeof i?t.createDivWithClass(i):i();return r&&(s.innerHTML=r),e.appendChild(s),Object.assign(s,{dispose:()=>{let{parentNode:t}=s;t&&t.removeChild(s)},setStyle:e=>{t.setStyle(s,e)}})})}})(C||(C={}));var to=0;function ta(){return to===Number.MAX_SAFE_INTEGER&&(to=0),to++}function th(t,e,i){t(e).toSelf().inSingletonScope(),i.forEach(i=>t(i).toService(e))}var tl=Symbol("ContributionProvider"),td=class{constructor(t,e){this.container=t,this.identifier=e}forEach(t){this.getContributions().forEach(t)}getContributions(){if(!this.services){let t=[],{container:e}=this;if(e.isBound(this.identifier))try{t.push(...e.getAll(this.identifier))}catch(t){console.error(t)}this.services=t}return this.services}};function tc(t,e){t(tl).toDynamicValue(t=>new td(t.container,e)).inSingletonScope().whenTargetNamed(e)}function tu(t){let[,e]=(0,N.useState)(t);return(0,N.useCallback)(t=>e(void 0!==t?t:{}),[])}new class{isDevEnv(){return!1}info(...t){if(this.isDevEnv())return console.info(t)}log(...t){if(this.isDevEnv())return console.log(...t)}error(...t){return console.error(...t)}warn(...t){return console.warn(...t)}}},664881:function(t,e,i){i.d(e,{Bl:function(){return u},Bw:function(){return k},Co:function(){return Z},FC:function(){return K},GH:function(){return P},Ps:function(){return Y},Us:function(){return B},au:function(){return T},b5:function(){return I},fu:function(){return M},j0:function(){return g},kq:function(){return H},o:function(){return J},pm:function(){return W},ps:function(){return z},yf:function(){return F}});var r=i(461932),s=i(362270),n=i(177783),o=i(213153),a=i(908600),h=Object.defineProperty,l=Object.getOwnPropertyDescriptor,d=(t,e,i,r)=>{for(var s=r>1?void 0:r?l(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&h(e,i,s),s},c=Symbol("NodeContribution"),u=class{constructor(){this.materialRenderRegistry=new Map,this.pluginRenderRegistry=new Map,this.nodeRenderHocs=[],this.nodeContributions=[]}registerMaterialRender(t,e){this.materialRenderRegistry.set(t,e)}getMaterialRender(t){return this.materialRenderRegistry.get(t)}registerPluginRender(t,e){this.pluginRenderRegistry.set(t,e)}getPluginRender(t){return this.pluginRenderRegistry.get(t)}registerNodeErrorRender(t){this.registerMaterialRender("Material_CustomNodeError",t)}get nodeRenderHoc(){return(0,s.flow)(this.nodeRenderHocs)}registerNodeRenderHoc(t){this.nodeRenderHocs.push(t)}get nodeErrorRender(){return this.materialRenderRegistry.get("Material_CustomNodeError")}init(){this.nodeContributions.forEach(t=>t.onRegister?.(this))}};d([(0,r.nx)(c),(0,r.jt)()],u.prototype,"nodeContributions",2),d([(0,r.zY)()],u.prototype,"init",1),u=d([(0,r.b2)()],u);var g=class{constructor(){this.onChangeEmitter=new n.Q5,this.onChange=this.onChangeEmitter.event,this._readonly=g.DEFAULT_READONLY,this._json=g.DEFAULT_JSON}get json(){return this._json}get readonly(){return this._readonly}set readonly(t){this._readonly=t,this.fireChange()}fireChange(){this.updateJSON(),this.onChangeEmitter.fire(this)}updateJSON(){this._json={readonly:this._readonly}}};g.DEFAULT_READONLY=!1,g.DEFAULT_JSON={readonly:g.DEFAULT_READONLY},g=d([(0,r.b2)()],g);var p=class{};d([(0,r.f3)(u)],p.prototype,"nodeManager",2),d([(0,r.f3)(g)],p.prototype,"context",2),p=d([(0,r.b2)()],p);var f=new r.nZ((t,e,i,r)=>{t(p).toSelf().inSingletonScope(),t(u).toSelf().inSingletonScope(),t(g).toSelf().inSingletonScope()}),y="Plugin_Form",m="Plugin_Error",E="node_error_render",D="node_placeholder_render",M=class extends o.RD{getDefaultData(){return{error:null}}setError(t){this.update({error:t})}getError(){return this.data.error}};M.type="FlowNodeErrorData";var C={color:"#f54a45"},b=({error:t})=>a.createElement("div",{style:C},t.message),N=({node:t,playgroundContext:e})=>{let i=(0,o.JA)(),r=t.getData(M),s=r.getError(),n=(0,o.G2)(u).getMaterialRender(E),h=(0,a.useCallback)(()=>n?n({error:s,context:{node:t,playgroundContext:e}}):b({error:s,context:{node:t,playgroundContext:e}}),[s,t,e]);return(0,a.useEffect)(()=>{let t=r.onDataChange(()=>{i()});return()=>{t.dispose()}},[]),s?h():null},S=t=>a.createElement(N,{...t}),x=class{onRegister(t){t.registerPluginRender(m,S)}};x=d([(0,r.b2)()],x);var _=new r.nZ(t=>{(0,n.KV)(t,x,[c])}),w=class{makeFormItemMaterialContext(t,e){return{meta:t.meta,path:t.path,readonly:this.nodeEngineContext.readonly,getFormItemValueByPath:t.formModel.getFormItemValueByPath.bind(t.formModel),onFormValidate:t.formModel.onValidate.bind(t.formModel),form:t.formModel,node:t.formModel.flowNodeEntity,playgroundContext:this.playgroundContext,index:e?.getIndex()}}};d([(0,r.f3)(g)],w.prototype,"nodeEngineContext",2),d([(0,o.el)()],w.prototype,"playgroundContext",2),w=d([(0,r.b2)()],w);var I=class{static normalize(t){return t===I.ROOT?t:(t.endsWith(I.DIVIDER)&&(t=t.slice(0,-1)),t)}static join(t){if(t[1].startsWith(I.ROOT))throw Error(`FormPathService Error: join failed, invalid paths[1], paths[1]= ${t[1]}`);return t[0].endsWith(I.DIVIDER)?`${t[0]}${t[1]}`:t.join(I.DIVIDER)}static toArrayPath(t){return I.join([t,I.ARRAY])}static parseArrayItemPath(t){let e=t.split("/"),i=0;for(;i<e.length;){let t=parseInt(e[i]);if(!isNaN(t)){let r=I.toArrayPath(e.slice(0,i).join(I.DIVIDER)),s=e.slice(i+1).join(I.DIVIDER),n=I.join([r,s]);return{itemIndex:t,arrayPath:r,itemMetaPath:n}}i+=1}return null}simplify(t){let e=t.split(I.DIVIDER),i=[];for(let t=0;t<e.length;t++){if(!e[t])throw Error("FormPathService: join failed");if(e[t]!==I.RELATIVE_CURRENT)e[t]===I.RELATIVE_PARENT&&i.pop(),i.push(e[t])}return i.join(I.DIVIDER)}};I.ROOT="/",I.DIVIDER="/",I.RELATIVE_PARENT="..",I.RELATIVE_CURRENT=".",I.ARRAY="[]",I=d([(0,r.b2)()],I),Symbol("FormModelFactory"),Symbol("FormModelEntity");var T=class{constructor(){this.toDispose=new n.K4}};T=d([(0,r.b2)()],T);var L=class{constructor(){this.registry=new Map}register(t){this.registry.set(t.key,t)}get(t){return this.registry.get(t)}get objectMap(){return Object.fromEntries(this.registry)}get collection(){return Array.from(this.registry.values())}};L=d([(0,r.b2)()],L);var O=Symbol("FormContribution"),A=class t{get type(){return t.type}};A.type="setter";var k=A,R=class t{get type(){return t.type}};R.type="decorator";var P=R;(class t{get type(){return t.type}}).type="visibility";var j=class t{get type(){return t.type}};j.type="effect";var z=j;(class t{get type(){return t.type}}).type="default";var V=class t{get type(){return t.type}};V.type="validation";var B=V,F=class{constructor(){this.abilityRegistry=new Map,this.setterHocs=[],this.extensionRegistryMap=new Map,this.formContributions=[],this.onFormModelWillInitEmitter=new n.Q5,this.onFormModelWillInit=this.onFormModelWillInitEmitter.event}get components(){return(0,s.mapValues)(this.extensionRegistryMap.get(k.type)?.objectMap||{},t=>t.component)}get decorators(){return(0,s.mapValues)(this.extensionRegistryMap.get(P.type)?.objectMap||{},t=>t.component)}registerAbilityExtension(t,e){!this.extensionRegistryMap.get(t)&&this.extensionRegistryMap.set(t,new L);let i=this.extensionRegistryMap.get(t);if(!!i)i.register(e)}getAbilityExtension(t,e){return this.extensionRegistryMap.get(t)?.get(e)}registerAbility(t){let e=new t;this.abilityRegistry.set(e.type,e)}registerAbilities(t){t.forEach(this.registerAbility.bind(this))}getAbility(t){return this.abilityRegistry.get(t)}registerSetterHoc(t){this.setterHocs.push(t)}fireFormModelWillInit(t,e){this.onFormModelWillInitEmitter.fire({model:t,data:e})}dispose(){this.onFormModelWillInitEmitter.dispose()}init(){this.formContributions.forEach(t=>t.onRegister?.(this))}};d([(0,r.f3)(I)],F.prototype,"pathManager",2),d([(0,r.f3)(w)],F.prototype,"formContextMaker",2),d([(0,o.el)()],F.prototype,"playgroundContext",2),d([(0,r.nx)(O),(0,r.jt)()],F.prototype,"formContributions",2),d([(0,r.zY)()],F.prototype,"init",1),F=d([(0,r.b2)()],F);var Y=class extends o.RD{constructor(t,e){super(t),this.onDetailChangeEmitter=new n.Q5,this.onDetailChange=this.onDetailChangeEmitter.event,this.flowNodeEntity=t,this.formModel=e.formModelFactory(t),this.toDispose.push(this.onDetailChangeEmitter),this.toDispose.push(n.JT.create(()=>{this.formModel.dispose()}))}getFormModel(){return this.formModel}getDefaultData(){return{}}createForm(t,e){let i=this.flowNodeEntity.getData(M);i.setError(null);try{this.formModel.init(t,e)}catch(t){i.setError(t)}}recreateForm(t,e){this.createForm(t,e)}toJSON(){return this.formModel.toJSON()}dispose(){super.dispose()}fireDetaiChange(t){this.onDetailChangeEmitter.fire(t)}};Y.type="FlowNodeEntityFormData";function U({node:t}){var e;let i=(0,n.JA)();let r=(e=t,e.getData(Y)?.getFormModel());return(0,a.useEffect)(()=>{let t=r?.onInitialized(()=>{i()});return()=>{t.dispose()}},[r]),r?.initialized?r.render():null}var G=t=>a.createElement(U,{...t}),Q=class{onRegister(t){t.registerPluginRender(y,G)}};Q=d([(0,r.b2)()],Q);var X=new r.nZ(t=>{t(F).toSelf().inSingletonScope(),t(I).toSelf().inSingletonScope(),t(w).toSelf().inSingletonScope(),(0,n.KV)(t,Q,[c])});function W(){return[f,X,_]}var $=a.createContext(g.DEFAULT_JSON),J=(0,a.memo)(({node:t})=>{let e=(0,o.JA)(),i=t.getData(M),r=t.getData(Y).formModel,s=!!t.getData(M).getError(),n=t.getData(Y).getFormModel().initialized,h=(0,o.G2)(o.xm),l=(0,o.G2)(u),d=l.getPluginRender(y),c=l.getPluginRender(m),p=l.getMaterialRender(D),f=function(){let t=(0,o.JA)(),e=(0,o.G2)(g);return(0,a.useEffect)(()=>{let i=e.onChange(()=>{t()});return()=>{i.dispose()}},[]),e}();(0,a.useEffect)(()=>{let t=i.onDataChange(()=>{e()}),s=r.onInitialized(()=>{e()});return()=>{t.dispose(),s.dispose()}},[]);let E=(0,a.useCallback)(()=>s?c({node:t,playgroundContext:h}):r.formMeta?n?d({node:t,playgroundContext:h}):p?.({node:t,playgroundContext:h})||null:null,[s,n,c,d,p,t,h]);return a.createElement($.Provider,{value:f.json},l.nodeRenderHoc(E)())});function H(t,e){t.registerMaterialRender(E,e)}function K(t,e){t.registerMaterialRender(D,e)}function Z(){return[Y,M]}},112168:function(t,e,i){i.d(e,{C$:function(){return f},F2:function(){return Y},Np:function(){return B},gN:function(){return I},l0:function(){return F},lE:function(){return z},rR:function(){return n}});var r,s,n,o,a=i(908600),h=i(362270),l=i(177783),d=i(474414),c=i(433210),u=t=>null!==t&&"object"==typeof t,g=t=>String(Math.floor(Number(t)))===t;function p(t,e){let i=new Set(e),r={};return Object.keys(t).forEach(e=>{i.has(e)&&(r[e]=t[e])}),r}(t=>{t.DIVIDER=".",t.ALL="*";t.isMatch=function(e,i){let r=e.split(t.DIVIDER),s=i.split(t.DIVIDER);return r.length===s.length&&r.every((e,i)=>e===t.ALL||e===s[i])};t.isMatchOrParent=function(e,i){if(""===e)return!0;let r=e.split(t.DIVIDER),s=i.split(t.DIVIDER);if(r.length>s.length)return!1;for(let e=0;e<r.length;e++)if(r[e]!==t.ALL&&r[e]!==s[e])return!1;return!0};function e(i,...r){let s=r.shift();if(void 0===s)return i.toString();let n="";return(n=""===i&&""===s?"":""!==i&&""===s?i.toString():""===i&&""!==s?s.toString():`${i}${t.DIVIDER}${s}`,r.length>0)?e(n,...r):n}t.getParentPathByPattern=function(e,i){let r=e.split(t.DIVIDER);return i.split(t.DIVIDER).slice(0,r.length).join(t.DIVIDER)};t.getSubPaths=function(t,i){return i&&"object"==typeof i?(0,h.flatten)(t.map(t=>{let r=""===t?i:(0,h.get)(i,t);return(0,h.isArray)(r)?r.map((i,r)=>e(t,r)):(0,h.isObject)(r)?Object.keys(r).map(i=>e(t,i)):[]})):[]};function i(r,s,n){if(!r||!s)return[];let o=s.split(t.DIVIDER),a=o.shift(),l=[],d=r;for(;a;){if("object"!=typeof d)return[];if(a===t.ALL){let r=l.join(t.DIVIDER);return(0,h.flatten)(Object.keys(d).map(s=>0===o.length?e(r,s):i(d[s],`${o.join(t.DIVIDER)}`,n).map(t=>e(r,s,t))))}if(!(a in d)&&!n)return[];d=d[a],l.push(a),a=o.shift()}return[s]}t.splitPattern=function(e){let i=e.split(t.DIVIDER),r=[],s=0,n=[];for(;s<i.length;)i[s]===t.ALL?(n.length&&r.push(n.join(t.DIVIDER)),r.push(t.ALL),n=[]):n.push(i[s]),s+=1;return n.length&&r.push(n.join(t.DIVIDER)),r},t.findMatchPaths=i;t.findMatchPathsWithEmptyValue=function(t,e){return i(t,e,!0)}})(n||(n={}));var f=((r=f||{}).onChange="onChange",r.onBlur="onBlur",r),y=class t{constructor(t){this._path=[],this._path=(0,h.toPath)(t)}get parent(){if(!(this._path.length<2))return new t(this._path.slice(0,-1))}toString(){return this._path.join(".")}get value(){return this._path}isChild(e){let i=new t(e).value,r=this.value;if(i.length-r.length!=1)return!1;for(let t=0;t<r.length;t++)if(i[t]!==r[t])return!1;return!0}static compareArrayPath(t,e){let i=0;for(;t.value[i]&&e.value[i];){let r=parseInt(t.value[i]),s=parseInt(e.value[i]);if(!isNaN(r)&&!isNaN(s))return r-s;if(t.value[i]!==e.value[i])throw Error(`[Form] Path.compareArrayPath invalid input Error: two path should refers to the same array, but got path1: ${t.toString()}, path2: ${e.toString()}`);i++}throw Error(`[Form] Path.compareArrayPath invalid input Error: got path1: ${t.toString()}, path2: ${e.toString()}`)}isChildOrGrandChild(e){let i=new t(e).value,r=this.value;if(i.length-r.length<1)return!1;for(let t=0;t<r.length;t++)if(i[t]!==r[t])return!1;return!0}getArrayIndex(t){return parseInt(this._path[t.value.length])}concat(e){if("string"==typeof e||"number"==typeof e)return new t(this._path.concat(new t(e.toString())._path));throw Error(`[Form] Error in Path.concat: invalid param type, require number or string, but got ${typeof e}`)}replaceParent(e,i){if(e.value.length>this.value.length)throw Error(`[Form] Error in Path.getChildSuffixByParent: invalid parent param: ${e}, parent length should not greater than current length.`);let r=[];for(let t=0;t<this.value.length;t++){if(t<e.value.length&&e.value[t]!==this.value[t])throw Error(`[Form] Error in Path.getChildSuffixByParent: invalid parent param: ${e}`);t>=e.value.length&&r.push(this.value[t])}return new t(i.value.concat(r))}};function m(t,e){return t.map(t=>({...t,name:e}))}function E(t,e){return e?t?Object.keys(e).some(i=>!(0,h.isEqual)(t[i],e[i]))?{...t,...e}:t:{...e}:t}function D(t,e){return e?(t in e&&delete e[t],e):e}function M(t,e){return t===e}function C(t){let e={get name(){return t.name},get value(){return t.value},onChange:e=>{var i,r;if("object"==typeof(i=e)&&null!==i&&"target"in i&&"object"==typeof i.target){;t.value="object"==typeof(r=e)&&null!==r&&"target"in r&&"object"==typeof r.target&&"checkbox"===r.target.type?e.target.checked:e.target.value}else t.value=e},onBlur(){if("onBlur"===t.form.validationTrigger)t.validate()},onFocus(){t.state.isTouched=!0}};return Object.defineProperty(e,"key",{enumerable:!1,get:()=>t.id}),Object.defineProperty(e,"_fieldModel",{enumerable:!1,get:()=>t}),e}function b(t){return{get isTouched(){return t.isTouched},get invalid(){return t.invalid},get isDirty(){return t.isDirty},get isValidating(){return t.isValidating},get errors(){if(t.errors)return Object.values(t.errors).reduce((t,e)=>t.concat(e),[]);return},get warnings(){if(t.warnings)return Object.values(t.warnings).reduce((t,e)=>t.concat(e),[]);return}}}function N(t){let e={initialValues:t.initialValues,get values(){return t.values},set values(v){t.values=v},state:S(t.state),getValueIn:e=>t.getValueIn(e),setValueIn:(e,i)=>t.setValueIn(e,i)};return Object.defineProperty(e,"_formModel",{enumerable:!1,get:()=>t}),e}function S(t){return{get isTouched(){return t.isTouched},get invalid(){return t.invalid},get isDirty(){return t.isDirty},get isValidating(){return t.isValidating},get errors(){return t.errors},get warnings(){return t.warnings}}}(s=o||(o={})).shouldTriggerFieldChangeEvent=function(t,e){let{name:i,options:r}=t;if(n.isMatchOrParent(e,i))return!0;if(new y(i).isChildOrGrandChild(e))return r?.action==="array-append"?!new y(i).isChildOrGrandChild(e):!(r?.action==="array-splice"&&r?.indexes?.length)||y.compareArrayPath(new y(e),new y(i).concat(r.indexes[0]))>=0;return!1},s.shouldTriggerFieldValidateWhenChange=function(t,e){let{name:i,options:r}=t;return r?.action==="array-splice"?e===i:s.shouldTriggerFieldChangeEvent(t,e)};var x=a.createContext({}),_=a.createContext({});function w(){return(0,a.useContext)(x)}function I({name:t,defaultValue:e,render:i,children:r,deps:s}){let n=w(),o=n.getField(t)||n.createField(t),c=a.useMemo(()=>C(o),[o]),u=(0,d.nt)(o.reactiveState),g=(0,d.nt)(n.reactiveState),p=a.useMemo(()=>b(u),[u]),f=S(g),y=(0,l.JA)();return a.useEffect(()=>{o.renderCount=o.renderCount+1,n.getValueIn(t),void 0!==e&&(n.setInitValueIn(t,e),y());let i=new l.K4;return i.push(o.onValueChange(()=>{y()})),s&&s.forEach(t=>{let e=n.getField(t)?.onValueChange(()=>{y()});e&&i.push(e)}),()=>{i.dispose(),o.renderCount>1?o.renderCount=o.renderCount-1:n.getField(o.name)===o&&o.dispose()}},[o]),a.createElement(_.Provider,{value:o},i?i({field:c,fieldState:p,formState:f}):(0,h.isFunction)(r)?r({field:c,fieldState:p,formState:f}):a.cloneElement(r,{...c}))}function T(t){let e={get key(){return t.id},get name(){return t.path.toString()},get value(){return t.value},onChange:e=>{t.value=e},map:e=>t.map((t,i)=>e(C(t),i)),append:e=>C(t.append(e)),delete:e=>t.delete(e),swap:(e,i)=>t.swap(e,i),move:(e,i)=>t.move(e,i)};return Object.defineProperty(e,"_fieldModel",{enumerable:!1,get:()=>t}),e}function L(t,e){return"string"==typeof t?{name:e,message:t,level:"error"}:t?.message?{...t,name:e}:void 0}function O(t,e){return{[t]:e?[e]:[]}}var A=t=>{for(let e in t)if(e.length)return!0;return!1},k={invalid:!1,isDirty:!1,isTouched:!1,isValidating:!1},R={invalid:!1,isDirty:!1,isTouched:!1,isValidating:!1},P=class{get values(){return this._values}set values(t){this._values=t}setInitialValues(t){this._values=t}setIn(t,e){this._values=function(t,e,i){let r=(0,h.clone)(t),s=r,n=0,o=(0,h.toPath)(e);for(;n<o.length-1;n++){let e=o[n],i=function(t,e,i,r=0){let s=(0,h.toPath)(e);for(;t&&r<s.length;)t=t[s[r++]];return r===s.length||t?void 0===t?i:t:void 0}(t,o.slice(0,n+1));if(i&&(u(i)||Array.isArray(i)))s=s[e]=(0,h.clone)(i);else{let t=o[n+1];s=s[e]=g(t)&&Number(t)>=0?[]:{}}}return(0===n?t:s)[o[n]]===i?t:(void 0===i?delete s[o[n]]:s[o[n]]=i,0===n&&void 0===i&&delete r[o[n]],r)}(this._values||{},t.toString(),e)}getIn(t){return(0,h.get)(this._values,t.value)}dispose(){}},j=class{constructor(t,e){var i;this.onValueChangeEmitter=new l.Q5,this.onValueChange=this.onValueChangeEmitter.event,this.toDispose=new l.K4,this._state=new d.BP({...k}),this._renderCount=0,this._mount=!1,this._path=t,this.form=e,this.id=(0,c.x0)();let r=this.form.onFormValuesChange(t=>{let{values:e,prevValues:i}=t;if(o.shouldTriggerFieldChangeEvent(t,this.name)){if(this.onValueChangeEmitter.fire({value:(0,h.get)(e,this.name),prevValue:(0,h.get)(i,this.name),formValues:e,prevFormValues:i}),"onChange"===this.form.validationTrigger&&o.shouldTriggerFieldValidateWhenChange(t,this.name))this.validate()}});this.toDispose.push(r),this.toDispose.push(this.onValueChangeEmitter),this.initState()}get renderCount(){return this._renderCount}set renderCount(t){this._renderCount=t}initState(){let t=(0,h.get)(this.form.state.errors,this.name),e=(0,h.get)(this.form.state.warnings,this.name);t&&(this.state.errors={[this.name]:t}),e&&(this.state.warnings={[this.name]:e})}get path(){return this._path}get name(){return this._path.toString()}set name(t){this._path=new y(t)}get ref(){return this._ref}set ref(t){this._ref=t}get state(){return this._state.value}get reactiveState(){return this._state}get value(){return this.form.getValueIn(this.name)}set value(t){this.form.setValueIn(this.name,t),!this.state.isTouched&&(this.state.isTouched=!0,this.bubbleState())}updateNameForLeafState(t){let{errors:e,warnings:i}=this.state,r=e?Object.keys(e)?.[0]:void 0;r&&e?.[r]&&r!==t&&(this.state.errors={[t]:e?.[r]?m(e?.[r],t):e?.[r]});let s=i?Object.keys(i)?.[0]:void 0;s&&i?.[s]&&s!==t&&(this.state.warnings={[t]:i?.[s]?m(i?.[s],t):i?.[s]})}updateValidate(t,e){"ui"===e?!this.originalValidate&&(this.originalValidate=t):this.originalValidate=t}bubbleState(){let{errors:t,warnings:e}=this.state;if(this.parent){this.parent.state.isTouched=(0,h.some)(this.parent.children.map(t=>t.state.isTouched),Boolean),this.parent.state.invalid=(0,h.some)(this.parent.children.map(t=>t.state.invalid),Boolean),this.parent.state.isDirty=(0,h.some)(this.parent.children.map(t=>t.state.isDirty),Boolean),this.parent.state.isValidating=(0,h.some)(this.parent.children.map(t=>t.state.isValidating),Boolean),this.parent.state.errors=t?E(this.parent.state.errors,t):D(this.name,this.parent.state.errors),this.parent.state.warnings=e?E(this.parent.state.warnings,e):D(this.name,this.parent.state.warnings),this.parent.bubbleState();return}this.form.state.isTouched=(0,h.some)(this.form.fields.map(t=>t.state.isTouched),Boolean),this.form.state.invalid=(0,h.some)(this.form.fields.map(t=>t.state.invalid),Boolean),this.form.state.isDirty=(0,h.some)(this.form.fields.map(t=>t.state.isDirty),Boolean),this.form.state.isValidating=(0,h.some)(this.form.fields.map(t=>t.state.isValidating),Boolean),this.form.state.errors=t?E(this.form.state.errors,t):D(this.name,this.form.state.errors),this.form.state.warnings=e?E(this.form.state.warnings,e):D(this.name,this.form.state.warnings)}clearState(){this.state.errors=k.errors,this.state.warnings=k.warnings,this.state.isTouched=k.isTouched,this.state.isDirty=k.isDirty,this.bubbleState()}get children(){let t=[];return this.form.fieldMap.forEach((e,i)=>{this.path.isChild(i)&&t.push(e)}),t}get parent(){let t=this.path.parent;if(!!t)return this.form.fieldMap.get(t.toString())}clear(){if(!!this.value)this.value=void 0}async validate(){await this.validateSelf()}async validateSelf(){this.state.isValidating=!0,this.bubbleState();let{errors:t,warnings:e}=await this._runAsyncValidate();t?.length?(this.state.errors=(0,h.groupBy)(t,"name"),this.state.invalid=!0):(this.state.errors={[this.name]:[]},this.state.invalid=!1),e?.length?this.state.warnings=(0,h.groupBy)(e,"name"):this.state.warnings={[this.name]:[]},this.state.isValidating=!1,this.bubbleState(),this.form.onValidateEmitter.fire(this.form.state)}async _runAsyncValidate(){let t=[],e=[],i=await this.form.validateIn(this.name);if(!i)return{};{let r=L(i,this.name);if(!r)return{};if("warning"===r.level?0:1)t.push(r);else e.push(r)}return{errors:t,warnings:e}}updateState(t){}dispose(){this.children.map(t=>t.dispose()),this.toDispose.dispose(),this.form.fieldMap.delete(this.path.toString())}onDispose(t){this.toDispose.onDispose(t)}},z=class extends j{constructor(){super(...arguments),this.onAppendEmitter=new l.Q5,this.onAppend=this.onAppendEmitter.event,this.onDeleteEmitter=new l.Q5,this.onDelete=this.onDeleteEmitter.event}get children(){let t=[];return this.form.fieldMap.forEach((e,i)=>{this.path.isChild(i)&&t.push(e)}),t.sort((t,e)=>{let i=t.path.value,r=e.path.value,s=parseInt(i[i.length-1]);return s-parseInt(i[r.length-1])})}map(t){return(this.value||[]).map((t,e)=>{let i=this.path.concat(e).toString(),r=this.form.getField(i);return!r&&(r=this.form.createField(i)),r}).map(t)}append(t){let e=this.value?.length||0,i=this.path.concat(e).toString(),r=this.form.createField(i),s=this.value?[...this.value,t]:[t],n=this.form.values;return this.form.store.setIn(new y(this.name),s),this.form.fireOnFormValuesChange({values:this.form.values,prevValues:n,name:this.name,options:{action:"array-append",indexes:[e]}}),this.form.fireOnFormValuesInit({values:this.form.values,prevValues:n,name:i}),this.onAppendEmitter.fire({value:t,arrayValue:this.value,index:this.value.length-1}),r}delete(t){this._splice(t,1),this.onDeleteEmitter.fire({arrayValue:this.value,index:t})}_splice(t,e=1){if(t<0||e<0)throw Error("[Form] Error in FieldArrayModel.splice: Invalid Params, start and deleteCount should > 0");if(!this.value||0===this.value.length||e>this.value.length)throw Error(`[Form] Error in FieldArrayModel.splice: delete count exceeds array length, tried to delete ${e} elements, but array length is ${this.value?.length||0}`);let i=this.form.values,r=[...this.value];r.splice(t,e),this.form.store.setIn(new y(this.name),r),this.form.fireOnFormValuesChange({values:this.form.values,prevValues:i,name:this.name,options:{action:"array-splice",indexes:Array.from({length:e},(e,i)=>i+t)}});let s=this.children;if(t+e>=s.length)for(let e=t;e<s.length;e++)this.form.disposeField(s[e].name);let n=[],o=new Map(this.form.fieldMap),a=(i,r)=>{if(i.children?.length&&i.children.forEach(t=>{a(t,r)}),r<t)o.set(i.name,i);else if(r<t+e)n.push(i);else{let t=i.name,n=i.path.replaceParent(this.path.concat(r),this.path.concat(r-e)).toString();o.set(n,i),!i.children.length&&(i.updateNameForLeafState(n),i.bubbleState()),i.name=n,r>s.length-e-1&&o.delete(t)}};s.map((t,e)=>{a(t,e)}),n.forEach(t=>{t.dispose()}),this.form.fieldMap=o,this.form.alignStateWithFieldMap()}swap(t,e){if(!this.value)return;if(t<0||e<0||t>this.value.length-1||e>this.value.length-1)throw Error(`[Form]: FieldArrayModel.swap Error: invalid params 'form' and 'to', form=${t} to=${e}. expect the value between 0 to ${length-1}`);let i=[...this.value],r=i[t],s=i[e];i[e]=r,i[t]=s,this.form.setValueIn(this.name,i)}move(t,e){if(!this.value)return;if(t<0||e<0||t>this.value.length-1||e>this.value.length-1)throw Error(`[Form]: FieldArrayModel.move Error: invalid params 'form' and 'to', form=${t} to=${e}. expect the value between 0 to ${length-1}`);let i=[...this.value],r=i[t];i.splice(t,1),i.splice(e,0,r),this.form.setValueIn(this.name,i)}},V=class{constructor(){var t;this._fieldMap=new Map,this.store=new P,this._options={},this.onFieldModelCreateEmitter=new l.Q5,this.onFieldModelCreate=this.onFieldModelCreateEmitter.event,this.onFormValuesChangeEmitter=new l.Q5,this.onFormValuesChange=this.onFormValuesChangeEmitter.event,this.onFormValuesInitEmitter=new l.Q5,this.onFormValuesInit=this.onFormValuesInitEmitter.event,this.onFormValuesUpdatedEmitter=new l.Q5,this.onFormValuesUpdated=this.onFormValuesUpdatedEmitter.event,this.onValidateEmitter=new l.Q5,this.onValidate=this.onValidateEmitter.event,this._state=new d.BP({...R}),this._initialized=!1}set fieldMap(t){this._fieldMap=t}get fieldMap(){return this._fieldMap}get context(){return this._options.context}get initialValues(){return this._options.initialValues}get values(){return(0,h.cloneDeep)(this.store.values)||(0,h.cloneDeep)(this.initialValues)}set values(t){let e=this.values;this.store.values=t,this.fireOnFormValuesChange({values:this.values,prevValues:e,name:""})}get validationTrigger(){return this._options.validateTrigger}get state(){return this._state.value}get reactiveState(){return this._state}get fields(){return Array.from(this.fieldMap.values())}updateState(t){}get initialized(){return this._initialized}fireOnFormValuesChange(t){this.onFormValuesChangeEmitter.fire(t),this.onFormValuesUpdatedEmitter.fire(t)}fireOnFormValuesInit(t){this.onFormValuesInitEmitter.fire(t),this.onFormValuesUpdatedEmitter.fire(t)}init(t){if(this._options=t,t.initialValues){let e=this.store.values;this.store.setInitialValues(t.initialValues),this.fireOnFormValuesInit({values:t.initialValues,prevValues:e,name:""})}this._initialized=!0}createField(t,e){let i=new y(t),r=i.toString();if(this.fieldMap.get(r))return this.fieldMap.get(r);let s=e?new z(i,this):new j(i,this);return this.fieldMap.set(r,s),s.onDispose(()=>{this.fieldMap.delete(r)}),this.onFieldModelCreateEmitter.fire(s),s}createFieldArray(t,e){return this.createField(t,!0)}disposeField(t){let e=this.fieldMap.get(t);e&&e.dispose()}deleteField(t){let e=this.fieldMap.get(t);e&&(e.clear(),e.dispose())}getField(t){return this.fieldMap.get(new y(t).toString())}getValueIn(t){return this.store.getIn(new y(t))}setValueIn(t,e){let i=this.values;this.store.setIn(new y(t),e),this.fireOnFormValuesChange({values:this.values,prevValues:i,name:t})}setInitValueIn(t,e){let i=new y(t);if(void 0===this.store.getIn(i)){let i=this.values;this.store.setIn(new y(t),e),this.fireOnFormValuesInit({values:this.values,prevValues:i,name:t})}}clearValueIn(t){this.setValueIn(t,void 0)}async validateIn(t){if(!this._options.validate)return;let e=Object.keys(this._options.validate).find(e=>n.isMatch(e,t));if(e)return(0,this._options.validate[e])({value:this.getValueIn(t),formValues:this.values,context:this.context,name:t})}async validate(){if(!this._options.validate)return[];let t=Object.keys(this._options.validate).map(async t=>{let e=this._options.validate[t];return Promise.all(n.findMatchPathsWithEmptyValue(this.values,t).map(async t=>{var i;let r=L(await e({value:(0,h.get)(this.values,t),formValues:this.values,context:this.context,name:t}),t),s=this.getField(t),n=O(t,r),o=O(t,r);return s&&(s.state.errors=n,s.state.warnings=o,s.state.invalid=A(n),s.bubbleState()),this.state.errors=E(this.state.errors,n),this.state.warnings=E(this.state.warnings,o),this.state.invalid=!(!(i=this.state.errors)||Object.keys(i).every(t=>(0,h.isEmpty)(i[t]))),r}))});this.state.isValidating=!0;let e=await Promise.all(t);return this.state.isValidating=!1,this.onValidateEmitter.fire(this.state),(0,h.flatten)(e).filter(Boolean)}alignStateWithFieldMap(){let t=Array.from(this.fieldMap.keys());this.state.errors&&(this.state.errors=p(this.state.errors,t)),this.state.warnings&&(this.state.warnings=p(this.state.warnings,t)),this.fieldMap.forEach(e=>{e.state.errors&&(e.state.errors=p(e.state.errors,t)),e.state.warnings&&(e.state.warnings=p(e.state.warnings,t))})}dispose(){this.fieldMap.forEach(t=>t.dispose()),this.store.dispose(),this._initialized=!1}};function B(t){let{disableAutoInit:e=!1,...i}=t||{},r=new V;return!e&&r.init(i||{}),{form:N(r),control:{_formModel:r,getField:t=>{let e=r.getField(t);if(e)return e instanceof z?T(e):C(e)},init:()=>r.init(i||{})}}}function F(t){let{children:e,keepModelOnUnMount:i=!1,control:r,...s}=t,{_formModel:n}=(0,a.useMemo)(()=>r||B(s).control,[r]);(0,a.useEffect)(()=>()=>{!i&&n.dispose()},[]);let o=(0,a.useMemo)(()=>N(n),[n]);return a.createElement(x.Provider,{value:n},e?(0,h.isFunction)(e)?e({form:o}):a.Children.only(e):null)}function Y({name:t,defaultValue:e,deps:i,render:r,children:s}){let n=w(),o=a.useMemo(()=>n.getField(t)||n.createFieldArray(t),[]),c=a.useMemo(()=>T(o),[o]),u=(0,l.JA)(),g=(0,d.nt)(o.reactiveState),p=(0,d.nt)(n.reactiveState),f=b(g),y=a.useMemo(()=>S(p),[p]);return a.useEffect(()=>{o.renderCount=o.renderCount+1,n.getValueIn(t),void 0!==e&&(n.setInitValueIn(t,e),u());let r=new l.K4;return r.push(o.onValueChange(()=>{u()})),i&&i.forEach(t=>{let e=n.getField(t)?.onValueChange(()=>{u()});e&&r.push(e)}),()=>{r.dispose(),o.renderCount>1?o.renderCount=o.renderCount-1:n.getField(o.name)===o&&o.dispose()}},[o]),a.createElement(_.Provider,{value:o},r&&(0,h.isFunction)(r)?r({field:c,fieldState:f,formState:y}):(0,h.isFunction)(s)?s({field:c,fieldState:f,formState:y}):a.createElement(a.Fragment,null,"Invalid Array render"))}},133253:function(t,e,i){i.d(e,{CM:function(){return D},CR:function(){return E},TH:function(){return u},wL:function(){return y},zE:function(){return c}});var r,s=i(362270),n=i(177783),o=i(664881),a=i(112168),h=i(213153),l=i(908600),d=i(433210);var c=((r=c||{}).onValueChange="onValueChange",r.onValueInit="onValueInit",r.onValueInitOrChange="onValueInitOrChange",r.onArrayAppend="onArrayAppend",r.onArrayDelete="onArrayDelete",r);function u(t){return"onFormValuesChange"in t}function g(t){return t.startsWith("/")?o.b5.normalize(t).slice(1).split("/").join("."):t}var p=({formModel:t})=>t?.formControl?l.createElement(l.Fragment,null,l.createElement(a.l0,{control:t?.formControl,keepModelOnUnMount:!0},t.formMeta.render)):null,f={EFFECT_MAP:{},EFFECT_RETURN_MAP:new Map([["onValueInitOrChange",{}],["onValueChange",{}],["onValueInit",{}],["onArrayAppend",{}],["onArrayDelete",{}]]),FORM_FEEDBACKS:[],VALID:null},y=class extends o.au{constructor(t){super(),this.effectMap=f.EFFECT_MAP,this.effectReturnMap=f.EFFECT_RETURN_MAP,this.plugins=[],this.formFeedbacks=f.FORM_FEEDBACKS,this.onInitializedEmitter=new n.Q5,this.onValidateEmitter=new n.Q5,this.onValidate=this.onValidateEmitter.event,this.onInitialized=this.onInitializedEmitter.event,this.onDisposeEmitter=new n.Q5,this.onDispose=this.onDisposeEmitter.event,this.toDispose=new n.K4,this.onFormValuesChangeEmitter=new n.Q5,this.onFormValuesChange=this.onFormValuesChangeEmitter.event,this.onValidChangeEmitter=new n.Q5,this.onValidChange=this.onValidChangeEmitter.event,this.onFeedbacksChangeEmitter=new n.Q5,this.onFeedbacksChange=this.onFeedbacksChangeEmitter.event,this._valid=f.VALID,this._feedbacks=[],this._initialized=!1,this.node=t,this.toDispose.pushAll([this.onInitializedEmitter,this.onValidateEmitter,this.onValidChangeEmitter,this.onFeedbacksChangeEmitter,this.onFormValuesChangeEmitter])}get valid(){return this._valid}set valid(t){this._valid=t,this.onValidChangeEmitter.fire(t)}get flowNodeEntity(){return this.node}get formManager(){return this.node.getService(o.yf)}get formControl(){return this._formControl}get formMeta(){return this.node.getNodeRegistry().formMeta}get feedbacks(){return this._feedbacks}set feedbacks(t){this._feedbacks=t,this.onFeedbacksChangeEmitter.fire(t)}get formItemPathMap(){return new Map}get initialized(){return this._initialized}get nodeContext(){return{node:this.node,playgroundContext:this.node.getService(h.xm)}}get nativeFormModel(){return this._formControl?._formModel}render(){var t;return t=this,l.createElement(p,{formModel:t})}initPlugins(t){if(!!t.length)this.plugins=t,t.forEach(t=>{if(t.init(this),t.config?.effect){var e,i;e=this.effectMap,i=t.config.effect,(0,s.mergeWith)(e,i,function(t,e){return(t||[]).concat(e)})}})}init(t,e){let i=this.node.getData(o.Ps);this.onFormValuesChange(()=>{this._valid=null,i.fireChange()});let{validateTrigger:r,validate:n,effect:h}=t;h&&(this.effectMap=h);let l="function"==typeof t.defaultValues?t.defaultValues():t.defaultValues,d=t.formatOnInit?t.formatOnInit(e,this.nodeContext):e,{control:c}=(0,a.Np)({initialValues:d||l,validateTrigger:r,context:this.nodeContext,validate:n,disableAutoInit:!0});this._formControl=c;let u=c._formModel;this.toDispose.push(u),u.onFormValuesChange(t=>{this.onFormValuesChangeEmitter.fire(t)}),t.plugins&&this.initPlugins(t.plugins),u.onFormValuesChange(({values:t,prevValues:e,name:i})=>{Object.keys(this.effectMap).filter(t=>a.rR.isMatchOrParent(t,i)).forEach(r=>{this.effectMap[r].forEach(({effect:n,event:o})=>{if("onValueChange"===o||"onValueInitOrChange"===o){let h=a.rR.getParentPathByPattern(r,i),l=this.effectReturnMap.get(o)?.[h];l&&l();let d=n({name:h,value:(0,s.get)(t,h),prevValue:(0,s.get)(e,h),formValues:t,context:this.nodeContext});d&&"function"==typeof d&&this.effectReturnMap.has(o)&&(this.effectReturnMap.get(o)[h]=d)}})})}),u.onFormValuesInit(({values:t,name:e,prevValues:i})=>{Object.keys(this.effectMap).forEach(r=>{let n=a.rR.findMatchPaths(t,r);this.effectMap[r].forEach(({event:r,effect:o})=>{("onValueInit"===r||"onValueInitOrChange"===r)&&n.forEach(n=>{if(a.rR.isMatchOrParent(e,n)||e===n){let e=this.effectReturnMap.get(r)?.[n];e&&e();let a=o({name:n,value:(0,s.get)(t,n),formValues:t,prevValue:(0,s.get)(i,n),context:this.nodeContext});a&&"function"==typeof a&&this.effectReturnMap.has(r)&&(this.effectReturnMap.get(r)[n]=a)}})})})}),u.onFieldModelCreate(t=>{let e=function(t,e){if(!e)return;if(e[t.name])return e[t.name];let i=(0,s.find)(Object.keys(e),e=>!!e.startsWith("regex:")&&RegExp(e.split(":")[1]).test(t.name));if(i)return e[i]}(t,this.effectMap);if(e?.length){let i=(0,s.groupBy)(e,"event");(0,s.mapKeys)(i,(e,i)=>{let r=t=>{e.forEach(({effect:e})=>e({...t,formValues:u.values,context:this.nodeContext}))};switch(i){case"onArrayAppend":t instanceof a.lE&&t.onAppend(r);break;case"onArrayDelete":t instanceof a.lE&&t.onDelete(r)}})}}),this._formControl.init(),this._initialized=!0,this.onInitializedEmitter.fire(this),this.onDispose(()=>{this._initialized=!1,this.effectMap={},u.dispose()})}toJSON(){return this.formMeta.formatOnSubmit?this.formMeta.formatOnSubmit(this.nativeFormModel?.values,this.nodeContext):this.nativeFormModel?.values}clearValid(){null!==this.valid&&(this.valid=null)}async validate(){return this.formFeedbacks=await this.nativeFormModel?.validate(),this.valid=(0,s.isEmpty)(this.formFeedbacks?.filter(t=>"error"===t.level)),this.onValidateEmitter.fire(this),this.valid}getValues(){return this._formControl?._formModel.values}getField(t){let e=t.includes("/")?g(t):t;return this.formControl?.getField(e)}getValueIn(t){let e=t.includes("/")?g(t):t;return this.nativeFormModel?.getValueIn(e)}setValueIn(t,e){let i=t.includes("/")?g(t):t;this.nativeFormModel?.setValueIn(i,e)}onFormValueChangeIn(t,e){if(!this._initialized)throw Error("[NodeEngine] FormModel Error: onFormValueChangeIn can not be called before initialized");this.formControl._formModel.onFormValuesChange(({name:i,values:r,prevValues:n})=>{i===t&&e({value:(0,s.get)(r,t),prevValue:(0,s.get)(n,t),formValues:r,prevFormValues:n})})}getFormItemValueByPath(t){if(!t)return;if("/"===t)return this._formControl?._formModel.values;let e=g(t);return this.getValueIn(e)}async validateWithFeedbacks(){return await this.validate(),this.formFeedbacks.map(t=>({feedbackStatus:t.level,feedbackText:t.message,path:t.name}))}getFormItemByPath(t){if(!this.nativeFormModel)return;let e=this;if("/"===t)return{get value(){return e.nativeFormModel.values},set value(v){e.nativeFormModel.values=v}};let i=g(t),r=e.getValueIn(i);return{get value(){return r},set value(v){e.setValueIn(i,v)}}}dispose(){this.onDisposeEmitter.fire(),this.effectReturnMap.forEach(t=>{Object.values(t).forEach(t=>{t()})}),this.effectMap=f.EFFECT_MAP,this.effectReturnMap=f.EFFECT_RETURN_MAP,this.plugins.forEach(t=>{t.dispose()}),this.plugins=[],this.formFeedbacks=f.FORM_FEEDBACKS,this._valid=f.VALID,this._formControl=void 0,this._initialized=!1,this.toDispose.dispose()}},m=class{constructor(t,e,i){this.name=t,this.pluginId=`${t}__${(0,d.x0)()}`,this.config=e,this.opts=i}get formModel(){return this._formModel}get ctx(){return{formModel:this.formModel,node:this.formModel.nodeContext.node,playgroundContext:this.formModel.nodeContext.playgroundContext}}init(t){this._formModel=t,this.config?.onInit?.(this.ctx,this.opts)}dispose(){this.config?.onDispose&&this.config?.onDispose(this.ctx,this.opts)}};function E(t,e){return function(i){return new m(t,e,i)}}function D(t){let e=t.getData(o.Ps)?.getFormModel(),i=e?.nativeFormModel;if(!e||!i)return;let r={initialValues:i.initialValues,get values(){return i.values},state:i.state,getValueIn:t=>i.getValueIn(t),setValueIn:(t,e)=>i.setValueIn(t,e),render:()=>l.createElement(o.o,{node:t}),onFormValuesChange:e.onFormValuesChange.bind(e),onFormValueChangeIn:e.onFormValueChangeIn.bind(e),onValidate:e.nativeFormModel.onValidate,validate:e.validate.bind(e)};return Object.defineProperty(r,"_formModel",{enumerable:!1,get:()=>e}),r}},927205:function(t,e,i){i.d(e,{I5:function(){return E},Zd:function(){return m},qP:function(){return M}});var r,s,n=i(908600),o=i(213153),a=i(362270),h=i(461932),l=i(177783),d=i(215206),c=Object.defineProperty,u=Object.getOwnPropertyDescriptor,g=(t,e,i,r)=>{for(var s=r>1?void 0:r?u(e,i):e,n,o=t.length-1;o>=0;o--)(n=t[o])&&(s=(r?n(e,i,s):n(s))||s);return r&&s&&c(e,i,s),s},p={canvasWidth:250,canvasHeight:250,canvasPadding:50,canvasBackground:"rgba(242, 243, 245, 1)",canvasBorderRadius:10,viewportBackground:"rgba(255, 255, 255, 1)",viewportBorderRadius:4,viewportBorderColor:"rgba(6, 7, 9, 0.10)",viewportBorderWidth:1,viewportBorderDashLength:void 0,nodeColor:"rgba(0, 0, 0, 0.10)",nodeBorderRadius:2,nodeBorderWidth:.145,nodeBorderColor:"rgba(6, 7, 9, 0.10)",overlayColor:"rgba(255, 255, 255, 0.55)"},f={scale:.7,opacity:1,translateX:15,translateY:15},y={canvasStyle:p,canvasClassName:"gedit-minimap-canvas",enableActiveDebounce:!1,enableInactiveDebounce:!0,enableDisplayAllNodes:!1,activeDebounceTime:0,inactiveDebounceTime:5},m=t=>{let{service:e,panelStyles:i={},containerStyles:r={},inactiveStyle:s={}}=t,o={...f,...s},a=(0,n.useRef)(null),[h,l]=(0,n.useState)(!1);(0,n.useEffect)(()=>{let t=a.current;t&&e.canvas&&t.appendChild(e.canvas);let i=e.onActive(t=>{l(t)});return()=>{i.dispose()}},[]);let d=h?1:o.scale,c=h?1:o.opacity,u=h?0:o.translateX,g=h?0:o.translateY;return n.createElement("div",{className:"minimap-container",style:{position:"fixed",right:30,bottom:70,transition:"all 0.3s ease",transform:`scale(${d}) translate(${u}px, ${g}px)`,opacity:c,transformOrigin:"bottom right",...r}},n.createElement("div",{className:"minimap-panel",style:{display:"flex",width:"100%",height:"100%",borderRadius:"10px",backgroundColor:"rgba(255, 255, 255, 1)",border:"0.572px solid rgba(6, 7, 9, 0.10)",overflow:"hidden",boxShadow:"0px 2.289px 6.867px 0px rgba(0, 0, 0, 0.08), 0px 4.578px 13.733px 0px rgba(0, 0, 0, 0.04)",padding:8,...i},"data-flow-editor-selectable":"false",ref:a,onMouseEnter:()=>{e.setActivate(!0)},onMouseLeave:()=>{e.setActivate(!1)}}))};(r=s||(s={})).clear=t=>{let{canvas:e,context:i}=t;i.clearRect(0,0,e.width,e.height)},r.backgroundColor=t=>{let{canvas:e,context:i,color:r}=t;i.fillStyle=r,i.fillRect(0,0,e.width,e.height)},r.rectangle=t=>{let{context:e,rect:i,color:r}=t;e.fillStyle=r,e.fillRect(i.x,i.y,i.width,i.height)},r.roundRectangle=t=>{let{context:e,rect:i,color:r,radius:s,borderColor:n,borderDashLength:o,borderWidth:a=0}=t,{x:h,y:l,width:d,height:c}=i;e.beginPath();e.moveTo(h+s,l),e.lineTo(h+d-s,l),e.quadraticCurveTo(h+d,l,h+d,l+s),e.lineTo(h+d,l+c-s),e.quadraticCurveTo(h+d,l+c,h+d-s,l+c),e.lineTo(h+s,l+c),e.quadraticCurveTo(h,l+c,h,l+c-s),e.lineTo(h,l+s),e.quadraticCurveTo(h,l,h+s,l),e.closePath(),e.fillStyle=r,e.fill(),n&&a>0&&(e.strokeStyle=n,e.lineWidth=a,o?e.setLineDash([o,o]):e.setLineDash([]),e.stroke(),e.setLineDash([]))},r.overlay=t=>{let{canvas:e,context:i,offset:r,scale:s,rect:n,color:o}=t;i.fillStyle=o,i.fillRect(0,0,e.width,(n.y+r.y)*s),i.fillRect(0,(n.y+n.height+r.y)*s,e.width,e.height-(n.y+n.height+r.y)*s),i.fillRect(0,(n.y+r.y)*s,(n.x+r.x)*s,n.height*s),i.fillRect((n.x+n.width+r.x)*s,(n.y+r.y)*s,e.width-(n.x+n.width+r.x)*s,n.height*s)};var E=class{constructor(){this.onActive=t=>(this.onActiveCallbacks.add(t),{dispose:()=>{this.onActiveCallbacks.delete(t)}}),this.render=this._render,this.handleWheel=t=>{},this.handleStartDrag=t=>{t.preventDefault(),t.stopPropagation();let{viewRect:e,scale:i,offset:r}=this.createRenderContext(),s=this.canvas.getBoundingClientRect(),n={x:t.clientX-s.left,y:t.clientY-s.top},o=this.rectOnCanvas({rect:e,scale:i,offset:r});if(!!this.isPointInRect({point:n,rect:o}))this.isDragging=!0,this.dragStart=n,document.addEventListener("mousemove",this.handleDragging),document.addEventListener("mouseup",this.handleEndDrag)},this.handleDragging=t=>{if(!this.isDragging||!this.dragStart)return;t.preventDefault(),t.stopPropagation();let{scale:e}=this.createRenderContext(),i=this.canvas.getBoundingClientRect(),r=t.clientX-i.left,s=t.clientY-i.top,n=(r-this.dragStart.x)/e,o=(s-this.dragStart.y)/e;this.updateScrollPosition(n,o),this.dragStart={x:r,y:s},this.render()},this.handleEndDrag=t=>{t.preventDefault(),t.stopPropagation(),document.removeEventListener("mousemove",this.handleDragging),document.removeEventListener("mouseup",this.handleEndDrag),this.isDragging=!1,this.dragStart=void 0,this.setActivate(this.isMouseInCanvas(t))},this.handleCursor=t=>{if(!this.activated)return;let{viewRect:e,scale:i,offset:r}=this.createRenderContext(),s=this.canvas.getBoundingClientRect(),n={x:t.clientX-s.left,y:t.clientY-s.top},o=this.rectOnCanvas({rect:e,scale:i,offset:r});this.isPointInRect({point:n,rect:o})?this.canvas.style.cursor="grab":this.canvas.style.cursor="default"},this.canvas=document.createElement("canvas"),this.context2D=this.canvas.getContext("2d"),this.initialized=!!this.context2D,this.onActiveCallbacks=new Set,this.toDispose=new l.K4,this.render=this._render,this.activated=!1,this.isDragging=!1}init(t){this.options=y,Object.assign(this.options,t),this.setDebounce({enableDebounce:this.options.enableInactiveDebounce,debounceTime:this.options.inactiveDebounceTime}),this.initStyle(),this.mountListener()}dispose(){this.toDispose.dispose(),this.initialized=!1,this.activated=!1,this.removeEventListeners()}setActivate(t){if(t!==this.activated&&(!!t||!this.isDragging))this.activated=t,t?(this.setDebounce({enableDebounce:this.options.enableActiveDebounce,debounceTime:this.options.activeDebounceTime}),this.addEventListeners()):(this.setDebounce({enableDebounce:this.options.enableInactiveDebounce,debounceTime:this.options.inactiveDebounceTime}),this.removeEventListeners()),this.render(),this.onActiveCallbacks.forEach(e=>e(t))}initStyle(){if(!this.initialized)return;let{canvasClassName:t,canvasStyle:e}=this.options;this.canvas.className=t,this.style={...p,...e},this.canvas.width=this.style.canvasWidth,this.canvas.height=this.style.canvasHeight,this.canvas.style.borderRadius=this.style.canvasBorderRadius?`${this.style.canvasBorderRadius}px`:"unset"}setDebounce(t){let{enableDebounce:e,debounceTime:i}=t;e?this.render=(0,a.debounce)(this._render,i):this.render=this._render}_render(){if(!this.initialized)return;let t=this.createRenderContext();this.renderCanvas(t)}createRenderContext(){let{canvas:t,context2D:e,nodes:i}=this,r=this.nodeTransforms(i).map(t=>t.bounds),s=this.viewRect(),n=this.renderRect(r).withPadding({top:this.style.canvasPadding,bottom:this.style.canvasPadding,left:this.style.canvasPadding,right:this.style.canvasPadding}),o=l.Ae.enlarge([s,n]),{scale:a,offset:h}=this.calculateScaleAndOffset({canvasRect:o});return{canvas:t,context2D:e,nodeRects:r,canvasRect:o,viewRect:s,renderRect:n,scale:a,offset:h}}renderCanvas(t){let{canvas:e,context2D:i,nodeRects:r,viewRect:n,scale:o,offset:a}=t;s.clear({canvas:e,context:i}),s.backgroundColor({canvas:e,context:i,color:this.style.canvasBackground}),s.roundRectangle({context:i,rect:this.rectOnCanvas({rect:n,scale:o,offset:a}),color:this.style.viewportBackground,radius:this.style.viewportBorderRadius}),r.forEach(t=>{s.roundRectangle({context:i,rect:this.rectOnCanvas({rect:t,scale:o,offset:a}),color:this.style.nodeColor,radius:this.style.nodeBorderRadius,borderWidth:this.style.nodeBorderWidth,borderColor:this.style.nodeBorderColor})}),s.roundRectangle({context:i,rect:this.rectOnCanvas({rect:n,scale:o,offset:a}),color:"rgba(255, 255, 255, 0)",radius:this.style.viewportBorderRadius,borderColor:this.style.viewportBorderColor,borderWidth:this.style.viewportBorderWidth,borderDashLength:this.style.viewportBorderDashLength}),s.overlay({canvas:e,context:i,offset:a,scale:o,rect:n,color:this.style.overlayColor})}calculateScaleAndOffset(t){let{canvasRect:e}=t,{width:i,height:r}=this.canvas,s=i/e.width,n=Math.min(s,r/e.height),o=e.width*n,a=e.height*n,h={x:(i-o)/2/n-e.x,y:(r-a)/2/n-e.y};return{scale:n,offset:h}}get nodes(){return this.document.getAllNodes().filter(t=>!t.hidden&&(t.flowNodeType===d.Sy.ROOT?void 0:!!this.options.enableDisplayAllNodes||!t.parent||t.parent.flowNodeType===d.Sy.ROOT||void 0))}nodeTransforms(t){return t.map(t=>t.getData(d.eG)).filter(Boolean)}renderRect(t){return l.Ae.enlarge(t)}viewRect(){let{width:t,height:e,scrollX:i,scrollY:r,zoom:s}=this.playgroundConfig.config;return new l.Ae(i/s,r/s,t/s,e/s)}mountListener(){let t=this.entityManager.onEntityChange(()=>this.render());this.toDispose.push(t)}rectOnCanvas(t){let{rect:e,scale:i,offset:r}=t;return new l.Ae((e.x+r.x)*i,(e.y+r.y)*i,e.width*i,e.height*i)}isPointInRect(t){let{point:e,rect:i}=t;return e.x>=i.x&&e.x<=i.x+i.width&&e.y>=i.y&&e.y<=i.y+i.height}addEventListeners(){this.canvas.addEventListener("wheel",this.handleWheel),this.canvas.addEventListener("mousedown",this.handleStartDrag),this.canvas.addEventListener("mousemove",this.handleCursor)}removeEventListeners(){this.canvas.removeEventListener("wheel",this.handleWheel),this.canvas.removeEventListener("mousedown",this.handleStartDrag),this.canvas.removeEventListener("mousemove",this.handleCursor)}isMouseInCanvas(t){let e=this.canvas.getBoundingClientRect();return t.clientX>=e.left&&t.clientX<=e.right&&t.clientY>=e.top&&t.clientY<=e.bottom}updateScrollPosition(t,e){let{scrollX:i,scrollY:r,zoom:s}=this.playgroundConfig.config;this.playgroundConfig.updateConfig({scrollX:i+t*s,scrollY:r+e*s})}};g([(0,h.f3)(d.pQ)],E.prototype,"document",2),g([(0,h.f3)(o.v2)],E.prototype,"entityManager",2),g([(0,h.f3)(o.ER)],E.prototype,"playgroundConfig",2),E=g([(0,h.b2)()],E);var D=class extends o.mh{constructor(){super(),this.className="gedit-minimap-layer gedit-playground-layer",this.node=l.xF.createDivWithClass(this.className),this.node.style.zIndex="9999"}render(){return this.options.disableLayer?n.createElement(n.Fragment,null):n.createElement(m,{service:this.service,panelStyles:this.options.panelStyles,containerStyles:this.options.containerStyles,inactiveStyle:this.options.inactiveStyle})}};D.type="FlowMinimapLayer",g([(0,h.f3)(E)],D.prototype,"service",2),D=g([(0,h.b2)()],D);var M=(0,o.M1)({onBind:({bind:t})=>{t(E).toSelf().inSingletonScope()},onInit:(t,e)=>{t.playground.registerLayer(D,e),t.get(E).init(e)},onDispose:t=>{t.get(E).dispose()}})},229687:function(t,e,i){i.d(e,{Y:function(){return s}});var r=i(775832),s=(0,i(213153).M1)({onInit(t,e){!1!==e.enable&&(t.playground.registerLayer(r.aK,e),t.playground.registerLayer(r.Kz,{canSelect:e.canSelect}))}})}}]);